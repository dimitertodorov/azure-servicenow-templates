{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "12915264897460654101"
    }
  },
  "definitions": {
    "roleDefinition": {
      "type": "object",
      "properties": {
        "roleDefinitionId": {
          "type": "string"
        },
        "principalId": {
          "type": "string"
        },
        "principalType": {
          "type": "string"
        }
      }
    }
  },
  "parameters": {
    "networkResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the network resource group."
      }
    },
    "deployNetwork": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy the network resources?"
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "aci-vnet-default",
      "metadata": {
        "description": "The name of the virtual network"
      }
    },
    "vnetAddressPrefixes": {
      "type": "array",
      "defaultValue": [
        "10.112.0.0/16"
      ],
      "metadata": {
        "description": "The address prefixes for the virtual network"
      }
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "aci-subnet-default",
      "metadata": {
        "description": "The name of the subnet"
      }
    },
    "nsgName": {
      "type": "string",
      "defaultValue": "snowmid-nsg-default",
      "metadata": {
        "description": "The name of the network security group"
      }
    },
    "subnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.112.0.0/24",
      "metadata": {
        "description": "The address prefix for the subnet"
      }
    },
    "devopsEnvironmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 5,
      "metadata": {
        "description": "The name of the environment. This will be used to tag, and identify resources."
      }
    },
    "deployPermissions": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Permissions? Requires Owner permissions on the resource group."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for the resources"
      }
    },
    "runValidationScript": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Run the validation script to test connectivity to ServiceNow"
      }
    },
    "adminEntraEntities": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Additional Azure AD Objects with principalId and principalType to be added to the Key Vault access policy"
      }
    },
    "snowHost": {
      "type": "string",
      "metadata": {
        "description": "ServiceNow Host. Will be stored as a tag on the storage account"
      }
    },
    "snowUsername": {
      "type": "string",
      "metadata": {
        "description": "ServiceNow Username"
      }
    },
    "snowPassword": {
      "type": "securestring",
      "metadata": {
        "description": "ServiceNow Password"
      }
    },
    "containerSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subnet ID for the container. Must have access to ServiceNow instance, ACR, and ARM Services at a minimum."
      }
    },
    "additionalStorageSubnetIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Subnet IDs to allow access to the storage account"
      }
    },
    "virtualNetworkRoleId": {
      "type": "string",
      "defaultValue": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
      "metadata": {
        "description": "The ID of the virtual network role. This is used to assign the role to the subnet. Default is Contributor on the virtual network."
      }
    },
    "containerRegistrySubscription": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "ACR Subscription"
      }
    },
    "containerRegistryResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "ACR Resource Group"
      }
    },
    "containerRegistryName": {
      "type": "string",
      "metadata": {
        "description": "ACR Registry Name"
      }
    },
    "additionalResourceGroupRoleAssignments": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Must contain roleDefinitionId, principalId, and principalType. This is used to assign additional roles to the resource group."
      }
    }
  },
  "resources": {
    "aciNetwork": {
      "condition": "[parameters('deployNetwork')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "ServiceNow-MID-ACI-Network",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceGroupName": {
            "value": "[parameters('networkResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "nsgName": {
            "value": "[parameters('nsgName')]"
          },
          "vnetAddressPrefixes": {
            "value": "[parameters('vnetAddressPrefixes')]"
          },
          "subnetName": {
            "value": "[parameters('subnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('subnetAddressPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "15470673799196117707"
            }
          },
          "parameters": {
            "resourceGroupName": {
              "type": "string",
              "defaultValue": "snmid-rg-network-default"
            },
            "location": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "defaultValue": "aci-vnet-default",
              "metadata": {
                "description": "The name of the virtual network"
              }
            },
            "vnetAddressPrefixes": {
              "type": "array",
              "defaultValue": [
                "10.112.0.0/16"
              ],
              "metadata": {
                "description": "The address prefixes for the virtual network"
              }
            },
            "subnetName": {
              "type": "string",
              "defaultValue": "aci-subnet-default",
              "metadata": {
                "description": "The name of the subnet"
              }
            },
            "nsgName": {
              "type": "string",
              "defaultValue": "snowmid-nsg-default",
              "metadata": {
                "description": "The name of the network security group"
              }
            },
            "subnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.112.0.0/24",
              "metadata": {
                "description": "The address prefix for the subnet"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "aci-nsg-default",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "nsgName": {
                    "value": "[parameters('nsgName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "6579114253917744486"
                    }
                  },
                  "parameters": {
                    "nsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "AllowInbound-443",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound to destination port 443",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "443",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1001,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "AllowInbound-dbports",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound to database ports",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1002,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "1433-1434",
                                "2382-2383",
                                "5432",
                                "27016-27019",
                                "3306",
                                "33060",
                                "6446-6449",
                                "50000-50001",
                                "1521-1525",
                                "8000",
                                "8200"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "Allow-AzureLoadBalancer-Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow AzureLoadBalancer inbound",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "*",
                              "sourceAddressPrefix": "AzureLoadBalancer",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1003,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "fileshare-access",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound fileshare access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1004,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "111",
                                "139",
                                "445",
                                "2048",
                                "2049"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "service_bus",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound service bus access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1005,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "5671",
                                "5672"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "event_hub",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound event hub access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "9093",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1006,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "mongodb",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound mongodb access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1007,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "1024-1030"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "elastic",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound elastic access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "9243",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1008,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "redis",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound redis access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1009,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "6379-6380"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "Deny-udp-Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Deny UDP inbound",
                              "protocol": "Udp",
                              "sourcePortRange": "*",
                              "destinationPortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Deny",
                              "priority": 4095,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "Deny-tcp-Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Deny TCP inbound",
                              "protocol": "Tcp",
                              "sourcePortRange": "*",
                              "destinationPortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Deny",
                              "priority": 4096,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "AllowInbound-https-9443-9455",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound to destination port 9443-9455",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1000,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "9443-9455"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          },
                          {
                            "name": "Allow-BatchAccount-Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "description": "Allow inbound batch account access",
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 1010,
                              "direction": "Inbound",
                              "sourcePortRanges": [],
                              "destinationPortRanges": [
                                "29876-29877"
                              ],
                              "sourceAddressPrefixes": [],
                              "destinationAddressPrefixes": []
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "nsgId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "aci-vnet-default",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vnetName": {
                    "value": "[parameters('vnetName')]"
                  },
                  "vnetAddressPrefixes": {
                    "value": "[parameters('vnetAddressPrefixes')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "5329169754028206859"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "vnetName": {
                      "type": "string",
                      "defaultValue": "aci-vnet-default"
                    },
                    "vnetAddressPrefixes": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "virtualNetwork": {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2024-05-01",
                      "name": "[parameters('vnetName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": "[parameters('vnetAddressPrefixes')]"
                        },
                        "privateEndpointVNetPolicies": "Disabled",
                        "enableDdosProtection": false
                      }
                    }
                  },
                  "outputs": {
                    "virtualNetwork": {
                      "type": "object",
                      "value": "[reference('virtualNetwork', '2024-05-01', 'full')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "aci-subnet-default",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "subnetName": {
                    "value": "[parameters('subnetName')]"
                  },
                  "workloadNsgId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aci-nsg-default'), '2022-09-01').outputs.nsgId.value]"
                  },
                  "virtualNetworkName": {
                    "value": "[parameters('vnetName')]"
                  },
                  "subnetAddressPrefix": {
                    "value": "[parameters('subnetAddressPrefix')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "8747035808070718892"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "subnetName": {
                      "type": "string"
                    },
                    "subnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": "10.166.85.0/26"
                    },
                    "workloadNsgId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName'))]",
                      "properties": {
                        "addressPrefix": "[parameters('subnetAddressPrefix')]",
                        "networkSecurityGroup": {
                          "id": "[parameters('workloadNsgId')]"
                        },
                        "serviceEndpoints": [
                          {
                            "service": "Microsoft.Storage",
                            "locations": [
                              "canadacentral",
                              "canadaeast"
                            ]
                          }
                        ],
                        "delegations": [
                          {
                            "name": "ACIDelegationService",
                            "properties": {
                              "serviceName": "Microsoft.ContainerInstance/containerGroups"
                            },
                            "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                          }
                        ],
                        "privateEndpointNetworkPolicies": "Enabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "subnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]"
                    },
                    "subnetName": {
                      "type": "string",
                      "value": "[parameters('subnetName')]"
                    },
                    "subnetAddressPrefix": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName')), '2024-05-01').addressPrefix]"
                    },
                    "virtualNetworkId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aci-nsg-default')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aci-vnet-default')]"
              ]
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aci-subnet-default'), '2022-09-01').outputs.subnetId.value]"
            }
          }
        }
      }
    },
    "midEnvironment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('ServiceNow-MID-ACI-{0}', parameters('devopsEnvironmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "devopsEnvironmentName": {
            "value": "[parameters('devopsEnvironmentName')]"
          },
          "deployPermissions": {
            "value": "[parameters('deployPermissions')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "runValidationScript": {
            "value": "[parameters('runValidationScript')]"
          },
          "adminEntraEntities": {
            "value": "[parameters('adminEntraEntities')]"
          },
          "snowHost": {
            "value": "[parameters('snowHost')]"
          },
          "snowUsername": {
            "value": "[parameters('snowUsername')]"
          },
          "snowPassword": {
            "value": "[parameters('snowPassword')]"
          },
          "containerSubnetId": "[if(parameters('deployNetwork'), createObject('value', reference('aciNetwork').outputs.subnetId.value), createObject('value', parameters('containerSubnetId')))]",
          "additionalStorageSubnetIds": {
            "value": "[parameters('additionalStorageSubnetIds')]"
          },
          "virtualNetworkRoleId": {
            "value": "[parameters('virtualNetworkRoleId')]"
          },
          "containerRegistrySubscription": {
            "value": "[parameters('containerRegistrySubscription')]"
          },
          "containerRegistryResourceGroup": {
            "value": "[parameters('containerRegistryResourceGroup')]"
          },
          "containerRegistryName": {
            "value": "[parameters('containerRegistryName')]"
          },
          "additionalResourceGroupRoleAssignments": {
            "value": "[parameters('additionalResourceGroupRoleAssignments')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "12117066489161632351"
            }
          },
          "parameters": {
            "devopsEnvironmentName": {
              "type": "string",
              "defaultValue": "dev",
              "maxLength": 5,
              "metadata": {
                "description": "The name of the environment. This will be used to tag, and identify resources."
              }
            },
            "deployPermissions": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Deploy Permissions? This will deploy the necessary permissions for the DevOps identities to the resources. Requires OWNER permissions on the resource group."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resources"
              }
            },
            "runValidationScript": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Run the validation script to test connectivity to ServiceNow"
              }
            },
            "adminEntraEntities": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional Azure AD Objects with principalId and principalType to be added to the Key Vault access policy, and admin role assignments."
              }
            },
            "snowHost": {
              "type": "string",
              "metadata": {
                "description": "ServiceNow Host. Will be stored as a tag on the storage account"
              }
            },
            "snowUsername": {
              "type": "string",
              "metadata": {
                "description": "ServiceNow Username"
              }
            },
            "snowPassword": {
              "type": "securestring",
              "metadata": {
                "description": "ServiceNow Password"
              }
            },
            "containerSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for the container. Must have access to ServiceNow instance, ACR, and ARM Services at a minimum."
              }
            },
            "additionalStorageSubnetIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Subnet IDs to allow access to the storage account"
              }
            },
            "virtualNetworkRoleId": {
              "type": "string",
              "defaultValue": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
              "metadata": {
                "description": "The ID of the virtual network role. This is used to assign the role to the subnet. Default is Contributor on the virtual network."
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "[format('snkv-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
              "maxLength": 24,
              "metadata": {
                "description": "Key Vault Name"
              }
            },
            "keyVaultResourceGroup": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "Key Vault Resource Group"
              }
            },
            "keyVaultSubscription": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "Key Vault Subscription"
              }
            },
            "containerRegistrySubscription": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "ACR Subscription"
              }
            },
            "containerRegistryResourceGroup": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "ACR Resource Group"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "ACR Registry Name"
              }
            },
            "additionalResourceGroupRoleAssignments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional Resource Group Role Assignments"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "adminEntitiesTagArray",
                "count": "[length(parameters('adminEntraEntities'))]",
                "input": "[format('{0}:{1}', parameters('adminEntraEntities')[copyIndex('adminEntitiesTagArray')].principalId, parameters('adminEntraEntities')[copyIndex('adminEntitiesTagArray')].principalType)]"
              }
            ],
            "containerRegistryId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.ContainerRegistry/registries/{2}', parameters('containerRegistrySubscription'), parameters('containerRegistryResourceGroup'), parameters('containerRegistryName'))]",
            "keyVaultId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.KeyVault/vaults/{2}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup'), parameters('keyVaultName'))]",
            "storageAccountName": "[format('snst{0}{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
            "userAssignedIdentityName": "[format('snow-devops-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
            "midServerIdentityName": "[format('snow-midserver-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
            "adminEntitiesTag": "[join(variables('adminEntitiesTagArray'), ',')]",
            "environmentTags": {
              "SnowEnvironment": "[parameters('devopsEnvironmentName')]",
              "SnowStorageAccount": "[variables('storageAccountName')]",
              "SnowContainerRegistry": "[format('{0}.azurecr.io', parameters('containerRegistryName'))]",
              "SnowKeyVaultId": "[variables('keyVaultId')]",
              "SnowContainerSubnetId": "[parameters('containerSubnetId')]",
              "SnowContainerRegistryId": "[variables('containerRegistryId')]",
              "SnowDevopsIdentity": "[variables('userAssignedIdentityName')]",
              "SnowMidServerIdentity": "[variables('midServerIdentityName')]",
              "SnowHost": "[parameters('snowHost')]",
              "SnowAdminEntities": "[variables('adminEntitiesTag')]"
            },
            "storageAccountSubnets": "[union(createArray(parameters('containerSubnetId')), parameters('additionalStorageSubnetIds'))]",
            "snowApiUserSecretName": "snow-api-username",
            "snowApiPasswordSecretName": "snow-api-password",
            "snowApiConnectionSecretName": "[format('snow-connection-{0}-json', toLower(parameters('devopsEnvironmentName')))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('userAssignedIdentityName')]",
              "location": "[parameters('location')]",
              "tags": "[union(variables('environmentTags'), createObject('SnowIdentityType', 'DevOps'))]"
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('midServerIdentityName')]",
              "location": "[parameters('location')]",
              "tags": "[union(variables('environmentTags'), createObject('SnowIdentityType', 'MidServer'))]"
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "networkAcls": {
                  "copy": [
                    {
                      "name": "virtualNetworkRules",
                      "count": "[length(variables('storageAccountSubnets'))]",
                      "input": {
                        "id": "[variables('storageAccountSubnets')[copyIndex('virtualNetworkRules')]]",
                        "action": "Allow",
                        "state": "Succeeded"
                      }
                    }
                  ],
                  "bypass": "AzureServices",
                  "defaultAction": "Deny"
                }
              },
              "tags": "[variables('environmentTags')]"
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'ServiceNowMidServers')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'config')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[parameters('keyVaultName')]",
              "subscriptionId": "[parameters('keyVaultSubscription')]",
              "resourceGroup": "[parameters('keyVaultResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tenantId": {
                    "value": "[subscription().tenantId]"
                  },
                  "objectIds": {
                    "value": "[union(createArray(reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31').principalId), map(parameters('adminEntraEntities'), lambda('entity', lambdaVariables('entity').principalId)))]"
                  },
                  "secretsPermissions": {
                    "value": [
                      "all"
                    ]
                  },
                  "keysPermissions": {
                    "value": [
                      "all"
                    ]
                  },
                  "certificatePermissions": {
                    "value": [
                      "all"
                    ]
                  },
                  "enabledForDeployment": {
                    "value": true
                  },
                  "enabledForTemplateDeployment": {
                    "value": true
                  },
                  "enabledForDiskEncryption": {
                    "value": true
                  },
                  "skuName": {
                    "value": "standard"
                  },
                  "secretsObject": {
                    "value": {
                      "secrets": [
                        {
                          "secretName": "[variables('snowApiUserSecretName')]",
                          "secretValue": "[parameters('snowUsername')]"
                        },
                        {
                          "secretName": "[variables('snowApiPasswordSecretName')]",
                          "secretValue": "[parameters('snowPassword')]"
                        },
                        {
                          "secretName": "[variables('snowApiConnectionSecretName')]",
                          "secretValue": "[string(createObject('Instance', parameters('snowHost'), 'Username', parameters('snowUsername'), 'Password', parameters('snowPassword')))]",
                          "contentType": "application/json"
                        }
                      ]
                    }
                  },
                  "tags": {
                    "value": "[variables('environmentTags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "4996166636307787255"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the key vault."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Specifies the Azure location where the key vault should be created."
                      }
                    },
                    "enabledForDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Specifies whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the key vault."
                      }
                    },
                    "enabledForDiskEncryption": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Specifies whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys."
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Specifies whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "tenantId": {
                      "type": "string",
                      "defaultValue": "[subscription().tenantId]",
                      "metadata": {
                        "description": "Specifies the Azure Active Directory tenant ID that should be used for authenticating requests to the key vault. Get it by using Get-AzSubscription cmdlet."
                      }
                    },
                    "objectIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Specifies the objects ID of a user, service principal or security group in the Azure Active Directory tenant for the vault. The object ID must be unique for the list of access policies. Get it by using Get-AzADUser or Get-AzADServicePrincipal cmdlets."
                      }
                    },
                    "keysPermissions": {
                      "type": "array",
                      "defaultValue": [
                        "all"
                      ],
                      "metadata": {
                        "description": "Specifies the permissions to keys in the vault. Valid values are: all, encrypt, decrypt, wrapKey, unwrapKey, sign, verify, get, list, create, update, import, delete, backup, restore, recover, and purge."
                      }
                    },
                    "secretsPermissions": {
                      "type": "array",
                      "defaultValue": [
                        "list",
                        "get",
                        "set",
                        "delete",
                        "backup",
                        "restore",
                        "recover",
                        "purge"
                      ],
                      "metadata": {
                        "description": "Specifies the permissions to secrets in the vault. Valid values are: all, get, list, set, delete, backup, restore, recover, and purge."
                      }
                    },
                    "certificatePermissions": {
                      "type": "array",
                      "defaultValue": [
                        "get",
                        "list",
                        "delete",
                        "create",
                        "import",
                        "update"
                      ],
                      "metadata": {
                        "description": "Certificate Permission"
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "standard",
                      "allowedValues": [
                        "standard",
                        "premium"
                      ],
                      "metadata": {
                        "description": "Specifies whether the key vault is a standard vault or a premium vault."
                      }
                    },
                    "secretsObject": {
                      "type": "secureObject",
                      "metadata": {
                        "description": "Specifies all secrets {\"secretName\":\"\",\"secretValue\":\"\"} wrapped in a secure object."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2023-07-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "accessPolicies",
                            "count": "[length(parameters('objectIds'))]",
                            "input": {
                              "objectId": "[parameters('objectIds')[copyIndex('accessPolicies')]]",
                              "tenantId": "[parameters('tenantId')]",
                              "permissions": {
                                "keys": "[parameters('keysPermissions')]",
                                "secrets": "[parameters('secretsPermissions')]",
                                "certificates": "[parameters('certificatePermissions')]",
                                "storage": [
                                  "all"
                                ]
                              }
                            }
                          }
                        ],
                        "enabledForDeployment": "[parameters('enabledForDeployment')]",
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "enabledForDiskEncryption": "[parameters('enabledForDiskEncryption')]",
                        "tenantId": "[parameters('tenantId')]",
                        "sku": {
                          "name": "[parameters('skuName')]",
                          "family": "A"
                        },
                        "networkAcls": {
                          "defaultAction": "Allow",
                          "bypass": "AzureServices"
                        }
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "copy": {
                        "name": "secrets",
                        "count": "[length(parameters('secretsObject').secrets)]"
                      },
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretsObject').secrets[copyIndex()].secretName)]",
                      "properties": {
                        "value": "[parameters('secretsObject').secrets[copyIndex()].secretValue]",
                        "contentType": "[coalesce(tryGet(parameters('secretsObject').secrets[copyIndex()], 'contentType'), 'String')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "location": {
                      "type": "string",
                      "value": "[parameters('location')]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "value": "[resourceGroup().name]"
                    },
                    "subscriptionId": {
                      "type": "string",
                      "value": "[subscription().subscriptionId]"
                    },
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                    },
                    "keyVault": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01', 'full')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "DevopsVaultAccessPolicies",
              "subscriptionId": "[parameters('keyVaultSubscription')]",
              "resourceGroup": "[parameters('keyVaultResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31').principalId]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "16892888835608624380"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string"
                    },
                    "permissions": {
                      "type": "object",
                      "defaultValue": {
                        "secrets": [
                          "all"
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults/accessPolicies",
                      "apiVersion": "2019-09-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
                      "properties": {
                        "accessPolicies": [
                          {
                            "objectId": "[parameters('principalId')]",
                            "tenantId": "[subscription().tenantId]",
                            "permissions": "[parameters('permissions')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "containerRegistry",
              "subscriptionId": "[parameters('containerRegistrySubscription')]",
              "resourceGroup": "[parameters('containerRegistryResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "registryName": {
                    "value": "[parameters('containerRegistryName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "7886093999930425737"
                    }
                  },
                  "parameters": {
                    "registryName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Basic",
                      "allowedValues": [
                        "Basic",
                        "Standard",
                        "Premium"
                      ]
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {
                        "type": "SystemAssigned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ContainerRegistry/registries",
                      "apiVersion": "2023-07-01",
                      "name": "[parameters('registryName')]",
                      "identity": "[parameters('identity')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "adminUserEnabled": true
                      },
                      "sku": {
                        "name": "[parameters('sku')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "containerRegistry": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), '2023-07-01', 'full')]"
                    },
                    "loginServer": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), '2023-07-01').loginServer]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('deployPermissions')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('AssignPermissions-{0}', parameters('devopsEnvironmentName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "devopsEnvironmentName": {
                    "value": "[parameters('devopsEnvironmentName')]"
                  },
                  "containerRegistrySubscription": {
                    "value": "[parameters('containerRegistrySubscription')]"
                  },
                  "containerRegistryResourceGroup": {
                    "value": "[parameters('containerRegistryResourceGroup')]"
                  },
                  "containerRegistryName": {
                    "value": "[parameters('containerRegistryName')]"
                  },
                  "keyVaultSubscription": {
                    "value": "[parameters('keyVaultSubscription')]"
                  },
                  "keyVaultResourceGroup": {
                    "value": "[parameters('keyVaultResourceGroup')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "containerSubnetId": {
                    "value": "[parameters('containerSubnetId')]"
                  },
                  "virtualNetworkRoleId": {
                    "value": "[parameters('virtualNetworkRoleId')]"
                  },
                  "adminEntraEntities": {
                    "value": "[parameters('adminEntraEntities')]"
                  },
                  "additionalResourceGroupRoleAssignments": {
                    "value": "[parameters('additionalResourceGroupRoleAssignments')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "7100827518187724853"
                    }
                  },
                  "functions": [
                    {
                      "namespace": "__bicep",
                      "members": {
                        "parseResourceId": {
                          "parameters": [
                            {
                              "type": "string",
                              "name": "resourceId"
                            }
                          ],
                          "output": {
                            "type": "object",
                            "value": {
                              "SubscriptionId": "[split(parameters('resourceId'), '/')[2]]",
                              "ResourceGroup": "[split(parameters('resourceId'), '/')[4]]",
                              "Name": "[last(split(parameters('resourceId'), '/'))]"
                            }
                          },
                          "metadata": {
                            "description": "Parse a resource ID into its components",
                            "__bicep_imported_from!": {
                              "sourceTemplate": "modules/common-functions.bicep"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "parameters": {
                    "devopsEnvironmentName": {
                      "type": "string",
                      "defaultValue": "dev",
                      "maxLength": 5,
                      "metadata": {
                        "description": "The name of the environment. This will be used to tag, and identify resources."
                      }
                    },
                    "containerSubnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Subnet ID for the container. Must have access to ServiceNow instance, ACR, and ARM Services at a minimum."
                      }
                    },
                    "virtualNetworkRoleId": {
                      "type": "string",
                      "defaultValue": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
                      "metadata": {
                        "description": "The ID of the virtual network role. This is used to assign the role to the subnet. Default is Contributor on the virtual network."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "defaultValue": "[format('snkv-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
                      "maxLength": 24,
                      "metadata": {
                        "description": "Key Vault Name"
                      }
                    },
                    "keyVaultResourceGroup": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Key Vault Resource Group"
                      }
                    },
                    "keyVaultSubscription": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Key Vault Subscription"
                      }
                    },
                    "containerRegistrySubscription": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "ACR Subscription"
                      }
                    },
                    "containerRegistryResourceGroup": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "ACR Resource Group"
                      }
                    },
                    "containerRegistryName": {
                      "type": "string",
                      "metadata": {
                        "description": "ACR Registry Name"
                      }
                    },
                    "adminEntraEntities": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "The Entra ID (Azure AD) objects with principalId and principalType to be added to the Key Vault access policy, and admin role assignments."
                      }
                    },
                    "additionalResourceGroupRoleAssignments": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Additional Resource Group Role Assignments"
                      }
                    }
                  },
                  "variables": {
                    "storageAccountName": "[format('snst{0}{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
                    "userAssignedIdentityName": "[format('snow-devops-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
                    "midServerIdentityName": "[format('snow-midserver-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
                    "subnetParts": "[if(not(equals(parameters('containerSubnetId'), '')), __bicep.parseResourceId(parameters('containerSubnetId')), createObject('ResourceGroup', resourceGroup().name, 'SubscriptionId', subscription().subscriptionId))]"
                  },
                  "resources": {
                    "userAssignedIdentity": {
                      "existing": true,
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2023-01-31",
                      "name": "[variables('userAssignedIdentityName')]"
                    },
                    "midServerIdentity": {
                      "existing": true,
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2023-01-31",
                      "name": "[variables('midServerIdentityName')]"
                    },
                    "storageAccount": {
                      "existing": true,
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[variables('storageAccountName')]"
                    },
                    "storageAccountTableServices": {
                      "type": "Microsoft.Storage/storageAccounts/tableServices",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]"
                    },
                    "storageAccountMidServersTable": {
                      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'ServiceNowMidServers')]",
                      "dependsOn": [
                        "storageAccountTableServices"
                      ]
                    },
                    "storageAccountConfigTable": {
                      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'config')]",
                      "dependsOn": [
                        "storageAccountTableServices"
                      ]
                    },
                    "storageFileDataPrivilegedContributor": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "scope": "/",
                      "name": "69566ab7-960f-475b-8e7c-b3118f30c6bd"
                    },
                    "storageTableDataContributor": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "scope": "/",
                      "name": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3"
                    },
                    "keyVaultAdministratorRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2018-01-01-preview",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "00482a5a-887f-4fb3-b363-3b7fe8e74483",
                      "metadata": {
                        "description": "This is the built-in Key Vault Administrator role. See https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#key-vault-administrator"
                      }
                    },
                    "keyvaultReaderRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "4633458b-17de-408a-b874-0445c86b69e6"
                    },
                    "contributorRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "b24988ac-6180-42a0-ab88-20f7382dd24c"
                    },
                    "readerRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
                    },
                    "acrPullRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
                    },
                    "keyVault": {
                      "existing": true,
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2024-12-01-preview",
                      "subscriptionId": "[parameters('keyVaultSubscription')]",
                      "resourceGroup": "[parameters('keyVaultResourceGroup')]",
                      "name": "[parameters('keyVaultName')]"
                    },
                    "roleAssignmentNetworkDevOps": {
                      "condition": "[not(equals(parameters('containerSubnetId'), ''))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentNetworkDevops",
                      "resourceGroup": "[variables('subnetParts').ResourceGroup]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "subnetId": {
                            "value": "[parameters('containerSubnetId')]"
                          },
                          "roleDefinitionId": {
                            "value": "[parameters('virtualNetworkRoleId')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "741552545490895985"
                            }
                          },
                          "parameters": {
                            "subnetId": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "variables": {
                            "subnetParts": "[split(parameters('subnetId'), '/')]",
                            "virtualNetworkName": "[variables('subnetParts')[8]]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', variables('virtualNetworkName'))]",
                              "name": "[guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName')), 'Microsoft.Authorization/roleAssignments', guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))), '2022-04-01', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "roleAssignmentNetworkDevOpsReader": {
                      "condition": "[not(equals(parameters('containerSubnetId'), ''))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentNetworkDevopsReader",
                      "resourceGroup": "[variables('subnetParts').ResourceGroup]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "roleAssignmentNetworkMidServer": {
                      "condition": "[not(equals(parameters('containerSubnetId'), ''))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentNetworkMid",
                      "resourceGroup": "[variables('subnetParts').ResourceGroup]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "subnetId": {
                            "value": "[parameters('containerSubnetId')]"
                          },
                          "roleDefinitionId": {
                            "value": "[parameters('virtualNetworkRoleId')]"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "741552545490895985"
                            }
                          },
                          "parameters": {
                            "subnetId": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "variables": {
                            "subnetParts": "[split(parameters('subnetId'), '/')]",
                            "virtualNetworkName": "[variables('subnetParts')[8]]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', variables('virtualNetworkName'))]",
                              "name": "[guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName')), 'Microsoft.Authorization/roleAssignments', guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))), '2022-04-01', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "roleAssignmentStorageFiles": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentStorageFiles",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "storageAccountName": {
                            "value": "[variables('storageAccountName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', '69566ab7-960f-475b-8e7c-b3118f30c6bd')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "10428523062572823636"
                            }
                          },
                          "parameters": {
                            "storageAccountName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "midRoleAssignmentStorageFiles": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "midRoleAssignmentStorageFiles",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "storageAccountName": {
                            "value": "[variables('storageAccountName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', '69566ab7-960f-475b-8e7c-b3118f30c6bd')]"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "10428523062572823636"
                            }
                          },
                          "parameters": {
                            "storageAccountName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "roleAssignmentStorageTables": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentStorageTables",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "storageAccountName": {
                            "value": "[variables('storageAccountName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', '0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "10428523062572823636"
                            }
                          },
                          "parameters": {
                            "storageAccountName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "midRoleAssignmentStorageTables": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "midRoleAssignmentStorageTables",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "storageAccountName": {
                            "value": "[variables('storageAccountName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[tenantResourceId('Microsoft.Authorization/roleDefinitions', '0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3')]"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "10428523062572823636"
                            }
                          },
                          "parameters": {
                            "storageAccountName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "roleAssignmentResourceGroup": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentResourceGroup",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "roleAssignmentResourceGroupMidServer": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentResourceGroupMidServer",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "roleAssignmentKeyVault": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentKeyVault",
                      "subscriptionId": "[parameters('keyVaultSubscription')]",
                      "resourceGroup": "[parameters('keyVaultResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "keyVaultName": {
                            "value": "[parameters('keyVaultName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "5428693023238762876"
                            }
                          },
                          "parameters": {
                            "keyVaultName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
                              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "roleAssignmentKeyVaultReaderMid": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "roleAssignmentKeyVaultReaderMid",
                      "subscriptionId": "[parameters('keyVaultSubscription')]",
                      "resourceGroup": "[parameters('keyVaultResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "keyVaultName": {
                            "value": "[parameters('keyVaultName')]"
                          },
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "5428693023238762876"
                            }
                          },
                          "parameters": {
                            "keyVaultName": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
                              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('roleDefinitionId'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "acrDevopsContributor": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "acrDevopsContributor",
                      "subscriptionId": "[parameters('containerRegistrySubscription')]",
                      "resourceGroup": "[parameters('containerRegistryResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "containerRegistryName": {
                            "value": "[parameters('containerRegistryName')]"
                          },
                          "roleDefinitionName": {
                            "value": "b24988ac-6180-42a0-ab88-20f7382dd24c"
                          },
                          "principalId": {
                            "value": "[reference('userAssignedIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "5909418283064645373"
                            }
                          },
                          "parameters": {
                            "containerRegistryName": {
                              "type": "string"
                            },
                            "roleDefinitionName": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                              "name": "[guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionName'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), 'Microsoft.Authorization/roleAssignments', guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "userAssignedIdentity"
                      ]
                    },
                    "acrMidServerContributor": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "acrMidServerContributor",
                      "subscriptionId": "[parameters('containerRegistrySubscription')]",
                      "resourceGroup": "[parameters('containerRegistryResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "containerRegistryName": {
                            "value": "[parameters('containerRegistryName')]"
                          },
                          "roleDefinitionName": {
                            "value": "b24988ac-6180-42a0-ab88-20f7382dd24c"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "5909418283064645373"
                            }
                          },
                          "parameters": {
                            "containerRegistryName": {
                              "type": "string"
                            },
                            "roleDefinitionName": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                              "name": "[guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionName'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), 'Microsoft.Authorization/roleAssignments', guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "acrMidServerAcrPull": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "acrMidServerAcrPull",
                      "subscriptionId": "[parameters('containerRegistrySubscription')]",
                      "resourceGroup": "[parameters('containerRegistryResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "containerRegistryName": {
                            "value": "[parameters('containerRegistryName')]"
                          },
                          "roleDefinitionName": {
                            "value": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
                          },
                          "principalId": {
                            "value": "[reference('midServerIdentity').principalId]"
                          },
                          "principalType": {
                            "value": "ServicePrincipal"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "5909418283064645373"
                            }
                          },
                          "parameters": {
                            "containerRegistryName": {
                              "type": "string"
                            },
                            "roleDefinitionName": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
                              "name": "[guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionName'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), 'Microsoft.Authorization/roleAssignments', guid(parameters('containerRegistryName'), parameters('roleDefinitionName'), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "midServerIdentity"
                      ]
                    },
                    "resourceGroupContributors": {
                      "copy": {
                        "name": "resourceGroupContributors",
                        "count": "[length(parameters('adminEntraEntities'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('roleAssignment-{0}', uniqueString(parameters('devopsEnvironmentName'), parameters('adminEntraEntities')[copyIndex()].principalId))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                          },
                          "principalId": {
                            "value": "[parameters('adminEntraEntities')[copyIndex()].principalId]"
                          },
                          "principalType": {
                            "value": "[coalesce(parameters('adminEntraEntities')[copyIndex()].principalType, 'ServicePrincipal')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      }
                    },
                    "acrContributors": {
                      "copy": {
                        "name": "acrContributors",
                        "count": "[length(parameters('adminEntraEntities'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('acrRoleAssignment-{0}', uniqueString(parameters('devopsEnvironmentName'), parameters('adminEntraEntities')[copyIndex()].principalId))]",
                      "subscriptionId": "[parameters('containerRegistrySubscription')]",
                      "resourceGroup": "[parameters('containerRegistryResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                          },
                          "principalId": {
                            "value": "[parameters('adminEntraEntities')[copyIndex()].principalId]"
                          },
                          "principalType": {
                            "value": "[coalesce(parameters('adminEntraEntities')[copyIndex()].principalType, 'ServicePrincipal')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      }
                    },
                    "networkAdditionalAssignments": {
                      "copy": {
                        "name": "networkAdditionalAssignments",
                        "count": "[length(parameters('adminEntraEntities'))]"
                      },
                      "condition": "[not(equals(parameters('containerSubnetId'), ''))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('networkRoleAssignment-{0}', uniqueString(parameters('devopsEnvironmentName'), parameters('adminEntraEntities')[copyIndex()].principalId))]",
                      "resourceGroup": "[variables('subnetParts').ResourceGroup]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "subnetId": {
                            "value": "[parameters('containerSubnetId')]"
                          },
                          "roleDefinitionId": {
                            "value": "[parameters('virtualNetworkRoleId')]"
                          },
                          "principalId": {
                            "value": "[parameters('adminEntraEntities')[copyIndex()].principalId]"
                          },
                          "principalType": {
                            "value": "[coalesce(parameters('adminEntraEntities')[copyIndex()].principalType, 'ServicePrincipal')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "741552545490895985"
                            }
                          },
                          "parameters": {
                            "subnetId": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "variables": {
                            "subnetParts": "[split(parameters('subnetId'), '/')]",
                            "virtualNetworkName": "[variables('subnetParts')[8]]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', variables('virtualNetworkName'))]",
                              "name": "[guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(extensionResourceId(resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName')), 'Microsoft.Authorization/roleAssignments', guid(variables('virtualNetworkName'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')), parameters('principalId'))), '2022-04-01', 'full')]"
                            }
                          }
                        }
                      }
                    },
                    "additionalRoleAssignments": {
                      "copy": {
                        "name": "additionalRoleAssignments",
                        "count": "[length(parameters('additionalResourceGroupRoleAssignments'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('roleAssignment-{0}', uniqueString(parameters('devopsEnvironmentName'), parameters('additionalResourceGroupRoleAssignments')[copyIndex()].roleDefinitionId, parameters('additionalResourceGroupRoleAssignments')[copyIndex()].principalId))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "roleDefinitionId": {
                            "value": "[parameters('additionalResourceGroupRoleAssignments')[copyIndex()].roleDefinitionId]"
                          },
                          "principalId": {
                            "value": "[parameters('additionalResourceGroupRoleAssignments')[copyIndex()].principalId]"
                          },
                          "principalType": {
                            "value": "[coalesce(parameters('additionalResourceGroupRoleAssignments')[copyIndex()].principalType, 'ServicePrincipal')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.36.177.2456",
                              "templateHash": "12572928082891054435"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-10-01-preview",
                              "name": "[guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))]",
                              "properties": {
                                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', last(split(parameters('roleDefinitionId'), '/')))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ],
                          "outputs": {
                            "roleAssignment": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, last(split(parameters('roleDefinitionId'), '/')), parameters('principalId'))), '2020-10-01-preview', 'full')]"
                            }
                          }
                        }
                      }
                    }
                  },
                  "outputs": {
                    "resourceGroupId": {
                      "type": "string",
                      "value": "[resourceGroup().id]"
                    },
                    "userAssignedIdentity": {
                      "type": "object",
                      "value": "[reference('userAssignedIdentity', '2023-01-31', 'full')]"
                    },
                    "midServerIdentity": {
                      "type": "object",
                      "value": "[reference('midServerIdentity', '2023-01-31', 'full')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('midServerIdentityName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', variables('storageAccountName'), 'default', 'config')]",
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', variables('storageAccountName'), 'default', 'ServiceNowMidServers')]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
              ]
            },
            {
              "condition": "[parameters('runValidationScript')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('ValidateEnvironment-{0}', parameters('devopsEnvironmentName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploymentScriptName": {
                    "value": "[format('ValidateEnvironment-{0}', parameters('devopsEnvironmentName'))]"
                  },
                  "devopsEnvironmentName": {
                    "value": "[parameters('devopsEnvironmentName')]"
                  },
                  "userAssignedIdentityName": {
                    "value": "[variables('userAssignedIdentityName')]"
                  },
                  "inlineScript": {
                    "value": "      Resolve-SNOWMIDPrereqs\r\n      $ctx = Resolve-SNOWMIDBuildContext\r\n      $SnowConn = Resolve-SNOWMIDEnvironmentAuth\r\n      foreach($key in $Ctx.Keys) {\r\n        $DeploymentScriptOutputs[$key] = $Ctx[$key]\r\n      }\r\n      $ImageState = Resolve-SNOWMIDImageState\r\n      foreach($key in $ImageState.Keys) {\r\n        $DeploymentScriptOutputs[$key] = $ImageState[$key]\r\n      }\r\n    "
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "3833043247047108089"
                    }
                  },
                  "parameters": {
                    "devopsEnvironmentName": {
                      "type": "string",
                      "defaultValue": "unts",
                      "maxLength": 5,
                      "metadata": {
                        "description": "The name of the environment. This will be used to tag, and identify resources."
                      }
                    },
                    "deploymentScriptName": {
                      "type": "string",
                      "defaultValue": "[format('SnowMidTools-{0}', parameters('devopsEnvironmentName'))]"
                    },
                    "userAssignedIdentityName": {
                      "type": "string"
                    },
                    "inlineScript": {
                      "type": "string",
                      "defaultValue": "Resolve-SNOWMIDPrereqs\r\n$ctx = Resolve-SNOWMIDBuildContext\r\nforeach($key in $Ctx.Keys) {\r\n  $DeploymentScriptOutputs[$key] = $Ctx[$key]\r\n}\r\n$DeploymentScriptOutputs['ctxJson'] = ($ctx | ConvertTo-Json -Depth 10)\r\n"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "scriptEnvironmentVariables": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": "[resourceGroup().tags]"
                    }
                  },
                  "variables": {
                    "storageAccountName": "[format('snst{0}{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
                    "commonScriptContent": "IyMjIEJFR0lOIFBTU25vdy5NaWRUb29scy5wc20xICMjIw0KIyBQU1Nub3cuTWlkVG9vbHMucHNtMQ0KIyBTZWN0aW9uIDA6IE1vZHVsZSBNZXRhZGF0YSAtIFJlc29sdmUgRW52aXJvbm1lbnQgVmFyaWFibGVzIHRvIHNjcmlwdCB2YXJpYWJsZXMuDQoNCmlmICghKEdldC1Db21tYW5kIC1OYW1lICdXcml0ZS1QU0ZNZXNzYWdlJyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICBJbnN0YWxsLU1vZHVsZSAtTmFtZSBQU0ZyYW1ld29yayAtRm9yY2UgLUFsbG93Q2xvYmJlciAtU2NvcGUgQ3VycmVudFVzZXINCiAgICBXcml0ZS1Ib3N0ICdQU0ZyYW1ld29yayBtb2R1bGUgd2FzIG5vdCBmb3VuZC4gSW5zdGFsbGluZyBpbnRvIEN1cnJlbnRVc2VyIHNjb3BlLicNCiAgICBJbXBvcnQtTW9kdWxlIC1OYW1lIFBTRnJhbWV3b3JrIC1Gb3JjZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtU2NvcGUgR2xvYmFsDQp9DQojIFdoZW4gdXNpbmcgdGhpcyBhcyBhIE1vZHVsZSwgeW91IG11c3QgdXNlIEltcG9ydC1Nb2R1bGUgd2l0aCB0aGUgLUZvcmNlIHBhcmFtZXRlciwNCiMgdG8gZW5zdXJlIHRoZSBtb2R1bGUgaXMgcmVsb2FkZWQgaWYgY2hhbmdpbmcgYW55IG9mIHRoZSBTTl9NSURfKiBlbnZpcm9ubWVudCB2YXJpYWJsZXMuDQokRGVmYXVsdEVudiA9IEB7DQogICAgU05fTUlEX0VOVklST05NRU5UX05BTUUgID0gJ2xvY2FsJw0KICAgIFNOX01JRF9DT05URVhUICAgICAgICAgICA9ICdsb2NhbCcNCiAgICBTTl9NSURfQlVJTERfU1RSQVRFR1kgICAgPSAncG9kbWFuJw0KICAgIFNOX01JRF9JTUFHRV9OQU1FICAgICAgICA9ICdzbm93X21pZF9iYXNlJw0KICAgIFNOX01JRF9DVVNUT01fSU1BR0VfTkFNRSA9ICdzbm93X21pZF9jdXN0b20nDQp9DQpmb3JlYWNoICgka2V5IGluICREZWZhdWx0RW52LktleXMpIHsNCiAgICAkZW52VmFsdWUgPSBbRW52aXJvbm1lbnRdOjpHZXRFbnZpcm9ubWVudFZhcmlhYmxlKCRrZXksIFtTeXN0ZW0uRW52aXJvbm1lbnRWYXJpYWJsZVRhcmdldF06OlByb2Nlc3MpDQogICAgaWYgKFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRlbnZWYWx1ZSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgVmVyYm9zZSAiJGtleSBpcyBub3Qgc2V0LiBEZWZhdWx0aW5nIHRvICckKCREZWZhdWx0RW52WyRrZXldKScuIg0KICAgICAgICBTZXQtVmFyaWFibGUgLU5hbWUgJGtleSAtU2NvcGUgU2NyaXB0IC1WYWx1ZSAkRGVmYXVsdEVudlska2V5XQ0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgVmVyYm9zZSAiJGtleSBpcyBzZXQgdG8gJyRlbnZWYWx1ZScuIg0KICAgICAgICBTZXQtVmFyaWFibGUgLU5hbWUgJGtleSAtU2NvcGUgU2NyaXB0IC1WYWx1ZSAkZW52VmFsdWUNCiAgICB9DQp9DQoNCiRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUgPSAic25taWR2YXVsdC0ke1NOX01JRF9FTlZJUk9OTUVOVF9OQU1FfS0ke1NOX01JRF9DT05URVhUfSINCg0KJFNjcmlwdDpTTl9DT05ORUNUSU9OX1NFQ1JFVF9OQU1FID0gInNub3ctY29ubmVjdGlvbi0ke1NOX01JRF9FTlZJUk9OTUVOVF9OQU1FfS1qc29uIg0KDQokU2NyaXB0OkFaX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUgPSAiYXotY29ubmVjdGlvbi0ke1NOX01JRF9FTlZJUk9OTUVOVF9OQU1FfS1qc29uIg0KDQokU2NyaXB0OlBTRGVwZW5kZW5jaWVzID0gQHsNCiAgICAnY2hlcmljaGl0YS9QU1Nub3cnICAgICAgICAgICAgICAgICAgICAgPSBAew0KICAgICAgICBTb3VyY2UgICAgID0gJ0dpdEh1YlJlcG8nDQogICAgICAgIFJlcG9zaXRvcnkgPSAnY2hlcmljaGl0YS9QU1Nub3cnDQogICAgICAgIFZlcnNpb24gICAgPSAnMS40LjAnDQogICAgICAgIFRhcmdldCAgICAgPSAnQ3VycmVudFVzZXInDQogICAgICAgIFBhcmFtZXRlcnMgPSBAew0KICAgICAgICAgICAgRXh0cmFjdFBhdGggPSAnc3JjLycNCiAgICAgICAgICAgIFRhcmdldFR5cGUgID0gJ1BhcmFsbGVsJw0KICAgICAgICB9DQogICAgfQ0KICAgICdNaWNyb3NvZnQuUG93ZXJTaGVsbC5TZWNyZXRNYW5hZ2VtZW50JyA9IEB7DQogICAgICAgIFRhcmdldCA9ICdDdXJyZW50VXNlcicNCiAgICB9DQogICAgJ01pY3Jvc29mdC5Qb3dlclNoZWxsLlNlY3JldFN0b3JlJyAgICAgID0gQHsNCiAgICAgICAgVGFyZ2V0ID0gJ0N1cnJlbnRVc2VyJw0KICAgIH0NCn0NCg0KZnVuY3Rpb24gR2V0LVNOT1dNaWRUb29sc1N0YXR1cyB7DQogICAgJFN0YXR1cyA9IEB7DQogICAgICAgIFNOX01JRF9FTlZJUk9OTUVOVF9OQU1FICA9ICRTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUUNCiAgICAgICAgU05fTUlEX0NPTlRFWFQgICAgICAgICAgID0gJFNjcmlwdDpTTl9NSURfQ09OVEVYVA0KICAgICAgICBTTl9NSURfQlVJTERfU1RSQVRFR1kgICAgPSAkU2NyaXB0OlNOX01JRF9CVUlMRF9TVFJBVEVHWQ0KICAgICAgICBTTl9NSURfSU1BR0VfTkFNRSAgICAgICAgPSAkU2NyaXB0OlNOX01JRF9JTUFHRV9OQU1FDQogICAgICAgIFNOX01JRF9DVVNUT01fSU1BR0VfTkFNRSA9ICRTY3JpcHQ6U05fTUlEX0NVU1RPTV9JTUFHRV9OQU1FDQogICAgICAgIFNOX01JRF9WQVVMVF9OQU1FICAgICAgICA9ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUNCiAgICB9DQogICAgcmV0dXJuICRTdGF0dXMNCn0NCg0KIyBTZWN0aW9uIDE6IEF6dXJlL0J1aWxkIEZ1bmN0aW9ucw0KZnVuY3Rpb24gQXNzZXJ0LVNOT1dNSURBekNsaSB7DQogICAgaWYgKCEoR2V0LUNvbW1hbmQgLU5hbWUgJ2F6JyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAtTWVzc2FnZSAnQXp1cmUgQ0xJIG5vdCBmb3VuZC4gSW5zdGFsbGluZyBBenVyZSBDTEknDQogICAgICAgIFJlc29sdmUtU05PV01JREF6dXJlQ2xpIHwgT3V0LU51bGwNCiAgICAgICAgQ29ubmVjdC1TTk9XTUlEQXp1cmVGcm9tRW52aXJvbm1lbnQgfCBPdXQtTnVsbA0KICAgIH0NCn0NCg0KDQpmdW5jdGlvbiBSZXNvbHZlLVNOT1dNSURWYXVsdCB7DQogICAgc3dpdGNoICgkU2NyaXB0OlNOX01JRF9DT05URVhUKSB7DQogICAgICAgICdsb2NhbCcgew0KICAgICAgICAgICAgJFZhdWx0UGFyYW1ldGVycyA9IEB7DQogICAgICAgICAgICAgICAgVmF1bHROYW1lID0gJFNOX01JRF9WQVVMVF9OQU1FDQogICAgICAgICAgICB9DQogICAgICAgICAgICBSZXNvbHZlLVNOT1dNaWRTZWNyZXRNYW5hZ2VtZW50VmF1bHQgQFZhdWx0UGFyYW1ldGVycyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICB9DQogICAgICAgICdhenVyZScgew0KICAgICAgICAgICAgaWYgKCEkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0LktleVZhdWx0Lm5hbWUpIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1FcnJvciAiS2V5IFZhdWx0IG5vdCBmb3VuZCBmb3IgZW52aXJvbm1lbnQgJCgkZW52OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FKSINCiAgICAgICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRWYXVsdFBhcmFtZXRlcnMgPSBAew0KICAgICAgICAgICAgICAgIFZhdWx0TmFtZSAgICAgICAgICAgPSAkU05fTUlEX1ZBVUxUX05BTUUNCiAgICAgICAgICAgICAgICBBenVyZUtleVZhdWx0TmFtZSAgID0gJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dC5LZXlWYXVsdC5OYW1lDQogICAgICAgICAgICAgICAgQXp1cmVTdWJzY3JpcHRpb25JZCA9ICRTY3JpcHQ6U05NSURCdWlsZENvbnRleHQuU3Vic2NyaXB0aW9uSWQNCiAgICAgICAgICAgICAgICBVc2VBenVyZUtleVZhdWx0ICAgID0gJHRydWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFJlc29sdmUtU05PV01pZFNlY3JldE1hbmFnZW1lbnRWYXVsdCBAVmF1bHRQYXJhbWV0ZXJzIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgZGVmYXVsdCB7DQogICAgICAgICAgICBXcml0ZS1FcnJvciAiVW5rbm93biBjb250ZXh0IHR5cGU6ICRTY3JpcHQ6U05fTUlEX0NPTlRFWFQuIFVzZSAnbG9jYWwnIG9yICdhenVyZScuIg0KICAgICAgICAgICAgcmV0dXJuICRudWxsDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JRFByZXJlcXMgew0KICAgIGlmICgtbm90IChHZXQtQ29tbWFuZCAnSW5zdGFsbC1EZXBlbmRlbmN5JyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdJbnN0YWxsaW5nIFBTRGVwZW5kIG1vZHVsZScNCiAgICAgICAgSW5zdGFsbC1Nb2R1bGUgLU5hbWUgUFNEZXBlbmQgLUZvcmNlIC1BbGxvd0Nsb2JiZXIgLVNjb3BlIEN1cnJlbnRVc2VyDQogICAgfQ0KICAgIEltcG9ydC1Nb2R1bGUgLU5hbWUgUFNEZXBlbmQgLUZvcmNlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1TY29wZSBHbG9iYWwNCiAgICBHZXQtRGVwZW5kZW5jeSAtSW5wdXRPYmplY3QgJFNjcmlwdDpQU0RlcGVuZGVuY2llcyB8IEluc3RhbGwtRGVwZW5kZW5jeQ0KfQ0KDQpmdW5jdGlvbiBSZXNvbHZlLVNOT1dNSURBenVyZUNsaSB7DQogICAgaWYgKC1ub3QgKEdldC1Db21tYW5kICdheicgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAnQXp1cmUgQ0xJIG5vdCBmb3VuZC4gSW5zdGFsbGluZyBBenVyZSBDTEknDQogICAgICAgIGlmICgoR2V0LUNvbW1hbmQgLU5hbWUgYXB0IC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSkgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdJbnN0YWxsaW5nIEF6dXJlIENMSSB1c2luZyBhcHQnDQogICAgICAgICAgICAkSW5zdGFsbFJlc3VsdHMgPSAoY3VybCAtc0wgaHR0cHM6Ly9ha2EubXMvSW5zdGFsbEF6dXJlQ0xJRGViIHwgYmFzaCkNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gQ29ubmVjdC1TTk9XTUlEQXp1cmVGcm9tRW52aXJvbm1lbnQgew0KICAgIHBhcmFtIChbc3RyaW5nXSRTY29wZSA9ICdQcm9jZXNzJykNCiAgICAkQXpDbGlFeGlzdHMgPSAoR2V0LUNvbW1hbmQgJ2F6JyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkNCiAgICAkT3V0ID0gW29yZGVyZWRdQHsgDQogICAgICAgIFRlbmFudElkID0gJGVudjpBWlVSRV9URU5BTlRfSUQ7IEVudmlyb25tZW50ID0gJGVudjpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRQ0KICAgICAgICBBekNvbnRleHQgPSAoR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkNCiAgICAgICAgQ2xpQ29udGV4dCA9IGlmICgkQXpDbGlFeGlzdHMpIHsgKGF6IGFjY291bnQgc2hvdyAtbyBqc29uIDI+MSB8IENvbnZlcnRGcm9tLUpzb24pIH0gZWxzZSB7ICRudWxsIH0NCiAgICB9DQogICAgaWYgKCRlbnY6SURFTlRJVFlfSEVBREVSKSB7DQogICAgICAgIGlmICgkZW52OkFaVVJFX0NMSUVOVF9JRCAtYW5kICRlbnY6QVpVUkVfQ0xJRU5UX1NFQ1JFVCAtYW5kICRlbnY6QVpVUkVfVEVOQU5UX0lEKSB7IA0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdJZ25vcmluZyBNU0kuIFVzaW5nIGVudmlyb25tZW50IHZhcmlhYmxlcyBpbnN0ZWFkJyANCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIGlmICgoJEF6Q2xpRXhpc3RzKSAtYW5kICEoJE91dC5DbGlDb250ZXh0KSkgew0KICAgICAgICAgICAgICAgICRPdXQuQ2xpQ29udGV4dCA9IGF6IGxvZ2luIC0taWRlbnRpdHkgfCBDb252ZXJ0RnJvbS1Kc29uIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICAgICAgICAgICRPdXQuQ2xpVmVyc2lvbiA9IGF6IHZlcnNpb24gfCBDb252ZXJ0RnJvbS1Kc29uDQogICAgICAgICAgICB9DQogICAgICAgICAgICAkT3V0LkF6Q29udGV4dCA9IENvbm5lY3QtQXpBY2NvdW50IC1JZGVudGl0eSAtU2NvcGUgJFNjb3BlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICAkU2NyaXB0OlNub3dBekNvbnRleHQgPSAkT3V0DQogICAgICAgICAgICByZXR1cm4gJE91dA0KICAgICAgICB9DQogICAgfQ0KICAgIGlmICgtbm90ICgkZW52OkFaVVJFX0NMSUVOVF9JRCAtYW5kICRlbnY6QVpVUkVfQ0xJRU5UX1NFQ1JFVCAtYW5kICRlbnY6QVpVUkVfVEVOQU5UX0lEKSkgew0KICAgICAgICBpZiAoISRPdXQuQXpDb250ZXh0IC1hbmQgKCRBekNsaUV4aXN0cyAtYW5kICEoJE91dC5DbGlDb250ZXh0KSkpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIEF6dXJlIGNvbnRleHQgZm91bmQuIEFaVVJFX0NMSUVOVF9JRCwgQVpVUkVfQ0xJRU5UX1NFQ1JFVCwgYW5kIEFaVVJFX1RFTkFOVF9JRCBtdXN0IGJlIHNldCcNCiAgICAgICAgICAgIHJldHVybiAkbnVsbA0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJVc2luZyBFeGlzdGluZyBBenVyZSBjb250ZXh0OiAkKCRPdXQuQXpDb250ZXh0Lk5hbWUpYG4gQ0xJIENvbnRleHQ6ICQoJE91dC5DbGlDb250ZXh0IHwgQ29udmVydFRvLUpzb24gLURlcHRoIDUpIg0KICAgICAgICAgICAgcmV0dXJuICRPdXQNCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoJEF6Q2xpRXhpc3RzIC1hbmQgISgkT3V0LkNsaUNvbnRleHQpKSB7DQogICAgICAgICRPdXQuQ2xpQ29udGV4dCA9IGF6IGxvZ2luIC0tc2VydmljZS1wcmluY2lwYWwgLS11c2VybmFtZSAkZW52OkFaVVJFX0NMSUVOVF9JRCAtLXBhc3N3b3JkICRlbnY6QVpVUkVfQ0xJRU5UX1NFQ1JFVCAtLXRlbmFudCAkZW52OkFaVVJFX1RFTkFOVF9JRCB8IENvbnZlcnRGcm9tLUpzb24gfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgICAgICRPdXQuQ2xpVmVyc2lvbiA9IGF6IHZlcnNpb24gfCBDb252ZXJ0RnJvbS1Kc29uDQogICAgfQ0KICAgICRMb2dpblBhcmFtcyA9IEB7DQogICAgICAgIFRlbmFudElkID0gJGVudjpBWlVSRV9URU5BTlRfSUQ7IFNlcnZpY2VQcmluY2lwYWwgPSAkdHJ1ZQ0KICAgICAgICBDcmVkZW50aWFsID0gKE5ldy1PYmplY3QgUFNDcmVkZW50aWFsICRlbnY6QVpVUkVfQ0xJRU5UX0lELCAoJGVudjpBWlVSRV9DTElFTlRfU0VDUkVUIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQgLUZvcmNlKSkNCiAgICAgICAgU2NvcGUgPSAkU2NvcGUNCiAgICB9DQogICAgaWYgKCRlbnY6QVpVUkVfU1VCU0NSSVBUSU9OX0lEKSB7ICRMb2dpblBhcmFtcy5TdWJzY3JpcHRpb24gPSAkZW52OkFaVVJFX1NVQlNDUklQVElPTl9JRCB9DQogICAgDQogICAgJE91dC5BekNvbnRleHQgPSBDb25uZWN0LUF6QWNjb3VudCBATG9naW5QYXJhbXMNCiAgICAkU2NyaXB0OlNub3dBekNvbnRleHQgPSAkT3V0DQogICAgcmV0dXJuICRPdXQNCn0NCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREN1c3RvbVJlc291cmNlcyB7DQogICAgcGFyYW0gKA0KICAgICAgICBbc3RyaW5nXSRTdWJzY3JpcHRpb25JZCwNCiAgICAgICAgW3N0cmluZ10kUmVzb3VyY2VHcm91cE5hbWUgPSAkZW52OkFaVVJFX1JFU09VUkNFX0dST1VQX05BTUUNCiAgICApDQogICAgJGN0eCA9IEdldC1BekNvbnRleHQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoLW5vdCAkY3R4KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIEF6dXJlIGNvbnRleHQgZm91bmQuIFBsZWFzZSBsb2dpbiB0byBBenVyZScNCiAgICAgICAgcmV0dXJuICRudWxsDQogICAgfQ0KICAgICRTdWJzY3JpcHRpb25JZCA9IGlmICgkU3Vic2NyaXB0aW9uSWQpIHsgJFN1YnNjcmlwdGlvbklkIH0gZWxzZSB7ICRjdHguU3Vic2NyaXB0aW9uLklkIH0NCiAgICBpZiAoLW5vdCAkU3Vic2NyaXB0aW9uSWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAnTm8gU3Vic2NyaXB0aW9uIElEIGZvdW5kLiBQbGVhc2UgbG9naW4gdG8gQXp1cmUnDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCg0KICAgICRSZXNvdXJjZVF1ZXJ5ID0gQCINCiAgICAgICAgcmVzb3VyY2VzIHwgd2hlcmUgdGFnc1snU25vd0Vudmlyb25tZW50J10gPT0gJyR7U2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FfScNCiAgICAgICAgfCBwcm9qZWN0IHJlc291cmNlSWQ9aWQsIG5hbWUsIHR5cGUsIHJlc291cmNlR3JvdXAsIHRhZ3MsIHByb3BlcnRpZXMsIHN1YnNjcmlwdGlvbklkLCBsb2NhdGlvbg0KICAgICAgICB8IG9yZGVyIGJ5IHR5cGUgYXNjLCBuYW1lIGFzYw0KIkANCg0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgIlF1ZXJ5aW5nIEF6dXJlIFJlc291cmNlIEdyYXBoIHdpdGggcXVlcnk6IGBuJFJlc291cmNlUXVlcnkiDQogICAgJHJlc291cmNlcyA9IFNlYXJjaC1BekdyYXBoIC1RdWVyeSAkUmVzb3VyY2VRdWVyeQ0KDQogICAgaWYgKCRyZXNvdXJjZXMuQ291bnQgLWVxIDApIHsNCiAgICAgICAgV3JpdGUtRXJyb3IgIk5vIHJlc291cmNlcyBmb3VuZCBmb3IgZW52aXJvbm1lbnQgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQoNCiAgICAkT3V0cHV0cyA9IFtvcmRlcmVkXUB7DQogICAgICAgIFN1YnNjcmlwdGlvbklkICA9ICRTdWJzY3JpcHRpb25JZA0KICAgICAgICBSZXNvdXJjZUdyb3VwICAgPSAkUmVzb3VyY2VHcm91cE5hbWUNCiAgICAgICAgRW52aXJvbm1lbnROYW1lID0gJFNjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRQ0KICAgICAgICBTdG9yYWdlQWNjb3VudCAgPSAkcmVzb3VyY2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8udHlwZSAtZXEgJ21pY3Jvc29mdC5zdG9yYWdlL3N0b3JhZ2VhY2NvdW50cycgfSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDEgICANCiAgICAgICAgDQogICAgfQ0KDQogICAgaWYgKC1ub3QgJE91dHB1dHMuU3RvcmFnZUFjY291bnQpIHsNCiAgICAgICAgV3JpdGUtRXJyb3IgIk5vIFN0b3JhZ2UgQWNjb3VudCBmb3VuZCBmb3IgZW52aXJvbm1lbnQgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9LiBIYXMgdGhpcyBlbnZpcm9ubWVudCBiZWVuIHByb3Zpc2lvbmVkPyIgLUVycm9yQWN0aW9uIFN0b3ANCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgICRPdXRwdXRzLlN1YnNjcmlwdGlvbklkID0gJE91dHB1dHMuU3RvcmFnZUFjY291bnQuc3Vic2NyaXB0aW9uSWQNCiAgICAgICAgJE91dHB1dHMuUmVzb3VyY2VHcm91cCA9ICRPdXRwdXRzLlN0b3JhZ2VBY2NvdW50LnJlc291cmNlR3JvdXANCiAgICAgICAgJENvbnRhaW5lclJlZ2lzdHJ5SWQgPSAkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC50YWdzLlNub3dDb250YWluZXJSZWdpc3RyeUlkDQogICAgICAgICRPdXRwdXRzICs9IEB7DQogICAgICAgICAgICBLZXlWYXVsdCAgICAgICAgICA9ICRyZXNvdXJjZXMgfCBXaGVyZS1PYmplY3QgeyAkXy50eXBlIC1lcSAnbWljcm9zb2Z0LmtleXZhdWx0L3ZhdWx0cycgLWFuZCAkXy5zdWJzY3JpcHRpb25JZCAtZXEgJE91dHB1dHMuU3Vic2NyaXB0aW9uSWQgfSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgICAgIE1hbmFnZWRJZGVudGl0aWVzID0gJHJlc291cmNlcyB8IFdoZXJlLU9iamVjdCB7ICRfLnR5cGUgLWVxICdtaWNyb3NvZnQubWFuYWdlZGlkZW50aXR5L3VzZXJhc3NpZ25lZGlkZW50aXRpZXMnIC1hbmQgJF8uc3Vic2NyaXB0aW9uSWQgLWVxICRPdXRwdXRzLlN1YnNjcmlwdGlvbklkICB9DQogICAgICAgICAgICBEZXZvcHNJZGVudGl0eSAgICA9ICRyZXNvdXJjZXMgfCBXaGVyZS1PYmplY3QgeyAkXy50eXBlIC1lcSAnbWljcm9zb2Z0Lm1hbmFnZWRpZGVudGl0eS91c2VyYXNzaWduZWRpZGVudGl0aWVzJyAtYW5kICRfLm5hbWUgLWxpa2UgIipkZXZvcHMtJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9KiIgLWFuZCAkXy5zdWJzY3JpcHRpb25JZCAtZXEgJE91dHB1dHMuU3Vic2NyaXB0aW9uSWQgfSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgICAgIE1pZElkZW50aXR5ICAgICAgID0gJHJlc291cmNlcyB8IFdoZXJlLU9iamVjdCB7ICRfLnR5cGUgLWVxICdtaWNyb3NvZnQubWFuYWdlZGlkZW50aXR5L3VzZXJhc3NpZ25lZGlkZW50aXRpZXMnIC1hbmQgJF8ubmFtZSAtbGlrZSAiKm1pZHNlcnZlci0ke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0qIiAtYW5kICRfLnN1YnNjcmlwdGlvbklkIC1lcSAkT3V0cHV0cy5TdWJzY3JpcHRpb25JZCB9IHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICB9DQogICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5ID0gaWYgKCRDb250YWluZXJSZWdpc3RyeUlkKSB7DQogICAgICAgICAgICBHZXQtQXpSZXNvdXJjZSAtUmVzb3VyY2VJZCAkQ29udGFpbmVyUmVnaXN0cnlJZCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJCgkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC5uYW1lKSINCiAgICAgICAgfQ0KICAgICAgICAkT3V0cHV0cy5Db250YWluZXJTdWJuZXQgPSBpZiAoJE91dHB1dHMuU3RvcmFnZUFjY291bnQudGFncy5Tbm93Q29udGFpbmVyU3VibmV0SWQpIHsNCiAgICAgICAgICAgIEdldC1BelJlc291cmNlIC1SZXNvdXJjZUlkICRPdXRwdXRzLlN0b3JhZ2VBY2NvdW50LnRhZ3MuU25vd0NvbnRhaW5lclN1Ym5ldElkIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiTm8gQ29udGFpbmVyIFN1Ym5ldCBmb3VuZCBmb3IgJCgkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC5uYW1lKSINCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoLW5vdCAkT3V0cHV0cy5LZXlWYXVsdCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBFcnJvciAiTm8gS2V5IFZhdWx0IGZvdW5kIGZvciBlbnZpcm9ubWVudCAke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0iIC1FcnJvckFjdGlvbiBTdG9wDQogICAgfQ0KICAgIGlmICgtbm90ICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgZW52aXJvbm1lbnQgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9IiAtRXJyb3JBY3Rpb24gU3RvcA0KICAgIH0NCiAgICAkT3V0cHV0cy5SYXcgPSAkcmVzb3VyY2VzDQogICAgJE91dHB1dHMNCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTUlEQnVpbGRDb250ZXh0IHsNCiAgICBwYXJhbSAoDQogICAgICAgIFtzdHJpbmddJFN1YnNjcmlwdGlvbklkLA0KICAgICAgICBbc3RyaW5nXSRSZXNvdXJjZUdyb3VwTmFtZSA9ICRlbnY6QVpVUkVfUkVTT1VSQ0VfR1JPVVBfTkFNRSwNCiAgICAgICAgW3N3aXRjaF0kUmVsb2FkQ29udGV4dA0KICAgICkNCiAgICBpZiAoLW5vdCAoR2V0LUNvbW1hbmQgR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgSW5zdGFsbC1Nb2R1bGUgLU5hbWUgQXogLUZvcmNlIC1BbGxvd0Nsb2JiZXIgLVNjb3BlIEN1cnJlbnRVc2VyDQogICAgfQ0KICAgIGlmICgkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0IC1hbmQgLW5vdCAkUmVsb2FkQ29udGV4dC5Jc1ByZXNlbnQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAiVXNpbmcgY2FjaGVkIGJ1aWxkIGNvbnRleHQgZm9yIGVudmlyb25tZW50ICQoJFNjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRSkgZnJvbSBgJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dCIgLUxldmVsIFZlcmJvc2UNCiAgICAgICAgcmV0dXJuICRTY3JpcHQ6U05NSURCdWlsZENvbnRleHQNCiAgICB9DQogICAgJE91dHB1dHMgPSBbb3JkZXJlZF1Aew0KICAgICAgICBFbnZpcm9ubWVudE5hbWUgPSAkU2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FDQogICAgICAgIFN1YnNjcmlwdGlvbklkICA9ICRTdWJzY3JpcHRpb25JZA0KICAgICAgICBCdWlsZFN0cmF0ZWd5ICAgPSAkU2NyaXB0OlNOX01JRF9CVUlMRF9TVFJBVEVHWSANCiAgICAgICAgSW1hZ2VOYW1lICAgICAgID0gJFNjcmlwdDpTTl9NSURfSU1BR0VfTkFNRQ0KICAgICAgICBDdXN0b21JbWFnZU5hbWUgPSAkU2NyaXB0OlNOX01JRF9DVVNUT01fSU1BR0VfTkFNRQ0KICAgICAgICBXb3JrRGlyICAgICAgICAgPSAoJGVudjpBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWSA/PyAnL3RtcCcpDQogICAgfQ0KICAgIHN3aXRjaCAoJFNjcmlwdDpTTl9NSURfQ09OVEVYVCkgew0KICAgICAgICAnbG9jYWwnIHsNCiAgICAgICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5ID0gQHsNCiAgICAgICAgICAgICAgICBuYW1lICAgICAgICAgICAgICA9ICdsb2NhbCcNCiAgICAgICAgICAgICAgICByZXNvdXJjZUdyb3VwTmFtZSA9ICdsb2NhbCcNCiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25JZCAgICA9ICdsb2NhbCcNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclN1Ym5ldCA9IEB7DQogICAgICAgICAgICAgICAgbmFtZSAgICAgICAgICAgICAgPSAnbG9jYWwnDQogICAgICAgICAgICAgICAgcmVzb3VyY2VHcm91cE5hbWUgPSAnbG9jYWwnDQogICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uSWQgICAgPSAnbG9jYWwnDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgJ2F6dXJlJyB7DQogICAgICAgICAgICAkY3R4ID0gR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgaWYgKC1ub3QgJGN0eCkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIEF6dXJlIGNvbnRleHQgZm91bmQuIFBsZWFzZSBsb2dpbiB0byBBenVyZScNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRTdWJzY3JpcHRpb25JZCA9IGlmICgkU3Vic2NyaXB0aW9uSWQpIHsgJFN1YnNjcmlwdGlvbklkIH0gZWxzZSB7ICRjdHguU3Vic2NyaXB0aW9uLklkIH0NCiAgICAgICAgICAgIGlmICgtbm90ICRTdWJzY3JpcHRpb25JZCkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIFN1YnNjcmlwdGlvbiBJRCBmb3VuZC4gUGxlYXNlIGxvZ2luIHRvIEF6dXJlJw0KICAgICAgICAgICAgICAgIHJldHVybiAkbnVsbA0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAkQ29udGV4dFJlc291cmNlcyA9IFJlc29sdmUtU05PV01JREN1c3RvbVJlc291cmNlcyAtU3Vic2NyaXB0aW9uSWQgJFN1YnNjcmlwdGlvbklkIC1SZXNvdXJjZUdyb3VwTmFtZSAkUmVzb3VyY2VHcm91cE5hbWUNCiAgICAgICAgICAgICAgICBmb3JlYWNoICgkayBpbiAkQ29udGV4dFJlc291cmNlcy5LZXlzKSB7DQogICAgICAgICAgICAgICAgICAgICRPdXRwdXRzWyRrXSA9ICRDb250ZXh0UmVzb3VyY2VzWyRrXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJFcnJvciBGZXRjaGluZyBBWiBSZXNvdXJjZXMke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0uIEVycm9yOiAkXyINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBkZWZhdWx0IHsNCiAgICAgICAgICAgIFdyaXRlLUVycm9yICJVbmtub3duIGNvbnRleHQgdHlwZTogJFNjcmlwdDpTTl9NSURfQ09OVEVYVC4gVXNlICdsb2NhbCcgb3IgJ2F6dXJlJy4iDQogICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgfQ0KICAgIH0NCiAgICAkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0ID0gJE91dHB1dHMNCiAgICAkT3V0cHV0cy5WYXVsdCA9IFJlc29sdmUtU05PV01JRFZhdWx0IC1Db250ZXh0VHlwZSAkU2NyaXB0OlNOX01JRF9DT05URVhUDQogICAgJE91dHB1dHMNCn0NCg0KZnVuY3Rpb24gR2V0LVNOT1dNSURQZnhDZXJ0aWZpY2F0ZUFzUGVtIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJENlcnRpZmljYXRlTmFtZQ0KICAgICkNCiAgICAkS2V5VmF1bHROYW1lID0gJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dC5LZXlWYXVsdC5OYW1lDQogICAgaWYgKC1ub3QgJEtleVZhdWx0TmFtZSkgew0KICAgICAgICBXcml0ZS1FcnJvciAnS2V5VmF1bHROYW1lIGlzIHJlcXVpcmVkJw0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgaWYgKCRDZXJ0ID0gR2V0LUF6S2V5VmF1bHRDZXJ0aWZpY2F0ZSAtVmF1bHROYW1lICRLZXlWYXVsdE5hbWUgLU5hbWUgJENlcnRpZmljYXRlTmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkgew0KICAgICAgICAkTGVhZkNvbGxlY3Rpb24gPSBOZXctT2JqZWN0IFN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuWDUwOUNlcnRpZmljYXRlcy5YNTA5Q2VydGlmaWNhdGUyQ29sbGVjdGlvbg0KICAgICAgICAkQ2VydEJ5dGVzID0gW0NvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKChHZXQtQXpLZXlWYXVsdFNlY3JldCAtU2VjcmV0SWQgJENlcnQuU2VjcmV0SWQgLUFzUGxhaW5UZXh0KSkNCiAgICAgICAgIyBNdXN0IHVzZSBFeHBvcnRhYmxlIGZsYWcgdG8gZXhwb3J0IHRoZSBwcml2YXRlIGtleSBvbiBXaW5kb3dzL01hY09TDQogICAgICAgICRQZnggPSBbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5YNTA5Q2VydGlmaWNhdGVzLlg1MDlDZXJ0aWZpY2F0ZTJdOjpuZXcoJENlcnRCeXRlcywgJG51bGwsIFtTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5Llg1MDlDZXJ0aWZpY2F0ZXMuWDUwOUtleVN0b3JhZ2VGbGFnc106OkV4cG9ydGFibGUpDQogICAgICAgICRMZWFmQ29sbGVjdGlvbi5BZGQoJFBmeCkgfCBPdXQtTnVsbA0KICAgICAgICByZXR1cm4gQCgkTGVhZkNvbGxlY3Rpb24uRXhwb3J0Q2VydGlmaWNhdGVQZW1zKCksICRMZWFmQ29sbGVjdGlvblswXS5Qcml2YXRlS2V5LkV4cG9ydFBrY3M4UHJpdmF0ZUtleVBlbSgpKSAtam9pbiAiYG4iDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDZXJ0aWZpY2F0ZSAkQ2VydGlmaWNhdGVOYW1lIG5vdCBmb3VuZCBpbiBLZXkgVmF1bHQgJEtleVZhdWx0TmFtZSINCiAgICAgICAgJG51bGwNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREFjckltYWdlU3RhdGUgew0KICAgICRCdWlsZENvbnRleHQgPSBSZXNvbHZlLVNOT1dNSURCdWlsZENvbnRleHQNCiAgICBpZiAoLW5vdCAkQnVpbGRDb250ZXh0LkNvbnRhaW5lclJlZ2lzdHJ5LlJlc291cmNlR3JvdXBOYW1lKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJENvbnRhaW5lclJlZ2lzdHJ5ID0gJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeQ0KICAgICRBY3IgPSBHZXQtQXpDb250YWluZXJSZWdpc3RyeSAtUmVzb3VyY2VHcm91cE5hbWUgJENvbnRhaW5lclJlZ2lzdHJ5LlJlc291cmNlR3JvdXBOYW1lIC1OYW1lICRDb250YWluZXJSZWdpc3RyeS5uYW1lIC1TdWJzY3JpcHRpb25JZCAkQ29udGFpbmVyUmVnaXN0cnkuc3Vic2NyaXB0aW9uSWQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoLW5vdCAkQWNyKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJEltYWdlcyA9IEdldC1BekNvbnRhaW5lclJlZ2lzdHJ5UmVwb3NpdG9yeSAtUmVnaXN0cnlOYW1lICRDb250YWluZXJSZWdpc3RyeS5uYW1lDQogICAgJEltYWdlcyB8IEZvckVhY2gtT2JqZWN0IHsgR2V0LUF6Q29udGFpbmVyUmVnaXN0cnlUYWcgLVJlZ2lzdHJ5TmFtZSAkQ29udGFpbmVyUmVnaXN0cnkubmFtZSAtUmVwb3NpdG9yeU5hbWUgJF8gfSBgDQogICAgfCBGb3JFYWNoLU9iamVjdCB7IA0KICAgICAgICAkaXRzID0gQHsNCiAgICAgICAgICAgIE5hbWUgICAgID0gJF8uSW1hZ2VOYW1lDQogICAgICAgICAgICBUYWdzICAgICA9IFtTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5MaXN0W2hhc2h0YWJsZV1dOjpuZXcoKQ0KICAgICAgICAgICAgUmVnaXN0cnkgPSAkXy5SZWdpc3RyeQ0KICAgICAgICB9DQogICAgICAgIGZvcmVhY2ggKCR0IGluICRfLlRhZ3MpIHsNCiAgICAgICAgICAgICRpdHMuVGFncy5BZGQoQHtOYW1lID0gJHQuTmFtZTsgRGlnZXN0ID0gJHQuRGlnZXN0IH0pDQogICAgICAgIH0NCiAgICAgICAgJGl0cw0KICAgIH0NCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTUlESW1hZ2VTdGF0ZSB7DQogICAgJEJ1aWxkQ29udGV4dCA9IFJlc29sdmUtU05PV01JREJ1aWxkQ29udGV4dA0KICAgICRCdWlsZFN0cmF0ZWd5ID0gJEJ1aWxkQ29udGV4dC5CdWlsZFN0cmF0ZWd5DQogICAgJGltYWdlcyA9IHN3aXRjaCAoJEJ1aWxkU3RyYXRlZ3kpIHsNCiAgICAgICAgJ2Fjcicgew0KICAgICAgICAgICAgJEltYWdlUmVwbyA9ICRCdWlsZENvbnRleHQuQ29udGFpbmVyUmVnaXN0cnkucHJvcGVydGllcy5sb2dpblNlcnZlcg0KICAgICAgICAgICAgUmVzb2x2ZS1TTk9XTUlEQWNySW1hZ2VTdGF0ZSAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQNCiAgICAgICAgfQ0KICAgICAgICAncG9kbWFuJyB7DQogICAgICAgICAgICAkSW1hZ2VSZXBvID0gJ2xvY2FsaG9zdCcNCiAgICAgICAgICAgIEdldC1Eb2NrZXJQb2RtYW5JbWFnZVN0YXRlIC1CdWlsZENvbnRleHQgJEJ1aWxkQ29udGV4dA0KICAgICAgICB9DQogICAgfQ0KICAgICRtaWRWZXJzaW9uID0gR2V0LVNOT1dNaWRWZXJzaW9uDQogICAgJEJ1aWxkQ29udGV4dC5JbWFnZVN0YXRlID0gQHsNCiAgICAgICAgSW1hZ2VzICAgICAgICAgICAgICAgICAgICA9ICRpbWFnZXMNCiAgICAgICAgTWlkVmVyc2lvbiAgICAgICAgICAgICAgICA9ICRtaWRWZXJzaW9uDQogICAgICAgIE1pZEltYWdlRmFjdHMgICAgICAgICAgICAgPSAoR2V0LVNOT1dNSUREb3dubG9hZEZhY3RzIC1CdWlsZFRhZyAkbWlkVmVyc2lvbikNCiAgICAgICAgRG9ja2VyQ29udGV4dCAgICAgICAgICAgICA9IChKb2luLVBhdGggJEJ1aWxkQ29udGV4dC5Xb3JrRGlyICRtaWRWZXJzaW9uKQ0KICAgICAgICBCYXNlSW1hZ2VVcmkgICAgICAgICAgICAgID0gIiR7SW1hZ2VSZXBvfS8kKCRCdWlsZENvbnRleHQuSW1hZ2VOYW1lKTokKCRtaWRWZXJzaW9uKSINCiAgICAgICAgQ3VzdG9tSW1hZ2VVcmkgICAgICAgICAgICA9ICIke0ltYWdlUmVwb30vJCgkQnVpbGRDb250ZXh0LkN1c3RvbUltYWdlTmFtZSk6JCgkbWlkVmVyc2lvbikiDQogICAgICAgIEJhc2VJbWFnZUVudmlyb25tZW50VXJpICAgPSAiJHtJbWFnZVJlcG99LyQoJEJ1aWxkQ29udGV4dC5JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIg0KICAgICAgICBDdXN0b21JbWFnZUVudmlyb25tZW50VXJpID0gIiR7SW1hZ2VSZXBvfS8kKCRCdWlsZENvbnRleHQuQ3VzdG9tSW1hZ2VOYW1lKTokKCRCdWlsZENvbnRleHQuRW52aXJvbm1lbnROYW1lKSINCiAgICAgICAgQmFzZUltYWdlICAgICAgICAgICAgICAgICA9ICgkaW1hZ2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJEJ1aWxkQ29udGV4dC5JbWFnZU5hbWUgfSkNCiAgICAgICAgQ3VzdG9tSW1hZ2UgICAgICAgICAgICAgICA9ICgkaW1hZ2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUgfSkNCiAgICB9DQogICAgJEJ1aWxkQ29udGV4dC5JbWFnZVN0YXRlDQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTWlkVmVyc2lvbiB7DQogICAgKEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3Byb3BlcnRpZXMnIC1RdWVyeSAnbmFtZT1taWQudmVyc2lvbicgLUZpZWxkcyAndmFsdWUnKSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5IHZhbHVlDQp9DQoNCmZ1bmN0aW9uIEJ1aWxkLVNOT1dNSURJbWFnZUNvbW1vbiB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJFN0cmF0ZWd5LA0KICAgICAgICBbc3RyaW5nXSRJbWFnZU5hbWUsDQogICAgICAgIFtzdHJpbmddJEltYWdlVGFnLA0KICAgICAgICBbc3RyaW5nW11dJEltYWdlQWRkaXRpb25hbFRhZ3MgPSBAKCksDQogICAgICAgIFtoYXNodGFibGVdJEJ1aWxkQ29udGV4dCwNCiAgICAgICAgW3N0cmluZ10kRG9ja2VyQ29udGV4dCwNCiAgICAgICAgW3N0cmluZ10kRG9ja2VyRmlsZSwNCiAgICAgICAgW3N0cmluZ10kUG9kbWFuSXNvbGF0aW9uID0gJ2Nocm9vdCcNCiAgICApDQogICAgc3dpdGNoICgkU3RyYXRlZ3kpIHsNCiAgICAgICAgJ2Fjcicgew0KICAgICAgICAgICAgQXNzZXJ0LVNOT1dNSURBekNsaQ0KICAgICAgICAgICAgJGRvY2tlckZpbGUgPSAoSm9pbi1QYXRoICREb2NrZXJDb250ZXh0ICREb2NrZXJGaWxlKQ0KICAgICAgICAgICAgJGJ1aWxkQ29tbWFuZCA9ICdheicNCiAgICAgICAgICAgICRidWlsZFBhcmFtcyA9IEAoDQogICAgICAgICAgICAgICAgJ2FjcicsICdidWlsZCcsICctLXJlZ2lzdHJ5JywgJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeS5uYW1lLA0KICAgICAgICAgICAgICAgICctLWltYWdlJywgIiQoJEltYWdlTmFtZSk6JEltYWdlVGFnIiwgJy0tc3Vic2NyaXB0aW9uJywgJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeS5zdWJzY3JpcHRpb25JZCwNCiAgICAgICAgICAgICAgICAnLS1maWxlJywgJGRvY2tlckZpbGUsICREb2NrZXJDb250ZXh0DQogICAgICAgICAgICApDQogICAgICAgIH0NCiAgICAgICAgJ3BvZG1hbicgew0KICAgICAgICAgICAgJGJ1aWxkQ29tbWFuZCA9ICdwb2RtYW4nDQogICAgICAgICAgICAkYnVpbGRQYXJhbXMgPSBAKA0KICAgICAgICAgICAgICAgICdidWlsZCcsICctLWZvcm1hdCcsICdkb2NrZXInLCAiLS1pc29sYXRpb249JHtQb2RtYW5Jc29sYXRpb259IiwgJy0tdGFnJywgIiR7SW1hZ2VOYW1lfToke0ltYWdlVGFnfSIsDQogICAgICAgICAgICAgICAgJy1mJywgJERvY2tlckZpbGUsICREb2NrZXJDb250ZXh0DQogICAgICAgICAgICApDQogICAgICAgIH0NCiAgICAgICAgZGVmYXVsdCB7DQogICAgICAgICAgICB0aHJvdyAiVW5rbm93biBidWlsZCBzdHJhdGVneTogJFN0cmF0ZWd5Ig0KICAgICAgICB9DQogICAgfQ0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiRXhlY3V0aW5nICRidWlsZENvbW1hbmQgJCgkYnVpbGRQYXJhbXMgLWpvaW4gJyAnKSINCiAgICAoJiAkYnVpbGRDb21tYW5kIEBidWlsZFBhcmFtcyB8IFRlZS1PYmplY3QgLVZhcmlhYmxlIFJlc3VsdCB8IFdyaXRlLVZlcmJvc2UgKSANCiAgICBpZiAoJFJlc3VsdCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkltYWdlICQoJEltYWdlTmFtZSk6JEltYWdlVGFnIGJ1aWx0IHN1Y2Nlc3NmdWxseSINCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIFdyaXRlLUVycm9yICJGYWlsZWQgdG8gYnVpbGQgaW1hZ2UgJCgkSW1hZ2VOYW1lKTokSW1hZ2VUYWciDQogICAgfQ0KICAgICRSZXN1bHQNCn0NCg0KZnVuY3Rpb24gRXhwYW5kLVNOT1dNSURBcmNoaXZlIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW3N0cmluZ10kUGF0aCwNCiAgICAgICAgW3N0cmluZ10kT3V0cHV0UGF0aA0KICAgICkNCiAgICAkRXhwYW5kQ21kID0gR2V0LUNvbW1hbmQgLU5hbWUgJ0V4cGFuZC1BcmNoaXZlJyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgIGlmICghJEV4cGFuZENtZCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJFeHBhbmQtQXJjaGl2ZSBub3QgZm91bmQuIFVzaW5nIHVuemlwIGluc3RlYWQuIg0KICAgICAgICBhcHQgdXBkYXRlIC15ICYmIGFwdCBpbnN0YWxsIHVuemlwIC15IHwgV3JpdGUtVmVyYm9zZQ0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgaWYgKCRFeHBhbmRDbWQuUGFyYW1ldGVycy5PdXRwdXRQYXRoKSB7DQogICAgICAgICAgICAjIFBTQ1ggbW9kdWxlDQogICAgICAgICAgICBFeHBhbmQtQXJjaGl2ZSAtUGF0aCAkUGF0aCAtT3V0cHV0UGF0aCAkT3V0cHV0UGF0aCAtRm9yY2UNCiAgICAgICAgfQ0KICAgICAgICBlbHNlaWYgKCRFeHBhbmRDbWQuUGFyYW1ldGVycy5EZXN0aW5hdGlvblBhdGgpIHsNCiAgICAgICAgICAgICMgUG93ZXJTaGVsbCA1LjENCiAgICAgICAgICAgIEV4cGFuZC1BcmNoaXZlIC1QYXRoICRQYXRoIC1EZXN0aW5hdGlvblBhdGggJE91dHB1dFBhdGggLUZvcmNlDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEJ1aWxkLVNOT1dNSURTTk9XTWlkSW1hZ2Ugew0KICAgIHBhcmFtKA0KICAgICAgICBbc3dpdGNoXSRGb3JjZUJ1aWxkQmFzZSwNCiAgICAgICAgW3N3aXRjaF0kRm9yY2VCdWlsZEN1c3RvbQ0KICAgICkNCiAgICAkQnVpbGRDb250ZXh0ID0gUmVzb2x2ZS1TTk9XTUlEQnVpbGRDb250ZXh0DQogICAgJEltYWdlU3RhdGUgPSBSZXNvbHZlLVNOT1dNSURJbWFnZVN0YXRlIC1CdWlsZENvbnRleHQgJEJ1aWxkQ29udGV4dA0KICAgIGlmKCRlbnY6U05fTUlEX0ZPUkNFX0JVSUxEX0JBU0UgLWVxICd0cnVlJykgew0KICAgICAgICAkRm9yY2VCdWlsZEJhc2UgPSAkdHJ1ZQ0KICAgIH0NCiAgICBpZigkZW52OlNOX01JRF9GT1JDRV9CVUlMRF9DVVNUT00gLWVxICd0cnVlJykgew0KICAgICAgICAkRm9yY2VCdWlsZEN1c3RvbSA9ICR0cnVlDQogICAgfQ0KICAgIGlmICgkRm9yY2VCdWlsZEJhc2UgLW9yICgtbm90ICRJbWFnZVN0YXRlLkJhc2VJbWFnZSAtb3IgKC1ub3QgKCRJbWFnZVN0YXRlLkJhc2VJbWFnZS5UYWdzLk5hbWUuQ29udGFpbnMoJEltYWdlU3RhdGUuTWlkVmVyc2lvbikpKSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJCdWlsZGluZyAkKCRCdWlsZENvbnRleHQuSW1hZ2VOYW1lKSBpbWFnZSB3aXRoIHRhZyAkKCRJbWFnZVN0YXRlLk1pZFZlcnNpb24pIg0KICAgICAgICBpZiAoLW5vdCAoVGVzdC1QYXRoICRJbWFnZVN0YXRlLkRvY2tlckNvbnRleHQpKSB7DQogICAgICAgICAgICBOZXctSXRlbSAtUGF0aCAkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0IC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlIHwgT3V0LU51bGwNCiAgICAgICAgfQ0KICAgICAgICAkQmFzZURvY2tlckZpbGUgPSAnRG9ja2VyZmlsZScNCiAgICAgICAgaWYgKC1ub3QgKFRlc3QtUGF0aCAoIiQoJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCkvJEJhc2VEb2NrZXJGaWxlIikpKSB7DQogICAgICAgICAgICAjIERvd25sb2FkIGZpbGUgZnJvbSBJbWFnZVN0YXRlIGZhY3RzDQogICAgICAgICAgICAkQXJjaGl2ZVBhdGggPSAiJCgkQnVpbGRDb250ZXh0LldvcmtEaXIpLyQoJEltYWdlU3RhdGUuTWlkSW1hZ2VGYWN0cy5QYWNrYWdlRmlsZU5hbWUpIg0KICAgICAgICAgICAgSW52b2tlLVdlYlJlcXVlc3QgLVVyaSAkSW1hZ2VTdGF0ZS5NaWRJbWFnZUZhY3RzLlBhY2thZ2VVcmkgLU91dEZpbGUgJEFyY2hpdmVQYXRoDQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkV4dHJhY3RpbmcgJCgkSW1hZ2VTdGF0ZS5NaWRJbWFnZUZhY3RzLlBhY2thZ2VGaWxlTmFtZSkgdG8gJCgkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0KSINCiAgICAgICAgICAgIEV4cGFuZC1TTk9XTUlEQXJjaGl2ZSAtUGF0aCAkQXJjaGl2ZVBhdGggLU91dHB1dFBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRm9yY2UNCiAgICAgICAgfQ0KICAgICAgICAkQnVpbGRDb250ZXh0LkJhc2VJbWFnZUJ1aWxkID0gQnVpbGQtU05PV01JREltYWdlQ29tbW9uIC1TdHJhdGVneSAkQnVpbGRDb250ZXh0LkJ1aWxkU3RyYXRlZ3kgLUltYWdlTmFtZSAkQnVpbGRDb250ZXh0LkltYWdlTmFtZSAtSW1hZ2VUYWcgJEltYWdlU3RhdGUuTWlkVmVyc2lvbiAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQgLURvY2tlckNvbnRleHQgJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRG9ja2VyRmlsZSAkQmFzZURvY2tlckZpbGUNCiAgICB9DQogICAgaWYgKCRGb3JjZUJ1aWxkQ3VzdG9tIC1vciAoLW5vdCAkSW1hZ2VTdGF0ZS5DdXN0b21JbWFnZSAtb3IgKC1ub3QgKCRJbWFnZVN0YXRlLkN1c3RvbUltYWdlLlRhZ3MuTmFtZS5Db250YWlucygkSW1hZ2VTdGF0ZS5NaWRWZXJzaW9uKSkpKSkgew0KICAgICAgICAkY3VzdG9tRG9ja2VyQ29udGVudCA9IEdldC1Eb2NrZXJQb2RtYW5Eb2NrZXJGaWxlQ29udGVudA0KICAgICAgICBpZiAoJGN1c3RvbURvY2tlckNvbnRlbnQpIHsNCiAgICAgICAgICAgICRsaW5lcyA9ICRjdXN0b21Eb2NrZXJDb250ZW50LlNwbGl0KCJgbiIpDQogICAgICAgICAgICAkZnJvbUxpbmVJbmRleCA9ICRsaW5lcy5JbmRleE9mKCgkbGluZXMgfCBXaGVyZS1PYmplY3QgeyAkXyAtbWF0Y2ggJ15GUk9NXHMnIH0pKQ0KICAgICAgICAgICAgJGJhc2VGaXJzdExpbmUgPSAiRlJPTSAkKCRJbWFnZVN0YXRlLkJhc2VJbWFnZVVyaSkiDQogICAgICAgICAgICBpZiAoJGZyb21MaW5lSW5kZXggLWdlIDAgLWFuZCAkbGluZXNbJGZyb21MaW5lSW5kZXhdIC1uZSAkYmFzZUZpcnN0TGluZSkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXBkYXRpbmcgY3VzdG9tIERvY2tlcmZpbGUgd2l0aCBjb3JyZWN0IGJhc2UgSW1hZ2UgJCgkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VVcmkpIg0KICAgICAgICAgICAgICAgICRsaW5lc1skZnJvbUxpbmVJbmRleF0gPSAkYmFzZUZpcnN0TGluZQ0KICAgICAgICAgICAgICAgICRjdXN0b21Eb2NrZXJDb250ZW50ID0gJGxpbmVzIC1qb2luICJgbiINCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFdyaXRlLUhvc3QgJGN1c3RvbURvY2tlckNvbnRlbnQNCiAgICAgICAgICAgIGlmICgtbm90IChUZXN0LVBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCkpIHsNCiAgICAgICAgICAgICAgICBOZXctSXRlbSAtUGF0aCAkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0IC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlIHwgT3V0LU51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRjdXN0b21Eb2NrZXJGaWxlUGF0aCA9IChKb2luLVBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAnRG9ja2VyZmlsZS5taWRjdXN0b20nKQ0KICAgICAgICAgICAgJGN1c3RvbURvY2tlckNvbnRlbnQgfCBPdXQtRmlsZSAtRmlsZVBhdGggJGN1c3RvbURvY2tlckZpbGVQYXRoIC1Gb3JjZSAtRW5jb2RpbmcgdXRmOA0KICAgICAgICAgICAgJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZUJ1aWxkID0gQnVpbGQtU05PV01JREltYWdlQ29tbW9uIC1TdHJhdGVneSAkQnVpbGRDb250ZXh0LkJ1aWxkU3RyYXRlZ3kgLUltYWdlTmFtZSAkQnVpbGRDb250ZXh0LkN1c3RvbUltYWdlTmFtZSAtSW1hZ2VUYWcgJEltYWdlU3RhdGUuTWlkVmVyc2lvbiAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQgLURvY2tlckNvbnRleHQgJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRG9ja2VyRmlsZSAnRG9ja2VyZmlsZS5taWRjdXN0b20nIC1Qb2RtYW5Jc29sYXRpb24gJ29jaScNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIGN1c3RvbSBEb2NrZXJmaWxlIGZvdW5kLiBTa2lwcGluZyBjdXN0b20gaW1hZ2UgYnVpbGQnDQogICAgICAgIH0NCiAgICB9DQogICAgJEltYWdlU3RhdGUgPSBSZXNvbHZlLVNOT1dNSURJbWFnZVN0YXRlIC1CdWlsZENvbnRleHQgJEJ1aWxkQ29udGV4dA0KDQogICAgZnVuY3Rpb24gVGFnSW1hZ2UoJFNvdXJjZSwgJERlc3QpIHsNCiAgICAgICAgJGNtZCA9IHN3aXRjaCAoJEJ1aWxkQ29udGV4dC5CdWlsZFN0cmF0ZWd5KSB7DQogICAgICAgICAgICAnYWNyJyB7IA0KICAgICAgICAgICAgICAgIEFzc2VydC1TTk9XTUlEQXpDbGkNCiAgICAgICAgICAgICAgICAkZGVzdCA9IGlmICgkZGVzdCAtbWF0Y2ggJy4qLycpIHsgJGRlc3QgLXJlcGxhY2UgJy4qLycsICcnIH0gZWxzZSB7ICRkZXN0IH0NCiAgICAgICAgICAgICAgICAiYXogYWNyIGltcG9ydCAtLW5hbWUgJCgkQnVpbGRDb250ZXh0LkNvbnRhaW5lclJlZ2lzdHJ5Lm5hbWUpIC0tc291cmNlICRTb3VyY2UgLS1pbWFnZSAkRGVzdCAtLWZvcmNlIC0tc3Vic2NyaXB0aW9uICQoJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeS5zdWJzY3JpcHRpb25JZCkiDQogICAgICAgICAgICB9DQogICAgICAgICAgICAncG9kbWFuJyB7DQogICAgICAgICAgICAgICAgInBvZG1hbiB0YWcgJFNvdXJjZSAkRGVzdCINCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGRlZmF1bHQgew0KICAgICAgICAgICAgICAgIHRocm93ICJVbmtub3duIGJ1aWxkIHN0cmF0ZWd5OiAkKCRCdWlsZENvbnRleHQuQnVpbGRTdHJhdGVneSkiDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJUYWdnaW5nIGltYWdlICRTb3VyY2Ugd2l0aCB0YWcgJERlc3QgLSBDb21tYW5kOiAkY21kIg0KICAgICAgICAoSW52b2tlLUV4cHJlc3Npb24gJGNtZCkgfCBUZWUtT2JqZWN0IC1WYXJpYWJsZSBSZXN1bHQgfCBXcml0ZS1WZXJib3NlDQogICAgICAgICRSZXN1bHQNCiAgICB9DQogICAgJEJhc2VJbWFnZVRhZyA9ICRJbWFnZVN0YXRlLkJhc2VJbWFnZS5UYWdzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJGltYWdlU3RhdGUuTWlkVmVyc2lvbiB9DQogICAgJEJhc2VJbWFnZUVudmlyb25tZW50VGFnID0gJEltYWdlU3RhdGUuQmFzZUltYWdlLlRhZ3MgfCBXaGVyZS1PYmplY3QgeyAkXy5OYW1lIC1lcSAkQnVpbGRDb250ZXh0LkVudmlyb25tZW50TmFtZSB9DQogICAgaWYgKCRCYXNlSW1hZ2VUYWcgLWFuZCAkQmFzZUltYWdlRW52aXJvbm1lbnRUYWcgLWFuZCAoJEJhc2VJbWFnZVRhZy5EaWdlc3QgLWVxICRCYXNlSW1hZ2VFbnZpcm9ubWVudFRhZy5EaWdlc3QpKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiSW1hZ2UgJCgkQnVpbGRDb250ZXh0LkltYWdlTmFtZSk6JCgkQnVpbGRDb250ZXh0LkVudmlyb25tZW50TmFtZSkgYWxyZWFkeSBleGlzdHMuIFNraXBwaW5nIHRhZ2dpbmcuIg0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgJEJ1aWxkQ29udGV4dC5CYXNlVGFnUmVzdWx0ID0gVGFnSW1hZ2UgLVNvdXJjZSAkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VVcmkgLURlc3QgJEltYWdlU3RhdGUuQmFzZUltYWdlRW52aXJvbm1lbnRVcmkNCiAgICB9DQogICAgDQogICAgJEN1c3RvbUltYWdlVGFnID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2UuVGFncyB8IFdoZXJlLU9iamVjdCB7ICRfLk5hbWUgLWVxICRpbWFnZVN0YXRlLk1pZFZlcnNpb24gfQ0KICAgICRDdXN0b21JbWFnZUVudmlyb25tZW50VGFnID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2UuVGFncyB8IFdoZXJlLU9iamVjdCB7ICRfLk5hbWUgLWVxICRCdWlsZENvbnRleHQuRW52aXJvbm1lbnROYW1lIH0NCiAgICBpZiAoJEN1c3RvbUltYWdlVGFnIC1hbmQgJEN1c3RvbUltYWdlRW52aXJvbm1lbnRUYWcgLWFuZCAoJEN1c3RvbUltYWdlVGFnLkRpZ2VzdCAtZXEgJEN1c3RvbUltYWdlRW52aXJvbm1lbnRUYWcuRGlnZXN0KSkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkltYWdlICQoJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIGFscmVhZHkgZXhpc3RzLiBTa2lwcGluZyB0YWdnaW5nLiINCiAgICB9DQogICAgZWxzZWlmICgkQ3VzdG9tSW1hZ2VUYWcpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJUYWdnaW5nIGltYWdlICQoJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIg0KICAgICAgICAkQnVpbGRDb250ZXh0LkN1c3RvbVRhZ1Jlc3VsdCA9IFRhZ0ltYWdlIC1Tb3VyY2UgJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VVcmkgLURlc3QgJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgIH0NCg0KICAgIFtvcmRlcmVkXUB7DQogICAgICAgIEJhc2VJbWFnZUVudmlyb25tZW50VXJpICAgPSAkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgICAgICBDdXN0b21JbWFnZUVudmlyb25tZW50VXJpID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgICAgICBCYXNlSW1hZ2VUYWdSZXN1bHQgICAgICAgID0gJEJ1aWxkQ29udGV4dC5CYXNlVGFnUmVzdWx0DQogICAgICAgIEN1c3RvbUltYWdlVGFnUmVzdWx0ICAgICAgPSAkQnVpbGRDb250ZXh0LkN1c3RvbVRhZ1Jlc3VsdA0KICAgIH0NCn0NCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIFNlY3Rpb24gMjogU2VydmljZU5vdyBGdW5jdGlvbnMNCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpmdW5jdGlvbiBHZXQtU05PV0N1cnJlbnRVc2VyIHsNCiAgICAkQ3VycmVudFVzZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyJyAtUXVlcnkgInVzZXJfbmFtZT1qYXZhc2NyaXB0OmdzLmdldFVzZXJOYW1lKCkiIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgaWYgKCRDdXJyZW50VXNlci5Db3VudCAtZXEgMCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgLU1lc3NhZ2UgIk5vIGN1cnJlbnQgdXNlciBmb3VuZCBpbiBTZXJ2aWNlTm93LiBQbGVhc2UgY2hlY2sgeW91ciBhdXRoZW50aWNhdGlvbi4iDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICByZXR1cm4gJEN1cnJlbnRVc2VyWzBdDQp9DQpmdW5jdGlvbiBHZXQtU05PV01JRFJlY29yZFdpdGhDcmVkcyB7DQogICAgcGFyYW0gKA0KICAgICAgICBbcHNjcmVkZW50aWFsXSRDcmVkZW50aWFsLA0KICAgICAgICBbc3RyaW5nXSRUYWJsZSA9ICdzeXNfdXNlcicsDQogICAgICAgIFtzdHJpbmddJFF1ZXJ5ID0gInVzZXJfbmFtZT0kKCRDcmVkZW50aWFsLlVzZXJOYW1lKSINCiAgICApDQogICAgJEN1cnJlbnRTbm93QXV0aCA9IEdldC1TTk9XQXV0aCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICRJbnN0YW5jZSA9ICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aC5JbnN0YW5jZSA/PyAkQ3VycmVudFNub3dBdXRoLkluc3RhbmNlDQogICAgaWYgKCAtbm90ICRJbnN0YW5jZSkgew0KICAgICAgICBXcml0ZS1FcnJvciAiTm8gU2VydmljZU5vdyBpbnN0YW5jZSBmb3VuZC4gUGxlYXNlIHNldCB0aGUgU05fSE9TVCBlbnZpcm9ubWVudCB2YXJpYWJsZS4iDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlVzaW5nIFNlcnZpY2VOb3cgaW5zdGFuY2UgJEluc3RhbmNlIHdpdGggdXNlciAkKCRDcmVkZW50aWFsLlVzZXJOYW1lKSINCiAgICBTZXQtU05PV0F1dGggLUluc3RhbmNlICRJbnN0YW5jZSAtQ3JlZGVudGlhbCAkQ3JlZGVudGlhbA0KICAgICRyZXN1bHQgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJFRhYmxlIC1RdWVyeSAkUXVlcnkgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoLW5vdCAkcmVzdWx0KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byBhdXRoZW50aWNhdGUgdG8gU2VydmljZU5vdyB3aXRoIHVzZXIgJCgkQ3JlZGVudGlhbC5Vc2VyTmFtZSkiDQogICAgfQ0KICAgIGlmICgkQ3VycmVudFNub3dBdXRoKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLU1lc3NhZ2UgIlJlc3RvcmluZyBwcmV2aW91cyBTZXJ2aWNlTm93IGF1dGhlbnRpY2F0aW9uICQoJEN1cnJlbnRTbm93QXV0aC5DcmVkZW50aWFsLlVzZXJOYW1lKUAkKCRDdXJyZW50U25vd0F1dGguSW5zdGFuY2UpIg0KICAgICAgICBTZXQtU05PV0F1dGggLUF1dGhPYmplY3QgJEN1cnJlbnRTbm93QXV0aA0KICAgIH0NCiAgICByZXR1cm4gJHJlc3VsdA0KfQ0KDQpmdW5jdGlvbiBHZXQtU05PV01JRFNlcnZlclJlY29yZCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUNCiAgICApDQogICAgR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSINCn0NCg0KZnVuY3Rpb24gTmV3LVNOT1dNSURQYXNzd29yZCB7DQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW1ZhbGlkYXRlUmFuZ2UoMTIsIDQyKV0NCiAgICAgICAgW2ludF0gDQogICAgICAgICRMZW5ndGggPSAyNCwNCiAgICAgICAgW3N3aXRjaF0kQXNQbGFpblRleHQNCiAgICApDQogICAgJHN5bWJvbHMgPSAnIUAjJConLlRvQ2hhckFycmF5KCkNCiAgICAkY2hhcmFjdGVyTGlzdCA9ICdhJy4uJ3onICsgJ0EnLi4nWicgKyAnMCcuLic5JyArICRzeW1ib2xzDQogICAgZG8gew0KICAgICAgICAkcGFzc3dvcmQgPSAnJw0KICAgICAgICBmb3IgKCRpID0gMDsgJGkgLWx0ICRMZW5ndGg7ICRpKyspIHsNCiAgICAgICAgICAgICRyYW5kb21JbmRleCA9IFtTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5LlJhbmRvbU51bWJlckdlbmVyYXRvcl06OkdldEludDMyKDAsICRjaGFyYWN0ZXJMaXN0Lkxlbmd0aCkNCiAgICAgICAgICAgICRwYXNzd29yZCArPSAkY2hhcmFjdGVyTGlzdFskcmFuZG9tSW5kZXhdDQogICAgICAgIH0NCg0KICAgICAgICBbaW50XSRoYXNMb3dlckNoYXIgPSAkcGFzc3dvcmQgLWNtYXRjaCAnW2Etel0nDQogICAgICAgIFtpbnRdJGhhc1VwcGVyQ2hhciA9ICRwYXNzd29yZCAtY21hdGNoICdbQS1aXScNCiAgICAgICAgW2ludF0kaGFzRGlnaXQgPSAkcGFzc3dvcmQgLW1hdGNoICdbMC05XScNCiAgICAgICAgW2ludF0kaGFzU3ltYm9sID0gJHBhc3N3b3JkLkluZGV4T2ZBbnkoJHN5bWJvbHMpIC1uZSAtMQ0KDQogICAgfQ0KICAgIHVudGlsICgoJGhhc0xvd2VyQ2hhciArICRoYXNVcHBlckNoYXIgKyAkaGFzRGlnaXQgKyAkaGFzU3ltYm9sKSAtZ2UgMykNCiAgICANCiAgICBpZiAoJEFzUGxhaW5UZXh0KSB7IA0KICAgICAgICByZXR1cm4gJHBhc3N3b3JkDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICByZXR1cm4gJHBhc3N3b3JkIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTUlEVXNlclJvbGVzIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW3N0cmluZ10kVXNlcm5hbWUsDQogICAgICAgIFtzd2l0Y2hdJEluY2x1ZGVJbmhlcml0ZWQNCiAgICApDQogICAgJFVzZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyJyAtUXVlcnkgInVzZXJfbmFtZT0kVXNlcm5hbWUiDQogICAgJFJvbGVRdWVyeSA9ICJ1c2VyPSQoJFVzZXIuc3lzX2lkKV4iDQogICAgaWYgKC1ub3QgJEluY2x1ZGVJbmhlcml0ZWQpIHsNCiAgICAgICAgJFJvbGVRdWVyeSArPSAnaW5oZXJpdGVkPWZhbHNlJw0KICAgIH0NCiAgICAkVXNlclJvbGVzID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcl9oYXNfcm9sZScgLVF1ZXJ5ICRSb2xlUXVlcnkgLURpc3BsYXlWYWx1ZSAndHJ1ZScgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICByZXR1cm4gJFVzZXJSb2xlcw0KfQ0KDQpmdW5jdGlvbiBBZGQtU05PV01JRFVzZXJSb2xlcyB7DQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRVc2VyU3lzSWQsDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nW11dJFJvbGVzDQogICAgKQ0KICAgICRSZXF1ZXN0ZWRSb2xlcyA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXJfcm9sZScgLVF1ZXJ5ICJuYW1lPSQoJFJvbGVzIC1qb2luICcsJykiDQogICAgJFVzZXJSb2xlcyA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXJfaGFzX3JvbGUnIC1RdWVyeSAidXNlcj0kVXNlclN5c0lkIg0KICAgICRSb2xlTGlzdCA9ICRVc2VyUm9sZXMucm9sZQ0KICAgIGZvcmVhY2ggKCRSb2xlIGluICRSZXF1ZXN0ZWRSb2xlcykgew0KICAgICAgICBpZiAoJFJvbGVMaXN0LnZhbHVlIC1jb250YWlucyAkUm9sZS5zeXNfaWQpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgIlVzZXIgWyRVc2VyU3lzSWRdIGFscmVhZHkgaGFzIHJvbGUgJCgkUm9sZS5uYW1lKSINCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgJFJvbGVQcm9wZXJ0aWVzID0gQHsNCiAgICAgICAgICAgIHVzZXIgPSAkVXNlclN5c0lkDQogICAgICAgICAgICByb2xlID0gJFJvbGUuc3lzX2lkDQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgU2lnbmlmaWNhbnQgIkFkZGluZyByb2xlICQoJFJvbGUubmFtZSkgdG8gWyRVc2VyU3lzSWRdIg0KICAgICAgICAkUm9sZUxpc3QgKz0gTmV3LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcl9oYXNfcm9sZScgLVByb3BlcnRpZXMgJFJvbGVQcm9wZXJ0aWVzIC1QYXNzVGhydQ0KICAgIH0NCiAgICAkUm9sZUxpc3QNCn0NCg0KZnVuY3Rpb24gU2V0LVNOT1dNSURTZXJ2ZXJVc2VyIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUsDQogICAgICAgIFtWYWxpZGF0ZVBhdHRlcm4oJ15bYS16QS1aMC05XC1dKyQnKV0NCiAgICAgICAgW3N0cmluZ10kTWlkU2VydmVyVXNlck5hbWUgPSAiYXptaWQtJE1pZFNlcnZlck5hbWUiLA0KICAgICAgICBbc2VjdXJlc3RyaW5nXSRQYXNzd29yZCwNCiAgICAgICAgW3N0cmluZ1tdXSRSb2xlcyA9IEAoJ21pZF9zZXJ2ZXInKSwNCiAgICAgICAgW3N0cmluZ1tdXSRDYXBhYmlsaXRpZXMgPSBAKCdBTEwnKSwNCiAgICAgICAgW3N0cmluZ10kTWlkU2VydmVyQ2x1c3RlciA9ICdhenVyZScsDQogICAgICAgIFtoYXNodGFibGVdJFVzZXJWYWx1ZXMgPSBAe30sDQogICAgICAgIFtzdHJpbmddJERlZmF1bHRFbWFpbFN1ZmZpeCA9ICdleGFtcGxlLmNvbScsDQogICAgICAgIFtzdHJpbmddJE9wZXJhdGlvbiA9ICdkZXBsb3knDQogICAgKQ0KICAgICRNaWRTZWNyZXROYW1lID0gIiR7TWlkU2VydmVyVXNlck5hbWV9LXBhc3N3b3JkIg0KICAgICRWYXVsdFNlY3JldCA9IEdldC1TZWNyZXQgLU5hbWUgJE1pZFNlY3JldE5hbWUgLVZhdWx0ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICANCiAgICBpZiAoJFZhdWx0U2VjcmV0KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXNpbmcgcGFzc3dvcmQgZnJvbSBWYXVsdCAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FIg0KICAgICAgICBpZiAoJFZhdWx0U2VjcmV0IC1pcyBbU3lzdGVtLlNlY3VyaXR5LlNlY3VyZVN0cmluZ10pIHsNCiAgICAgICAgICAgIGlmKC1ub3QgJFBhc3N3b3JkKXsNCiAgICAgICAgICAgICAgICAkUGFzc3dvcmQgPSAkVmF1bHRTZWNyZXQNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIlNlY3JldCAkTWlkU2VjcmV0TmFtZSBpcyBhbHJlYWR5IHNldCwgYnV0IGEgbmV3IHBhc3N3b3JkIHdhcyBwcm92aWRlZC4gVXNpbmcgdGhlIHByb3ZpZGVkIHBhc3N3b3JkIGluc3RlYWQuIg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiU2VjcmV0ICRNaWRTZWNyZXROYW1lIGlzIG5vdCBhIHZhbGlkIFNlY3VyZVN0cmluZyINCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoJGVudjpNSURfSU5TVEFOQ0VfVVNFUk5BTUUgLWFuZCAkZW52Ok1JRF9JTlNUQU5DRV9QQVNTV09SRCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlVzaW5nIHBhc3N3b3JkIE1JRF9JTlNUQU5DRV9VU0VSTkFNRTogJE1pZFNlcnZlclVzZXJOYW1lIGFuZCBNSURfSU5TVEFOQ0VfUEFTU1dPUkQiDQogICAgICAgICRQYXNzd29yZCA9ICRlbnY6TUlEX0lOU1RBTkNFX1BBU1NXT1JEIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQgLUZvcmNlDQogICAgICAgICRNaWRTZXJ2ZXJVc2VyTmFtZSA9ICRlbnY6TUlEX0lOU1RBTkNFX1VTRVJOQU1FDQogICAgfQ0KICAgIGlmICgtbm90ICRQYXNzd29yZCkgew0KICAgICAgICAkUGFzc3dvcmQgPSBOZXctU05PV01JRFBhc3N3b3JkIC1MZW5ndGggMTkNCiAgICB9DQogICAgJE1pZFVzZXJDcmVkZW50aWFscyA9IFtwc2NyZWRlbnRpYWxdOjpuZXcoJE1pZFNlcnZlclVzZXJOYW1lLCAkUGFzc3dvcmQpDQogICAgJE1pZE1ldGFkYXRhID0gW29yZGVyZWRdQHsNCiAgICAgICAgVGFnICAgICA9ICdTTk1JRCcNCiAgICAgICAgTmFtZSAgICA9ICRNaWRTZXJ2ZXJOYW1lDQogICAgICAgIENsdXN0ZXIgPSAkTWlkU2VydmVyQ2x1c3Rlcg0KICAgICAgICBTdGF0dXMgID0gJE9wZXJhdGlvbg0KICAgIH0NCg0KICAgICRNaWRVc2VyID0gW2hhc2h0YWJsZV1Aew0KICAgICAgICB1c2VyX25hbWUgICAgICAgICAgICAgICAgID0gJE1pZFNlcnZlclVzZXJOYW1lDQogICAgICAgIHVzZXJfcGFzc3dvcmQgICAgICAgICAgICAgPSAoQ29udmVydEZyb20tU2VjdXJlU3RyaW5nIC1TZWN1cmVTdHJpbmcgJFBhc3N3b3JkIC1Bc1BsYWluVGV4dCkNCiAgICAgICAgYWN0aXZlICAgICAgICAgICAgICAgICAgICA9ICR0cnVlDQogICAgICAgIGVtYWlsICAgICAgICAgICAgICAgICAgICAgPSAiJHtNaWRTZXJ2ZXJVc2VyTmFtZX1AJHtEZWZhdWx0RW1haWxTdWZmaXh9Ig0KICAgICAgICBsb2NrZWRfb3V0ICAgICAgICAgICAgICAgID0gJGZhbHNlDQogICAgICAgIHBhc3N3b3JkX25lZWRzX3Jlc2V0ICAgICAgPSAkZmFsc2UNCiAgICAgICAgZmlyc3RfbmFtZSAgICAgICAgICAgICAgICA9ICRNaWRTZXJ2ZXJOYW1lDQogICAgICAgIGxhc3RfbmFtZSAgICAgICAgICAgICAgICAgPSAnTWlkIFNlcnZlcicNCiAgICAgICAgc291cmNlICAgICAgICAgICAgICAgICAgICA9ICdBenVyZSBNSUQnDQogICAgICAgIGludGVybmFsX2ludGVncmF0aW9uX3VzZXIgPSAkdHJ1ZQ0KICAgICAgICBlbXBsb3llZV9udW1iZXIgICAgICAgICAgID0gKCRNaWRNZXRhZGF0YS5WYWx1ZXMgLWpvaW4gJ3wnKQ0KICAgIH0NCiAgICAkQ3VycmVudFNub3dBdXRoID0gR2V0LVNOT1dBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgJFVzZXJJc0FkbWluID0gJGZhbHNlDQogICAgaWYgKCRDdXJyZW50U25vd0F1dGgpIHsNCiAgICAgICAgJFJvbGVSZWNvcmRzID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcl9oYXNfcm9sZScgLVF1ZXJ5ICJ1c2VyX25hbWU9amF2YXNjcmlwdDpncy5nZXRVc2VyTmFtZSgpIiAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtRXJyb3JWYXJpYWJsZSBVc2VySXNBZG1pbkVycm9yDQogICAgICAgIGlmICgkVXNlcklzQWRtaW5FcnJvcikgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiQ3VycmVudCB1c2VyIGlzIG5vdCBhbiBhZG1pbi4gQ2Fubm90IGFzc2lnbiByb2xlcyBvciBjcmVhdGUgdXNlci4gUHJvY2VlZGluZyB3aXRoIHBhc3N0aHJvdWdoLiINCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ3VycmVudCB1c2VyIGlzIGFuIGFkbWluLiBQcm9jZWVkaW5nIHdpdGggcm9sZSBhc3NpZ25tZW50LiINCiAgICAgICAgICAgICRVc2VySXNBZG1pbiA9ICgkUm9sZVJlY29yZHMuQ291bnQgLWd0IDApIA0KICAgICAgICB9DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBFcnJvciAtTWVzc2FnZSAiTm8gU2VydmljZU5vdyBhdXRoZW50aWNhdGlvbiBmb3VuZCBpbiBjb250ZXh0Ig0KICAgIH0NCiAgICAkTWlkU2VydmVyVXNlciA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXInIC1RdWVyeSAidXNlcl9uYW1lPSRNaWRTZXJ2ZXJVc2VyTmFtZSIgLVZlcmJvc2UNCiAgICBpZiAoJE1pZFNlcnZlclVzZXIpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICgnezB9IGFscmVhZHkgZXhpc3RzLiBbYWN0aXZlOiB7MX1dIFtsb2NrZWRfb3V0OiB7Mn1dIFtwYXNzd29yZF9uZWVkc19yZXNldDogezN9XScgLWYgJE1pZFNlcnZlclVzZXJOYW1lLCAkTWlkU2VydmVyVXNlci5hY3RpdmUsICRNaWRTZXJ2ZXJVc2VyLmxvY2tlZF9vdXQsICRNaWRTZXJ2ZXJVc2VyLnBhc3N3b3JkX25lZWRzX3Jlc2V0KQ0KICAgICAgICAkTWlkVXNlclZhbGlkID0gR2V0LVNOT1dNSURSZWNvcmRXaXRoQ3JlZHMgLUNyZWRlbnRpYWwgJE1pZFVzZXJDcmVkZW50aWFscw0KICAgICAgICBpZiAoLW5vdCAkTWlkVXNlclZhbGlkKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJVc2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSBwYXNzd29yZCBpcyBpbnZhbGlkIg0KICAgICAgICB9DQogICAgICAgIGlmKCRVc2VySXNBZG1pbil7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJVcGRhdGluZyB1c2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSIgDQogICAgICAgICAgICAkTWlkU2VydmVyVXNlciA9IFNldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXInIC1TeXNJZCAkTWlkU2VydmVyVXNlci5zeXNfaWQgLVByb3BlcnRpZXMgJE1pZFVzZXIgLUlucHV0RGlzcGxheVZhbHVlIC1QYXNzVGhydQ0KICAgICAgICB9DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBpZigkVXNlcklzQWRtaW4pew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDcmVhdGluZyB1c2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSINCiAgICAgICAgICAgICRNaWRTZXJ2ZXJVc2VyID0gTmV3LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcicgLVByb3BlcnRpZXMgJE1pZFVzZXIgLUlucHV0RGlzcGxheVZhbHVlIC1QYXNzVGhydQ0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkN1cnJlbnQgdXNlciBpcyBub3QgYW4gYWRtaW4uIFVzaW5nIEV4aXN0aW5nIFNOT1dBdXRoIENyZWRlbnRpYWxzIg0KICAgICAgICAgICAgJE1pZFNlcnZlclVzZXJOYW1lID0gJEN1cnJlbnRTbm93QXV0aC5DcmVkZW50aWFsLlVzZXJOYW1lDQogICAgICAgICAgICAkTWlkVXNlckNyZWRlbnRpYWxzID0gJEN1cnJlbnRTbm93QXV0aC5DcmVkZW50aWFsDQogICAgICAgICAgICAkTWlkU2VjcmV0TmFtZSA9ICIke01pZFNlcnZlclVzZXJOYW1lfS1wYXNzd29yZCINCiAgICAgICAgICAgICRNaWRTZXJ2ZXJVc2VyID0gR2V0LVNOT1dDdXJyZW50VXNlciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgaWYoLW5vdCAkTWlkU2VydmVyVXNlcikgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIHVzZXIgZm91bmQgd2l0aCB1c2VybmFtZSAkTWlkU2VydmVyVXNlck5hbWUuIENhbm5vdCBhc3NpZ24gcm9sZXMgb3IgY2FwYWJpbGl0aWVzLiINCiAgICAgICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoJFVzZXJJc0FkbWluKSB7DQogICAgICAgICRNaWRTZXJ2ZXJVc2VyUm9sZXMgPSBBZGQtU05PV01JRFVzZXJSb2xlcyAtVXNlclN5c0lkICRNaWRTZXJ2ZXJVc2VyLnN5c19pZCAtUm9sZXMgJFJvbGVzDQogICAgfWVsc2V7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkN1cnJlbnQgdXNlciBpcyBub3QgYW4gYWRtaW4uIENhbm5vdCBhc3NpZ24gcm9sZXMgdG8gJE1pZFNlcnZlclVzZXJOYW1lLiBSb2xlcyBtdXN0IGJlIGFzc2lnbmVkIG1hbnVhbGx5LiINCiAgICB9DQogICAgJE1pZFVzZXJWYWxpZCA9IEdldC1TTk9XTUlEUmVjb3JkV2l0aENyZWRzIC1DcmVkZW50aWFsICRNaWRVc2VyQ3JlZGVudGlhbHMgDQogICAgaWYgKCRNaWRVc2VyVmFsaWQpIHsNCiAgICAgICAgJEN1cnJlbnRTZWNyZXQgPSBHZXQtU2VjcmV0IC1OYW1lICRNaWRTZWNyZXROYW1lIC1WYXVsdCAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1Bc1BsYWluVGV4dA0KICAgICAgICBpZiAoJEN1cnJlbnRTZWNyZXQgLWFuZCAkQ3VycmVudFNlY3JldCAtZXEgJE1pZFVzZXJDcmVkZW50aWFscy5HZXROZXR3b3JrQ3JlZGVudGlhbCgpLlBhc3N3b3JkKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJTZWNyZXQgJE1pZFNlY3JldE5hbWUgYWxyZWFkeSBleGlzdHMgYW5kIGlzIHRoZSBzYW1lIGFzIHRoZSBuZXcgcGFzc3dvcmQuIE5vIG5lZWQgdG8gdXBkYXRlLiINCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiU2V0dGluZyBwYXNzd29yZCBmb3IgJE1pZFNlcnZlclVzZXJOYW1lIGluIFZhdWx0Ig0KICAgICAgICAgICAgU2V0LVNlY3JldCAtTmFtZSAkTWlkU2VjcmV0TmFtZSAtU2VjcmV0ICRNaWRVc2VyQ3JlZGVudGlhbHMuUGFzc3dvcmQgLVZhdWx0ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAgICAgfQ0KICAgIH0NCiAgICAkUmVzdWx0cyA9IFtvcmRlcmVkXUB7DQogICAgICAgIE1pZFNlcnZlck5hbWUgPSAkTWlkU2VydmVyTmFtZQ0KICAgICAgICBVc2VyICAgICAgICAgID0gJE1pZFNlcnZlclVzZXINCiAgICAgICAgUm9sZXMgICAgICAgICA9ICRNaWRTZXJ2ZXJVc2VyUm9sZXMNCiAgICAgICAgQ3JlZGVudGlhbHMgICA9ICRNaWRVc2VyQ3JlZGVudGlhbHMNCiAgICAgICAgTWlkVmVyc2lvbiAgICA9ICRNaWRVc2VyVmFsaWQudmFsdWUNCiAgICAgICAgVmF1bHRTZWNyZXQgICA9ICRNaWRTZWNyZXROYW1lDQogICAgICAgIFNub3dBdXRoICAgICAgPSBAew0KICAgICAgICAgICAgSW5zdGFuY2UgICA9ICRDdXJyZW50U25vd0F1dGguSW5zdGFuY2UNCiAgICAgICAgICAgIENyZWRlbnRpYWwgPSAkTWlkVXNlckNyZWRlbnRpYWxzDQogICAgICAgIH0NCiAgICB9DQogICAgaWYgKCRSZXN1bHRzLk1pZFZlcnNpb24pIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJVc2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSBpcyB2YWxpZCINCiAgICAgICAgJFJlc3VsdHMuTWlkSW1hZ2VGYWN0cyA9IEdldC1TTk9XTUlERG93bmxvYWRGYWN0cyAtQnVpbGRUYWcgJFJlc3VsdHMuTWlkVmVyc2lvbg0KICAgIH0NCiAgICBXcml0ZS1QU0ZNZXNzYWdlICgkUmVzdWx0cyB8IENvbnZlcnRUby1Kc29uIC1EZXB0aCAzKQ0KICAgIHJldHVybiAkUmVzdWx0cyAgIA0KfQ0KDQpmdW5jdGlvbiBTdGFydC1TTk9XTUlEVmFsaWRhdGlvblNjcmlwdCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUsDQogICAgICAgIFtzdHJpbmddJE9wZXJhdGlvbiwNCiAgICAgICAgW2ludF0kVGltZW91dE1pbnV0ZXMgPSA0NQ0KICAgICkNCiAgICAkQWRtaW5DcmVkcyA9IChHZXQtU05PV0F1dGgpLkNyZWRlbnRpYWwNCiAgICAkU2NyaXB0TmFtZSA9ICJBWlVSRV9ERVZPUFNfTUlEVkFMSURBVEVfJCgkTWlkU2VydmVyTmFtZSkiDQogICAgJEFkbWluVXNlciA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXInIC1RdWVyeSAidXNlcl9uYW1lPSQoJEFkbWluQ3JlZHMuR2V0TmV0d29ya0NyZWRlbnRpYWwoKS5Vc2VybmFtZSkiIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICRFY2NBZ2VudCA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnZWNjX2FnZW50JyAtUXVlcnkgIm5hbWU9JE1pZFNlcnZlck5hbWUiIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgIGlmICgkRWNjQWdlbnQgLWFuZCAkRWNjQWdlbnQudmFsaWRhdGVkIC1lcSAndHJ1ZScgLWFuZCAkRWNjQWdlbnQuc3RhdHVzIC1lcSAnRG93bicpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdlY2NfYWdlbnQgaXMgRE9XTi4gSW52YWxpZGF0aW5nJw0KICAgICAgICAkRWNjQWdlbnQgPSAkRWNjQWdlbnQgfCBTZXQtU05PV09iamVjdCAtUHJvcGVydGllcyBAeyB2YWxpZGF0ZWQgPSAnZmFsc2UnOyB2YWxpZGF0ZWRfYXQgPSAnJzsgdmFsaWRhdGVkX2J5ID0gJycgfSAtVGFibGUgJ2VjY19hZ2VudCcgLVBhc3NUaHJ1DQogICAgfQ0KICAgICRFeGlzdGluZ1NjcmlwdCA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzYXV0b19zY3JpcHQnIC1RdWVyeSAibmFtZT0ke1NjcmlwdE5hbWV9Ig0KICAgIGlmICgkRXhpc3RpbmdTY3JpcHQuc3lzX2lkKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAnU2NyaXB0IGFscmVhZHkgZXhpc3RzLCBkZWxldGluZycNCiAgICAgICAgUmVtb3ZlLVNOT1dPYmplY3QgLVRhYmxlICdzeXNhdXRvX3NjcmlwdCcgLVN5c19JRCAkRXhpc3RpbmdTY3JpcHQuc3lzX2lkIC1Db25maXJtOiRmYWxzZSB8IE91dC1OdWxsDQogICAgfQ0KICAgIGlmICgkT3BlcmF0aW9uIC1lcSAncmVtb3ZlJykgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgJ09wZXJhdGlvbiBpcyByZW1vdmUuIE5vIG5lZWQgdG8gY3JlYXRlIHN5c2F1dG9fc2NyaXB0IGVudHJ5LicNCiAgICAgICAgcmV0dXJuICRmYWxzZQ0KICAgIH0NCiAgICAjIENoZWNrIHRoZSBhZ2VudC4gSWYgYWxyZWFkeSB2YWxpZGF0ZWQsIGRvIG5vdGhpbmcNCiAgICAkc3lzU2NyaXB0Qm9keSA9IEB7DQogICAgICAgICdjb25kaXRpb25hbCcgICAgICAgPSAnZmFsc2UnDQogICAgICAgICdidXNpbmVzc19jYWxlbmRhcicgPSAnJw0KICAgICAgICAnZW50ZXJlZF90aW1lJyAgICAgID0gJzE5NzAtMDEtMDEgMDA6MDA6MDAnDQogICAgICAgICdydW5fYXNfdHonICAgICAgICAgPSAnJw0KICAgICAgICAncnVuX2FzJyAgICAgICAgICAgID0gJEFkbWluVXNlci5zeXNfaWQNCiAgICAgICAgJ3J1bl90eXBlJyAgICAgICAgICA9ICdwZXJpb2RpY2FsbHknDQogICAgICAgICdydW5fc3RhcnQnICAgICAgICAgPSAoR2V0LURhdGUpLkFkZE1pbnV0ZXMoKzEpLlRvU3RyaW5nKCd5eXl5LU1NLWRkIEhIOm1tOnNzJykgICAgDQogICAgICAgICdydW5fZGF5b2Ztb250aCcgICAgPSAnMScNCiAgICAgICAgJ3N5c19zY29wZScgICAgICAgICA9ICdnbG9iYWwnDQogICAgICAgICdydW5fZGF5b2Z3ZWVrJyAgICAgPSAnMScNCiAgICAgICAgJ29mZnNldCcgICAgICAgICAgICA9ICcnDQogICAgICAgICdydW5fdGltZScgICAgICAgICAgPSAnMTk3MC0wMS0wMSAwNTowMDowMCcNCiAgICAgICAgJ2FjdGl2ZScgICAgICAgICAgICA9ICd0cnVlJw0KICAgICAgICAndGltZV96b25lJyAgICAgICAgID0gJycNCiAgICAgICAgJ3N5c19wYWNrYWdlJyAgICAgICA9ICdnbG9iYWwnDQogICAgICAgICdjb25kaXRpb24nICAgICAgICAgPSAnJw0KICAgICAgICAnb2Zmc2V0X3R5cGUnICAgICAgID0gJzAnDQogICAgICAgICduYW1lJyAgICAgICAgICAgICAgPSAkU2NyaXB0TmFtZQ0KICAgICAgICAnbWF4X2RyaWZ0JyAgICAgICAgID0gJycNCiAgICAgICAgJ3J1bl9wZXJpb2QnICAgICAgICA9ICcxOTcwLTAxLTAxIDAwOjAwOjQ1JyAjIGV2ZXJ5IDQ1IHNlY29uZHMgICANCiAgICB9DQogICAgDQogICAgJHNjcmlwdEhlYWRlciA9ICd2YXIgU1lTX0FVVE9fU0NSSVBUX05BTUU9IkFaVVJFX0RFVk9QU19NSURWQUxJREFURV97MH0iO3ZhciBNSURfU0VSVkVSX05BTUU9InswfSI7dmFyIFNZU19BVVRPX1NDUklQVF9FWFBJUllfTUlOVVRFUz17MX07JyAtZiAkTWlkU2VydmVyTmFtZSwgJFRpbWVvdXRNaW51dGVzDQogICAgJHNjcmlwdEJhc2UgPSAnZnVuY3Rpb24gR2V0TWlkVXNlck1ldGFkYXRhKG1pZFNlcnZlck5hbWUpe3ZhciB1c2VyPW5ldyBHbGlkZVJlY29yZCgic3lzX3VzZXIiKTt1c2VyLmFkZFF1ZXJ5KCJlbXBsb3llZV9udW1iZXIiLCJTVEFSVFNXSVRIIiwiU05NSUR8IittaWRTZXJ2ZXJOYW1lKTt1c2VyLnF1ZXJ5KCk7aWYoIXVzZXIubmV4dCgpKXtncy5pbmZvKCJVc2VyIG5vdCBmb3VuZCBmb3IgTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUpO3JldHVybiBudWxsfXZhciBtZXRhUGFydHM9dXNlci5lbXBsb3llZV9udW1iZXIuc3BsaXQoInwiKTt2YXIgb3V0cHV0cz17dXNlcjp1c2VyLG1pZFNlcnZlck5hbWU6bWlkU2VydmVyTmFtZX07aWYobWV0YVBhcnRzLmxlbmd0aD49Myl7b3V0cHV0cy5taWRTZXJ2ZXJDbHVzdGVyPW1ldGFQYXJ0c1syXX1pZihtZXRhUGFydHMubGVuZ3RoPj00KXtvdXRwdXRzLm1pZFNlcnZlckNsdXN0ZXI9bWV0YVBhcnRzWzJdO291dHB1dHMubWlkU2VydmVyU3RhdHVzPW1ldGFQYXJ0c1szXX12YXIgYWdlbnQ9bmV3IEdsaWRlUmVjb3JkKCJlY2NfYWdlbnQiKTthZ2VudC5hZGRRdWVyeSgibmFtZSIsbWlkU2VydmVyTmFtZSk7YWdlbnQucXVlcnkoKTtpZihhZ2VudC5uZXh0KCkpe291dHB1dHMuYWdlbnQ9YWdlbnR9cmV0dXJuIG91dHB1dHN9ZnVuY3Rpb24gQ2hlY2tDYXBhYmlsaXRpZXMobWlkU2VydmVyTmFtZSxjYXBhYmlsaXRpZXMpe2lmKCFjYXBhYmlsaXRpZXMpe2NhcGFiaWxpdGllcz1bIkFMTCJdfXZhciBvdXRwdXRzPXtjYXBhYmlsaXRpZXM6W119O3ZhciBhZ2VudD1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudCIpO2FnZW50LmFkZFF1ZXJ5KCJuYW1lIixtaWRTZXJ2ZXJOYW1lKTthZ2VudC5xdWVyeSgpO2lmKCFhZ2VudC5uZXh0KCkpe2dzLmluZm8oIk1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKyIgbm90IGZvdW5kIik7cmV0dXJufXZhciBhZ2VudENhcHM9Y2FwYWJpbGl0aWVzLm1hcChmdW5jdGlvbihjYXApe3ZhciBjYXBRdWVyeT1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudF9jYXBhYmlsaXR5X20ybSIpO2NhcFF1ZXJ5LmFkZEVuY29kZWRRdWVyeSgiYWdlbnQ9IithZ2VudC5zeXNfaWQrIl5jYXBhYmlsaXR5Lm5hbWU9IitjYXApO2NhcFF1ZXJ5LnF1ZXJ5KCk7aWYoY2FwUXVlcnkubmV4dCgpKXtncy5kZWJ1ZygiQ2FwYWJpbGl0eSAiK2NhcCsiIGZvdW5kIGZvciBNSUQgU2VydmVyICIrbWlkU2VydmVyTmFtZSk7b3V0cHV0cy5jYXBhYmlsaXRpZXMucHVzaChjYXBRdWVyeS5zeXNfaWQudG9TdHJpbmcoKSl9ZWxzZXtncy5pbmZvKCJDYXBhYmlsaXR5ICIrY2FwKyIgbm90IGZvdW5kIGZvciBNSUQgU2VydmVyICIrbWlkU2VydmVyTmFtZSk7dmFyIG5ld0NhcD1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudF9jYXBhYmlsaXR5X20ybSIpO25ld0NhcC5pbml0aWFsaXplKCk7bmV3Q2FwLmNhcGFiaWxpdHkuc2V0RGlzcGxheVZhbHVlKGNhcCk7bmV3Q2FwLmFnZW50PWFnZW50LnN5c19pZDtpZihuZXdDYXAuaW5zZXJ0KCkpe291dHB1dHMuY2FwYWJpbGl0aWVzLnB1c2gobmV3Q2FwLnN5c19pZCl9ZWxzZXtncy5pbmZvKCJGYWlsZWQgdG8gYWRkIGNhcGFiaWxpdHkgIitjYXArIiB0byBNSUQgU2VydmVyICIrbWlkU2VydmVyTmFtZSl9fXJldHVybiBjYXBRdWVyeX0pO3JldHVybiBvdXRwdXRzfWZ1bmN0aW9uIENoZWNrQ2x1c3RlcihtaWRTZXJ2ZXJOYW1lKXt2YXIgdXNlck1ldGE9R2V0TWlkVXNlck1ldGFkYXRhKG1pZFNlcnZlck5hbWUpO2lmKHVzZXJNZXRhPT09bnVsbCl7Z3MuaW5mbygiVXNlciBtZXRhZGF0YSBub3QgZm91bmQgZm9yIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKTtyZXR1cm59dmFyIGNsdXN0ZXI9bmV3IEdsaWRlUmVjb3JkKCJlY2NfYWdlbnRfY2x1c3RlciIpO2NsdXN0ZXIuYWRkUXVlcnkoIm5hbWUiLHVzZXJNZXRhLm1pZFNlcnZlckNsdXN0ZXIpO2NsdXN0ZXIucXVlcnkoKTtpZighY2x1c3Rlci5uZXh0KCkpe2dzLmluZm8oIkNsdXN0ZXIgIit1c2VyTWV0YS5taWRTZXJ2ZXJDbHVzdGVyKyIgbm90IGZvdW5kLiBDcmVhdGluZy4uLiIpO2NsdXN0ZXI9bmV3IEdsaWRlUmVjb3JkKCJlY2NfYWdlbnRfY2x1c3RlciIpO2NsdXN0ZXIuaW5pdGlhbGl6ZSgpO2NsdXN0ZXIubmFtZT11c2VyTWV0YS5taWRTZXJ2ZXJDbHVzdGVyO2NsdXN0ZXIuYWN0aXZlPXRydWU7Y2x1c3Rlci5pbnNlcnQoKX12YXIgY2x1c3Rlck1lbWJlcj1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudF9jbHVzdGVyX21lbWJlcl9tMm0iKTtjbHVzdGVyTWVtYmVyLmFkZFF1ZXJ5KCJjbHVzdGVyLm5hbWUiLHVzZXJNZXRhLm1pZFNlcnZlckNsdXN0ZXIpO2NsdXN0ZXJNZW1iZXIuYWRkUXVlcnkoImFnZW50Lm5hbWUiLG1pZFNlcnZlck5hbWUpO2NsdXN0ZXJNZW1iZXIucXVlcnkoKTtpZighY2x1c3Rlck1lbWJlci5uZXh0KCkpe2dzLmluZm8oIk1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKyIgbm90IGZvdW5kIGluIGNsdXN0ZXIgIit1c2VyTWV0YS5taWRTZXJ2ZXJDbHVzdGVyKTtjbHVzdGVyTWVtYmVyPW5ldyBHbGlkZVJlY29yZCgiZWNjX2FnZW50X2NsdXN0ZXJfbWVtYmVyX20ybSIpO2NsdXN0ZXJNZW1iZXIuaW5pdGlhbGl6ZSgpO2NsdXN0ZXJNZW1iZXIuY2x1c3Rlci5zZXREaXNwbGF5VmFsdWUodXNlck1ldGEubWlkU2VydmVyQ2x1c3Rlcik7Y2x1c3Rlck1lbWJlci5hZ2VudC5zZXREaXNwbGF5VmFsdWUobWlkU2VydmVyTmFtZSk7Y2x1c3Rlck1lbWJlci5pbnNlcnQoKX1yZXR1cm4gY2x1c3Rlck1lbWJlci5zeXNfaWQudG9TdHJpbmcoKX1mdW5jdGlvbiBWYWxpZGF0ZU1pZFNlcnZlcihtaWRTZXJ2ZXJOYW1lKXt2YXIgb3V0cHV0cz17c3VjY2VzczpmYWxzZSxzdGF0dXM6InVua25vd24iLG1pZFNlcnZlcjptaWRTZXJ2ZXJOYW1lfTt2YXIgdXNlck1ldGE9R2V0TWlkVXNlck1ldGFkYXRhKG1pZFNlcnZlck5hbWUpO2lmKHVzZXJNZXRhPT09bnVsbCl7Z3MuaW5mbygiVXNlciBtZXRhZGF0YSBub3QgZm91bmQgZm9yIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKTtvdXRwdXRzLnN0YXR1cz0ibm90IGZvdW5kIjtyZXR1cm4gb3V0cHV0c31pZihncy5uaWwodXNlck1ldGEuYWdlbnQpKXtncy5pbmZvKCJBZ2VudCBub3QgZm91bmQgZm9yIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKTtvdXRwdXRzLnN0YXR1cz0iYWdlbnQgbm90IGZvdW5kIjtyZXR1cm4gb3V0cHV0c31vdXRwdXRzLmNsdXN0ZXJNZW1iZXI9Q2hlY2tDbHVzdGVyKG1pZFNlcnZlck5hbWUpO291dHB1dHMuY2FwYWJpbGl0aWVzPUNoZWNrQ2FwYWJpbGl0aWVzKG1pZFNlcnZlck5hbWUpO3ZhciBhZ2VudD11c2VyTWV0YS5hZ2VudDtvdXRwdXRzLmFnZW50X3N0YXR1cz1hZ2VudC5zdGF0dXMudG9TdHJpbmcoKTt2YXIgbW09bmV3IGdsb2JhbC5NSURTZXJ2ZXJNYW5hZ2U7dmFyIGludmFsaWRhdGVSZXF1aXJlZD1mYWxzZTt2YXIgZXJyb3JzPW5ldyBnbG9iYWwuR2xpZGVRdWVyeSgiZWNjX2FnZW50X2lzc3VlIikud2hlcmUoIm1pZF9zZXJ2ZXIubmFtZSIsbWlkU2VydmVyTmFtZSkud2hlcmUoInN0YXRlIiwiIT0iLCJyZXNvbHZlZCIpLndoZXJlKCJzb3VyY2UiLCJVcGRhdGVQdWJsaWNLZXkiKS5zZWxlY3QoInN5c19pZCIsInN0YXRlIiwibWVzc2FnZSIpLnRvQXJyYXkoMTApO2lmKGVycm9ycy5sZW5ndGg+MCl7aW52YWxpZGF0ZVJlcXVpcmVkPXRydWU7aWYoYWdlbnQudmFsaWRhdGVkLnRvU3RyaW5nKCk9PT0idHJ1ZSIpe2lmKGFnZW50LnN0YXR1cz09IlVwIil7Z3MuaW5mbygiQWdlbnQgcmUtdmFsaWRhdGlvbiByZXF1aXJlZCBmb3IgTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUpO21tLmludmFsaWRhdGUoYWdlbnQubmFtZSk7b3V0cHV0cy5zdGF0dXM9ImludmFsaWRhdGluZyJ9fXJldHVybiBvdXRwdXRzfWlmKGFnZW50LnZhbGlkYXRlZC50b1N0cmluZygpPT09ImZhbHNlIiYmYWdlbnQuc3RhdHVzPT0iVXAiKXttbS52YWxpZGF0ZShhZ2VudC5uYW1lKTtvdXRwdXRzLnN0YXR1cz0idmFsaWRhdGluZyI7b3V0cHV0cy5zdWNjZXNzPXRydWV9ZWxzZXtvdXRwdXRzLnN0YXR1cz11c2VyTWV0YS5hZ2VudC52YWxpZGF0ZWQudG9TdHJpbmcoKTtvdXRwdXRzLnN1Y2Nlc3M9dHJ1ZX1yZXR1cm4gb3V0cHV0c31mdW5jdGlvbiBDbGVhckF1dG9TY3JpcHQobmFtZSxmb3JjZURlbGV0ZSl7dmFyIHNjcmlwdD1uZXcgR2xpZGVSZWNvcmQoInN5c2F1dG9fc2NyaXB0Iik7c2NyaXB0LmFkZFF1ZXJ5KCJuYW1lIixuYW1lKTtzY3JpcHQucXVlcnkoKTtpZihzY3JpcHQubmV4dCgpKXtpZihmb3JjZURlbGV0ZSl7c2NyaXB0LmRlbGV0ZVJlY29yZCgpO3JldHVybiJzeXNhdXRvX3NjcmlwdCAiK25hbWUrIiBkZWxldGVkIn1lbHNle3ZhciBsYXN0TW9kaWZpZWQ9bmV3IEdsaWRlRGF0ZVRpbWUoc2NyaXB0LnN5c19jcmVhdGVkX29uKTt2YXIgbm93PW5ldyBHbGlkZURhdGVUaW1lO3ZhciBtaW5zPWdzLmRhdGVEaWZmKGxhc3RNb2RpZmllZCxub3csdHJ1ZSkvNjA7aWYobWlucz5TWVNfQVVUT19TQ1JJUFRfRVhQSVJZX01JTlVURVMpe3NjcmlwdC5kZWxldGVSZWNvcmQoKTtyZXR1cm4ic3lzYXV0b19zY3JpcHQgIituYW1lKyIgZGVsZXRlZCAtIFRpbWUgRWxhcHNlZDogIittaW5zfWVsc2V7cmV0dXJuInN5c2F1dG9fc2NyaXB0ICIrbmFtZSsiIG5vdCBleHBpcmVkLiBNaW51dGVzIEVsYXBzZWQ6ICIrbWluc319fWVsc2V7cmV0dXJuInN5c2F1dG9fc2NyaXB0ICIrbmFtZSsiIG5vdCBmb3VuZCJ9fXZhciByZXN1bHRzPVZhbGlkYXRlTWlkU2VydmVyKE1JRF9TRVJWRVJfTkFNRSk7aWYocmVzdWx0cy5zdWNjZXNzKXtyZXN1bHRzLnN5c19zY3JpcHRfYXV0bz1DbGVhckF1dG9TY3JpcHQoU1lTX0FVVE9fU0NSSVBUX05BTUUsZmFsc2UpfWVsc2V7cmVzdWx0cy5zeXNfc2NyaXB0X2F1dG89Q2xlYXJBdXRvU2NyaXB0KFNZU19BVVRPX1NDUklQVF9OQU1FLGZhbHNlKX1ncy5pbmZvKEpTT04uc3RyaW5naWZ5KHJlc3VsdHMsbnVsbCwyKSk7Jw0KICAgICRzeXNTY3JpcHRCb2R5LnNjcmlwdCA9ICRzY3JpcHRIZWFkZXIgKyAkc2NyaXB0QmFzZQ0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ3JlYXRpbmcgc3lzYXV0b19zY3JpcHQgcmVjb3JkIGluIFNOIG5hbWU6ICRTY3JpcHROYW1lLiBFeHBpcnk6ICRUaW1lb3V0TWludXRlcyBtaW51dGVzIg0KICAgICRDcmVhdGVSZXF1ZXN0ID0gQHsNCiAgICAgICAgVXJpICAgICAgICAgPSAnL2FwaS9ub3cvdGFibGUvc3lzYXV0b19zY3JpcHQ/c3lzcGFybV90cmFuc2FjdGlvbl9zY29wZT1nbG9iYWwnDQogICAgICAgIEJvZHkgICAgICAgID0gKCRzeXNTY3JpcHRCb2R5IHwgQ29udmVydFRvLUpzb24gLURlcHRoIDMpDQogICAgICAgIENvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nDQogICAgICAgIE1ldGhvZCAgICAgID0gJ1BPU1QnDQogICAgfQ0KICAgICRDcmVhdGVSZXNwb25zZSA9IEludm9rZS1TTk9XV2ViUmVxdWVzdCBAQ3JlYXRlUmVxdWVzdCAtVXNlUmVzdE1ldGhvZA0KICAgIHJldHVybiBAew0KICAgICAgICBuYW1lICAgPSAkU2NyaXB0TmFtZQ0KICAgICAgICBzeXNfaWQgPSAkQ3JlYXRlUmVzcG9uc2UucmVzdWx0LnN5c19pZA0KICAgIH0NCn0NCg0KZnVuY3Rpb24gSW52b2tlLVNOT1dNSURWYWxpZGF0ZSB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUNCiAgICApDQogICAgJE1pZFNlcnZlciA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnZWNjX2FnZW50JyAtUXVlcnkgIm5hbWU9JE1pZFNlcnZlck5hbWUiIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgIGlmICggLW5vdCAkTWlkU2VydmVyKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgbm90IGZvdW5kIg0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgaWYgKC1ub3QgJE1pZFNlcnZlci5wdWJsaWNfa2V5KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgZG9lcyBub3QgaGF2ZSBhIHB1YmxpYyBrZXkiDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICAkVXNlclJlY29yZCA9IEdldC1TTk9XVXNlciAtUXVlcnkgInVzZXJfbmFtZT1qYXZhc2NyaXB0OmdzLmdldFVzZXJOYW1lKCkiIC1GaWVsZHMgJ3VzZXJfbmFtZScNCiAgICBTZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVN5c19JRCAkTWlkU2VydmVyLnN5c19pZCAtUHJvcGVydGllcyBAew0KICAgICAgICB2YWxpZGF0ZWQgICAgPSAndHJ1ZScNCiAgICAgICAgdmFsaWRhdGVkX2J5ID0gJFVzZXJSZWNvcmQudXNlcl9uYW1lDQogICAgICAgICMgMjAyNS0wNS0wOCAwMjoyMDo1MQ0KICAgICAgICB2YWxpZGF0ZWRfYXQgPSAoR2V0LURhdGUgLUZvcm1hdCAneXl5eS1NTS1kZCBISDptbTpzcycgLUFzVVRDKQ0KICAgIH0NCiAgICAkRWNjUXVldWUgPSBOZXctU05PV09iamVjdCAtVGFibGUgJ2VjY19xdWV1ZScgLVByb3BlcnRpZXMgQHsNCiAgICAgICAgYWdlbnQgICAgPSAibWlkLnNlcnZlci4ke01pZFNlcnZlck5hbWV9Ig0KICAgICAgICBzb3VyY2UgICA9ICdyZXN0YXJ0U2VydmljZScNCiAgICAgICAgc2VxdWVuY2UgPSBbZ3VpZF06Ok5ld0d1aWQoKS5Ub1N0cmluZygnTicpDQogICAgICAgIHF1ZXVlICAgID0gJ291dHB1dCcNCiAgICAgICAgdG9waWMgICAgPSAnU3lzdGVtQ29tbWFuZCcNCiAgICB9IC1QYXNzVGhydQ0KICAgIGlmICgkUXVldWVTeXNJZCA9ICRFY2NRdWV1ZS5zeXNfaWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDb21tYW5kIHNlbnQgdG8gTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBbc3lzX2lkOiAkUXVldWVTeXNJZF0iDQogICAgICAgICRFY2NSZXNwb25zZSA9IFdhaXQtU05PV0VjY1F1ZXVlUmVzcG9uc2UgLVF1ZXVlU3lzSWQgJFF1ZXVlU3lzSWQgLVRpbWVvdXRTZWNvbmRzIDEyMA0KICAgICAgICBpZiAoJEVjY1Jlc3BvbnNlIC1hbmQgJEVjY1Jlc3BvbnNlLnN0YXRlIC1lcSAncmVhZHknKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIk1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgdmFsaWRhdGVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgICAgIHJldHVybiAkRWNjUmVzcG9uc2UNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byB2YWxpZGF0ZSBNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIg0KICAgICAgICAgICAgcmV0dXJuICRudWxsDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEludm9rZS1TTk9XTUlESW52YWxpZGF0ZSB7IA0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRNaWRTZXJ2ZXJOYW1lDQogICAgKQ0KICAgICRNaWRTZXJ2ZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVF1ZXJ5ICJuYW1lPSRNaWRTZXJ2ZXJOYW1lIiB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICBpZiAoIC1ub3QgJE1pZFNlcnZlcikgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIG5vdCBmb3VuZCINCiAgICAgICAgcmV0dXJuICRudWxsDQogICAgfQ0KICAgIFNldC1TTk9XT2JqZWN0IC1UYWJsZSAnZWNjX2FnZW50JyAtU3lzX0lEICRNUi5zeXNfaWQgLVByb3BlcnRpZXMgQHsNCiAgICAgICAgdmFsaWRhdGVkICAgID0gJycNCiAgICAgICAgdmFsaWRhdGVkX2J5ID0gJycNCiAgICAgICAgIyAyMDI1LTA1LTA4IDAyOjIwOjUxDQogICAgICAgIHZhbGlkYXRlZF9hdCA9ICcnDQogICAgICAgIHB1YmxpY19rZXkgICA9ICcnDQogICAgfQ0KICAgICRFY2NRdWV1ZSA9IE5ldy1TTk9XT2JqZWN0IC1UYWJsZSAnZWNjX3F1ZXVlJyAtUHJvcGVydGllcyBAew0KICAgICAgICBhZ2VudCAgICA9ICJtaWQuc2VydmVyLiR7TWlkU2VydmVyTmFtZX0iDQogICAgICAgIG5hbWUgICAgID0gJ0ludmFsaWRhdGUnDQogICAgICAgIHNvdXJjZSAgID0gJ2RlbGV0ZV9taWRfa2V5cGFpcicNCiAgICAgICAgc2VxdWVuY2UgPSBbZ3VpZF06Ok5ld0d1aWQoKS5Ub1N0cmluZygnTicpDQogICAgICAgIHF1ZXVlICAgID0gJ291dHB1dCcNCiAgICAgICAgdG9waWMgICAgPSAnU3lzdGVtQ29tbWFuZCcNCiAgICB9IC1QYXNzVGhydQ0KICAgIGlmICgkUXVldWVTeXNJZCA9ICRFY2NRdWV1ZS5zeXNfaWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDb21tYW5kIHNlbnQgdG8gTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBbc3lzX2lkOiAkUXVldWVTeXNJZF0iDQogICAgICAgICRFY2NSZXNwb25zZSA9IFdhaXQtU05PV0VjY1F1ZXVlUmVzcG9uc2UgLVF1ZXVlU3lzSWQgJFF1ZXVlU3lzSWQNCiAgICAgICAgaWYgKCRFY2NSZXNwb25zZSAtYW5kICRFY2NSZXNwb25zZS5zdGF0ZSAtZXEgJ3JlYWR5Jykgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIGludmFsaWRhdGVkIHN1Y2Nlc3NmdWxseSINCiAgICAgICAgICAgIHJldHVybiAkRWNjUmVzcG9uc2UNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byBpbnZhbGlkYXRlIE1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUiDQogICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gV2FpdC1TTk9XRWNjUXVldWVSZXNwb25zZSB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJFF1ZXVlU3lzSWQsDQogICAgICAgIFtpbnRdJFRpbWVvdXRTZWNvbmRzID0gMzYwDQogICAgKQ0KICAgICRTdGFydFRpbWUgPSBHZXQtRGF0ZQ0KICAgICRFbmRUaW1lID0gJFN0YXJ0VGltZS5BZGRTZWNvbmRzKCRUaW1lb3V0U2Vjb25kcykNCiAgICAkRWNjUmVzcG9uc2UgPSAkbnVsbA0KICAgIHdoaWxlICgoR2V0LURhdGUpIC1sdCAkRW5kVGltZSkgew0KICAgICAgICAkRWNjUmVzcG9uc2UgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19xdWV1ZScgLVF1ZXJ5ICJyZXNwb25zZV90bz0kKCRRdWV1ZVN5c0lkKV5xdWV1ZT1pbnB1dCINCiAgICAgICAgaWYgKCRFY2NSZXNwb25zZSAtYW5kICRFY2NSZXNwb25zZS5zdGF0ZSAtZXEgJ3JlYWR5Jykgew0KICAgICAgICAgICAgcmV0dXJuICRFY2NSZXNwb25zZQ0KICAgICAgICB9DQogICAgICAgIFN0YXJ0LVNsZWVwIC1TZWNvbmRzIDENCiAgICB9DQogICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiVGltZW91dCByZWFjaGVkIHdhaXRpbmcgZm9yIGVjY19xdWV1ZSByZXNwb25zZSAkKCRRdWV1ZVN5c0lkKSINCn0NCg0KZnVuY3Rpb24gV2FpdC1TTk9XVGFibGVSZWNvcmQgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRUYWJsZSwNCiAgICAgICAgW3N0cmluZ10kUXVlcnksDQogICAgICAgIFtpbnRdJFRpbWVvdXRTZWNvbmRzID0gMzYwDQogICAgKQ0KICAgICRTdGFydFRpbWUgPSBHZXQtRGF0ZQ0KICAgICRFbmRUaW1lID0gJFN0YXJ0VGltZS5BZGRTZWNvbmRzKCRUaW1lb3V0U2Vjb25kcykNCiAgICAkUmVjb3JkID0gJG51bGwNCiAgICB3aGlsZSAoKEdldC1EYXRlKSAtbHQgJEVuZFRpbWUpIHsNCiAgICAgICAgJFJlY29yZCA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAkVGFibGUgLVF1ZXJ5ICRRdWVyeQ0KICAgICAgICBpZiAoJFJlY29yZCkgew0KICAgICAgICAgICAgcmV0dXJuICRSZWNvcmQNCiAgICAgICAgfQ0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIldhaXRpbmcgZm9yIHRhYmxlIHJlY29yZCBbJFRhYmxlXSB3aXRoIHF1ZXJ5IFskUXVlcnldIg0KICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyAxDQogICAgfQ0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIlRpbWVvdXQgcmVhY2hlZCB3YWl0aW5nIGZvciB0YWJsZSByZWNvcmQgWyRUYWJsZV0gd2l0aCBzeXNfaWQgWyRTeXNJZF0iDQp9DQoNCmZ1bmN0aW9uIEludm9rZS1TTk9XTUlEQ29tbWFuZCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUsDQogICAgICAgIFtzdHJpbmddJENvbW1hbmQsDQogICAgICAgIFtpbnRdJFRpbWVvdXRTZWNvbmRzID0gMzYwDQogICAgKQ0KICAgICRNaWRTZXJ2ZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVF1ZXJ5ICJuYW1lPSRNaWRTZXJ2ZXJOYW1lIiB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICBpZiAoIC1ub3QgJE1pZFNlcnZlcikgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIG5vdCBmb3VuZCINCiAgICAgICAgcmV0dXJuICRudWxsDQogICAgfQ0KICAgIFdyaXRlLUhvc3QgIlNlbmRpbmcgY29tbWFuZCB0byBNSUQgU2VydmVyICRDb21tYW5kIg0KICAgICRQYXlsb2FkID0gW3htbF0iPD94bWwgdmVyc2lvbj0nMS4wJyBlbmNvZGluZz0nVVRGLTgnPz48cGFyYW1ldGVycz48cGFyYW1ldGVyIG5hbWU9J25hbWUnIHZhbHVlPSdpZCcvPjwvcGFyYW1ldGVycz4iDQogICAgJFBheWxvYWQucGFyYW1ldGVycy5wYXJhbWV0ZXIudmFsdWUgPSAkQ29tbWFuZA0KICAgICRFY2NRdWV1ZSA9IE5ldy1TTk9XT2JqZWN0IC1UYWJsZSAnZWNjX3F1ZXVlJyAtUHJvcGVydGllcyBAew0KICAgICAgICBhZ2VudCAgID0gIm1pZC5zZXJ2ZXIuJHtNaWRTZXJ2ZXJOYW1lfSINCiAgICAgICAgbmFtZSAgICA9ICdSdW5Db21tYW5kJw0KICAgICAgICBwYXlsb2FkID0gJFBheWxvYWQuT3V0ZXJYbWwNCiAgICAgICAgcXVldWUgICA9ICdvdXRwdXQnDQogICAgICAgIHRvcGljICAgPSAnQ29tbWFuZCcNCiAgICB9IC1QYXNzVGhydQ0KICAgICRTdGFydFRpbWUgPSBHZXQtRGF0ZQ0KICAgIGlmICgkUXVldWVTeXNJZCA9ICRFY2NRdWV1ZS5zeXNfaWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDb21tYW5kIHNlbnQgdG8gTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBbc3lzX2lkOiAkUXVldWVTeXNJZF0iDQogICAgICAgICRFY2NSZXNwb25zZSA9IFdhaXQtU05PV0VjY1F1ZXVlUmVzcG9uc2UgLVF1ZXVlU3lzSWQgJFF1ZXVlU3lzSWQgLVRpbWVvdXRTZWNvbmRzICRUaW1lb3V0U2Vjb25kcw0KICAgICAgICAkUmVzcG9uc2VQYXlsb2FkID0gW3htbF0kRWNjUmVzcG9uc2UucGF5bG9hZA0KICAgICAgICByZXR1cm4gW29yZGVyZWRdQHsNCiAgICAgICAgICAgIFN0ZE91dCAgICAgICAgICA9ICRSZXNwb25zZVBheWxvYWQucmVzdWx0cy5yZXN1bHQuc3Rkb3V0IA0KICAgICAgICAgICAgU3RkRXJyICAgICAgICAgID0gJFJlc3BvbnNlUGF5bG9hZC5yZXN1bHRzLnJlc3VsdC5zdGRlcnINCiAgICAgICAgICAgIFJlcXVlc3QgICAgICAgICA9ICRFY2NRdWV1ZQ0KICAgICAgICAgICAgUmVzcG9uc2UgICAgICAgID0gJEVjY1Jlc3BvbnNlDQogICAgICAgICAgICBTdGF0dXMgICAgICAgICAgPSAkRWNjUmVzcG9uc2Uuc3RhdGUNCiAgICAgICAgICAgIFRpbWUgICAgICAgICAgICA9ICRFY2NSZXNwb25zZS5zeXNfdXBkYXRlZF9vbg0KICAgICAgICAgICAgRHVyYXRpb24gICAgICAgID0gKEdldC1EYXRlKSAtICRTdGFydFRpbWUNCiAgICAgICAgICAgIER1cmF0aW9uU2Vjb25kcyA9IChHZXQtRGF0ZSkgLSAkU3RhcnRUaW1lIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgVG90YWxTZWNvbmRzDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTUlERG93bmxvYWRGYWN0cyB7DQogICAgcGFyYW0oDQogICAgICAgICMgeGFuYWR1LTA3LTAyLTIwMjRfX3BhdGNoNGItMDEtMTUtMjAyNV8wMi0xMS0yMDI1XzE3MzMNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkpXQ0KICAgICAgICBbVmFsaWRhdGVQYXR0ZXJuKCdeW2EtekEtWjAtOVwtX10rJCcpXQ0KICAgICAgICAkQnVpbGRUYWcsDQogICAgICAgIFtWYWxpZGF0ZVNldCgnbWlkLWxpbnV4LWNvbnRhaW5lci1yZWNpcGUnLCAnbWlkLXdpbmRvd3MtaW5zdGFsbGVyJywgJ21pZC1saW51eC1pbnN0YWxsZXItcnBtJywgJ21pZC1saW51eC1pbnN0YWxsZXItZGViJyldDQogICAgICAgICRQYWNrYWdlID0gJ21pZC1saW51eC1jb250YWluZXItcmVjaXBlJywNCiAgICAgICAgJEFyY2hpdGVjdHVyZSA9ICdsaW51eC54ODYtNjQnDQogICAgKQ0KICAgICRQYXJ0cyA9ICRCdWlsZFRhZyAtc3BsaXQgJ18nDQogICAgJEJ1aWxkRGF0ZSA9ICgkUGFydHMgfCBTZWxlY3QtT2JqZWN0IC1MYXN0IDIpIC1qb2luICdfJw0KICAgICRCdWlsZFN0YW1wID0gJEJ1aWxkVGFnDQogICAgJE91dCA9IFtvcmRlcmVkXUB7DQogICAgICAgIFBhY2thZ2UgICAgICA9ICRQYWNrYWdlDQogICAgICAgIEFyY2hpdGVjdHVyZSA9ICRBcmNoaXRlY3R1cmUNCiAgICAgICAgQnVpbGREYXRlICAgID0gJEJ1aWxkRGF0ZQ0KICAgICAgICBCdWlsZFN0YW1wICAgPSAkQnVpbGRTdGFtcA0KICAgIH0NCiAgICAkdXJsX2RhdGUgPSAoJEJ1aWxkRGF0ZSAtc3BsaXQgJ18nKVswXSAtc3BsaXQgJy0nIA0KICAgICRwYWNrYWdlRm9sZGVyID0gQCgNCiAgICAgICAgJHVybF9kYXRlWzJdLA0KICAgICAgICAkdXJsX2RhdGVbMF0sDQogICAgICAgICR1cmxfZGF0ZVsxXQ0KICAgICkgLWpvaW4gJy8nDQogICAgJFBhY2thZ2VFeHRlbnNpb24gPSBzd2l0Y2ggKCRQYWNrYWdlKSB7DQogICAgICAgICdtaWQtbGludXgtY29udGFpbmVyLXJlY2lwZScgeyAnemlwJyB9DQogICAgICAgICdtaWQtd2luZG93cy1pbnN0YWxsZXInIHsgJ2V4ZScgfQ0KICAgICAgICAnbWlkLWxpbnV4LWluc3RhbGxlci1ycG0nIHsgJ3JwbScgfQ0KICAgICAgICAnbWlkLWxpbnV4LWluc3RhbGxlci1kZWInIHsgJ2RlYicgfQ0KICAgIH0NCiAgICAjUmVtb3ZlIC1kZWIgYW5kIC1ycG0gZnJvbSBwYWNrYWdlIG5hbWUNCiAgICAkUGFja2FnZU5hbWUgPSAkUGFja2FnZSAtcmVwbGFjZSAnLShkZWJ8cnBtKSQnDQogICAgJE91dC5QYWNrYWdlRmlsZU5hbWUgPSAiJFBhY2thZ2VOYW1lLiRCdWlsZFN0YW1wLiRBcmNoaXRlY3R1cmUuJFBhY2thZ2VFeHRlbnNpb24iDQogICAgJGJhc2VVcmkgPSAnaHR0cHM6Ly9pbnN0YWxsLnNlcnZpY2Utbm93LmNvbS9nbGlkZS9kaXN0cmlidXRpb24vYnVpbGRzL3BhY2thZ2UvYXBwLXNpZ25lZC97MH0nIC1mICRQYWNrYWdlTmFtZQ0KICAgICRPdXQuUGFja2FnZVVyaSA9ICIkYmFzZVVyaS8kcGFja2FnZUZvbGRlci8kKCRPdXQuUGFja2FnZUZpbGVOYW1lKSINCiAgICAkT3V0DQp9DQoNCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBQcml2YXRlIEZ1bmN0aW9ucyAoRG9ja2VyL1BvZG1hbikNCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpmdW5jdGlvbiBHZXQtRG9ja2VyUG9kbWFuQ29tbWFuZCB7DQogICAgaWYgKCRlbnY6RE9DS0VSX0NPTU1BTkQpIHsNCiAgICAgICAgJGVudjpET0NLRVJfQ09NTUFORA0KICAgIH0NCiAgICBlbHNlaWYgKChHZXQtQ29tbWFuZCBwb2RtYW4gLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgICdwb2RtYW4nDQogICAgfQ0KICAgIGVsc2VpZiAoKEdldC1Db21tYW5kIGRvY2tlciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgJ2RvY2tlcicNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIGRvY2tlciBvciBwb2RtYW4gY29tbWFuZCBmb3VuZC4gQ2Fubm90IHJlc29sdmUgbG9jYWwgaW1hZ2VzJw0KICAgICAgICAkbnVsbA0KICAgIH0NCn0NCg0KZnVuY3Rpb24gR2V0LURvY2tlclBvZG1hbkltYWdlU3RhdGUgew0KICAgICRJbWFnZVRhZ3MgPSBAKCkNCiAgICAkRG9ja2VyQ29tbWFuZCA9IEdldC1Eb2NrZXJQb2RtYW5Db21tYW5kDQogICAgJEltYWdlcyA9ICgmICREb2NrZXJDb21tYW5kIGltYWdlIGxzIC0tZm9ybWF0ICd7ey5SZXBvc2l0b3J5fX18fHt7LlRhZ319fHx7ey5EaWdlc3R9fScpDQogICAgZm9yZWFjaCAoJEltYWdlIGluICRJbWFnZXMpIHsNCiAgICAgICAgJE5hbWVSZWdleCA9ICdeKD88UmVwb3NpdG9yeT4uKylcfFx8KD88VGFnPi4rKVx8XHwoPzxEaWdlc3Q+LispJCcNCg0KICAgICAgICBpZiAoJEltYWdlIC1tYXRjaCAkTmFtZVJlZ2V4KSB7DQogICAgICAgICAgICAkUCA9ICRtYXRjaGVzWydSZXBvc2l0b3J5J10gLXNwbGl0ICcvJywgMg0KICAgICAgICAgICAgJEltYWdlVGFncyArPSBbUFNDdXN0b21PYmplY3RdQHsNCiAgICAgICAgICAgICAgICBSZWdpc3RyeSAgPSAkcFswXQ0KICAgICAgICAgICAgICAgIEltYWdlTmFtZSA9ICRwWzFdDQogICAgICAgICAgICAgICAgTmFtZSAgICAgID0gJE1hdGNoZXNbJ1RhZyddDQogICAgICAgICAgICAgICAgRGlnZXN0ICAgID0gJG1hdGNoZXNbJ0RpZ2VzdCddDQogICAgICAgICAgICB9ICANCiAgICAgICAgfQ0KICAgIH0gDQogICAgJEltYWdlVGFncyB8IEdyb3VwLU9iamVjdCAtUHJvcGVydHkgSW1hZ2VOYW1lIHwgRm9yRWFjaC1PYmplY3Qgew0KICAgICAgICBbUFNDdXN0b21PYmplY3RdQHsNCiAgICAgICAgICAgIE5hbWUgICAgID0gJF8uTmFtZQ0KICAgICAgICAgICAgUmVnaXN0cnkgPSAkXy5Hcm91cFswXS5SZWdpc3RyeQ0KICAgICAgICAgICAgVGFncyAgICAgPSBAKCRfLkdyb3VwIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgTmFtZSwgRGlnZXN0KQ0KICAgICAgICB9DQogICAgfSB8IFNvcnQtT2JqZWN0IC1Qcm9wZXJ0eSBOYW1lDQp9DQoNCmZ1bmN0aW9uIEdldC1Eb2NrZXJQb2RtYW5Eb2NrZXJGaWxlQ29udGVudCB7DQogICAgaWYgKCRlbnY6U05fTUlEX0NVU1RPTV9ET0NLRVJGSUxFX0JBU0U2NCkgew0KICAgICAgICAkZG9ja2VyRmlsZSA9IFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0U3RyaW5nKFtTeXN0ZW0uQ29udmVydF06OkZyb21CYXNlNjRTdHJpbmcoJGVudjpTTl9NSURfQ1VTVE9NX0RPQ0tFUkZJTEVfQkFTRTY0KSkNCiAgICB9DQogICAgZWxzZWlmIChUZXN0LVBhdGggIiRQU1NjcmlwdFJvb3QvRG9ja2VyZmlsZS5taWRjdXN0b20iKSB7DQogICAgICAgICRkb2NrZXJGaWxlID0gR2V0LUNvbnRlbnQgLVBhdGggKCIkUFNTY3JpcHRSb290L0RvY2tlcmZpbGUubWlkY3VzdG9tIikgLVJhdw0KICAgIH0NCiAgICBlbHNlaWYgKCRlbnY6U05fTUlEX0NVU1RPTV9ET0NLRVJGSUxFX1BBVEgpIHsNCiAgICAgICAgJGRvY2tlckZpbGUgPSBHZXQtQ29udGVudCAtUGF0aCAkZW52OlNOX01JRF9DVVNUT01fRE9DS0VSRklMRV9QQVRIIC1SYXcNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICAkZG9ja2VyRmlsZQ0KfQ0KDQpmdW5jdGlvbiBNZXJnZS1Eb2NrZXJQb2RtYW5IYXNoVGFibGVzIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW2hhc2h0YWJsZV0gJGRlZmF1bHQsICMgWW91ciBvcmlnaW5hbCBzZXQNCiAgICAgICAgW2hhc2h0YWJsZV0gJHVwcGVuZCAjIFRoZSBzZXQgeW91IHdhbnQgdG8gdXBkYXRlL2FwcGVuZCB0byB0aGUgb3JpZ2luYWwgc2V0DQogICAgKQ0KICAgICRkZWZhdWx0MSA9ICRkZWZhdWx0LkNsb25lKCkNCiAgICBmb3JlYWNoICgka2V5IGluICR1cHBlbmQuS2V5cykgew0KICAgICAgICBpZiAoJGRlZmF1bHQxLkNvbnRhaW5zS2V5KCRrZXkpKSB7DQogICAgICAgICAgICAkZGVmYXVsdDEuUmVtb3ZlKCRrZXkpDQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuICRkZWZhdWx0MSArICR1cHBlbmQNCn0NCg0KIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBTZXJ2aWNlTm93IE1JRCBUb29scyAtIFZhdWx0IE1hbmFnZW1lbnQgRnVuY3Rpb25zDQojPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIFRoaXMgc2NyaXB0IHByb3ZpZGVzIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgc2VjcmV0cyBpbiBQb3dlclNoZWxsIFNlY3JldFN0b3JlDQojIG9yIEF6dXJlIEtleSBWYXVsdCBmb3IgdXNlIHdpdGggU2VydmljZU5vdyBhbmQgQXp1cmUgZW52aXJvbm1lbnRzLg0KIw0KIyBGdW5jdGlvbnM6DQojIC0gUmVzb2x2ZS1TTk9XTWlkU2VjcmV0TWFuYWdlbWVudFZhdWx0OiBDb25maWd1cmUgYW5kIHJlZ2lzdGVyIGEgc2VjcmV0IHZhdWx0DQojIC0gU2V0LUpzb25TZWNyZXQgLyBHZXQtSnNvblNlY3JldDogU3RvcmUgYW5kIHJldHJpZXZlIEpTT04tZm9ybWF0dGVkIHNlY3JldHMNCiMgLSBTZXQtU05PV01pZEVudmlyb25tZW50U2VjcmV0IC8gUmVzb2x2ZS1TTk9XTUlERW52aXJvbm1lbnRBdXRoOiBNYW5hZ2UgU2VydmljZU5vdyBjcmVkZW50aWFscw0KIyAtIFNldC1TTk9XTWlkQXp1cmVFbnZpcm9ubWVudFNlY3JldCAvIFJlc29sdmUtU05PV01pZEF6dXJlRW52aXJvbm1lbnRTZWNyZXRzOiBNYW5hZ2UgQXp1cmUgY3JlZGVudGlhbHMNCiMNCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiMgRVhBTVBMRVMNCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiMgRXhhbXBsZSAxOiBSZWdpc3RlciBhIHZhdWx0DQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojICMgVXNlIFBvd2VyU2hlbGwgU2VjcmV0U3RvcmUgKGRlZmF1bHQpDQojICREZWZhdWx0VmF1bHQgPSBSZXNvbHZlLVNOT1dNaWRTZWNyZXRNYW5hZ2VtZW50VmF1bHQgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0JyAtVXNlQXp1cmVLZXlWYXVsdDokZmFsc2UNCiMNCiMgIyBVc2UgQXp1cmUgS2V5VmF1bHQgd2l0aCBtZXRhZGF0YQ0KIyBSZXNvbHZlLVNOT1dNaWRTZWNyZXRNYW5hZ2VtZW50VmF1bHQgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0JyAtVXBkYXRlTWV0YWRhdGEgLVZhdWx0TWV0YWRhdGEgQHsNCiMgICAgIEVudmlyb25tZW50TmFtZSA9ICdUZXN0Jw0KIyAgICAgU3Vic2NyaXB0aW9uSWQgID0gJzEyMzQ1Njc4LTEyMzQtMTIzNC0xMjM0LTEyMzQ1Njc4OTAxMicNCiMgfQ0KIw0KIyBFeGFtcGxlIDI6IFNlcnZpY2VOb3cgQ3JlZGVudGlhbHMgTWFuYWdlbWVudA0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgIyBTdG9yZSBTZXJ2aWNlTm93IGNyZWRlbnRpYWxzDQojIFNldC1TTk9XTWlkRW52aXJvbm1lbnRTZWNyZXQgLVVzZXJuYW1lIGFkbWluIC1JbnN0YW5jZSBkZXYxOTUyMjYgLVBhc3N3b3JkICgkZW52OlNOX1BBU1NXT1JEIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQgLUZvcmNlKSBgDQojICAgICAtU2VjcmV0TmFtZSAnc25vdy1jb25uZWN0aW9uLXVudHMtanNvbicgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0Jw0KIw0KIyAjIFJldHJpZXZlIFNlcnZpY2VOb3cgY3JlZGVudGlhbHMgYW5kIHNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMNCiMgUmVzb2x2ZS1TTk9XTUlERW52aXJvbm1lbnRBdXRoIC1TZWNyZXROYW1lICdzbm93LWNvbm5lY3Rpb24tc2J4LWpzb24nIC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RWYXVsdCcNCiMNCiMgRXhhbXBsZSAzOiBBenVyZSBDcmVkZW50aWFscyBNYW5hZ2VtZW50DQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgIyBTdG9yZSBBenVyZSBjcmVkZW50aWFscw0KIyAkY2xpZW50U2VjcmV0ID0gQ29udmVydFRvLVNlY3VyZVN0cmluZyAtU3RyaW5nICJ5b3VyLWNsaWVudC1zZWNyZXQiIC1Bc1BsYWluVGV4dCAtRm9yY2UNCiMgU2V0LVNOT1dNaWRBenVyZUVudmlyb25tZW50U2VjcmV0IC1UZW5hbnRJZCAieW91ci10ZW5hbnQtaWQiIC1TdWJzY3JpcHRpb25JZCAieW91ci1zdWJzY3JpcHRpb24taWQiIGANCiMgICAgIC1DbGllbnRJZCAieW91ci1jbGllbnQtaWQiIC1QcmluY2lwYWxJZCAieW91ci1wcmluY2lwYWwtaWQiIC1DbGllbnRTZWNyZXQgJGNsaWVudFNlY3JldCBgDQojICAgICAtU2VjcmV0TmFtZSAnYXp1cmUtY29ubmVjdGlvbi1zYngtanNvbicgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0Jw0KIw0KIyAjIFJldHJpZXZlIGFuZCBzZXQgQXp1cmUgZW52aXJvbm1lbnQgdmFyaWFibGVzDQojIFJlc29sdmUtU05PV01pZEF6dXJlRW52aXJvbm1lbnRTZWNyZXRzIC1TZWNyZXROYW1lICdhenVyZS1jb25uZWN0aW9uLXNieC1qc29uJyAtVmF1bHROYW1lICdQU1Nub3dUZXN0VmF1bHQnDQojDQojIEV4YW1wbGUgNDogQ29weSBzZWNyZXRzIGJldHdlZW4gdmF1bHRzDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyBSZXNvbHZlLVNOT1dNSURFbnZpcm9ubWVudEF1dGggLVNlY3JldE5hbWUgJ3Nub3ctY29ubmVjdGlvbi1zYngtanNvbicgLVZhdWx0TmFtZSAnUFNTbm93VGVzdEF6VmF1bHQnIHwgDQojICAgICBTZXQtSnNvblNlY3JldCAtU2VjcmV0TmFtZSAnc25vdy1jb25uZWN0aW9uLXNieC1qc29uJyAtVmF1bHROYW1lICdQU1Nub3dUZXN0VmF1bHQnDQojDQojPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01pZFNlY3JldE1hbmFnZW1lbnRWYXVsdCB7DQogICAgW0NtZGxldEJpbmRpbmcoKV0NCiAgICBwYXJhbSgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZSwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW3N3aXRjaF0kVXNlQXp1cmVLZXlWYXVsdCwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW3N0cmluZ10kQXp1cmVLZXlWYXVsdE5hbWUsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJEF6dXJlU3Vic2NyaXB0aW9uSWQsDQoNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbaGFzaHRhYmxlXSRWYXVsdE1ldGFkYXRhID0gQHt9LA0KDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW3N3aXRjaF0kVXBkYXRlTWV0YWRhdGENCiAgICApDQogICAgJFZhdWx0TWV0YWRhdGEgKz0gW2hhc2h0YWJsZV1Aew0KICAgICAgICBWYXVsdE5hbWUgICAgICAgICAgID0gJFZhdWx0TmFtZQ0KICAgICAgICBVc2VBenVyZUtleVZhdWx0ICAgID0gJFVzZUF6dXJlS2V5VmF1bHQNCiAgICAgICAgQXp1cmVLZXlWYXVsdE5hbWUgICA9ICRBenVyZUtleVZhdWx0TmFtZQ0KICAgICAgICBBenVyZVN1YnNjcmlwdGlvbklkID0gJEF6dXJlU3Vic2NyaXB0aW9uSWQNCiAgICAgICAgVXBkYXRlVGltZXN0YW1wICAgICA9IChHZXQtRGF0ZSkuVG9TdHJpbmcoJ3l5eXktTU0tZGRUSEg6bW06c3MnKQ0KICAgIH0NCiAgICAjIFByZXBhcmUgdmF1bHQgY29uZmlndXJhdGlvbiBiYXNlZCBvbiB0eXBlDQogICAgaWYgKCRVc2VBenVyZUtleVZhdWx0KSB7DQogICAgICAgICMgVmVyaWZ5IEF6dXJlIGNvbnRleHQNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICRjb250ZXh0ID0gR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU3RvcA0KICAgICAgICAgICAgaWYgKC1ub3QgJGNvbnRleHQpIHsNCiAgICAgICAgICAgICAgICB0aHJvdyAiTm8gQXp1cmUgY29udGV4dCBmb3VuZC4gUGxlYXNlIGNvbm5lY3QgdG8gQXp1cmUgZmlyc3Qgd2l0aCBDb25uZWN0LUF6QWNjb3VudC4iDQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgICMgVXNlIHByb3ZpZGVkIHN1YnNjcmlwdGlvbiBJRCBvciBjdXJyZW50IG9uZQ0KICAgICAgICAgICAgJHN1YnNjcmlwdGlvbklkID0gJEF6dXJlU3Vic2NyaXB0aW9uSWQgPyAkQXp1cmVTdWJzY3JpcHRpb25JZCA6ICRjb250ZXh0LlN1YnNjcmlwdGlvbi5JZA0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFVzZSB0aGUgcHJvdmlkZWQgS2V5VmF1bHQgbmFtZSBvciBkZWZhdWx0IHRvIHRoZSBWYXVsdE5hbWUgcGFyYW1ldGVyDQogICAgICAgICAgICAka2V5VmF1bHRUb1VzZSA9IGlmICgkQXp1cmVLZXlWYXVsdE5hbWUpIHsgJEF6dXJlS2V5VmF1bHROYW1lIH0gZWxzZSB7ICRWYXVsdE5hbWUgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFByZXBhcmUgcGFyYW1ldGVycyBmb3IgQXp1cmUgS2V5VmF1bHQNCiAgICAgICAgICAgICR2YXVsdENvbmZpZyA9IEB7DQogICAgICAgICAgICAgICAgTW9kdWxlTmFtZSAgICAgID0gJ0F6LktleVZhdWx0Jw0KICAgICAgICAgICAgICAgIFZhdWx0UGFyYW1ldGVycyA9IEB7DQogICAgICAgICAgICAgICAgICAgIEFaS1ZhdWx0TmFtZSAgID0gJGtleVZhdWx0VG9Vc2UNCiAgICAgICAgICAgICAgICAgICAgU3Vic2NyaXB0aW9uSWQgPSAkc3Vic2NyaXB0aW9uSWQNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgY2F0Y2ggew0KICAgICAgICAgICAgV3JpdGUtRXJyb3IgIkF6dXJlIEtleVZhdWx0IGNvbmZpZ3VyYXRpb24gZmFpbGVkOiAkXyINCiAgICAgICAgICAgIHJldHVybg0KICAgICAgICB9DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICAjIFNldHVwIGZvciBQb3dlclNoZWxsIFNlY3JldFN0b3JlDQogICAgICAgICRSZXF1aXJlZE1vZHVsZXMgPSBAKA0KICAgICAgICAgICAgJ01pY3Jvc29mdC5Qb3dlclNoZWxsLlNlY3JldE1hbmFnZW1lbnQnLA0KICAgICAgICAgICAgJ01pY3Jvc29mdC5Qb3dlclNoZWxsLlNlY3JldFN0b3JlJw0KICAgICAgICApDQogICAgICAgICRSZXF1aXJlZE1vZHVsZXMgfCBGb3JFYWNoLU9iamVjdCB7DQogICAgICAgICAgICBpZiAoLW5vdCAoR2V0LU1vZHVsZSAtTmFtZSAkXyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtTGlzdEF2YWlsYWJsZSkpIHsNCiAgICAgICAgICAgICAgICBJbnN0YWxsLU1vZHVsZSAtTmFtZSAkXyAtRm9yY2UgLVNjb3BlIEN1cnJlbnRVc2VyDQogICAgICAgICAgICAgICAgaWYgKCRfIC1lcSAnTWljcm9zb2Z0LlBvd2VyU2hlbGwuU2VjcmV0U3RvcmUnKSB7DQogICAgICAgICAgICAgICAgICAgIEltcG9ydC1Nb2R1bGUgLU5hbWUgJF8gLUZvcmNlIC1TY29wZSBDdXJyZW50VXNlcg0KICAgICAgICAgICAgICAgICAgICBSZXNldC1TZWNyZXRTdG9yZSAtQ29uZmlybTokZmFsc2UgLUF1dGhlbnRpY2F0aW9uIE5vbmUNCiAgICAgICAgICAgICAgICAgICAgU2V0LVNlY3JldFN0b3JlQ29uZmlndXJhdGlvbiAtQXV0aGVudGljYXRpb24gTm9uZSAtU2NvcGUgQ3VycmVudFVzZXIgLUNvbmZpcm06JGZhbHNlDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICAjIENvbmZpZ3VyZSBTZWNyZXRTdG9yZQ0KICAgICAgICBTZXQtU2VjcmV0U3RvcmVDb25maWd1cmF0aW9uIC1BdXRoZW50aWNhdGlvbiBOb25lIC1TY29wZSBDdXJyZW50VXNlciAtQ29uZmlybTokZmFsc2UNCiAgICAgICAgDQogICAgICAgICMgUHJlcGFyZSBwYXJhbWV0ZXJzIGZvciBQb3dlclNoZWxsIFNlY3JldFN0b3JlDQogICAgICAgICR2YXVsdENvbmZpZyA9IEB7DQogICAgICAgICAgICBNb2R1bGVOYW1lICAgPSAnTWljcm9zb2Z0LlBvd2VyU2hlbGwuU2VjcmV0U3RvcmUnDQogICAgICAgICAgICBEZWZhdWx0VmF1bHQgPSAkdHJ1ZQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgIyBDb21tb24gZnVuY3Rpb25hbGl0eSBmb3IgYm90aCB2YXVsdCB0eXBlcw0KICAgICRleGlzdGluZ1ZhdWx0ID0gR2V0LVNlY3JldFZhdWx0IC1OYW1lICRWYXVsdE5hbWUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAkVmF1bHRNZXRhZGF0YS5WYXVsdENvbmZpZyA9ICR2YXVsdENvbmZpZw0KICAgICRNZXRhZGF0YSA9IChDb252ZXJ0VG8tSnNvbiAtSW5wdXRPYmplY3QgJFZhdWx0TWV0YWRhdGEgLURlcHRoIDQgLUNvbXByZXNzKQ0KDQogICAgaWYgKC1ub3QgJGV4aXN0aW5nVmF1bHQpIHsNCiAgICAgICAgIyBSZWdpc3RlciB0aGUgdmF1bHQgdXNpbmcgcGFyYW1ldGVycw0KICAgICAgICBSZWdpc3Rlci1TZWNyZXRWYXVsdCAtTmFtZSAkVmF1bHROYW1lIEB2YXVsdENvbmZpZw0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlZhdWx0ICRWYXVsdE5hbWUgcmVnaXN0ZXJlZCBhcyAkKCR2YXVsdENvbmZpZy5Nb2R1bGVOYW1lKSB3aXRoIHBhcmFtZXRlcnMgJCgkdmF1bHRDb25maWcuVmF1bHRQYXJhbWV0ZXJzKSINCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiU2VjcmV0IHZhdWx0ICRWYXVsdE5hbWUgYWxyZWFkeSBleGlzdHMuIg0KICAgIH0NCiAgICAkZXhpc3RpbmdNZXRhZGF0YSA9IEdldC1TZWNyZXQgLU5hbWUgJ0F6VmF1bHRNZXRhZGF0YScgLVZhdWx0ICRWYXVsdE5hbWUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLUFzUGxhaW5UZXh0DQogICAgaWYgKCRleGlzdGluZ01ldGFkYXRhKSB7DQogICAgICAgICRDdXJyZW50TWV0YWRhdGEgPSAoQ29udmVydEZyb20tSnNvbiAtSW5wdXRPYmplY3QgJGV4aXN0aW5nTWV0YWRhdGEgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLUFzSGFzaHRhYmxlKSANCiAgICB9DQogICAgaWYgKCRVcGRhdGVNZXRhZGF0YSkgew0KICAgICAgICBTZXQtU2VjcmV0IC1OYW1lICdBelZhdWx0TWV0YWRhdGEnIC1WYXVsdCAkVmF1bHROYW1lIC1TZWNyZXQgJE1ldGFkYXRhDQogICAgfQ0KICAgIA0KICAgICMgUmV0dXJuIHZhdWx0IGluZm9ybWF0aW9uDQogICAgJHJlc3VsdCA9IEB7DQogICAgICAgIFZhdWx0TmFtZSAgICAgICA9ICRWYXVsdE5hbWUNCiAgICAgICAgVmF1bHQgICAgICAgICAgID0gKEdldC1TZWNyZXRWYXVsdCAtTmFtZSAkVmF1bHROYW1lKQ0KICAgICAgICBWYXVsdFBhcmFtcyAgICAgPSAkdmF1bHRDb25maWcNCiAgICAgICAgTWV0YWRhdGEgICAgICAgID0gJFZhdWx0TWV0YWRhdGENCiAgICAgICAgQ3VycmVudE1ldGFkYXRhID0gJEN1cnJlbnRNZXRhZGF0YQ0KICAgIH0NCiAgICANCiAgICANCiAgICByZXR1cm4gJHJlc3VsdA0KfQ0KDQpmdW5jdGlvbiBTZXQtSnNvblNlY3JldCB7DQogICAgW0NtZGxldEJpbmRpbmcoKV0NCiAgICBwYXJhbSAoDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUsIFZhbHVlRnJvbVBpcGVsaW5lID0gJHRydWUpXQ0KICAgICAgICBbb2JqZWN0XSRTZWNyZXRWYWx1ZSwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRTZWNyZXROYW1lLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZQ0KICAgICkNCiAgICBwcm9jZXNzIHsNCiAgICAgICAgaWYgKC1ub3QgJFZhdWx0TmFtZSkgew0KICAgICAgICAgICAgJFZhdWx0TmFtZSA9ICdQU1Nub3dUZXN0VmF1bHQnDQogICAgICAgIH0NCiAgICAgICAgJEpzb25TZWNyZXRWYWx1ZSA9ICRTZWNyZXRWYWx1ZSB8IENvbnZlcnRUby1Kc29uIC1EZXB0aCAxMCAtQ29tcHJlc3MNCiAgICAgICAgU2V0LVNlY3JldCAtTmFtZSAkU2VjcmV0TmFtZSAtU2VjcmV0ICRKc29uU2VjcmV0VmFsdWUgLVZhdWx0ICRWYXVsdE5hbWUNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEdldC1Kc29uU2VjcmV0IHsNCiAgICBbQ21kbGV0QmluZGluZygpXQ0KICAgIHBhcmFtICgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kVmF1bHROYW1lDQogICAgKQ0KICAgIHByb2Nlc3Mgew0KICAgICAgICBpZiAoLW5vdCAkVmF1bHROYW1lKSB7DQogICAgICAgICAgICAkVmF1bHROYW1lID0gJ1BTU25vd1Rlc3RWYXVsdCcNCiAgICAgICAgfQ0KICAgICAgICAkSnNvblNlY3JldFZhbHVlID0gR2V0LVNlY3JldCAtTmFtZSAkU2VjcmV0TmFtZSAtVmF1bHQgJFZhdWx0TmFtZSAtQXNQbGFpblRleHQgLUVycm9yQWN0aW9uIENvbnRpbnVlDQogICAgICAgIGlmICgkSnNvblNlY3JldFZhbHVlKSB7DQogICAgICAgICAgICByZXR1cm4gJEpzb25TZWNyZXRWYWx1ZSB8IENvbnZlcnRGcm9tLUpzb24gLURlcHRoIDEwDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1FcnJvciAiU2VjcmV0ICckU2VjcmV0TmFtZScgbm90IGZvdW5kIGluIHZhdWx0ICckVmF1bHROYW1lJy4iIA0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBTZXQtU05PV01pZEVudmlyb25tZW50U2VjcmV0IHsNCiAgICBbQ21kbGV0QmluZGluZygpXQ0KICAgIHBhcmFtICgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJEluc3RhbmNlLA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kVXNlcm5hbWUsDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc2VjdXJlc3RyaW5nXSRQYXNzd29yZCwNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5YNTA5Q2VydGlmaWNhdGVzLlg1MDlDZXJ0aWZpY2F0ZTJdJENlcnRpZmljYXRlLA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtoYXNodGFibGVdJE1ldGFkYXRhID0gQHt9LA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZSA9ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUsDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW3N0cmluZ10kU2VjcmV0TmFtZSA9ICRTY3JpcHQ6U05fQ09OTkVDVElPTl9TRUNSRVRfTkFNRQ0KICAgICkNCiAgICBwcm9jZXNzIHsNCiAgICAgICAgJFNlY3JldFZhbHVlID0gQHsNCiAgICAgICAgICAgIEluc3RhbmNlID0gJEluc3RhbmNlDQogICAgICAgICAgICBVc2VybmFtZSA9ICRVc2VybmFtZQ0KICAgICAgICAgICAgUGFzc3dvcmQgPSAoJFBhc3N3b3JkIHwgQ29udmVydEZyb20tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCkNCiAgICAgICAgICAgIE1ldGFkYXRhID0gJE1ldGFkYXRhDQogICAgICAgIH0NCiAgICAgICAgaWYgKCRDZXJ0aWZpY2F0ZSkgew0KICAgICAgICAgICAgJFNlY3JldFZhbHVlLkNlcnRpZmljYXRlID0gQCgkQ2VydGlmaWNhdGUuRXhwb3J0Q2VydGlmaWNhdGVQZW0oKSwgJENlcnRpZmljYXRlLlByaXZhdGVLZXkuRXhwb3J0UGtjczhQcml2YXRlS2V5UGVtKCkpIC1qb2luICJgbiINCiAgICAgICAgfQ0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgJE9sZEF1dGggPSBHZXQtU05PV0F1dGggLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAgICAgICAgIFNldC1TTk9XQXV0aCAtSW5zdGFuY2UgJEluc3RhbmNlIC1DcmVkZW50aWFsIChOZXctT2JqZWN0IFBTQ3JlZGVudGlhbCgkVXNlcm5hbWUsICRQYXNzd29yZCkpDQogICAgICAgICAgICAjIFRlc3QgdGhlIGNvbm5lY3Rpb24gd2l0aCBhIHNpbXBsZSBBUEkgY2FsbA0KICAgICAgICAgICAgJFNlbGYgPSBJbnZva2UtU05PV1dlYlJlcXVlc3QgLU1ldGhvZCBHZXQgLVVSSSAnL2FwaS9ub3cvdGFibGUvc3lzX3VzZXI/c3lzcGFybV9maWVsZHM9c3lzX2lkLG5hbWUsdXNlcl9uYW1lJnN5c3Bhcm1fcXVlcnk9dXNlcl9uYW1lPWphdmFzY3JpcHQ6Z3MuZ2V0VXNlck5hbWUoKScgLVVzZVJlc3RNZXRob2QgLUVycm9yQWN0aW9uIFN0b3ANCiAgICAgICAgICAgIGlmICgkU2VsZi5yZXN1bHQpIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFNlcnZpY2VOb3cgWyQoJEluc3RhbmNlKV06ICQoJFNlbGYucmVzdWx0LnVzZXJfbmFtZSkgKCQoJFNlbGYucmVzdWx0LnN5c19pZCkpIg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiRmFpbGVkIHRvIHJldHJpZXZlIHVzZXIgaW5mb3JtYXRpb24gZnJvbSBTZXJ2aWNlTm93IGluc3RhbmNlLiBDaGVjayB5b3VyIGNyZWRlbnRpYWxzLiINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDb3VsZCBub3QgdmVyaWZ5IFNlcnZpY2VOb3cgY3JlZGVudGlhbHM6ICRfIg0KICAgICAgICAgICAgaWYgKCRPbGRBdXRoKSB7DQogICAgICAgICAgICAgICAgU2V0LVNOT1dBdXRoIC1BdXRoT2JqZWN0ICRPbGRBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIHwgT3V0LU51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBTZXQtSnNvblNlY3JldCAtU2VjcmV0VmFsdWUgJFNlY3JldFZhbHVlIC1TZWNyZXROYW1lICIkU2VjcmV0TmFtZSIgLVZhdWx0TmFtZSAkVmF1bHROYW1lDQogICAgICAgICRWYXVsdFNlY3JldHMgPSBAew0KICAgICAgICAgICAgJ3Nub3ctYXBpLXVzZXJuYW1lJyA9ICRVc2VybmFtZSB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZQ0KICAgICAgICAgICAgJ3Nub3ctYXBpLXBhc3N3b3JkJyA9ICRQYXNzd29yZA0KICAgICAgICB9DQogICAgICAgIGZvcmVhY2ggKCRrZXkgaW4gJFZhdWx0U2VjcmV0cy5LZXlzKSB7DQogICAgICAgICAgICAkQ3VycmVudFNlY3JldCA9IEdldC1TZWNyZXQgLU5hbWUgJGtleSAtVmF1bHQgJFZhdWx0TmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgaWYgKCRDdXJyZW50U2VjcmV0KSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJTZWNyZXQgJyRrZXknIGFscmVhZHkgZXhpc3RzIGluIHZhdWx0ICckVmF1bHROYW1lJy4gT3ZlcndyaXRpbmcuIg0KICAgICAgICAgICAgICAgIFNldC1TZWNyZXQgLU5hbWUgJGtleSAtU2VjdXJlU3RyaW5nU2VjcmV0ICRWYXVsdFNlY3JldHNbJGtleV0gLVZhdWx0ICRWYXVsdE5hbWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREVudmlyb25tZW50QXV0aCB7DQogICAgcHJvY2VzcyB7DQogICAgICAgICRTZWNyZXRWYWx1ZSA9IEdldC1Kc29uU2VjcmV0IC1TZWNyZXROYW1lICRTY3JpcHQ6U05fQ09OTkVDVElPTl9TRUNSRVRfTkFNRSAtVmF1bHROYW1lICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAgICAgIyBBdHRlbXB0IHRvIFNldC1TTk9XQXV0aCB3aXRoIHRoZSByZXRyaWV2ZWQgc2VjcmV0IGFuZCBxdWVyeSB0aGUgdXNlcg0KICAgICAgICBpZiAoJFNlY3JldFZhbHVlKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJSZXNvbHZlZCBTZXJ2aWNlTm93IGNyZWRlbnRpYWxzIGZvciAkKCRTZWNyZXRWYWx1ZS5JbnN0YW5jZSkgaW4gRW52aXJvbm1lbnQgJCgkU2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FKSINCiAgICAgICAgICAgICMgSWYgdGhlIGluc3RhbmNlIGlzIG5vdCBhIHByb3BlciBVUkwsIGFwcGVuZCAuc2VydmljZS1ub3cuY29tDQogICAgICAgICAgICBpZiAoJFNlY3JldFZhbHVlLkluc3RhbmNlIC1ub3RtYXRjaCAnXmh0dHBzLiokJykgew0KICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5JbnN0YW5jZSA9ICJodHRwczovLyQoJFNlY3JldFZhbHVlLkluc3RhbmNlKS5zZXJ2aWNlLW5vdy5jb20iDQogICAgICAgICAgICB9DQogICAgICAgICAgICAkU2NyaXB0OlNOX0hPU1QgPSAkU2VjcmV0VmFsdWUuSW5zdGFuY2UNCiAgICAgICAgICAgICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aCA9IEB7DQogICAgICAgICAgICAgICAgSW5zdGFuY2UgICA9ICRTZWNyZXRWYWx1ZS5JbnN0YW5jZQ0KICAgICAgICAgICAgICAgIENyZWRlbnRpYWwgPSBbcHNjcmVkZW50aWFsXTo6bmV3KCRTZWNyZXRWYWx1ZS5Vc2VybmFtZSwgKCRTZWNyZXRWYWx1ZS5QYXNzd29yZCB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZSkpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1NZXNzYWdlICJTZXR0aW5nIFNlcnZpY2VOb3cgY3JlZGVudGlhbHMgZm9yICQoJFNlY3JldFZhbHVlLkluc3RhbmNlKSBmcm9tIFZhdWx0IFNlY3JldCIgLUxldmVsIEltcG9ydGFudA0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAtTWVzc2FnZSAiRmFpbGVkIHRvIHJldHJpZXZlIHNlY3JldCAnJCgkU2NyaXB0OlNOX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUpJyBmcm9tIHZhdWx0ICckKCRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUpJy4iDQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIVtzdHJpbmddOjpJc051bGxPckVtcHR5KCRlbnY6TUlEX0lOU1RBTkNFX1VSTCkgLWFuZCAhW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJGVudjpNSURfSU5TVEFOQ0VfVVNFUk5BTUUpIGANCiAgICAgICAgICAgICAgICAtYW5kICFbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkZW52Ok1JRF9JTlNUQU5DRV9QQVNTV09SRCkpIHsNCiAgICAgICAgICAgICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aCA9IEB7DQogICAgICAgICAgICAgICAgSW5zdGFuY2UgICA9ICRlbnY6TUlEX0lOU1RBTkNFX1VSTA0KICAgICAgICAgICAgICAgIENyZWRlbnRpYWwgPSBbcHNjcmVkZW50aWFsXTo6bmV3KCRlbnY6TUlEX0lOU1RBTkNFX1VTRVJOQU1FLCAoJGVudjpNSURfSU5TVEFOQ0VfUEFTU1dPUkQgfCBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCAtRm9yY2UpKQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTWVzc2FnZSAiU2V0dGluZyBTZXJ2aWNlTm93IGNyZWRlbnRpYWxzIGZvciAkKCRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aC5JbnN0YW5jZSkgZnJvbSBNSURfSU5TVEFOQ0VfIEVudmlyb25tZW50IiAtTGV2ZWwgSW1wb3J0YW50DQogICAgICAgIH0NCiAgICAgICAgDQoNCiAgICAgICAgaWYgKCRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aCkgew0KICAgICAgICAgICAgJFNjcmlwdDpTTl9IT1NUID0gJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoLkluc3RhbmNlDQogICAgICAgICAgICAkTWlkVmVyc2lvbiA9IEdldC1TTk9XTUlEUmVjb3JkV2l0aENyZWRzIC1DcmVkZW50aWFsICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aC5DcmVkZW50aWFsIC1UYWJsZSAnc3lzX3Byb3BlcnRpZXMnIC1RdWVyeSAnbmFtZT1taWQudmVyc2lvbicgLUluc3RhbmNlICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aC5JbnN0YW5jZQ0KICAgICAgICAgICAgaWYgKCRNaWRWZXJzaW9uKSB7DQogICAgICAgICAgICAgICAgU2V0LVNOT1dBdXRoIEBTbm93RW52aXJvbm1lbnRBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFNlcnZpY2VOb3cgWyQoJFNlY3JldFZhbHVlLkluc3RhbmNlKV06ICQoJE1pZFZlcnNpb24udmFsdWUpIg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiRmFpbGVkIHRvIHJldHJpZXZlIE1JRCB2ZXJzaW9uIGZyb20gU2VydmljZU5vdyBpbnN0YW5jZS4gQ2hlY2sgeW91ciBjcmVkZW50aWFscy4iDQogICAgICAgICAgICAgICAgJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoID0gJG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoDQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBTZXQtU05PV01pZEF6dXJlRW52aXJvbm1lbnRTZWNyZXQgew0KICAgIFtDbWRsZXRCaW5kaW5nKCldDQogICAgcGFyYW0gKA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kVGVuYW50SWQsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kU3Vic2NyaXB0aW9uSWQsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kQ2xpZW50SWQsDQoNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJFByaW5jaXBhbElkLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzZWN1cmVzdHJpbmddJENsaWVudFNlY3JldCwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW1N5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuWDUwOUNlcnRpZmljYXRlcy5YNTA5Q2VydGlmaWNhdGUyXSRDZXJ0aWZpY2F0ZSwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW2hhc2h0YWJsZV0kTWV0YWRhdGEgPSBAe30sDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJEF6dXJlRW52aXJvbm1lbnROYW1lID0gJ0F6dXJlQ2xvdWQnLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbc3RyaW5nXSRTZWNyZXROYW1lID0gJFNjcmlwdDpBWl9DT05ORUNUSU9OX1NFQ1JFVF9OQU1FLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbc3RyaW5nXSRWYXVsdE5hbWUgPSAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FDQogICAgKQ0KICAgIHByb2Nlc3Mgew0KICAgICAgICAkU2VjcmV0VmFsdWUgPSBAew0KICAgICAgICAgICAgVGVuYW50SWQgICAgICAgID0gJFRlbmFudElkDQogICAgICAgICAgICBTdWJzY3JpcHRpb25JZCAgPSAkU3Vic2NyaXB0aW9uSWQNCiAgICAgICAgICAgIENsaWVudElkICAgICAgICA9ICRDbGllbnRJZA0KICAgICAgICAgICAgUHJpbmNpcGFsSWQgICAgID0gJFByaW5jaXBhbElkDQogICAgICAgICAgICBDbGllbnRTZWNyZXQgICAgPSAoJENsaWVudFNlY3JldCB8IENvbnZlcnRGcm9tLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQpDQogICAgICAgICAgICBFbnZpcm9ubWVudE5hbWUgPSAkQXp1cmVFbnZpcm9ubWVudE5hbWUNCiAgICAgICAgICAgIE1ldGFkYXRhICAgICAgICA9ICRNZXRhZGF0YQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZiAoJENlcnRpZmljYXRlKSB7DQogICAgICAgICAgICAkU2VjcmV0VmFsdWUuQ2VydGlmaWNhdGUgPSBAKCRDZXJ0aWZpY2F0ZS5FeHBvcnRDZXJ0aWZpY2F0ZVBlbSgpLCAkQ2VydGlmaWNhdGUuUHJpdmF0ZUtleS5FeHBvcnRQa2NzOFByaXZhdGVLZXlQZW0oKSkgLWpvaW4gImBuIg0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICAjIFZlcmlmeSB0aGUgY3JlZGVudGlhbHMgYXJlIHZhbGlkIGlmIHBvc3NpYmxlDQogICAgICAgIHRyeSB7DQogICAgICAgICAgICAkY29udGV4dCA9IENvbm5lY3QtQXpBY2NvdW50IC1UZW5hbnQgJFRlbmFudElkIC1TdWJzY3JpcHRpb24gJFN1YnNjcmlwdGlvbklkIGANCiAgICAgICAgICAgICAgICAtQ3JlZGVudGlhbCAoTmV3LU9iamVjdCBQU0NyZWRlbnRpYWwoJENsaWVudElkLCAkQ2xpZW50U2VjcmV0KSkgLUVudmlyb25tZW50ICRBenVyZUVudmlyb25tZW50TmFtZSBgDQogICAgICAgICAgICAgICAgLVNlcnZpY2VQcmluY2lwYWwgLUVycm9yQWN0aW9uIFN0b3AgLVNjb3BlIFByb2Nlc3MNCiAgICAgICAgICAgICMgRGlzY29ubmVjdCBpZiB0aGUgY29ubmVjdGlvbiB3YXMgc3VjY2Vzc2Z1bA0KICAgICAgICAgICAgRGlzY29ubmVjdC1BekFjY291bnQgLVNjb3BlIFByb2Nlc3MgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgDQogICAgICAgIH0NCiAgICAgICAgY2F0Y2ggew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiQ291bGQgbm90IHZlcmlmeSBBenVyZSBjcmVkZW50aWFsczogJF8iDQogICAgICAgICAgICAjIENvbnRpbnVlIGFueXdheSAtIHRoZSBzZWNyZXQgd2lsbCBzdGlsbCBiZSBzdG9yZWQNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgU2V0LUpzb25TZWNyZXQgLVNlY3JldFZhbHVlICRTZWNyZXRWYWx1ZSAtU2VjcmV0TmFtZSAkU2VjcmV0TmFtZSAtVmF1bHROYW1lICRWYXVsdE5hbWUNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01pZEF6dXJlRW52aXJvbm1lbnRTZWNyZXRzIHsNCiAgICBbQ21kbGV0QmluZGluZygpXQ0KICAgIHBhcmFtICgNCiAgICAgICAgW3N0cmluZ10kU2VjcmV0TmFtZSA9ICRTY3JpcHQ6QVpfQ09OTkVDVElPTl9TRUNSRVRfTkFNRSwNCiAgICAgICAgW3N0cmluZ10kVmF1bHROYW1lID0gJFNjcmlwdDpTTl9NSURfVkFVTFRfTkFNRSwNCiAgICAgICAgW3N3aXRjaF0kU2V0RW52aXJvbm1lbnRWYXJpYWJsZXMNCiAgICApDQogICAgcHJvY2VzcyB7DQogICAgICAgICRTZWNyZXRWYWx1ZSA9IEdldC1Kc29uU2VjcmV0IC1TZWNyZXROYW1lICRTZWNyZXROYW1lIC1WYXVsdE5hbWUgJFZhdWx0TmFtZQ0KICAgICAgICAkRW52VmFycyA9IFtvcmRlcmVkXUB7DQogICAgICAgICAgICBBWlVSRV9URU5BTlRfSUQgICAgICAgID0gJFNlY3JldFZhbHVlLlRlbmFudElkDQogICAgICAgICAgICBBWlVSRV9TVUJTQ1JJUFRJT05fSUQgID0gJFNlY3JldFZhbHVlLlN1YnNjcmlwdGlvbklkDQogICAgICAgICAgICBBWlVSRV9DTElFTlRfSUQgICAgICAgID0gJFNlY3JldFZhbHVlLkNsaWVudElkDQogICAgICAgICAgICBBWlVSRV9DTElFTlRfU0VDUkVUICAgID0gJFNlY3JldFZhbHVlLkNsaWVudFNlY3JldA0KICAgICAgICAgICAgQVpVUkVfRU5WSVJPTk1FTlRfTkFNRSA9ICRTZWNyZXRWYWx1ZS5FbnZpcm9ubWVudE5hbWUNCiAgICAgICAgfQ0KICAgICAgICBpZiAoJFNlY3JldFZhbHVlLkNlcnRpZmljYXRlKSB7DQogICAgICAgICAgICAkY2VydFBhdGggPSBbU3lzdGVtLklPLlBhdGhdOjpHZXRUZW1wRmlsZU5hbWUoKQ0KICAgICAgICAgICAgJFNlY3JldFZhbHVlLkNlcnRpZmljYXRlIHwgT3V0LUZpbGUgLUZpbGVQYXRoICRjZXJ0UGF0aCAtRW5jb2RpbmcgdXRmOA0KICAgICAgICAgICAgJEVudlZhcnMuQVpVUkVfQ0VSVElGSUNBVEVfUEFUSCA9ICRjZXJ0UGF0aA0KICAgICAgICB9DQogICAgICAgICMgU2V0IGVudmlyb25tZW50IHZhcmlhYmxlcyBpZiByZXF1ZXN0ZWQgb3IgYnkgZGVmYXVsdA0KICAgICAgICBpZiAoJFNlY3JldFZhbHVlIC1hbmQgKCRTZXRFbnZpcm9ubWVudFZhcmlhYmxlcyAtb3IgISRQU0JvdW5kUGFyYW1ldGVycy5Db250YWluc0tleSgnU2V0RW52aXJvbm1lbnRWYXJpYWJsZXMnKSkpIHsNCiAgICAgICAgICAgIGZvcmVhY2ggKCRFbnZWYXIgaW4gJEVudlZhcnMuS2V5cykgew0KICAgICAgICAgICAgICAgIGlmICgkRW52VmFyc1skRW52VmFyXSkgew0KICAgICAgICAgICAgICAgICAgICBbU3lzdGVtLkVudmlyb25tZW50XTo6U2V0RW52aXJvbm1lbnRWYXJpYWJsZSgkRW52VmFyLCAkRW52VmFyc1skRW52VmFyXSwgW1N5c3RlbS5FbnZpcm9ubWVudFZhcmlhYmxlVGFyZ2V0XTo6UHJvY2VzcykNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFZlcmJvc2UgIkVudmlyb25tZW50IHZhcmlhYmxlICckRW52VmFyJyBub3Qgc2V0LiBWYWx1ZSBpcyBudWxsIG9yIGVtcHR5LiINCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZWlmICghJFNlY3JldFZhbHVlKSB7DQogICAgICAgICAgICBXcml0ZS1FcnJvciAiRmFpbGVkIHRvIHJldHJpZXZlIHNlY3JldCAnJFNlY3JldE5hbWUnIGZyb20gdmF1bHQgJyRWYXVsdE5hbWUnLiINCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuICRFbnZWYXJzDQogICAgfQ0KfQ0KJFNjcmlwdDpDb21tYW5kQ29udGV4dCA9ICRNeUludm9jYXRpb24uTXlDb21tYW5kLk5hbWUNCiRTY3JpcHQ6U2NyaXB0UGF0aCA9IEpvaW4tUGF0aCAkUFNTY3JpcHRSb290ICRTY3JpcHQ6Q29tbWFuZENvbnRleHQNCmZ1bmN0aW9uIEdldC1TTk9XTUlEVG9vbHNNb2R1bGVDb250ZW50IHsNCiAgICAkR2xvYmFsOlNjcmlwdENvbnRlbnRzID0gR2V0LUNvbnRlbnQgLVBhdGggJFNjcmlwdDpTY3JpcHRQYXRoIC1SYXcgDQogICAgJGhlYWRlciA9ICIjIyMgQkVHSU4gJCgnUFNTbm93Lk1pZFRvb2xzLnBzbTEnKSAjIyMiDQogICAgIyBSZW1vdmUgYW55dGhpbmcgYmVmb3JlIHRoZSBoZWFkZXINCiAgICAkaGVhZGVySW5kZXggPSAkU2NyaXB0Q29udGVudHMuSW5kZXhPZigkaGVhZGVyKQ0KICAgIGlmICgkaGVhZGVySW5kZXggLWdlIDApIHsNCiAgICAgICAgIyBSZW1vdmUgZXZlcnl0aGluZyBiZWZvcmUgdGhlIGhlYWRlcg0KICAgICAgICAkU2NyaXB0Q29udGVudHMgPSAkU2NyaXB0Q29udGVudHMuU3Vic3RyaW5nKCRoZWFkZXJJbmRleCArICRoZWFkZXIuTGVuZ3RoKQ0KICAgIH0NCg0KICAgICMgUmVtb3ZlIGFueXRoaW5nIGFmdGVyIHRoZSBmb290ZXINCiAgICAkZm9vdGVyID0gIiMjIyBFTkQgJCgnUFNTbm93Lk1pZFRvb2xzLnBzbTEnKSAjIyMiDQogICAgJGZvb3RlckluZGV4ID0gJFNjcmlwdENvbnRlbnRzLkluZGV4T2YoJGZvb3RlcikNCiAgICBpZiAoJGZvb3RlckluZGV4IC1nZSAwKSB7DQogICAgICAgICRTY3JpcHRDb250ZW50cyA9ICRTY3JpcHRDb250ZW50cy5TdWJzdHJpbmcoMCwgJGZvb3RlckluZGV4ICsgJGZvb3Rlci5MZW5ndGgpDQogICAgfQ0KICAgICRTY3JpcHRDb250ZW50cw0KfQ0KIyBETyBOT1QgUkVNT1ZFIFRISVMgTElORQ0KIyMjIEVORCBQU1Nub3cuTWlkVG9vbHMucHNtMSAjIyM=",
                    "dsEnv": "[union(createArray(createObject('name', 'SN_MID_ENVIRONMENT_NAME', 'value', parameters('devopsEnvironmentName')), createObject('name', 'SN_MID_CONTEXT', 'value', 'azure'), createObject('name', 'SN_MID_BUILD_STRATEGY', 'value', 'acr'), createObject('name', 'NO_COLOR', 'value', 'true')), parameters('scriptEnvironmentVariables'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[parameters('deploymentScriptName')]",
                      "location": "[resourceGroup().location]",
                      "identity": {
                        "type": "userAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')))]": {}
                        }
                      },
                      "kind": "AzurePowerShell",
                      "properties": {
                        "environmentVariables": "[variables('dsEnv')]",
                        "forceUpdateTag": "[parameters('utcValue')]",
                        "azPowerShellVersion": "14.1",
                        "storageAccountSettings": {
                          "storageAccountName": "[variables('storageAccountName')]"
                        },
                        "containerSettings": {
                          "subnetIds": [
                            {
                              "id": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowContainerSubnetId]"
                            }
                          ]
                        },
                        "scriptContent": "[join(createArray('# GENERATED IN snow-mid-deplyoymentscript.mod.bicep', '# This function is called at the bottom of this script.', 'function SnowMidDeploymentScript {', parameters('inlineScript'), '}', '# END GENERATED FUNCTION', '# BEGIN PSSnow.MidTools.psm1 Content', base64ToString(variables('commonScriptContent')), '# END PSSnow.MidTools.psm1 Content', 'SnowMidDeploymentScript'), '\n')]",
                        "retentionInterval": "PT1H",
                        "cleanupPreference": "OnSuccess"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "scriptOutput": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('deploymentScriptName')), '2023-08-01').outputs]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('containerRegistrySubscription'), parameters('containerRegistryResourceGroup')), 'Microsoft.Resources/deployments', 'containerRegistry')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', variables('storageAccountName'), 'default', 'config')]",
                "[resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', variables('storageAccountName'), 'default', 'ServiceNowMidServers')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', 'DevopsVaultAccessPolicies')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "appendResourceGroupTags",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": {
                      "SnowEnvironments": "[parameters('devopsEnvironmentName')]"
                    }
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "5901011431715368273"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to append to the resource group"
                      }
                    }
                  },
                  "variables": {
                    "existingTags": "[resourceGroup().tags]",
                    "mergedTags": "[union(variables('existingTags'), parameters('tags'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/tags",
                      "apiVersion": "2021-01-01",
                      "name": "default",
                      "properties": {
                        "tags": "[variables('mergedTags')]"
                      }
                    }
                  ],
                  "outputs": {
                    "mergedTags": {
                      "type": "object",
                      "value": "[variables('mergedTags')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "resourceGroupId": {
              "type": "string",
              "value": "[resourceGroup().id]"
            },
            "containerRegistry": {
              "type": "object",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('containerRegistrySubscription'), parameters('containerRegistryResourceGroup')), 'Microsoft.Resources/deployments', 'containerRegistry'), '2022-09-01').outputs.containerRegistry.value]"
            },
            "keyVault": {
              "type": "object",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('keyVaultSubscription'), parameters('keyVaultResourceGroup')), 'Microsoft.Resources/deployments', parameters('keyVaultName')), '2022-09-01').outputs.keyVault.value]"
            },
            "storageAccount": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full')]"
            },
            "userAssignedIdentity": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31', 'full')]"
            },
            "midServerIdentity": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('midServerIdentityName')), '2023-01-31', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "aciNetwork"
      ]
    }
  }
}