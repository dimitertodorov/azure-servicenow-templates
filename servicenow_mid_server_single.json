{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "10054944650890396185"
    }
  },
  "parameters": {
    "devopsEnvironmentName": {
      "type": "string"
    },
    "midServerName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 16
    },
    "midServerCluster": {
      "type": "string",
      "minLength": 3,
      "maxLength": 16
    },
    "numCpu": {
      "type": "int",
      "defaultValue": 1,
      "allowedValues": [
        1,
        2,
        4,
        8
      ],
      "metadata": {
        "description": "The number of CPU cores to allocate to the MID Server container"
      }
    },
    "memoryInGB": {
      "type": "int",
      "defaultValue": 4,
      "allowedValues": [
        1,
        2,
        4,
        8,
        16
      ],
      "metadata": {
        "description": "The amount of memory in GB to allocate to the MID Server container"
      }
    },
    "customImageName": {
      "type": "string",
      "defaultValue": "snow_mid_custom"
    },
    "customDockerfileContent": {
      "type": "string",
      "defaultValue": "FROM localhost/snow_mid_server:yokohama-12-18-2024__patch1-02-21-2025_03-05-2025_2133\r\nARG AZ_PWSH_VERSION=\"14.1.0\"\r\nARG ANSIBLE_VERSION=\"9.13.0\"\r\nARG AZ_CLI_VERSION=\"2.74.0\"\r\nARG MID_USERNAME=mid\r\n\r\nUSER root\r\n\r\nRUN dnf update -y && \\\r\n    dnf install -y  ca-certificates curl gnupg && \\\r\n    curl -sL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | tee /etc/pki/rpm-gpg/microsoft.asc.gpg > /dev/null && \\\r\n    curl -sL https://packages.microsoft.com/config/rhel/9/prod.repo | tee /etc/yum.repos.d/microsoft-prod.repo && \\\r\n    dnf check-update -y && \\\r\n    dnf install -y azure-cli-${AZ_CLI_VERSION}-1.el9 && \\\r\n    dnf install -y https://github.com/PowerShell/PowerShell/releases/download/v7.5.1/powershell-7.5.1-1.rh.x86_64.rpm && \\\r\n    dnf clean all -y\r\n\r\nUSER $MID_USERNAME\r\n\r\nRUN pwsh -C \"Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted\" && \\\r\n    pwsh -C \"Install-Module -Name Az -MinimumVersion ${AZ_PWSH_VERSION} -MaximumVersion ${AZ_PWSH_VERSION} -Force -AllowClobber -Scope CurrentUser -Repository PSGallery -AcceptLicense\" && \\\r\n    pwsh -C \"Install-Module -Name PSDepend -Force -AllowClobber -Scope CurrentUser -Repository PSGallery -AcceptLicense\" && \\\r\n    pwsh -C \"Install-Module -Name InvokeBuild -Force -AllowClobber -Scope CurrentUser -Repository PSGallery -AcceptLicense\"\r\n\r\nENTRYPOINT [\"/opt/snc_mid_server/init\", \"start\"]\r\n"
    },
    "forceBuildCustomImage": {
      "type": "bool",
      "defaultValue": false
    }
  },
  "variables": {
    "storageAccountName": "[format('snst{0}{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
    "keyVaultName": "[format('snkv-{0}-{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('GetBuildContext-{0}', parameters('midServerName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentScriptName": {
            "value": "[format('SnowMidTools-{0}', parameters('midServerName'))]"
          },
          "userAssignedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowDevopsIdentity]"
          },
          "inlineScript": {
            "value": "      Resolve-SNOWMIDPrereqs\r\n      $connectResults = Connect-SNOWMIDAzureFromEnvironment\r\n      $buildContext = Resolve-SNOWMIDBuildContext\r\n      $SnowConn = Resolve-SNOWMIDEnvironmentAuth\r\n      $BuildResults = Build-SNOWMIDSnowMidImage\r\n      $DeploymentScriptOutputs['BuildContext'] = $buildContext\r\n      $DeploymentScriptOutputs['BuildResults'] = $BuildResults\r\n      $UserResult = Set-SNOWMIDServerUser -MidServerName $env:MID_SERVER_NAME -MidServerCluster $env:MID_SERVER_CLUSTER\r\n      foreach($key in $UserResult.Keys) {\r\n        $DeploymentScriptOutputs[$key] = $UserResult[$key]\r\n      }\r\n      $DeploymentScriptOutputs['sysauto_script'] = try {\r\n        Start-SNOWMIDValidationScript -MidServerName $env:MID_SERVER_NAME -ErrorAction Stop\r\n      } catch {\r\n        Write-PSFMessage -Level Warning \"Failed to start validation script. Ensure the MID Server has the necessary permissions.\"\r\n        $null\r\n      }\r\n"
          },
          "devopsEnvironmentName": {
            "value": "[parameters('devopsEnvironmentName')]"
          },
          "tags": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags]"
          },
          "scriptEnvironmentVariables": {
            "value": [
              {
                "name": "SN_MID_CUSTOM_DOCKERFILE_BASE64",
                "value": "[base64(parameters('customDockerfileContent'))]"
              },
              {
                "name": "MID_SERVER_NAME",
                "value": "[parameters('midServerName')]"
              },
              {
                "name": "MID_SERVER_CLUSTER",
                "value": "[parameters('midServerCluster')]"
              },
              {
                "name": "SN_MID_CUSTOM_IMAGE_NAME",
                "value": "[parameters('customImageName')]"
              },
              {
                "name": "SN_MID_FORCE_BUILD_CUSTOM",
                "value": "[if(parameters('forceBuildCustomImage'), 'true', 'false')]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "14056090992735312894"
            }
          },
          "parameters": {
            "devopsEnvironmentName": {
              "type": "string",
              "defaultValue": "unts",
              "maxLength": 5,
              "metadata": {
                "description": "The name of the environment. This will be used to tag, and identify resources."
              }
            },
            "deploymentScriptName": {
              "type": "string",
              "defaultValue": "[format('SnowMidTools-{0}', parameters('devopsEnvironmentName'))]"
            },
            "userAssignedIdentityName": {
              "type": "string"
            },
            "inlineScript": {
              "type": "string",
              "defaultValue": "Resolve-SNOWMIDPrereqs\r\n$ctx = Resolve-SNOWMIDBuildContext\r\nforeach($key in $Ctx.Keys) {\r\n  $DeploymentScriptOutputs[$key] = $Ctx[$key]\r\n}\r\n$DeploymentScriptOutputs['ctxJson'] = ($ctx | ConvertTo-Json -Depth 10)\r\n"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "scriptEnvironmentVariables": {
              "type": "array",
              "defaultValue": []
            },
            "tags": {
              "type": "object",
              "defaultValue": "[resourceGroup().tags]"
            }
          },
          "variables": {
            "storageAccountName": "[format('snst{0}{1}', parameters('devopsEnvironmentName'), uniqueString(resourceGroup().id))]",
            "commonScriptContent": "DQojIEluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIGZvciBTTk9XTWlkVG9vbHMNCmZ1bmN0aW9uIEluaXRpYWxpemUtU05PV01pZFRvb2xzIHsNCiAgICBpZiAoIShHZXQtQ29tbWFuZCAtTmFtZSAnV3JpdGUtUFNGTWVzc2FnZScgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgIGlmIChHZXQtTW9kdWxlIC1OYW1lICdQU0ZyYW1ld29yaycgLUxpc3RBdmFpbGFibGUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpIHsNCiAgICAgICAgICAgIEltcG9ydC1Nb2R1bGUgLU5hbWUgJ1BTRnJhbWV3b3JrJyAtRm9yY2UgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLUhvc3QgIlBTRnJhbWV3b3JrIG1vZHVsZSBub3QgZm91bmQuIEluc3RhbGxpbmcuLi4iDQogICAgICAgICAgICBJbnN0YWxsLU1vZHVsZSAtTmFtZSBQU0ZyYW1ld29yayAtRm9yY2UgLUFsbG93Q2xvYmJlciAtU2NvcGUgQ3VycmVudFVzZXINCiAgICAgICAgICAgIEltcG9ydC1Nb2R1bGUgLU5hbWUgUFNGcmFtZXdvcmsgLUZvcmNlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtSG9zdCAnUFNGcmFtZXdvcmsgbW9kdWxlIHdhcyBub3QgZm91bmQuIEluc3RhbGxpbmcgaW50byBDdXJyZW50VXNlciBzY29wZS4nDQogICAgfQ0KICAgICMgV2hlbiB1c2luZyB0aGlzIGFzIGEgTW9kdWxlLCB5b3UgbXVzdCB1c2UgSW1wb3J0LU1vZHVsZSB3aXRoIHRoZSAtRm9yY2UgcGFyYW1ldGVyLA0KICAgICMgdG8gZW5zdXJlIHRoZSBtb2R1bGUgaXMgcmVsb2FkZWQgaWYgY2hhbmdpbmcgYW55IG9mIHRoZSBTTl9NSURfKiBlbnZpcm9ubWVudCB2YXJpYWJsZXMuDQogICAgJERlZmF1bHRFbnYgPSBAew0KICAgICAgICBTTl9NSURfRU5WSVJPTk1FTlRfTkFNRSAgPSAnbG9jYWwnDQogICAgICAgIFNOX01JRF9DT05URVhUICAgICAgICAgICA9ICdsb2NhbCcNCiAgICAgICAgU05fTUlEX0JVSUxEX1NUUkFURUdZICAgID0gJ3BvZG1hbicNCiAgICAgICAgU05fTUlEX0lNQUdFX05BTUUgICAgICAgID0gJ3Nub3dfbWlkX2Jhc2UnDQogICAgICAgIFNOX01JRF9DVVNUT01fSU1BR0VfTkFNRSA9ICdzbm93X21pZF9jdXN0b20nDQogICAgfQ0KICAgIGZvcmVhY2ggKCRrZXkgaW4gJERlZmF1bHRFbnYuS2V5cykgew0KICAgICAgICAkZW52VmFsdWUgPSBbRW52aXJvbm1lbnRdOjpHZXRFbnZpcm9ubWVudFZhcmlhYmxlKCRrZXksIFtTeXN0ZW0uRW52aXJvbm1lbnRWYXJpYWJsZVRhcmdldF06OlByb2Nlc3MpDQogICAgICAgIGlmIChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkZW52VmFsdWUpKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBWZXJib3NlICIka2V5IGlzIG5vdCBzZXQuIERlZmF1bHRpbmcgdG8gJyQoJERlZmF1bHRFbnZbJGtleV0pJy4iDQogICAgICAgICAgICBTZXQtVmFyaWFibGUgLU5hbWUgJGtleSAtU2NvcGUgU2NyaXB0IC1WYWx1ZSAkRGVmYXVsdEVudlska2V5XQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgVmVyYm9zZSAiJGtleSBpcyBzZXQgdG8gJyRlbnZWYWx1ZScuIg0KICAgICAgICAgICAgU2V0LVZhcmlhYmxlIC1OYW1lICRrZXkgLVNjb3BlIFNjcmlwdCAtVmFsdWUgJGVudlZhbHVlDQogICAgICAgIH0NCiAgICB9DQoNCiAgICAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FID0gInNubWlkdmF1bHQtJHtTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0tJHtTTl9NSURfQ09OVEVYVH0iLlRvTG93ZXIoKQ0KICAgICRTY3JpcHQ6U05fQ09OTkVDVElPTl9TRUNSRVRfTkFNRSA9ICJzbm93LWNvbm5lY3Rpb24tJHtTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0tanNvbiIuVG9Mb3dlcigpDQogICAgJFNjcmlwdDpBWl9DT05ORUNUSU9OX1NFQ1JFVF9OQU1FID0gImF6LWNvbm5lY3Rpb24tJHtTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0tanNvbiIuVG9Mb3dlcigpDQogICAgJFNjcmlwdDpQU0RlcGVuZGVuY2llcyA9IEB7DQogICAgICAgICdjaGVyaWNoaXRhL1BTU25vdycgICAgICAgICAgICAgICAgICAgICA9IEB7DQogICAgICAgICAgICBTb3VyY2UgICAgID0gJ0dpdEh1YlJlcG8nDQogICAgICAgICAgICBSZXBvc2l0b3J5ID0gJ2NoZXJpY2hpdGEvUFNTbm93Jw0KICAgICAgICAgICAgVmVyc2lvbiAgICA9ICcxLjQuMCcNCiAgICAgICAgICAgIFRhcmdldCAgICAgPSAnQ3VycmVudFVzZXInDQogICAgICAgICAgICBQYXJhbWV0ZXJzID0gQHsNCiAgICAgICAgICAgICAgICBFeHRyYWN0UGF0aCA9ICdzcmMvJw0KICAgICAgICAgICAgICAgIFRhcmdldFR5cGUgID0gJ1BhcmFsbGVsJw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgICdNaWNyb3NvZnQuUG93ZXJTaGVsbC5TZWNyZXRNYW5hZ2VtZW50JyA9IEB7DQogICAgICAgICAgICBUYXJnZXQgPSAnQ3VycmVudFVzZXInDQogICAgICAgIH0NCiAgICAgICAgJ01pY3Jvc29mdC5Qb3dlclNoZWxsLlNlY3JldFN0b3JlJyAgICAgID0gQHsNCiAgICAgICAgICAgIFRhcmdldCA9ICdDdXJyZW50VXNlcicNCiAgICAgICAgfQ0KICAgIH0NCiAgICAkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0ID0gJG51bGwNCiAgICAkU2NyaXB0OlNub3dBekNvbnRleHQgPSAkbnVsbA0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAtTWVzc2FnZSAiU05NSURCdWlsZENvbnRleHQgYW5kIFNub3dBekNvbnRleHQgaW5pdGlhbGl6ZWQuIFdpdGggcGFyYW1ldGVycyAkKEdldC1TTk9XTWlkVG9vbHNTdGF0dXMgfCBDb252ZXJ0VG8tSnNvbiAtRGVwdGggNSkiDQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTWlkVG9vbHNTdGF0dXMgew0KICAgICRTdGF0dXMgPSBAew0KICAgICAgICBTTl9NSURfRU5WSVJPTk1FTlRfTkFNRSAgPSAkU2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FDQogICAgICAgIFNOX01JRF9DT05URVhUICAgICAgICAgICA9ICRTY3JpcHQ6U05fTUlEX0NPTlRFWFQNCiAgICAgICAgU05fTUlEX0JVSUxEX1NUUkFURUdZICAgID0gJFNjcmlwdDpTTl9NSURfQlVJTERfU1RSQVRFR1kNCiAgICAgICAgU05fTUlEX0lNQUdFX05BTUUgICAgICAgID0gJFNjcmlwdDpTTl9NSURfSU1BR0VfTkFNRQ0KICAgICAgICBTTl9NSURfQ1VTVE9NX0lNQUdFX05BTUUgPSAkU2NyaXB0OlNOX01JRF9DVVNUT01fSU1BR0VfTkFNRQ0KICAgICAgICBTTl9NSURfVkFVTFRfTkFNRSAgICAgICAgPSAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FDQogICAgfQ0KICAgIHJldHVybiAkU3RhdHVzDQp9DQoNCiMgU2VjdGlvbiAxOiBBenVyZS9CdWlsZCBGdW5jdGlvbnMNCmZ1bmN0aW9uIEFzc2VydC1TTk9XTUlEQXpDbGkgew0KICAgIGlmICghKEdldC1Db21tYW5kIC1OYW1lICdheicgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgLU1lc3NhZ2UgJ0F6dXJlIENMSSBub3QgZm91bmQuIEluc3RhbGxpbmcgQXp1cmUgQ0xJJw0KICAgICAgICBSZXNvbHZlLVNOT1dNSURBenVyZUNsaSB8IE91dC1OdWxsDQogICAgICAgIENvbm5lY3QtU05PV01JREF6dXJlRnJvbUVudmlyb25tZW50IHwgT3V0LU51bGwNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JRFZhdWx0IHsNCiAgICBzd2l0Y2ggKCRTY3JpcHQ6U05fTUlEX0NPTlRFWFQpIHsNCiAgICAgICAgJ2xvY2FsJyB7DQogICAgICAgICAgICAkVmF1bHRQYXJhbWV0ZXJzID0gQHsNCiAgICAgICAgICAgICAgICBWYXVsdE5hbWUgPSAkU05fTUlEX1ZBVUxUX05BTUUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFJlc29sdmUtU05PV01pZFNlY3JldE1hbmFnZW1lbnRWYXVsdCBAVmF1bHRQYXJhbWV0ZXJzIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgJ2F6dXJlJyB7DQogICAgICAgICAgICBpZiAoISRTY3JpcHQ6U05NSURCdWlsZENvbnRleHQuS2V5VmF1bHQubmFtZSkgew0KICAgICAgICAgICAgICAgIFdyaXRlLUVycm9yICJLZXkgVmF1bHQgbm90IGZvdW5kIGZvciBlbnZpcm9ubWVudCAkKCRlbnY6U05fTUlEX0VOVklST05NRU5UX05BTUUpIg0KICAgICAgICAgICAgICAgIHJldHVybiAkbnVsbA0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgJFZhdWx0UGFyYW1ldGVycyA9IEB7DQogICAgICAgICAgICAgICAgVmF1bHROYW1lICAgICAgICAgICA9ICRTTl9NSURfVkFVTFRfTkFNRQ0KICAgICAgICAgICAgICAgIEF6dXJlS2V5VmF1bHROYW1lICAgPSAkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0LktleVZhdWx0Lk5hbWUNCiAgICAgICAgICAgICAgICBBenVyZVN1YnNjcmlwdGlvbklkID0gJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dC5TdWJzY3JpcHRpb25JZA0KICAgICAgICAgICAgICAgIFVzZUF6dXJlS2V5VmF1bHQgICAgPSAkdHJ1ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgUmVzb2x2ZS1TTk9XTWlkU2VjcmV0TWFuYWdlbWVudFZhdWx0IEBWYXVsdFBhcmFtZXRlcnMgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAgICAgfQ0KICAgICAgICBkZWZhdWx0IHsNCiAgICAgICAgICAgIFdyaXRlLUVycm9yICJVbmtub3duIGNvbnRleHQgdHlwZTogJFNjcmlwdDpTTl9NSURfQ09OVEVYVC4gVXNlICdsb2NhbCcgb3IgJ2F6dXJlJy4iDQogICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTUlEUHJlcmVxcyB7DQogICAgaWYgKC1ub3QgKEdldC1Db21tYW5kICdJbnN0YWxsLURlcGVuZGVuY3knIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgJ0luc3RhbGxpbmcgUFNEZXBlbmQgbW9kdWxlJw0KICAgICAgICBJbnN0YWxsLU1vZHVsZSAtTmFtZSBQU0RlcGVuZCAtRm9yY2UgLUFsbG93Q2xvYmJlciAtU2NvcGUgQ3VycmVudFVzZXINCiAgICB9DQogICAgSW1wb3J0LU1vZHVsZSAtTmFtZSBQU0RlcGVuZCAtRm9yY2UgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLVNjb3BlIEdsb2JhbA0KICAgIEdldC1EZXBlbmRlbmN5IC1JbnB1dE9iamVjdCAkU2NyaXB0OlBTRGVwZW5kZW5jaWVzIHwgSW5zdGFsbC1EZXBlbmRlbmN5DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREF6dXJlQ2xpIHsNCiAgICBpZiAoLW5vdCAoR2V0LUNvbW1hbmQgJ2F6JyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdBenVyZSBDTEkgbm90IGZvdW5kLiBJbnN0YWxsaW5nIEF6dXJlIENMSScNCiAgICAgICAgaWYgKChHZXQtQ29tbWFuZCAtTmFtZSBhcHQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgJ0luc3RhbGxpbmcgQXp1cmUgQ0xJIHVzaW5nIGFwdCcNCiAgICAgICAgICAgICRJbnN0YWxsUmVzdWx0cyA9IChjdXJsIC1zTCBodHRwczovL2FrYS5tcy9JbnN0YWxsQXp1cmVDTElEZWIgfCBiYXNoKQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBDb25uZWN0LVNOT1dNSURBenVyZUZyb21FbnZpcm9ubWVudCB7DQogICAgcGFyYW0gKFtzdHJpbmddJFNjb3BlID0gJ1Byb2Nlc3MnKQ0KICAgICRBekNsaUV4aXN0cyA9IChHZXQtQ29tbWFuZCAnYXonIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKQ0KICAgICRPdXQgPSBbb3JkZXJlZF1AeyANCiAgICAgICAgVGVuYW50SWQgICAgPSAkZW52OkFaVVJFX1RFTkFOVF9JRA0KICAgICAgICBFbnZpcm9ubWVudCA9ICRlbnY6U05fTUlEX0VOVklST05NRU5UX05BTUUNCiAgICAgICAgQXpDb250ZXh0ICAgPSAoR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkNCiAgICAgICAgQ2xpQ29udGV4dCAgPSBpZiAoJEF6Q2xpRXhpc3RzKSB7IChheiBhY2NvdW50IHNob3cgLW8ganNvbiAyPjEgfCBDb252ZXJ0RnJvbS1Kc29uKSB9IGVsc2UgeyAkbnVsbCB9DQogICAgfQ0KICAgIGlmICgkZW52OklERU5USVRZX0hFQURFUikgew0KICAgICAgICBpZiAoJGVudjpBWlVSRV9DTElFTlRfSUQgLWFuZCAkZW52OkFaVVJFX0NMSUVOVF9TRUNSRVQgLWFuZCAkZW52OkFaVVJFX1RFTkFOVF9JRCkgeyANCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAnSWdub3JpbmcgTVNJLiBVc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXMgaW5zdGVhZCcgDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBpZiAoKCRBekNsaUV4aXN0cykgLWFuZCAhKCRPdXQuQ2xpQ29udGV4dCkpIHsNCiAgICAgICAgICAgICAgICAkT3V0LkNsaUNvbnRleHQgPSBheiBsb2dpbiAtLWlkZW50aXR5IHwgQ29udmVydEZyb20tSnNvbiB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgICAgICAgICAkT3V0LkNsaVZlcnNpb24gPSBheiB2ZXJzaW9uIHwgQ29udmVydEZyb20tSnNvbg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgJE91dC5BekNvbnRleHQgPSBDb25uZWN0LUF6QWNjb3VudCAtSWRlbnRpdHkgLVNjb3BlICRTY29wZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgJFNjcmlwdDpTbm93QXpDb250ZXh0ID0gJE91dA0KICAgICAgICAgICAgcmV0dXJuICRPdXQNCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoLW5vdCAoJGVudjpBWlVSRV9DTElFTlRfSUQgLWFuZCAkZW52OkFaVVJFX0NMSUVOVF9TRUNSRVQgLWFuZCAkZW52OkFaVVJFX1RFTkFOVF9JRCkpIHsNCiAgICAgICAgaWYgKCEkT3V0LkF6Q29udGV4dCAtYW5kICgkQXpDbGlFeGlzdHMgLWFuZCAhKCRPdXQuQ2xpQ29udGV4dCkpKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICdObyBBenVyZSBjb250ZXh0IGZvdW5kLiBBWlVSRV9DTElFTlRfSUQsIEFaVVJFX0NMSUVOVF9TRUNSRVQsIGFuZCBBWlVSRV9URU5BTlRfSUQgbXVzdCBiZSBzZXQnDQogICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXNpbmcgRXhpc3RpbmcgQXp1cmUgY29udGV4dDogJCgkT3V0LkF6Q29udGV4dC5OYW1lKWBuIENMSSBDb250ZXh0OiAkKCRPdXQuQ2xpQ29udGV4dCB8IENvbnZlcnRUby1Kc29uIC1EZXB0aCA1KSINCiAgICAgICAgICAgIHJldHVybiAkT3V0DQogICAgICAgIH0NCiAgICB9DQogICAgaWYgKCRBekNsaUV4aXN0cyAtYW5kICEoJE91dC5DbGlDb250ZXh0KSkgew0KICAgICAgICAkT3V0LkNsaUNvbnRleHQgPSBheiBsb2dpbiAtLXNlcnZpY2UtcHJpbmNpcGFsIC0tdXNlcm5hbWUgJGVudjpBWlVSRV9DTElFTlRfSUQgLS1wYXNzd29yZCAkZW52OkFaVVJFX0NMSUVOVF9TRUNSRVQgLS10ZW5hbnQgJGVudjpBWlVSRV9URU5BTlRfSUQgfCBDb252ZXJ0RnJvbS1Kc29uIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICAkT3V0LkNsaVZlcnNpb24gPSBheiB2ZXJzaW9uIHwgQ29udmVydEZyb20tSnNvbg0KICAgIH0NCiAgICAkTG9naW5QYXJhbXMgPSBAew0KICAgICAgICBUZW5hbnRJZCA9ICRlbnY6QVpVUkVfVEVOQU5UX0lEOyBTZXJ2aWNlUHJpbmNpcGFsID0gJHRydWUNCiAgICAgICAgQ3JlZGVudGlhbCA9IChOZXctT2JqZWN0IFBTQ3JlZGVudGlhbCAkZW52OkFaVVJFX0NMSUVOVF9JRCwgKCRlbnY6QVpVUkVfQ0xJRU5UX1NFQ1JFVCB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZSkpDQogICAgICAgIFNjb3BlID0gJFNjb3BlDQogICAgfQ0KICAgIGlmICgkZW52OkFaVVJFX1NVQlNDUklQVElPTl9JRCkgeyAkTG9naW5QYXJhbXMuU3Vic2NyaXB0aW9uID0gJGVudjpBWlVSRV9TVUJTQ1JJUFRJT05fSUQgfQ0KICAgIA0KICAgICRPdXQuQXpDb250ZXh0ID0gQ29ubmVjdC1BekFjY291bnQgQExvZ2luUGFyYW1zDQogICAgJFNjcmlwdDpTbm93QXpDb250ZXh0ID0gJE91dA0KICAgIHJldHVybiAkT3V0DQp9DQpmdW5jdGlvbiBSZXNvbHZlLVNOT1dNSURDdXN0b21SZXNvdXJjZXMgew0KICAgIHBhcmFtICgNCiAgICAgICAgW3N0cmluZ10kU3Vic2NyaXB0aW9uSWQsDQogICAgICAgIFtzdHJpbmddJFJlc291cmNlR3JvdXBOYW1lID0gJGVudjpBWlVSRV9SRVNPVVJDRV9HUk9VUF9OQU1FDQogICAgKQ0KICAgICRjdHggPSBHZXQtQXpDb250ZXh0IC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgaWYgKC1ub3QgJGN0eCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICdObyBBenVyZSBjb250ZXh0IGZvdW5kLiBQbGVhc2UgbG9naW4gdG8gQXp1cmUnDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICAkU3Vic2NyaXB0aW9uSWQgPSBpZiAoJFN1YnNjcmlwdGlvbklkKSB7ICRTdWJzY3JpcHRpb25JZCB9IGVsc2UgeyAkY3R4LlN1YnNjcmlwdGlvbi5JZCB9DQogICAgaWYgKC1ub3QgJFN1YnNjcmlwdGlvbklkKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIFN1YnNjcmlwdGlvbiBJRCBmb3VuZC4gUGxlYXNlIGxvZ2luIHRvIEF6dXJlJw0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQoNCiAgICAkUmVzb3VyY2VRdWVyeSA9IEAiDQogICAgICAgIHJlc291cmNlcyB8IHdoZXJlIHRhZ3NbJ1Nub3dFbnZpcm9ubWVudCddID09ICcke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0nDQogICAgICAgIHwgcHJvamVjdCByZXNvdXJjZUlkPWlkLCBuYW1lLCB0eXBlLCByZXNvdXJjZUdyb3VwLCB0YWdzLCBwcm9wZXJ0aWVzLCBzdWJzY3JpcHRpb25JZCwgbG9jYXRpb24NCiAgICAgICAgfCBvcmRlciBieSB0eXBlIGFzYywgbmFtZSBhc2MNCiJADQoNCiAgICBXcml0ZS1QU0ZNZXNzYWdlICJRdWVyeWluZyBBenVyZSBSZXNvdXJjZSBHcmFwaCB3aXRoIHF1ZXJ5OiBgbiRSZXNvdXJjZVF1ZXJ5Ig0KICAgICRyZXNvdXJjZXMgPSBTZWFyY2gtQXpHcmFwaCAtUXVlcnkgJFJlc291cmNlUXVlcnkNCg0KICAgIGlmICgkcmVzb3VyY2VzLkNvdW50IC1lcSAwKSB7DQogICAgICAgIFdyaXRlLUVycm9yICJObyByZXNvdXJjZXMgZm91bmQgZm9yIGVudmlyb25tZW50ICR7U2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FfSINCiAgICAgICAgcmV0dXJuICRudWxsDQogICAgfQ0KDQogICAgJE91dHB1dHMgPSBbb3JkZXJlZF1Aew0KICAgICAgICBTdWJzY3JpcHRpb25JZCAgPSAkU3Vic2NyaXB0aW9uSWQNCiAgICAgICAgUmVzb3VyY2VHcm91cCAgID0gJFJlc291cmNlR3JvdXBOYW1lDQogICAgICAgIEVudmlyb25tZW50TmFtZSA9ICRTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUUNCiAgICAgICAgU3RvcmFnZUFjY291bnQgID0gJHJlc291cmNlcyB8IFdoZXJlLU9iamVjdCB7ICRfLnR5cGUgLWVxICdtaWNyb3NvZnQuc3RvcmFnZS9zdG9yYWdlYWNjb3VudHMnIH0gfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxICAgDQogICAgICAgIA0KICAgIH0NCg0KICAgIGlmICgtbm90ICRPdXRwdXRzLlN0b3JhZ2VBY2NvdW50KSB7DQogICAgICAgIFdyaXRlLUVycm9yICJObyBTdG9yYWdlIEFjY291bnQgZm91bmQgZm9yIGVudmlyb25tZW50ICR7U2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FfS4gSGFzIHRoaXMgZW52aXJvbm1lbnQgYmVlbiBwcm92aXNpb25lZD8iIC1FcnJvckFjdGlvbiBTdG9wDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICAkT3V0cHV0cy5TdWJzY3JpcHRpb25JZCA9ICRPdXRwdXRzLlN0b3JhZ2VBY2NvdW50LnN1YnNjcmlwdGlvbklkDQogICAgICAgICRPdXRwdXRzLlJlc291cmNlR3JvdXAgPSAkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC5yZXNvdXJjZUdyb3VwDQogICAgICAgICRDb250YWluZXJSZWdpc3RyeUlkID0gJE91dHB1dHMuU3RvcmFnZUFjY291bnQudGFncy5Tbm93Q29udGFpbmVyUmVnaXN0cnlJZA0KICAgICAgICAkT3V0cHV0cyArPSBAew0KICAgICAgICAgICAgS2V5VmF1bHQgICAgICAgICAgPSAkcmVzb3VyY2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8udHlwZSAtZXEgJ21pY3Jvc29mdC5rZXl2YXVsdC92YXVsdHMnIC1hbmQgJF8uc3Vic2NyaXB0aW9uSWQgLWVxICRPdXRwdXRzLlN1YnNjcmlwdGlvbklkIH0gfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgICAgICAgICBNYW5hZ2VkSWRlbnRpdGllcyA9ICRyZXNvdXJjZXMgfCBXaGVyZS1PYmplY3QgeyAkXy50eXBlIC1lcSAnbWljcm9zb2Z0Lm1hbmFnZWRpZGVudGl0eS91c2VyYXNzaWduZWRpZGVudGl0aWVzJyAtYW5kICRfLnN1YnNjcmlwdGlvbklkIC1lcSAkT3V0cHV0cy5TdWJzY3JpcHRpb25JZCB9DQogICAgICAgICAgICBEZXZvcHNJZGVudGl0eSAgICA9ICRyZXNvdXJjZXMgfCBXaGVyZS1PYmplY3QgeyAkXy50eXBlIC1lcSAnbWljcm9zb2Z0Lm1hbmFnZWRpZGVudGl0eS91c2VyYXNzaWduZWRpZGVudGl0aWVzJyAtYW5kICRfLm5hbWUgLWxpa2UgIipkZXZvcHMtJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9KiIgLWFuZCAkXy5zdWJzY3JpcHRpb25JZCAtZXEgJE91dHB1dHMuU3Vic2NyaXB0aW9uSWQgfSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgICAgIE1pZElkZW50aXR5ICAgICAgID0gJHJlc291cmNlcyB8IFdoZXJlLU9iamVjdCB7ICRfLnR5cGUgLWVxICdtaWNyb3NvZnQubWFuYWdlZGlkZW50aXR5L3VzZXJhc3NpZ25lZGlkZW50aXRpZXMnIC1hbmQgJF8ubmFtZSAtbGlrZSAiKm1pZHNlcnZlci0ke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0qIiAtYW5kICRfLnN1YnNjcmlwdGlvbklkIC1lcSAkT3V0cHV0cy5TdWJzY3JpcHRpb25JZCB9IHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICB9DQogICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5ID0gaWYgKCRDb250YWluZXJSZWdpc3RyeUlkKSB7DQogICAgICAgICAgICBHZXQtQXpSZXNvdXJjZSAtUmVzb3VyY2VJZCAkQ29udGFpbmVyUmVnaXN0cnlJZCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJCgkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC5uYW1lKSINCiAgICAgICAgfQ0KICAgICAgICAkT3V0cHV0cy5Db250YWluZXJTdWJuZXQgPSBpZiAoJE91dHB1dHMuU3RvcmFnZUFjY291bnQudGFncy5Tbm93Q29udGFpbmVyU3VibmV0SWQpIHsNCiAgICAgICAgICAgIEdldC1BelJlc291cmNlIC1SZXNvdXJjZUlkICRPdXRwdXRzLlN0b3JhZ2VBY2NvdW50LnRhZ3MuU25vd0NvbnRhaW5lclN1Ym5ldElkIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiTm8gQ29udGFpbmVyIFN1Ym5ldCBmb3VuZCBmb3IgJCgkT3V0cHV0cy5TdG9yYWdlQWNjb3VudC5uYW1lKSINCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoLW5vdCAkT3V0cHV0cy5LZXlWYXVsdCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBFcnJvciAiTm8gS2V5IFZhdWx0IGZvdW5kIGZvciBlbnZpcm9ubWVudCAke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0iIC1FcnJvckFjdGlvbiBTdG9wDQogICAgfQ0KICAgIGlmICgtbm90ICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgZW52aXJvbm1lbnQgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9IiAtRXJyb3JBY3Rpb24gU3RvcA0KICAgIH0NCiAgICAkT3V0cHV0cy5SYXcgPSAkcmVzb3VyY2VzDQogICAgJE91dHB1dHMNCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTUlEQnVpbGRDb250ZXh0IHsNCiAgICBwYXJhbSAoDQogICAgICAgIFtzdHJpbmddJFN1YnNjcmlwdGlvbklkLA0KICAgICAgICBbc3RyaW5nXSRSZXNvdXJjZUdyb3VwTmFtZSA9ICRlbnY6QVpVUkVfUkVTT1VSQ0VfR1JPVVBfTkFNRSwNCiAgICAgICAgW3N3aXRjaF0kUmVsb2FkQ29udGV4dA0KICAgICkNCiAgICBpZiAoLW5vdCAoR2V0LUNvbW1hbmQgR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsNCiAgICAgICAgSW5zdGFsbC1Nb2R1bGUgLU5hbWUgQXogLUZvcmNlIC1BbGxvd0Nsb2JiZXIgLVNjb3BlIEN1cnJlbnRVc2VyDQogICAgfQ0KICAgIGlmICgkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0IC1hbmQgLW5vdCAkUmVsb2FkQ29udGV4dC5Jc1ByZXNlbnQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAiVXNpbmcgY2FjaGVkIGJ1aWxkIGNvbnRleHQgZm9yIGVudmlyb25tZW50ICQoJFNjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRSkgZnJvbSBgJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dCIgLUxldmVsIFZlcmJvc2UNCiAgICAgICAgcmV0dXJuICRTY3JpcHQ6U05NSURCdWlsZENvbnRleHQNCiAgICB9DQogICAgJE91dHB1dHMgPSBbb3JkZXJlZF1Aew0KICAgICAgICBFbnZpcm9ubWVudE5hbWUgPSAkU2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FDQogICAgICAgIFN1YnNjcmlwdGlvbklkICA9ICRTdWJzY3JpcHRpb25JZA0KICAgICAgICBCdWlsZFN0cmF0ZWd5ICAgPSAkU2NyaXB0OlNOX01JRF9CVUlMRF9TVFJBVEVHWSANCiAgICAgICAgSW1hZ2VOYW1lICAgICAgID0gJFNjcmlwdDpTTl9NSURfSU1BR0VfTkFNRQ0KICAgICAgICBDdXN0b21JbWFnZU5hbWUgPSAkU2NyaXB0OlNOX01JRF9DVVNUT01fSU1BR0VfTkFNRQ0KICAgICAgICBXb3JrRGlyICAgICAgICAgPSAoJGVudjpBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWSA/PyAnL3RtcCcpDQogICAgfQ0KICAgIHN3aXRjaCAoJFNjcmlwdDpTTl9NSURfQ09OVEVYVCkgew0KICAgICAgICAnbG9jYWwnIHsNCiAgICAgICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclJlZ2lzdHJ5ID0gQHsNCiAgICAgICAgICAgICAgICBuYW1lICAgICAgICAgICAgICA9ICdsb2NhbCcNCiAgICAgICAgICAgICAgICByZXNvdXJjZUdyb3VwTmFtZSA9ICdsb2NhbCcNCiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25JZCAgICA9ICdsb2NhbCcNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRPdXRwdXRzLkNvbnRhaW5lclN1Ym5ldCA9IEB7DQogICAgICAgICAgICAgICAgbmFtZSAgICAgICAgICAgICAgPSAnbG9jYWwnDQogICAgICAgICAgICAgICAgcmVzb3VyY2VHcm91cE5hbWUgPSAnbG9jYWwnDQogICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uSWQgICAgPSAnbG9jYWwnDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgJ2F6dXJlJyB7DQogICAgICAgICAgICAkY3R4ID0gR2V0LUF6Q29udGV4dCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgaWYgKC1ub3QgJGN0eCkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIEF6dXJlIGNvbnRleHQgZm91bmQuIFBsZWFzZSBsb2dpbiB0byBBenVyZScNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRTdWJzY3JpcHRpb25JZCA9IGlmICgkU3Vic2NyaXB0aW9uSWQpIHsgJFN1YnNjcmlwdGlvbklkIH0gZWxzZSB7ICRjdHguU3Vic2NyaXB0aW9uLklkIH0NCiAgICAgICAgICAgIGlmICgtbm90ICRTdWJzY3JpcHRpb25JZCkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIFN1YnNjcmlwdGlvbiBJRCBmb3VuZC4gUGxlYXNlIGxvZ2luIHRvIEF6dXJlJw0KICAgICAgICAgICAgICAgIHJldHVybiAkbnVsbA0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAkQ29udGV4dFJlc291cmNlcyA9IFJlc29sdmUtU05PV01JREN1c3RvbVJlc291cmNlcyAtU3Vic2NyaXB0aW9uSWQgJFN1YnNjcmlwdGlvbklkIC1SZXNvdXJjZUdyb3VwTmFtZSAkUmVzb3VyY2VHcm91cE5hbWUNCiAgICAgICAgICAgICAgICBmb3JlYWNoICgkayBpbiAkQ29udGV4dFJlc291cmNlcy5LZXlzKSB7DQogICAgICAgICAgICAgICAgICAgICRPdXRwdXRzWyRrXSA9ICRDb250ZXh0UmVzb3VyY2VzWyRrXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJFcnJvciBGZXRjaGluZyBBWiBSZXNvdXJjZXMke1NjcmlwdDpTTl9NSURfRU5WSVJPTk1FTlRfTkFNRX0uIEVycm9yOiAkXyINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBkZWZhdWx0IHsNCiAgICAgICAgICAgIFdyaXRlLUVycm9yICJVbmtub3duIGNvbnRleHQgdHlwZTogJFNjcmlwdDpTTl9NSURfQ09OVEVYVC4gVXNlICdsb2NhbCcgb3IgJ2F6dXJlJy4iDQogICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgfQ0KICAgIH0NCiAgICAkU2NyaXB0OlNOTUlEQnVpbGRDb250ZXh0ID0gJE91dHB1dHMNCiAgICAkT3V0cHV0cy5WYXVsdCA9IFJlc29sdmUtU05PV01JRFZhdWx0IC1Db250ZXh0VHlwZSAkU2NyaXB0OlNOX01JRF9DT05URVhUDQogICAgJE91dHB1dHMNCn0NCg0KZnVuY3Rpb24gR2V0LVNOT1dNSURQZnhDZXJ0aWZpY2F0ZUFzUGVtIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJENlcnRpZmljYXRlTmFtZQ0KICAgICkNCiAgICAkS2V5VmF1bHROYW1lID0gJFNjcmlwdDpTTk1JREJ1aWxkQ29udGV4dC5LZXlWYXVsdC5OYW1lDQogICAgaWYgKC1ub3QgJEtleVZhdWx0TmFtZSkgew0KICAgICAgICBXcml0ZS1FcnJvciAnS2V5VmF1bHROYW1lIGlzIHJlcXVpcmVkJw0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgaWYgKCRDZXJ0ID0gR2V0LUF6S2V5VmF1bHRDZXJ0aWZpY2F0ZSAtVmF1bHROYW1lICRLZXlWYXVsdE5hbWUgLU5hbWUgJENlcnRpZmljYXRlTmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkgew0KICAgICAgICAkTGVhZkNvbGxlY3Rpb24gPSBOZXctT2JqZWN0IFN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuWDUwOUNlcnRpZmljYXRlcy5YNTA5Q2VydGlmaWNhdGUyQ29sbGVjdGlvbg0KICAgICAgICAkQ2VydEJ5dGVzID0gW0NvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKChHZXQtQXpLZXlWYXVsdFNlY3JldCAtU2VjcmV0SWQgJENlcnQuU2VjcmV0SWQgLUFzUGxhaW5UZXh0KSkNCiAgICAgICAgIyBNdXN0IHVzZSBFeHBvcnRhYmxlIGZsYWcgdG8gZXhwb3J0IHRoZSBwcml2YXRlIGtleSBvbiBXaW5kb3dzL01hY09TDQogICAgICAgICRQZnggPSBbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5YNTA5Q2VydGlmaWNhdGVzLlg1MDlDZXJ0aWZpY2F0ZTJdOjpuZXcoJENlcnRCeXRlcywgJG51bGwsIFtTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5Llg1MDlDZXJ0aWZpY2F0ZXMuWDUwOUtleVN0b3JhZ2VGbGFnc106OkV4cG9ydGFibGUpDQogICAgICAgICRMZWFmQ29sbGVjdGlvbi5BZGQoJFBmeCkgfCBPdXQtTnVsbA0KICAgICAgICByZXR1cm4gQCgkTGVhZkNvbGxlY3Rpb24uRXhwb3J0Q2VydGlmaWNhdGVQZW1zKCksICRMZWFmQ29sbGVjdGlvblswXS5Qcml2YXRlS2V5LkV4cG9ydFBrY3M4UHJpdmF0ZUtleVBlbSgpKSAtam9pbiAiYG4iDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDZXJ0aWZpY2F0ZSAkQ2VydGlmaWNhdGVOYW1lIG5vdCBmb3VuZCBpbiBLZXkgVmF1bHQgJEtleVZhdWx0TmFtZSINCiAgICAgICAgJG51bGwNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREFjckltYWdlU3RhdGUgew0KICAgICRCdWlsZENvbnRleHQgPSBSZXNvbHZlLVNOT1dNSURCdWlsZENvbnRleHQNCiAgICBpZiAoLW5vdCAkQnVpbGRDb250ZXh0LkNvbnRhaW5lclJlZ2lzdHJ5LlJlc291cmNlR3JvdXBOYW1lKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJENvbnRhaW5lclJlZ2lzdHJ5ID0gJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeQ0KICAgICRBY3IgPSBHZXQtQXpDb250YWluZXJSZWdpc3RyeSAtUmVzb3VyY2VHcm91cE5hbWUgJENvbnRhaW5lclJlZ2lzdHJ5LlJlc291cmNlR3JvdXBOYW1lIC1OYW1lICRDb250YWluZXJSZWdpc3RyeS5uYW1lIC1TdWJzY3JpcHRpb25JZCAkQ29udGFpbmVyUmVnaXN0cnkuc3Vic2NyaXB0aW9uSWQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoLW5vdCAkQWNyKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIENvbnRhaW5lciBSZWdpc3RyeSBmb3VuZCBmb3IgJHtTY3JpcHQ6U05fTUlEX0VOVklST05NRU5UX05BTUV9Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJEltYWdlcyA9IEdldC1BekNvbnRhaW5lclJlZ2lzdHJ5UmVwb3NpdG9yeSAtUmVnaXN0cnlOYW1lICRDb250YWluZXJSZWdpc3RyeS5uYW1lDQogICAgJEltYWdlcyB8IEZvckVhY2gtT2JqZWN0IHsgR2V0LUF6Q29udGFpbmVyUmVnaXN0cnlUYWcgLVJlZ2lzdHJ5TmFtZSAkQ29udGFpbmVyUmVnaXN0cnkubmFtZSAtUmVwb3NpdG9yeU5hbWUgJF8gfSBgDQogICAgfCBGb3JFYWNoLU9iamVjdCB7IA0KICAgICAgICAkaXRzID0gQHsNCiAgICAgICAgICAgIE5hbWUgICAgID0gJF8uSW1hZ2VOYW1lDQogICAgICAgICAgICBUYWdzICAgICA9IFtTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5MaXN0W2hhc2h0YWJsZV1dOjpuZXcoKQ0KICAgICAgICAgICAgUmVnaXN0cnkgPSAkXy5SZWdpc3RyeQ0KICAgICAgICB9DQogICAgICAgIGZvcmVhY2ggKCR0IGluICRfLlRhZ3MpIHsNCiAgICAgICAgICAgICRpdHMuVGFncy5BZGQoQHtOYW1lID0gJHQuTmFtZTsgRGlnZXN0ID0gJHQuRGlnZXN0IH0pDQogICAgICAgIH0NCiAgICAgICAgJGl0cw0KICAgIH0NCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTUlESW1hZ2VTdGF0ZSB7DQogICAgJEJ1aWxkQ29udGV4dCA9IFJlc29sdmUtU05PV01JREJ1aWxkQ29udGV4dA0KICAgICRCdWlsZFN0cmF0ZWd5ID0gJEJ1aWxkQ29udGV4dC5CdWlsZFN0cmF0ZWd5DQogICAgJGltYWdlcyA9IHN3aXRjaCAoJEJ1aWxkU3RyYXRlZ3kpIHsNCiAgICAgICAgJ2Fjcicgew0KICAgICAgICAgICAgJEltYWdlUmVwbyA9ICRCdWlsZENvbnRleHQuQ29udGFpbmVyUmVnaXN0cnkucHJvcGVydGllcy5sb2dpblNlcnZlcg0KICAgICAgICAgICAgUmVzb2x2ZS1TTk9XTUlEQWNySW1hZ2VTdGF0ZSAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQNCiAgICAgICAgfQ0KICAgICAgICAncG9kbWFuJyB7DQogICAgICAgICAgICAkSW1hZ2VSZXBvID0gJ2xvY2FsaG9zdCcNCiAgICAgICAgICAgIEdldC1Eb2NrZXJQb2RtYW5JbWFnZVN0YXRlIC1CdWlsZENvbnRleHQgJEJ1aWxkQ29udGV4dA0KICAgICAgICB9DQogICAgfQ0KICAgICRtaWRWZXJzaW9uID0gR2V0LVNOT1dNaWRWZXJzaW9uDQogICAgJEJ1aWxkQ29udGV4dC5JbWFnZVN0YXRlID0gQHsNCiAgICAgICAgSW1hZ2VzICAgICAgICAgICAgICAgICAgICA9ICRpbWFnZXMNCiAgICAgICAgTWlkVmVyc2lvbiAgICAgICAgICAgICAgICA9ICRtaWRWZXJzaW9uDQogICAgICAgIE1pZEltYWdlRmFjdHMgICAgICAgICAgICAgPSAoR2V0LVNOT1dNSUREb3dubG9hZEZhY3RzIC1CdWlsZFRhZyAkbWlkVmVyc2lvbikNCiAgICAgICAgRG9ja2VyQ29udGV4dCAgICAgICAgICAgICA9IChKb2luLVBhdGggJEJ1aWxkQ29udGV4dC5Xb3JrRGlyICRtaWRWZXJzaW9uKQ0KICAgICAgICBCYXNlSW1hZ2VVcmkgICAgICAgICAgICAgID0gIiR7SW1hZ2VSZXBvfS8kKCRCdWlsZENvbnRleHQuSW1hZ2VOYW1lKTokKCRtaWRWZXJzaW9uKSINCiAgICAgICAgQ3VzdG9tSW1hZ2VVcmkgICAgICAgICAgICA9ICIke0ltYWdlUmVwb30vJCgkQnVpbGRDb250ZXh0LkN1c3RvbUltYWdlTmFtZSk6JCgkbWlkVmVyc2lvbikiDQogICAgICAgIEJhc2VJbWFnZUVudmlyb25tZW50VXJpICAgPSAiJHtJbWFnZVJlcG99LyQoJEJ1aWxkQ29udGV4dC5JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIg0KICAgICAgICBDdXN0b21JbWFnZUVudmlyb25tZW50VXJpID0gIiR7SW1hZ2VSZXBvfS8kKCRCdWlsZENvbnRleHQuQ3VzdG9tSW1hZ2VOYW1lKTokKCRCdWlsZENvbnRleHQuRW52aXJvbm1lbnROYW1lKSINCiAgICAgICAgQmFzZUltYWdlICAgICAgICAgICAgICAgICA9ICgkaW1hZ2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJEJ1aWxkQ29udGV4dC5JbWFnZU5hbWUgfSkNCiAgICAgICAgQ3VzdG9tSW1hZ2UgICAgICAgICAgICAgICA9ICgkaW1hZ2VzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUgfSkNCiAgICB9DQogICAgJEJ1aWxkQ29udGV4dC5JbWFnZVN0YXRlDQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTWlkVmVyc2lvbiB7DQogICAgKEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3Byb3BlcnRpZXMnIC1RdWVyeSAnbmFtZT1taWQudmVyc2lvbicgLUZpZWxkcyAndmFsdWUnKSAgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSB2YWx1ZQ0KfQ0KDQpmdW5jdGlvbiBCdWlsZC1TTk9XTUlESW1hZ2VDb21tb24gew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRTdHJhdGVneSwNCiAgICAgICAgW3N0cmluZ10kSW1hZ2VOYW1lLA0KICAgICAgICBbc3RyaW5nXSRJbWFnZVRhZywNCiAgICAgICAgW3N0cmluZ1tdXSRJbWFnZUFkZGl0aW9uYWxUYWdzID0gQCgpLA0KICAgICAgICBbaGFzaHRhYmxlXSRCdWlsZENvbnRleHQsDQogICAgICAgIFtzdHJpbmddJERvY2tlckNvbnRleHQsDQogICAgICAgIFtzdHJpbmddJERvY2tlckZpbGUsDQogICAgICAgIFtzdHJpbmddJFBvZG1hbklzb2xhdGlvbiA9ICdjaHJvb3QnDQogICAgKQ0KICAgIHN3aXRjaCAoJFN0cmF0ZWd5KSB7DQogICAgICAgICdhY3InIHsNCiAgICAgICAgICAgIEFzc2VydC1TTk9XTUlEQXpDbGkNCiAgICAgICAgICAgICRkb2NrZXJGaWxlID0gKEpvaW4tUGF0aCAkRG9ja2VyQ29udGV4dCAkRG9ja2VyRmlsZSkNCiAgICAgICAgICAgICRidWlsZENvbW1hbmQgPSAnYXonDQogICAgICAgICAgICAkYnVpbGRQYXJhbXMgPSBAKA0KICAgICAgICAgICAgICAgICdhY3InLCAnYnVpbGQnLCAnLS1yZWdpc3RyeScsICRCdWlsZENvbnRleHQuQ29udGFpbmVyUmVnaXN0cnkubmFtZSwNCiAgICAgICAgICAgICAgICAnLS1pbWFnZScsICIkKCRJbWFnZU5hbWUpOiRJbWFnZVRhZyIsICctLXN1YnNjcmlwdGlvbicsICRCdWlsZENvbnRleHQuQ29udGFpbmVyUmVnaXN0cnkuc3Vic2NyaXB0aW9uSWQsDQogICAgICAgICAgICAgICAgJy0tZmlsZScsICRkb2NrZXJGaWxlLCAkRG9ja2VyQ29udGV4dA0KICAgICAgICAgICAgKQ0KICAgICAgICB9DQogICAgICAgICdwb2RtYW4nIHsNCiAgICAgICAgICAgICRidWlsZENvbW1hbmQgPSAncG9kbWFuJw0KICAgICAgICAgICAgJGJ1aWxkUGFyYW1zID0gQCgNCiAgICAgICAgICAgICAgICAnYnVpbGQnLCAnLS1mb3JtYXQnLCAnZG9ja2VyJywgIi0taXNvbGF0aW9uPSR7UG9kbWFuSXNvbGF0aW9ufSIsICctLXRhZycsICIke0ltYWdlTmFtZX06JHtJbWFnZVRhZ30iLA0KICAgICAgICAgICAgICAgICctZicsICREb2NrZXJGaWxlLCAkRG9ja2VyQ29udGV4dA0KICAgICAgICAgICAgKQ0KICAgICAgICB9DQogICAgICAgIGRlZmF1bHQgew0KICAgICAgICAgICAgdGhyb3cgIlVua25vd24gYnVpbGQgc3RyYXRlZ3k6ICRTdHJhdGVneSINCiAgICAgICAgfQ0KICAgIH0NCiAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkV4ZWN1dGluZyAkYnVpbGRDb21tYW5kICQoJGJ1aWxkUGFyYW1zIC1qb2luICcgJykiDQogICAgKCYgJGJ1aWxkQ29tbWFuZCBAYnVpbGRQYXJhbXMgfCBUZWUtT2JqZWN0IC1WYXJpYWJsZSBSZXN1bHQgfCBXcml0ZS1WZXJib3NlICkgDQogICAgaWYgKCRSZXN1bHQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJJbWFnZSAkKCRJbWFnZU5hbWUpOiRJbWFnZVRhZyBidWlsdCBzdWNjZXNzZnVsbHkiDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1FcnJvciAiRmFpbGVkIHRvIGJ1aWxkIGltYWdlICQoJEltYWdlTmFtZSk6JEltYWdlVGFnIg0KICAgIH0NCiAgICAkUmVzdWx0DQp9DQoNCmZ1bmN0aW9uIEV4cGFuZC1TTk9XTUlEQXJjaGl2ZSB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJFBhdGgsDQogICAgICAgIFtzdHJpbmddJE91dHB1dFBhdGgNCiAgICApDQogICAgJEV4cGFuZENtZCA9IEdldC1Db21tYW5kIC1OYW1lICdFeHBhbmQtQXJjaGl2ZScgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoISRFeHBhbmRDbWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiRXhwYW5kLUFyY2hpdmUgbm90IGZvdW5kLiBVc2luZyB1bnppcCBpbnN0ZWFkLiINCiAgICAgICAgYXB0IHVwZGF0ZSAteSAmJiBhcHQgaW5zdGFsbCB1bnppcCAteSB8IFdyaXRlLVZlcmJvc2UNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIGlmICgkRXhwYW5kQ21kLlBhcmFtZXRlcnMuT3V0cHV0UGF0aCkgew0KICAgICAgICAgICAgIyBQU0NYIG1vZHVsZQ0KICAgICAgICAgICAgRXhwYW5kLUFyY2hpdmUgLVBhdGggJFBhdGggLU91dHB1dFBhdGggJE91dHB1dFBhdGggLUZvcmNlDQogICAgICAgIH0NCiAgICAgICAgZWxzZWlmICgkRXhwYW5kQ21kLlBhcmFtZXRlcnMuRGVzdGluYXRpb25QYXRoKSB7DQogICAgICAgICAgICAjIFBvd2VyU2hlbGwgNS4xDQogICAgICAgICAgICBFeHBhbmQtQXJjaGl2ZSAtUGF0aCAkUGF0aCAtRGVzdGluYXRpb25QYXRoICRPdXRwdXRQYXRoIC1Gb3JjZQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBCdWlsZC1TTk9XTUlEU05PV01pZEltYWdlIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW3N3aXRjaF0kRm9yY2VCdWlsZEJhc2UsDQogICAgICAgIFtzd2l0Y2hdJEZvcmNlQnVpbGRDdXN0b20NCiAgICApDQogICAgJEJ1aWxkQ29udGV4dCA9IFJlc29sdmUtU05PV01JREJ1aWxkQ29udGV4dA0KICAgICRJbWFnZVN0YXRlID0gUmVzb2x2ZS1TTk9XTUlESW1hZ2VTdGF0ZSAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQNCiAgICBpZiAoJGVudjpTTl9NSURfRk9SQ0VfQlVJTERfQkFTRSAtZXEgJ3RydWUnKSB7DQogICAgICAgICRGb3JjZUJ1aWxkQmFzZSA9ICR0cnVlDQogICAgfQ0KICAgIGlmICgkZW52OlNOX01JRF9GT1JDRV9CVUlMRF9DVVNUT00gLWVxICd0cnVlJykgew0KICAgICAgICAkRm9yY2VCdWlsZEN1c3RvbSA9ICR0cnVlDQogICAgfQ0KICAgIGlmICgkRm9yY2VCdWlsZEJhc2UgLW9yICgtbm90ICRJbWFnZVN0YXRlLkJhc2VJbWFnZSAtb3IgKC1ub3QgKCRJbWFnZVN0YXRlLkJhc2VJbWFnZS5UYWdzLk5hbWUuQ29udGFpbnMoJEltYWdlU3RhdGUuTWlkVmVyc2lvbikpKSkpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJCdWlsZGluZyAkKCRCdWlsZENvbnRleHQuSW1hZ2VOYW1lKSBpbWFnZSB3aXRoIHRhZyAkKCRJbWFnZVN0YXRlLk1pZFZlcnNpb24pIg0KICAgICAgICBpZiAoLW5vdCAoVGVzdC1QYXRoICRJbWFnZVN0YXRlLkRvY2tlckNvbnRleHQpKSB7DQogICAgICAgICAgICBOZXctSXRlbSAtUGF0aCAkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0IC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlIHwgT3V0LU51bGwNCiAgICAgICAgfQ0KICAgICAgICAkQmFzZURvY2tlckZpbGUgPSAnRG9ja2VyZmlsZScNCiAgICAgICAgaWYgKC1ub3QgKFRlc3QtUGF0aCAoIiQoJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCkvJEJhc2VEb2NrZXJGaWxlIikpKSB7DQogICAgICAgICAgICAjIERvd25sb2FkIGZpbGUgZnJvbSBJbWFnZVN0YXRlIGZhY3RzDQogICAgICAgICAgICAkQXJjaGl2ZVBhdGggPSAiJCgkQnVpbGRDb250ZXh0LldvcmtEaXIpLyQoJEltYWdlU3RhdGUuTWlkSW1hZ2VGYWN0cy5QYWNrYWdlRmlsZU5hbWUpIg0KICAgICAgICAgICAgSW52b2tlLVdlYlJlcXVlc3QgLVVyaSAkSW1hZ2VTdGF0ZS5NaWRJbWFnZUZhY3RzLlBhY2thZ2VVcmkgLU91dEZpbGUgJEFyY2hpdmVQYXRoDQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkV4dHJhY3RpbmcgJCgkSW1hZ2VTdGF0ZS5NaWRJbWFnZUZhY3RzLlBhY2thZ2VGaWxlTmFtZSkgdG8gJCgkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0KSINCiAgICAgICAgICAgIEV4cGFuZC1TTk9XTUlEQXJjaGl2ZSAtUGF0aCAkQXJjaGl2ZVBhdGggLU91dHB1dFBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRm9yY2UNCiAgICAgICAgfQ0KICAgICAgICAkQnVpbGRDb250ZXh0LkJhc2VJbWFnZUJ1aWxkID0gQnVpbGQtU05PV01JREltYWdlQ29tbW9uIC1TdHJhdGVneSAkQnVpbGRDb250ZXh0LkJ1aWxkU3RyYXRlZ3kgLUltYWdlTmFtZSAkQnVpbGRDb250ZXh0LkltYWdlTmFtZSAtSW1hZ2VUYWcgJEltYWdlU3RhdGUuTWlkVmVyc2lvbiAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQgLURvY2tlckNvbnRleHQgJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRG9ja2VyRmlsZSAkQmFzZURvY2tlckZpbGUNCiAgICB9DQogICAgaWYgKCRGb3JjZUJ1aWxkQ3VzdG9tIC1vciAoLW5vdCAkSW1hZ2VTdGF0ZS5DdXN0b21JbWFnZSAtb3IgKC1ub3QgKCRJbWFnZVN0YXRlLkN1c3RvbUltYWdlLlRhZ3MuTmFtZS5Db250YWlucygkSW1hZ2VTdGF0ZS5NaWRWZXJzaW9uKSkpKSkgew0KICAgICAgICAkY3VzdG9tRG9ja2VyQ29udGVudCA9IEdldC1Eb2NrZXJQb2RtYW5Eb2NrZXJGaWxlQ29udGVudA0KICAgICAgICBpZiAoJGN1c3RvbURvY2tlckNvbnRlbnQpIHsNCiAgICAgICAgICAgICRsaW5lcyA9ICRjdXN0b21Eb2NrZXJDb250ZW50LlNwbGl0KCJgbiIpDQogICAgICAgICAgICAkZnJvbUxpbmVJbmRleCA9ICRsaW5lcy5JbmRleE9mKCgkbGluZXMgfCBXaGVyZS1PYmplY3QgeyAkXyAtbWF0Y2ggJ15GUk9NXHMnIH0pKQ0KICAgICAgICAgICAgJGJhc2VGaXJzdExpbmUgPSAiRlJPTSAkKCRJbWFnZVN0YXRlLkJhc2VJbWFnZVVyaSkiDQogICAgICAgICAgICBpZiAoJGZyb21MaW5lSW5kZXggLWdlIDAgLWFuZCAkbGluZXNbJGZyb21MaW5lSW5kZXhdIC1uZSAkYmFzZUZpcnN0TGluZSkgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXBkYXRpbmcgY3VzdG9tIERvY2tlcmZpbGUgd2l0aCBjb3JyZWN0IGJhc2UgSW1hZ2UgJCgkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VVcmkpIg0KICAgICAgICAgICAgICAgICRsaW5lc1skZnJvbUxpbmVJbmRleF0gPSAkYmFzZUZpcnN0TGluZQ0KICAgICAgICAgICAgICAgICRjdXN0b21Eb2NrZXJDb250ZW50ID0gJGxpbmVzIC1qb2luICJgbiINCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFdyaXRlLUhvc3QgJGN1c3RvbURvY2tlckNvbnRlbnQNCiAgICAgICAgICAgIGlmICgtbm90IChUZXN0LVBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCkpIHsNCiAgICAgICAgICAgICAgICBOZXctSXRlbSAtUGF0aCAkSW1hZ2VTdGF0ZS5Eb2NrZXJDb250ZXh0IC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlIHwgT3V0LU51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRjdXN0b21Eb2NrZXJGaWxlUGF0aCA9IChKb2luLVBhdGggJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAnRG9ja2VyZmlsZS5taWRjdXN0b20nKQ0KICAgICAgICAgICAgJGN1c3RvbURvY2tlckNvbnRlbnQgfCBPdXQtRmlsZSAtRmlsZVBhdGggJGN1c3RvbURvY2tlckZpbGVQYXRoIC1Gb3JjZSAtRW5jb2RpbmcgdXRmOA0KICAgICAgICAgICAgJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZUJ1aWxkID0gQnVpbGQtU05PV01JREltYWdlQ29tbW9uIC1TdHJhdGVneSAkQnVpbGRDb250ZXh0LkJ1aWxkU3RyYXRlZ3kgLUltYWdlTmFtZSAkQnVpbGRDb250ZXh0LkN1c3RvbUltYWdlTmFtZSAtSW1hZ2VUYWcgJEltYWdlU3RhdGUuTWlkVmVyc2lvbiAtQnVpbGRDb250ZXh0ICRCdWlsZENvbnRleHQgLURvY2tlckNvbnRleHQgJEltYWdlU3RhdGUuRG9ja2VyQ29udGV4dCAtRG9ja2VyRmlsZSAnRG9ja2VyZmlsZS5taWRjdXN0b20nIC1Qb2RtYW5Jc29sYXRpb24gJ29jaScNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgJ05vIGN1c3RvbSBEb2NrZXJmaWxlIGZvdW5kLiBTa2lwcGluZyBjdXN0b20gaW1hZ2UgYnVpbGQnDQogICAgICAgIH0NCiAgICB9DQogICAgJEltYWdlU3RhdGUgPSBSZXNvbHZlLVNOT1dNSURJbWFnZVN0YXRlIC1CdWlsZENvbnRleHQgJEJ1aWxkQ29udGV4dA0KDQogICAgZnVuY3Rpb24gVGFnSW1hZ2UoJFNvdXJjZSwgJERlc3QpIHsNCiAgICAgICAgJGNtZCA9IHN3aXRjaCAoJEJ1aWxkQ29udGV4dC5CdWlsZFN0cmF0ZWd5KSB7DQogICAgICAgICAgICAnYWNyJyB7IA0KICAgICAgICAgICAgICAgIEFzc2VydC1TTk9XTUlEQXpDbGkNCiAgICAgICAgICAgICAgICAkZGVzdCA9IGlmICgkZGVzdCAtbWF0Y2ggJy4qLycpIHsgJGRlc3QgLXJlcGxhY2UgJy4qLycsICcnIH0gZWxzZSB7ICRkZXN0IH0NCiAgICAgICAgICAgICAgICAiYXogYWNyIGltcG9ydCAtLW5hbWUgJCgkQnVpbGRDb250ZXh0LkNvbnRhaW5lclJlZ2lzdHJ5Lm5hbWUpIC0tc291cmNlICRTb3VyY2UgLS1pbWFnZSAkRGVzdCAtLWZvcmNlIC0tc3Vic2NyaXB0aW9uICQoJEJ1aWxkQ29udGV4dC5Db250YWluZXJSZWdpc3RyeS5zdWJzY3JpcHRpb25JZCkiDQogICAgICAgICAgICB9DQogICAgICAgICAgICAncG9kbWFuJyB7DQogICAgICAgICAgICAgICAgInBvZG1hbiB0YWcgJFNvdXJjZSAkRGVzdCINCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGRlZmF1bHQgew0KICAgICAgICAgICAgICAgIHRocm93ICJVbmtub3duIGJ1aWxkIHN0cmF0ZWd5OiAkKCRCdWlsZENvbnRleHQuQnVpbGRTdHJhdGVneSkiDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJUYWdnaW5nIGltYWdlICRTb3VyY2Ugd2l0aCB0YWcgJERlc3QgLSBDb21tYW5kOiAkY21kIg0KICAgICAgICAoSW52b2tlLUV4cHJlc3Npb24gJGNtZCkgfCBUZWUtT2JqZWN0IC1WYXJpYWJsZSBSZXN1bHQgfCBXcml0ZS1WZXJib3NlDQogICAgICAgICRSZXN1bHQNCiAgICB9DQogICAgJEJhc2VJbWFnZVRhZyA9ICRJbWFnZVN0YXRlLkJhc2VJbWFnZS5UYWdzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJGltYWdlU3RhdGUuTWlkVmVyc2lvbiB9DQogICAgJEJhc2VJbWFnZUVudmlyb25tZW50VGFnID0gJEltYWdlU3RhdGUuQmFzZUltYWdlLlRhZ3MgfCBXaGVyZS1PYmplY3QgeyAkXy5OYW1lIC1lcSAkQnVpbGRDb250ZXh0LkVudmlyb25tZW50TmFtZSB9DQogICAgaWYgKCRCYXNlSW1hZ2VUYWcgLWFuZCAkQmFzZUltYWdlRW52aXJvbm1lbnRUYWcgLWFuZCAoJEJhc2VJbWFnZVRhZy5EaWdlc3QgLWVxICRCYXNlSW1hZ2VFbnZpcm9ubWVudFRhZy5EaWdlc3QpKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiSW1hZ2UgJCgkQnVpbGRDb250ZXh0LkltYWdlTmFtZSk6JCgkQnVpbGRDb250ZXh0LkVudmlyb25tZW50TmFtZSkgYWxyZWFkeSBleGlzdHMuIFNraXBwaW5nIHRhZ2dpbmcuIg0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgJEJ1aWxkQ29udGV4dC5CYXNlVGFnUmVzdWx0ID0gVGFnSW1hZ2UgLVNvdXJjZSAkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VVcmkgLURlc3QgJEltYWdlU3RhdGUuQmFzZUltYWdlRW52aXJvbm1lbnRVcmkNCiAgICB9DQogICAgDQogICAgJEN1c3RvbUltYWdlVGFnID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2UuVGFncyB8IFdoZXJlLU9iamVjdCB7ICRfLk5hbWUgLWVxICRpbWFnZVN0YXRlLk1pZFZlcnNpb24gfQ0KICAgICRDdXN0b21JbWFnZUVudmlyb25tZW50VGFnID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2UuVGFncyB8IFdoZXJlLU9iamVjdCB7ICRfLk5hbWUgLWVxICRCdWlsZENvbnRleHQuRW52aXJvbm1lbnROYW1lIH0NCiAgICBpZiAoJEN1c3RvbUltYWdlVGFnIC1hbmQgJEN1c3RvbUltYWdlRW52aXJvbm1lbnRUYWcgLWFuZCAoJEN1c3RvbUltYWdlVGFnLkRpZ2VzdCAtZXEgJEN1c3RvbUltYWdlRW52aXJvbm1lbnRUYWcuRGlnZXN0KSkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIkltYWdlICQoJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIGFscmVhZHkgZXhpc3RzLiBTa2lwcGluZyB0YWdnaW5nLiINCiAgICB9DQogICAgZWxzZWlmICgkQ3VzdG9tSW1hZ2VUYWcpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJUYWdnaW5nIGltYWdlICQoJEJ1aWxkQ29udGV4dC5DdXN0b21JbWFnZU5hbWUpOiQoJEJ1aWxkQ29udGV4dC5FbnZpcm9ubWVudE5hbWUpIg0KICAgICAgICAkQnVpbGRDb250ZXh0LkN1c3RvbVRhZ1Jlc3VsdCA9IFRhZ0ltYWdlIC1Tb3VyY2UgJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VVcmkgLURlc3QgJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgIH0NCg0KICAgIFtvcmRlcmVkXUB7DQogICAgICAgIEJhc2VJbWFnZUVudmlyb25tZW50VXJpICAgPSAkSW1hZ2VTdGF0ZS5CYXNlSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgICAgICBDdXN0b21JbWFnZUVudmlyb25tZW50VXJpID0gJEltYWdlU3RhdGUuQ3VzdG9tSW1hZ2VFbnZpcm9ubWVudFVyaQ0KICAgICAgICBCYXNlSW1hZ2VUYWdSZXN1bHQgICAgICAgID0gJEJ1aWxkQ29udGV4dC5CYXNlVGFnUmVzdWx0DQogICAgICAgIEN1c3RvbUltYWdlVGFnUmVzdWx0ICAgICAgPSAkQnVpbGRDb250ZXh0LkN1c3RvbVRhZ1Jlc3VsdA0KICAgIH0NCn0NCg0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIFNlY3Rpb24gMjogU2VydmljZU5vdyBGdW5jdGlvbnMNCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpmdW5jdGlvbiBHZXQtU05PV0N1cnJlbnRVc2VyIHsNCiAgICAkQ3VycmVudFVzZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyJyAtUXVlcnkgInVzZXJfbmFtZT1qYXZhc2NyaXB0OmdzLmdldFVzZXJOYW1lKCkiIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgaWYgKCRDdXJyZW50VXNlci5Db3VudCAtZXEgMCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgLU1lc3NhZ2UgIk5vIGN1cnJlbnQgdXNlciBmb3VuZCBpbiBTZXJ2aWNlTm93LiBQbGVhc2UgY2hlY2sgeW91ciBhdXRoZW50aWNhdGlvbi4iDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICByZXR1cm4gJEN1cnJlbnRVc2VyWzBdDQp9DQpmdW5jdGlvbiBHZXQtU05PV01JRFJlY29yZFdpdGhDcmVkcyB7DQogICAgcGFyYW0gKA0KICAgICAgICBbcHNjcmVkZW50aWFsXSRDcmVkZW50aWFsLA0KICAgICAgICBbaGFzaHRhYmxlXSRBdXRoT2JqZWN0ID0gQHt9LA0KICAgICAgICBbc3RyaW5nXSRUYWJsZSA9ICdzeXNfdXNlcicsDQogICAgICAgIFtzdHJpbmddJFF1ZXJ5ID0gInVzZXJfbmFtZT1qYXZhc2NyaXB0OmdzLmdldFVzZXJOYW1lKCkiDQogICAgKQ0KICAgICRDdXJyZW50U25vd0F1dGggPSBHZXQtU05PV0F1dGggLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAkSW5zdGFuY2UgPSAkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGguSW5zdGFuY2UgPz8gJEN1cnJlbnRTbm93QXV0aC5JbnN0YW5jZQ0KICAgIGlmICggLW5vdCAkSW5zdGFuY2UpIHsNCiAgICAgICAgV3JpdGUtRXJyb3IgIk5vIFNlcnZpY2VOb3cgaW5zdGFuY2UgZm91bmQuIFBsZWFzZSBzZXQgdGhlIFNOX0hPU1QgZW52aXJvbm1lbnQgdmFyaWFibGUuIg0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJEF1dGhPYmplY3QuSW5zdGFuY2UgPSAkSW5zdGFuY2UNCiAgICBpZiAoJENyZWRlbnRpYWwpIHsNCiAgICAgICAgJEF1dGhPYmplY3QuQ3JlZGVudGlhbCA9ICRDcmVkZW50aWFsDQogICAgfQ0KICAgICRMb2dpbk1ldGhvZCA9IGlmICgkQXV0aE9iamVjdC5DbGllbnRJZCAtYW5kICRBdXRoT2JqZWN0LkNsaWVudFNlY3JldCAtYW5kICRBdXRoT2JqZWN0LkNyZWRlbnRpYWwpIHsNCiAgICAgICAgJ09BdXRoIC0gcGFzc3dvcmQgZmxvdycNCiAgICB9DQogICAgZWxzZWlmICgkQXV0aE9iamVjdC5DbGllbnRJZCAtYW5kICRBdXRoT2JqZWN0LkFjY2Vzc1Rva2VuKSB7DQogICAgICAgICdPQXV0aCAtIGFjY2VzcyB0b2tlbicNCiAgICB9DQogICAgZWxzZWlmICgkQXV0aE9iamVjdC5DbGllbnRJZCAtYW5kICRBdXRoT2JqZWN0LkNsaWVudFNlY3JldCkgew0KICAgICAgICAnT0F1dGggLSBjbGllbnQgY3JlZGVudGlhbHMnDQogICAgfQ0KICAgIGVsc2VpZiAoJEF1dGhPYmplY3QuQ3JlZGVudGlhbCkgew0KICAgICAgICAnQmFzaWMgQXV0aCcNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgICdObyBhdXRoZW50aWNhdGlvbiBtZXRob2QgcHJvdmlkZWQuIFBsZWFzZSBwcm92aWRlIGEgdmFsaWQgQ3JlZGVudGlhbCBvciBPQXV0aCBwYXJhbWV0ZXJzLicNCiAgICB9DQogICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJVc2luZyBTZXJ2aWNlTm93IGluc3RhbmNlICRJbnN0YW5jZSAtICR7TG9naW5NZXRob2R9Ig0KICAgIFNldC1TTk9XQXV0aCBAQXV0aE9iamVjdCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICRyZXN1bHQgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJFRhYmxlIC1RdWVyeSAkUXVlcnkgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoLW5vdCAkcmVzdWx0KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byBhdXRoZW50aWNhdGUgdG8gU2VydmljZU5vdyAtJHtMb2dpbk1ldGhvZH0iDQogICAgfQ0KICAgIGlmICgkQ3VycmVudFNub3dBdXRoKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLU1lc3NhZ2UgIlJlc3RvcmluZyBwcmV2aW91cyBTZXJ2aWNlTm93IGF1dGhlbnRpY2F0aW9uICQoJEN1cnJlbnRTbm93QXV0aC5DcmVkZW50aWFsLlVzZXJOYW1lKUAkKCRDdXJyZW50U25vd0F1dGguSW5zdGFuY2UpIg0KICAgICAgICBTZXQtU05PV0F1dGggLUF1dGhPYmplY3QgJEN1cnJlbnRTbm93QXV0aA0KICAgIH0NCiAgICByZXR1cm4gJHJlc3VsdA0KfQ0KDQpmdW5jdGlvbiBHZXQtU05PV01JRFNlcnZlclJlY29yZCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUNCiAgICApDQogICAgR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSINCn0NCg0KZnVuY3Rpb24gR2VuZXJhdGVSYW5kb21QYXNzd29yZCB7DQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW1ZhbGlkYXRlUmFuZ2UoMTIsIDQyKV0NCiAgICAgICAgW2ludF0gDQogICAgICAgICRMZW5ndGggPSAyNCwNCiAgICAgICAgW3N3aXRjaF0kQXNQbGFpblRleHQNCiAgICApDQogICAgJHN5bWJvbHMgPSAnIUAjJConLlRvQ2hhckFycmF5KCkNCiAgICAkY2hhcmFjdGVyTGlzdCA9ICdhJy4uJ3onICsgJ0EnLi4nWicgKyAnMCcuLic5JyArICRzeW1ib2xzDQogICAgZG8gew0KICAgICAgICAkcGFzc3dvcmQgPSAnJw0KICAgICAgICBmb3IgKCRpID0gMDsgJGkgLWx0ICRMZW5ndGg7ICRpKyspIHsNCiAgICAgICAgICAgICRyYW5kb21JbmRleCA9IFtTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5LlJhbmRvbU51bWJlckdlbmVyYXRvcl06OkdldEludDMyKDAsICRjaGFyYWN0ZXJMaXN0Lkxlbmd0aCkNCiAgICAgICAgICAgICRwYXNzd29yZCArPSAkY2hhcmFjdGVyTGlzdFskcmFuZG9tSW5kZXhdDQogICAgICAgIH0NCg0KICAgICAgICBbaW50XSRoYXNMb3dlckNoYXIgPSAkcGFzc3dvcmQgLWNtYXRjaCAnW2Etel0nDQogICAgICAgIFtpbnRdJGhhc1VwcGVyQ2hhciA9ICRwYXNzd29yZCAtY21hdGNoICdbQS1aXScNCiAgICAgICAgW2ludF0kaGFzRGlnaXQgPSAkcGFzc3dvcmQgLW1hdGNoICdbMC05XScNCiAgICAgICAgW2ludF0kaGFzU3ltYm9sID0gJHBhc3N3b3JkLkluZGV4T2ZBbnkoJHN5bWJvbHMpIC1uZSAtMQ0KDQogICAgfQ0KICAgIHVudGlsICgoJGhhc0xvd2VyQ2hhciArICRoYXNVcHBlckNoYXIgKyAkaGFzRGlnaXQgKyAkaGFzU3ltYm9sKSAtZ2UgMykNCiAgICANCiAgICBpZiAoJEFzUGxhaW5UZXh0KSB7IA0KICAgICAgICByZXR1cm4gJHBhc3N3b3JkDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICByZXR1cm4gJHBhc3N3b3JkIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEdldC1TTk9XTUlEVXNlclJvbGVzIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW3N0cmluZ10kVXNlcm5hbWUsDQogICAgICAgIFtzd2l0Y2hdJEluY2x1ZGVJbmhlcml0ZWQNCiAgICApDQogICAgJFVzZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyJyAtUXVlcnkgInVzZXJfbmFtZT0kVXNlcm5hbWUiDQogICAgJFJvbGVRdWVyeSA9ICJ1c2VyPSQoJFVzZXIuc3lzX2lkKV4iDQogICAgaWYgKC1ub3QgJEluY2x1ZGVJbmhlcml0ZWQpIHsNCiAgICAgICAgJFJvbGVRdWVyeSArPSAnaW5oZXJpdGVkPWZhbHNlJw0KICAgIH0NCiAgICAkVXNlclJvbGVzID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcl9oYXNfcm9sZScgLVF1ZXJ5ICRSb2xlUXVlcnkgLURpc3BsYXlWYWx1ZSAndHJ1ZScgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICByZXR1cm4gJFVzZXJSb2xlcw0KfQ0KDQpmdW5jdGlvbiBBZGQtU05PV01JRFVzZXJSb2xlcyB7DQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRVc2VyU3lzSWQsDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nW11dJFJvbGVzDQogICAgKQ0KICAgICRSZXF1ZXN0ZWRSb2xlcyA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXJfcm9sZScgLVF1ZXJ5ICJuYW1lPSQoJFJvbGVzIC1qb2luICcsJykiDQogICAgJFVzZXJSb2xlcyA9IEdldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXJfaGFzX3JvbGUnIC1RdWVyeSAidXNlcj0kVXNlclN5c0lkIg0KICAgICRSb2xlTGlzdCA9ICRVc2VyUm9sZXMucm9sZQ0KICAgIGZvcmVhY2ggKCRSb2xlIGluICRSZXF1ZXN0ZWRSb2xlcykgew0KICAgICAgICBpZiAoJFJvbGVMaXN0LnZhbHVlIC1jb250YWlucyAkUm9sZS5zeXNfaWQpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgIlVzZXIgWyRVc2VyU3lzSWRdIGFscmVhZHkgaGFzIHJvbGUgJCgkUm9sZS5uYW1lKSINCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgJFJvbGVQcm9wZXJ0aWVzID0gQHsNCiAgICAgICAgICAgIHVzZXIgPSAkVXNlclN5c0lkDQogICAgICAgICAgICByb2xlID0gJFJvbGUuc3lzX2lkDQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgU2lnbmlmaWNhbnQgIkFkZGluZyByb2xlICQoJFJvbGUubmFtZSkgdG8gWyRVc2VyU3lzSWRdIg0KICAgICAgICAkUm9sZUxpc3QgKz0gTmV3LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcl9oYXNfcm9sZScgLVByb3BlcnRpZXMgJFJvbGVQcm9wZXJ0aWVzIC1QYXNzVGhydQ0KICAgIH0NCiAgICAkUm9sZUxpc3QNCn0NCg0KZnVuY3Rpb24gU2V0LVNOT1dNSURTZXJ2ZXJVc2VyIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJE1pZFNlcnZlck5hbWUsDQogICAgICAgIFtWYWxpZGF0ZVBhdHRlcm4oJ15bYS16QS1aMC05XC1dKyQnKV0NCiAgICAgICAgW3N0cmluZ10kTWlkU2VydmVyVXNlck5hbWUgPSAiYXptaWQtJE1pZFNlcnZlck5hbWUiLA0KICAgICAgICBbc2VjdXJlc3RyaW5nXSRQYXNzd29yZCwNCiAgICAgICAgW3N0cmluZ1tdXSRSb2xlcyA9IEAoJ21pZF9zZXJ2ZXInKSwNCiAgICAgICAgW3N0cmluZ1tdXSRDYXBhYmlsaXRpZXMgPSBAKCdBTEwnKSwNCiAgICAgICAgW3N0cmluZ10kTWlkU2VydmVyQ2x1c3RlciA9ICdhenVyZScsDQogICAgICAgIFtoYXNodGFibGVdJFVzZXJWYWx1ZXMgPSBAe30sDQogICAgICAgIFtzdHJpbmddJERlZmF1bHRFbWFpbFN1ZmZpeCA9ICdleGFtcGxlLmNvbScsDQogICAgICAgIFtzdHJpbmddJE9wZXJhdGlvbiA9ICdkZXBsb3knDQogICAgKQ0KICAgICRNaWRTZWNyZXROYW1lID0gIiR7TWlkU2VydmVyVXNlck5hbWV9LXBhc3N3b3JkIg0KICAgICRWYXVsdFNlY3JldCA9IEdldC1TZWNyZXQgLU5hbWUgJE1pZFNlY3JldE5hbWUgLVZhdWx0ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICANCiAgICBpZiAoJFZhdWx0U2VjcmV0KSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXNpbmcgcGFzc3dvcmQgZnJvbSBWYXVsdCAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FIg0KICAgICAgICBpZiAoJFZhdWx0U2VjcmV0IC1pcyBbU3lzdGVtLlNlY3VyaXR5LlNlY3VyZVN0cmluZ10pIHsNCiAgICAgICAgICAgIGlmICgtbm90ICRQYXNzd29yZCkgew0KICAgICAgICAgICAgICAgICRQYXNzd29yZCA9ICRWYXVsdFNlY3JldA0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiU2VjcmV0ICRNaWRTZWNyZXROYW1lIGlzIGFscmVhZHkgc2V0LCBidXQgYSBuZXcgcGFzc3dvcmQgd2FzIHByb3ZpZGVkLiBVc2luZyB0aGUgcHJvdmlkZWQgcGFzc3dvcmQgaW5zdGVhZC4iDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJTZWNyZXQgJE1pZFNlY3JldE5hbWUgaXMgbm90IGEgdmFsaWQgU2VjdXJlU3RyaW5nIg0KICAgICAgICB9DQogICAgfQ0KICAgIGlmICgkZW52Ok1JRF9JTlNUQU5DRV9VU0VSTkFNRSAtYW5kICRlbnY6TUlEX0lOU1RBTkNFX1BBU1NXT1JEKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXNpbmcgcGFzc3dvcmQgTUlEX0lOU1RBTkNFX1VTRVJOQU1FOiAkTWlkU2VydmVyVXNlck5hbWUgYW5kIE1JRF9JTlNUQU5DRV9QQVNTV09SRCINCiAgICAgICAgJFBhc3N3b3JkID0gJGVudjpNSURfSU5TVEFOQ0VfUEFTU1dPUkQgfCBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCAtRm9yY2UNCiAgICAgICAgJE1pZFNlcnZlclVzZXJOYW1lID0gJGVudjpNSURfSU5TVEFOQ0VfVVNFUk5BTUUNCiAgICB9DQogICAgaWYgKC1ub3QgJFBhc3N3b3JkKSB7DQogICAgICAgICRQYXNzd29yZCA9IEdlbmVyYXRlUmFuZG9tUGFzc3dvcmQgLUxlbmd0aCAxOQ0KICAgIH0NCiAgICAkTWlkVXNlckNyZWRlbnRpYWxzID0gW3BzY3JlZGVudGlhbF06Om5ldygkTWlkU2VydmVyVXNlck5hbWUsICRQYXNzd29yZCkNCiAgICAkTWlkTWV0YWRhdGEgPSBbb3JkZXJlZF1Aew0KICAgICAgICBUYWcgICAgID0gJ1NOTUlEJw0KICAgICAgICBOYW1lICAgID0gJE1pZFNlcnZlck5hbWUNCiAgICAgICAgQ2x1c3RlciA9ICRNaWRTZXJ2ZXJDbHVzdGVyDQogICAgICAgIFN0YXR1cyAgPSAkT3BlcmF0aW9uDQogICAgfQ0KDQogICAgJE1pZFVzZXIgPSBbaGFzaHRhYmxlXUB7DQogICAgICAgIHVzZXJfbmFtZSAgICAgICAgICAgICAgICAgPSAkTWlkU2VydmVyVXNlck5hbWUNCiAgICAgICAgdXNlcl9wYXNzd29yZCAgICAgICAgICAgICA9IChDb252ZXJ0RnJvbS1TZWN1cmVTdHJpbmcgLVNlY3VyZVN0cmluZyAkUGFzc3dvcmQgLUFzUGxhaW5UZXh0KQ0KICAgICAgICBhY3RpdmUgICAgICAgICAgICAgICAgICAgID0gJHRydWUNCiAgICAgICAgZW1haWwgICAgICAgICAgICAgICAgICAgICA9ICIke01pZFNlcnZlclVzZXJOYW1lfUAke0RlZmF1bHRFbWFpbFN1ZmZpeH0iDQogICAgICAgIGxvY2tlZF9vdXQgICAgICAgICAgICAgICAgPSAkZmFsc2UNCiAgICAgICAgcGFzc3dvcmRfbmVlZHNfcmVzZXQgICAgICA9ICRmYWxzZQ0KICAgICAgICBmaXJzdF9uYW1lICAgICAgICAgICAgICAgID0gJE1pZFNlcnZlck5hbWUNCiAgICAgICAgbGFzdF9uYW1lICAgICAgICAgICAgICAgICA9ICdNaWQgU2VydmVyJw0KICAgICAgICBzb3VyY2UgICAgICAgICAgICAgICAgICAgID0gJ0F6dXJlIE1JRCcNCiAgICAgICAgaW50ZXJuYWxfaW50ZWdyYXRpb25fdXNlciA9ICR0cnVlDQogICAgICAgIGVtcGxveWVlX251bWJlciAgICAgICAgICAgPSAoJE1pZE1ldGFkYXRhLlZhbHVlcyAtam9pbiAnfCcpDQogICAgfQ0KICAgICRDdXJyZW50U25vd0F1dGggPSBHZXQtU05PV0F1dGggLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICAkVXNlcklzQWRtaW4gPSAkZmFsc2UNCiAgICBpZiAoJEN1cnJlbnRTbm93QXV0aCkgew0KICAgICAgICAkUm9sZVJlY29yZHMgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyX2hhc19yb2xlJyAtUXVlcnkgInVzZXJfbmFtZT1qYXZhc2NyaXB0OmdzLmdldFVzZXJOYW1lKCkiIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1FcnJvclZhcmlhYmxlIFVzZXJJc0FkbWluRXJyb3INCiAgICAgICAgaWYgKCRVc2VySXNBZG1pbkVycm9yKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDdXJyZW50IHVzZXIgaXMgbm90IGFuIGFkbWluLiBDYW5ub3QgYXNzaWduIHJvbGVzIG9yIGNyZWF0ZSB1c2VyLiBQcm9jZWVkaW5nIHdpdGggcGFzc3Rocm91Z2guIg0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDdXJyZW50IHVzZXIgaXMgYW4gYWRtaW4uIFByb2NlZWRpbmcgd2l0aCByb2xlIGFzc2lnbm1lbnQuIg0KICAgICAgICAgICAgJFVzZXJJc0FkbWluID0gKCRSb2xlUmVjb3Jkcy5Db3VudCAtZ3QgMCkgDQogICAgICAgIH0NCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEVycm9yIC1NZXNzYWdlICJObyBTZXJ2aWNlTm93IGF1dGhlbnRpY2F0aW9uIGZvdW5kIGluIGNvbnRleHQiDQogICAgfQ0KICAgICRNaWRTZXJ2ZXJVc2VyID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcicgLVF1ZXJ5ICJ1c2VyX25hbWU9JE1pZFNlcnZlclVzZXJOYW1lIiAtVmVyYm9zZQ0KICAgIGlmICgkTWlkU2VydmVyVXNlcikgew0KICAgICAgICBpZiAoJFVzZXJJc0FkbWluIC1hbmQgJE1pZFNlcnZlclVzZXIubG9ja2VkX291dCAtZXEgJ3RydWUnKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJVc2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSBpcyBsb2NrZWQgb3V0LiBVbmxvY2tpbmcgdXNlci4iDQogICAgICAgICAgICAkTWlkU2VydmVyVXNlciA9IFNldC1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXInIC1TeXNJZCAkTWlkU2VydmVyVXNlci5zeXNfaWQgLVByb3BlcnRpZXMgQHsgbG9ja2VkX291dCA9ICdmYWxzZScgfSAtSW5wdXREaXNwbGF5VmFsdWUgLVBhc3NUaHJ1DQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICgnezB9IGFscmVhZHkgZXhpc3RzLiBbYWN0aXZlOiB7MX1dIFtsb2NrZWRfb3V0OiB7Mn1dIFtwYXNzd29yZF9uZWVkc19yZXNldDogezN9XScgLWYgJE1pZFNlcnZlclVzZXJOYW1lLCAkTWlkU2VydmVyVXNlci5hY3RpdmUsICRNaWRTZXJ2ZXJVc2VyLmxvY2tlZF9vdXQsICRNaWRTZXJ2ZXJVc2VyLnBhc3N3b3JkX25lZWRzX3Jlc2V0KQ0KICAgICAgICAkTWlkVXNlclZhbGlkID0gR2V0LVNOT1dNSURSZWNvcmRXaXRoQ3JlZHMgLUNyZWRlbnRpYWwgJE1pZFVzZXJDcmVkZW50aWFscw0KICAgICAgICBpZiAoLW5vdCAkTWlkVXNlclZhbGlkKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJVc2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSBwYXNzd29yZCBpcyBpbnZhbGlkIg0KICAgICAgICB9DQogICAgICAgIGlmICgkVXNlcklzQWRtaW4pIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXBkYXRpbmcgdXNlciAkTWlkU2VydmVyVXNlck5hbWUiIA0KICAgICAgICAgICAgJE1pZFNlcnZlclVzZXIgPSBTZXQtU05PV09iamVjdCAtVGFibGUgJ3N5c191c2VyJyAtU3lzSWQgJE1pZFNlcnZlclVzZXIuc3lzX2lkIC1Qcm9wZXJ0aWVzICRNaWRVc2VyIC1JbnB1dERpc3BsYXlWYWx1ZSAtUGFzc1RocnUNCiAgICAgICAgfQ0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgaWYgKCRVc2VySXNBZG1pbikgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDcmVhdGluZyB1c2VyICRNaWRTZXJ2ZXJVc2VyTmFtZSINCiAgICAgICAgICAgICRNaWRTZXJ2ZXJVc2VyID0gTmV3LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcicgLVByb3BlcnRpZXMgJE1pZFVzZXIgLUlucHV0RGlzcGxheVZhbHVlIC1QYXNzVGhydQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiQ3VycmVudCB1c2VyIGlzIG5vdCBhbiBhZG1pbi4gVXNpbmcgRXhpc3RpbmcgU05PV0F1dGggQ3JlZGVudGlhbHMiDQogICAgICAgICAgICAkTWlkU2VydmVyVXNlck5hbWUgPSAkQ3VycmVudFNub3dBdXRoLkNyZWRlbnRpYWwuVXNlck5hbWUNCiAgICAgICAgICAgICRNaWRVc2VyQ3JlZGVudGlhbHMgPSAkQ3VycmVudFNub3dBdXRoLkNyZWRlbnRpYWwNCiAgICAgICAgICAgICRNaWRTZWNyZXROYW1lID0gIiR7TWlkU2VydmVyVXNlck5hbWV9LXBhc3N3b3JkIg0KICAgICAgICAgICAgJE1pZFNlcnZlclVzZXIgPSBHZXQtU05PV0N1cnJlbnRVc2VyIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICBpZiAoLW5vdCAkTWlkU2VydmVyVXNlcikgew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIk5vIHVzZXIgZm91bmQgd2l0aCB1c2VybmFtZSAkTWlkU2VydmVyVXNlck5hbWUuIENhbm5vdCBhc3NpZ24gcm9sZXMgb3IgY2FwYWJpbGl0aWVzLiINCiAgICAgICAgICAgICAgICByZXR1cm4gJG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoJFVzZXJJc0FkbWluKSB7DQogICAgICAgICRNaWRTZXJ2ZXJVc2VyUm9sZXMgPSBBZGQtU05PV01JRFVzZXJSb2xlcyAtVXNlclN5c0lkICRNaWRTZXJ2ZXJVc2VyLnN5c19pZCAtUm9sZXMgJFJvbGVzDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDdXJyZW50IHVzZXIgaXMgbm90IGFuIGFkbWluLiBDYW5ub3QgYXNzaWduIHJvbGVzIHRvICRNaWRTZXJ2ZXJVc2VyTmFtZS4gUm9sZXMgbXVzdCBiZSBhc3NpZ25lZCBtYW51YWxseS4iDQogICAgfQ0KICAgICRNaWRVc2VyVmFsaWQgPSBHZXQtU05PV01JRFJlY29yZFdpdGhDcmVkcyAtQ3JlZGVudGlhbCAkTWlkVXNlckNyZWRlbnRpYWxzIA0KICAgIGlmICgkTWlkVXNlclZhbGlkKSB7DQogICAgICAgICRDdXJyZW50U2VjcmV0ID0gR2V0LVNlY3JldCAtTmFtZSAkTWlkU2VjcmV0TmFtZSAtVmF1bHQgJFNjcmlwdDpTTl9NSURfVkFVTFRfTkFNRSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtQXNQbGFpblRleHQNCiAgICAgICAgaWYgKCRDdXJyZW50U2VjcmV0IC1hbmQgJEN1cnJlbnRTZWNyZXQgLWVxICRNaWRVc2VyQ3JlZGVudGlhbHMuR2V0TmV0d29ya0NyZWRlbnRpYWwoKS5QYXNzd29yZCkgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAiU2VjcmV0ICRNaWRTZWNyZXROYW1lIGFscmVhZHkgZXhpc3RzIGFuZCBpcyB0aGUgc2FtZSBhcyB0aGUgbmV3IHBhc3N3b3JkLiBObyBuZWVkIHRvIHVwZGF0ZS4iDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlNldHRpbmcgcGFzc3dvcmQgZm9yICRNaWRTZXJ2ZXJVc2VyTmFtZSBpbiBWYXVsdCINCiAgICAgICAgICAgIFNldC1TZWNyZXQgLU5hbWUgJE1pZFNlY3JldE5hbWUgLVNlY3JldCAkTWlkVXNlckNyZWRlbnRpYWxzLlBhc3N3b3JkIC1WYXVsdCAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgIH0NCiAgICB9DQogICAgJFJlc3VsdHMgPSBbb3JkZXJlZF1Aew0KICAgICAgICBNaWRTZXJ2ZXJOYW1lID0gJE1pZFNlcnZlck5hbWUNCiAgICAgICAgVXNlciAgICAgICAgICA9ICRNaWRTZXJ2ZXJVc2VyDQogICAgICAgIFJvbGVzICAgICAgICAgPSAkTWlkU2VydmVyVXNlclJvbGVzDQogICAgICAgIENyZWRlbnRpYWxzICAgPSAkTWlkVXNlckNyZWRlbnRpYWxzDQogICAgICAgIE1pZFZlcnNpb24gICAgPSAkTWlkVXNlclZhbGlkLnZhbHVlDQogICAgICAgIFZhdWx0U2VjcmV0ICAgPSAkTWlkU2VjcmV0TmFtZQ0KICAgICAgICBTbm93QXV0aCAgICAgID0gQHsNCiAgICAgICAgICAgIEluc3RhbmNlICAgPSAkQ3VycmVudFNub3dBdXRoLkluc3RhbmNlDQogICAgICAgICAgICBDcmVkZW50aWFsID0gJE1pZFVzZXJDcmVkZW50aWFscw0KICAgICAgICB9DQogICAgfQ0KICAgIGlmICgkUmVzdWx0cy5NaWRWZXJzaW9uKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiVXNlciAkTWlkU2VydmVyVXNlck5hbWUgaXMgdmFsaWQiDQogICAgICAgICRSZXN1bHRzLk1pZEltYWdlRmFjdHMgPSBHZXQtU05PV01JRERvd25sb2FkRmFjdHMgLUJ1aWxkVGFnICRSZXN1bHRzLk1pZFZlcnNpb24NCiAgICB9DQogICAgV3JpdGUtUFNGTWVzc2FnZSAoJFJlc3VsdHMgfCBDb252ZXJ0VG8tSnNvbiAtRGVwdGggMykNCiAgICByZXR1cm4gJFJlc3VsdHMgICANCn0NCg0KZnVuY3Rpb24gU3RhcnQtU05PV01JRFZhbGlkYXRpb25TY3JpcHQgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRNaWRTZXJ2ZXJOYW1lLA0KICAgICAgICBbc3RyaW5nXSRPcGVyYXRpb24sDQogICAgICAgIFtpbnRdJFRpbWVvdXRNaW51dGVzID0gNDUNCiAgICApDQogICAgJFNjcmlwdE5hbWUgPSAiQVpVUkVfREVWT1BTX01JRFZBTElEQVRFXyQoJE1pZFNlcnZlck5hbWUpIg0KICAgICRBZG1pblVzZXIgPSBHZXQtU05PV0N1cnJlbnRVc2VyDQogICAgJEVjY0FnZW50ID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSIgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgaWYgKCRFY2NBZ2VudCAtYW5kICRFY2NBZ2VudC52YWxpZGF0ZWQgLWVxICd0cnVlJyAtYW5kICRFY2NBZ2VudC5zdGF0dXMgLWVxICdEb3duJykgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgJ2VjY19hZ2VudCBpcyBET1dOLiBJbnZhbGlkYXRpbmcnDQogICAgICAgICRFY2NBZ2VudCA9ICRFY2NBZ2VudCB8IFNldC1TTk9XT2JqZWN0IC1Qcm9wZXJ0aWVzIEB7IHZhbGlkYXRlZCA9ICdmYWxzZSc7IHZhbGlkYXRlZF9hdCA9ICcnOyB2YWxpZGF0ZWRfYnkgPSAnJyB9IC1UYWJsZSAnZWNjX2FnZW50JyAtUGFzc1RocnUNCiAgICB9DQogICAgJEV4aXN0aW5nU2NyaXB0ID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNhdXRvX3NjcmlwdCcgLVF1ZXJ5ICJuYW1lPSR7U2NyaXB0TmFtZX0iDQogICAgaWYgKCRFeGlzdGluZ1NjcmlwdC5zeXNfaWQpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICdTY3JpcHQgYWxyZWFkeSBleGlzdHMsIGRlbGV0aW5nJw0KICAgICAgICBSZW1vdmUtU05PV09iamVjdCAtVGFibGUgJ3N5c2F1dG9fc2NyaXB0JyAtU3lzX0lEICRFeGlzdGluZ1NjcmlwdC5zeXNfaWQgLUNvbmZpcm06JGZhbHNlIHwgT3V0LU51bGwNCiAgICB9DQogICAgaWYgKCRPcGVyYXRpb24gLWVxICdyZW1vdmUnKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAnT3BlcmF0aW9uIGlzIHJlbW92ZS4gTm8gbmVlZCB0byBjcmVhdGUgc3lzYXV0b19zY3JpcHQgZW50cnkuJw0KICAgICAgICByZXR1cm4gJGZhbHNlDQogICAgfQ0KICAgICMgQ2hlY2sgdGhlIGFnZW50LiBJZiBhbHJlYWR5IHZhbGlkYXRlZCwgZG8gbm90aGluZw0KICAgICRzeXNTY3JpcHRCb2R5ID0gQHsNCiAgICAgICAgJ2NvbmRpdGlvbmFsJyAgICAgICA9ICdmYWxzZScNCiAgICAgICAgJ2J1c2luZXNzX2NhbGVuZGFyJyA9ICcnDQogICAgICAgICdlbnRlcmVkX3RpbWUnICAgICAgPSAnMTk3MC0wMS0wMSAwMDowMDowMCcNCiAgICAgICAgJ3J1bl9hc190eicgICAgICAgICA9ICcnDQogICAgICAgICdydW5fYXMnICAgICAgICAgICAgPSAkQWRtaW5Vc2VyLnN5c19pZA0KICAgICAgICAncnVuX3R5cGUnICAgICAgICAgID0gJ3BlcmlvZGljYWxseScNCiAgICAgICAgJ3J1bl9zdGFydCcgICAgICAgICA9IChHZXQtRGF0ZSkuQWRkTWludXRlcygrMSkuVG9TdHJpbmcoJ3l5eXktTU0tZGQgSEg6bW06c3MnKSAgICANCiAgICAgICAgJ3J1bl9kYXlvZm1vbnRoJyAgICA9ICcxJw0KICAgICAgICAnc3lzX3Njb3BlJyAgICAgICAgID0gJ2dsb2JhbCcNCiAgICAgICAgJ3J1bl9kYXlvZndlZWsnICAgICA9ICcxJw0KICAgICAgICAnb2Zmc2V0JyAgICAgICAgICAgID0gJycNCiAgICAgICAgJ3J1bl90aW1lJyAgICAgICAgICA9ICcxOTcwLTAxLTAxIDA1OjAwOjAwJw0KICAgICAgICAnYWN0aXZlJyAgICAgICAgICAgID0gJ3RydWUnDQogICAgICAgICd0aW1lX3pvbmUnICAgICAgICAgPSAnJw0KICAgICAgICAnc3lzX3BhY2thZ2UnICAgICAgID0gJ2dsb2JhbCcNCiAgICAgICAgJ2NvbmRpdGlvbicgICAgICAgICA9ICcnDQogICAgICAgICdvZmZzZXRfdHlwZScgICAgICAgPSAnMCcNCiAgICAgICAgJ25hbWUnICAgICAgICAgICAgICA9ICRTY3JpcHROYW1lDQogICAgICAgICdtYXhfZHJpZnQnICAgICAgICAgPSAnJw0KICAgICAgICAncnVuX3BlcmlvZCcgICAgICAgID0gJzE5NzAtMDEtMDEgMDA6MDA6NDUnICMgZXZlcnkgNDUgc2Vjb25kcyAgIA0KICAgIH0NCiAgICANCiAgICAkc2NyaXB0SGVhZGVyID0gJ3ZhciBTWVNfQVVUT19TQ1JJUFRfTkFNRT0iQVpVUkVfREVWT1BTX01JRFZBTElEQVRFX3swfSI7dmFyIE1JRF9TRVJWRVJfTkFNRT0iezB9Ijt2YXIgU1lTX0FVVE9fU0NSSVBUX0VYUElSWV9NSU5VVEVTPXsxfTsnIC1mICRNaWRTZXJ2ZXJOYW1lLCAkVGltZW91dE1pbnV0ZXMNCiAgICAkc2NyaXB0QmFzZSA9ICdmdW5jdGlvbiBHZXRNaWRVc2VyTWV0YWRhdGEobWlkU2VydmVyTmFtZSl7dmFyIHVzZXI9bmV3IEdsaWRlUmVjb3JkKCJzeXNfdXNlciIpO3VzZXIuYWRkUXVlcnkoImVtcGxveWVlX251bWJlciIsIlNUQVJUU1dJVEgiLCJTTk1JRHwiK21pZFNlcnZlck5hbWUpO3VzZXIucXVlcnkoKTtpZighdXNlci5uZXh0KCkpe2dzLmluZm8oIlVzZXIgbm90IGZvdW5kIGZvciBNSUQgU2VydmVyICIrbWlkU2VydmVyTmFtZSk7cmV0dXJuIG51bGx9dmFyIG1ldGFQYXJ0cz11c2VyLmVtcGxveWVlX251bWJlci5zcGxpdCgifCIpO3ZhciBvdXRwdXRzPXt1c2VyOnVzZXIsbWlkU2VydmVyTmFtZTptaWRTZXJ2ZXJOYW1lfTtpZihtZXRhUGFydHMubGVuZ3RoPj0zKXtvdXRwdXRzLm1pZFNlcnZlckNsdXN0ZXI9bWV0YVBhcnRzWzJdfWlmKG1ldGFQYXJ0cy5sZW5ndGg+PTQpe291dHB1dHMubWlkU2VydmVyQ2x1c3Rlcj1tZXRhUGFydHNbMl07b3V0cHV0cy5taWRTZXJ2ZXJTdGF0dXM9bWV0YVBhcnRzWzNdfXZhciBhZ2VudD1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudCIpO2FnZW50LmFkZFF1ZXJ5KCJuYW1lIixtaWRTZXJ2ZXJOYW1lKTthZ2VudC5xdWVyeSgpO2lmKGFnZW50Lm5leHQoKSl7b3V0cHV0cy5hZ2VudD1hZ2VudH1yZXR1cm4gb3V0cHV0c31mdW5jdGlvbiBDaGVja0NhcGFiaWxpdGllcyhtaWRTZXJ2ZXJOYW1lLGNhcGFiaWxpdGllcyl7aWYoIWNhcGFiaWxpdGllcyl7Y2FwYWJpbGl0aWVzPVsiQUxMIl19dmFyIG91dHB1dHM9e2NhcGFiaWxpdGllczpbXX07dmFyIGFnZW50PW5ldyBHbGlkZVJlY29yZCgiZWNjX2FnZW50Iik7YWdlbnQuYWRkUXVlcnkoIm5hbWUiLG1pZFNlcnZlck5hbWUpO2FnZW50LnF1ZXJ5KCk7aWYoIWFnZW50Lm5leHQoKSl7Z3MuaW5mbygiTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUrIiBub3QgZm91bmQiKTtyZXR1cm59dmFyIGFnZW50Q2Fwcz1jYXBhYmlsaXRpZXMubWFwKGZ1bmN0aW9uKGNhcCl7dmFyIGNhcFF1ZXJ5PW5ldyBHbGlkZVJlY29yZCgiZWNjX2FnZW50X2NhcGFiaWxpdHlfbTJtIik7Y2FwUXVlcnkuYWRkRW5jb2RlZFF1ZXJ5KCJhZ2VudD0iK2FnZW50LnN5c19pZCsiXmNhcGFiaWxpdHkubmFtZT0iK2NhcCk7Y2FwUXVlcnkucXVlcnkoKTtpZihjYXBRdWVyeS5uZXh0KCkpe2dzLmRlYnVnKCJDYXBhYmlsaXR5ICIrY2FwKyIgZm91bmQgZm9yIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKTtvdXRwdXRzLmNhcGFiaWxpdGllcy5wdXNoKGNhcFF1ZXJ5LnN5c19pZC50b1N0cmluZygpKX1lbHNle2dzLmluZm8oIkNhcGFiaWxpdHkgIitjYXArIiBub3QgZm91bmQgZm9yIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKTt2YXIgbmV3Q2FwPW5ldyBHbGlkZVJlY29yZCgiZWNjX2FnZW50X2NhcGFiaWxpdHlfbTJtIik7bmV3Q2FwLmluaXRpYWxpemUoKTtuZXdDYXAuY2FwYWJpbGl0eS5zZXREaXNwbGF5VmFsdWUoY2FwKTtuZXdDYXAuYWdlbnQ9YWdlbnQuc3lzX2lkO2lmKG5ld0NhcC5pbnNlcnQoKSl7b3V0cHV0cy5jYXBhYmlsaXRpZXMucHVzaChuZXdDYXAuc3lzX2lkKX1lbHNle2dzLmluZm8oIkZhaWxlZCB0byBhZGQgY2FwYWJpbGl0eSAiK2NhcCsiIHRvIE1JRCBTZXJ2ZXIgIittaWRTZXJ2ZXJOYW1lKX19cmV0dXJuIGNhcFF1ZXJ5fSk7cmV0dXJuIG91dHB1dHN9ZnVuY3Rpb24gQ2hlY2tDbHVzdGVyKG1pZFNlcnZlck5hbWUpe3ZhciB1c2VyTWV0YT1HZXRNaWRVc2VyTWV0YWRhdGEobWlkU2VydmVyTmFtZSk7aWYodXNlck1ldGE9PT1udWxsKXtncy5pbmZvKCJVc2VyIG1ldGFkYXRhIG5vdCBmb3VuZCBmb3IgTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUpO3JldHVybn12YXIgY2x1c3Rlcj1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudF9jbHVzdGVyIik7Y2x1c3Rlci5hZGRRdWVyeSgibmFtZSIsdXNlck1ldGEubWlkU2VydmVyQ2x1c3Rlcik7Y2x1c3Rlci5xdWVyeSgpO2lmKCFjbHVzdGVyLm5leHQoKSl7Z3MuaW5mbygiQ2x1c3RlciAiK3VzZXJNZXRhLm1pZFNlcnZlckNsdXN0ZXIrIiBub3QgZm91bmQuIENyZWF0aW5nLi4uIik7Y2x1c3Rlcj1uZXcgR2xpZGVSZWNvcmQoImVjY19hZ2VudF9jbHVzdGVyIik7Y2x1c3Rlci5pbml0aWFsaXplKCk7Y2x1c3Rlci5uYW1lPXVzZXJNZXRhLm1pZFNlcnZlckNsdXN0ZXI7Y2x1c3Rlci5hY3RpdmU9dHJ1ZTtjbHVzdGVyLmluc2VydCgpfXZhciBjbHVzdGVyTWVtYmVyPW5ldyBHbGlkZVJlY29yZCgiZWNjX2FnZW50X2NsdXN0ZXJfbWVtYmVyX20ybSIpO2NsdXN0ZXJNZW1iZXIuYWRkUXVlcnkoImNsdXN0ZXIubmFtZSIsdXNlck1ldGEubWlkU2VydmVyQ2x1c3Rlcik7Y2x1c3Rlck1lbWJlci5hZGRRdWVyeSgiYWdlbnQubmFtZSIsbWlkU2VydmVyTmFtZSk7Y2x1c3Rlck1lbWJlci5xdWVyeSgpO2lmKCFjbHVzdGVyTWVtYmVyLm5leHQoKSl7Z3MuaW5mbygiTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUrIiBub3QgZm91bmQgaW4gY2x1c3RlciAiK3VzZXJNZXRhLm1pZFNlcnZlckNsdXN0ZXIpO2NsdXN0ZXJNZW1iZXI9bmV3IEdsaWRlUmVjb3JkKCJlY2NfYWdlbnRfY2x1c3Rlcl9tZW1iZXJfbTJtIik7Y2x1c3Rlck1lbWJlci5pbml0aWFsaXplKCk7Y2x1c3Rlck1lbWJlci5jbHVzdGVyLnNldERpc3BsYXlWYWx1ZSh1c2VyTWV0YS5taWRTZXJ2ZXJDbHVzdGVyKTtjbHVzdGVyTWVtYmVyLmFnZW50LnNldERpc3BsYXlWYWx1ZShtaWRTZXJ2ZXJOYW1lKTtjbHVzdGVyTWVtYmVyLmluc2VydCgpfXJldHVybiBjbHVzdGVyTWVtYmVyLnN5c19pZC50b1N0cmluZygpfWZ1bmN0aW9uIFZhbGlkYXRlTWlkU2VydmVyKG1pZFNlcnZlck5hbWUpe3ZhciBvdXRwdXRzPXtzdWNjZXNzOmZhbHNlLHN0YXR1czoidW5rbm93biIsbWlkU2VydmVyOm1pZFNlcnZlck5hbWV9O3ZhciB1c2VyTWV0YT1HZXRNaWRVc2VyTWV0YWRhdGEobWlkU2VydmVyTmFtZSk7aWYodXNlck1ldGE9PT1udWxsKXtncy5pbmZvKCJVc2VyIG1ldGFkYXRhIG5vdCBmb3VuZCBmb3IgTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUpO291dHB1dHMuc3RhdHVzPSJub3QgZm91bmQiO3JldHVybiBvdXRwdXRzfWlmKGdzLm5pbCh1c2VyTWV0YS5hZ2VudCkpe2dzLmluZm8oIkFnZW50IG5vdCBmb3VuZCBmb3IgTUlEIFNlcnZlciAiK21pZFNlcnZlck5hbWUpO291dHB1dHMuc3RhdHVzPSJhZ2VudCBub3QgZm91bmQiO3JldHVybiBvdXRwdXRzfW91dHB1dHMuY2x1c3Rlck1lbWJlcj1DaGVja0NsdXN0ZXIobWlkU2VydmVyTmFtZSk7b3V0cHV0cy5jYXBhYmlsaXRpZXM9Q2hlY2tDYXBhYmlsaXRpZXMobWlkU2VydmVyTmFtZSk7dmFyIGFnZW50PXVzZXJNZXRhLmFnZW50O291dHB1dHMuYWdlbnRfc3RhdHVzPWFnZW50LnN0YXR1cy50b1N0cmluZygpO3ZhciBtbT1uZXcgZ2xvYmFsLk1JRFNlcnZlck1hbmFnZTt2YXIgaW52YWxpZGF0ZVJlcXVpcmVkPWZhbHNlO3ZhciBlcnJvcnM9bmV3IGdsb2JhbC5HbGlkZVF1ZXJ5KCJlY2NfYWdlbnRfaXNzdWUiKS53aGVyZSgibWlkX3NlcnZlci5uYW1lIixtaWRTZXJ2ZXJOYW1lKS53aGVyZSgic3RhdGUiLCIhPSIsInJlc29sdmVkIikud2hlcmUoInNvdXJjZSIsIlVwZGF0ZVB1YmxpY0tleSIpLnNlbGVjdCgic3lzX2lkIiwic3RhdGUiLCJtZXNzYWdlIikudG9BcnJheSgxMCk7aWYoZXJyb3JzLmxlbmd0aD4wKXtpbnZhbGlkYXRlUmVxdWlyZWQ9dHJ1ZTtpZihhZ2VudC52YWxpZGF0ZWQudG9TdHJpbmcoKT09PSJ0cnVlIil7aWYoYWdlbnQuc3RhdHVzPT0iVXAiKXtncy5pbmZvKCJBZ2VudCByZS12YWxpZGF0aW9uIHJlcXVpcmVkIGZvciBNSUQgU2VydmVyICIrbWlkU2VydmVyTmFtZSk7bW0uaW52YWxpZGF0ZShhZ2VudC5uYW1lKTtvdXRwdXRzLnN0YXR1cz0iaW52YWxpZGF0aW5nIn19cmV0dXJuIG91dHB1dHN9aWYoYWdlbnQudmFsaWRhdGVkLnRvU3RyaW5nKCk9PT0iZmFsc2UiJiZhZ2VudC5zdGF0dXM9PSJVcCIpe21tLnZhbGlkYXRlKGFnZW50Lm5hbWUpO291dHB1dHMuc3RhdHVzPSJ2YWxpZGF0aW5nIjtvdXRwdXRzLnN1Y2Nlc3M9dHJ1ZX1lbHNle291dHB1dHMuc3RhdHVzPXVzZXJNZXRhLmFnZW50LnZhbGlkYXRlZC50b1N0cmluZygpO291dHB1dHMuc3VjY2Vzcz10cnVlfXJldHVybiBvdXRwdXRzfWZ1bmN0aW9uIENsZWFyQXV0b1NjcmlwdChuYW1lLGZvcmNlRGVsZXRlKXt2YXIgc2NyaXB0PW5ldyBHbGlkZVJlY29yZCgic3lzYXV0b19zY3JpcHQiKTtzY3JpcHQuYWRkUXVlcnkoIm5hbWUiLG5hbWUpO3NjcmlwdC5xdWVyeSgpO2lmKHNjcmlwdC5uZXh0KCkpe2lmKGZvcmNlRGVsZXRlKXtzY3JpcHQuZGVsZXRlUmVjb3JkKCk7cmV0dXJuInN5c2F1dG9fc2NyaXB0ICIrbmFtZSsiIGRlbGV0ZWQifWVsc2V7dmFyIGxhc3RNb2RpZmllZD1uZXcgR2xpZGVEYXRlVGltZShzY3JpcHQuc3lzX2NyZWF0ZWRfb24pO3ZhciBub3c9bmV3IEdsaWRlRGF0ZVRpbWU7dmFyIG1pbnM9Z3MuZGF0ZURpZmYobGFzdE1vZGlmaWVkLG5vdyx0cnVlKS82MDtpZihtaW5zPlNZU19BVVRPX1NDUklQVF9FWFBJUllfTUlOVVRFUyl7c2NyaXB0LmRlbGV0ZVJlY29yZCgpO3JldHVybiJzeXNhdXRvX3NjcmlwdCAiK25hbWUrIiBkZWxldGVkIC0gVGltZSBFbGFwc2VkOiAiK21pbnN9ZWxzZXtyZXR1cm4ic3lzYXV0b19zY3JpcHQgIituYW1lKyIgbm90IGV4cGlyZWQuIE1pbnV0ZXMgRWxhcHNlZDogIittaW5zfX19ZWxzZXtyZXR1cm4ic3lzYXV0b19zY3JpcHQgIituYW1lKyIgbm90IGZvdW5kIn19dmFyIHJlc3VsdHM9VmFsaWRhdGVNaWRTZXJ2ZXIoTUlEX1NFUlZFUl9OQU1FKTtpZihyZXN1bHRzLnN1Y2Nlc3Mpe3Jlc3VsdHMuc3lzX3NjcmlwdF9hdXRvPUNsZWFyQXV0b1NjcmlwdChTWVNfQVVUT19TQ1JJUFRfTkFNRSxmYWxzZSl9ZWxzZXtyZXN1bHRzLnN5c19zY3JpcHRfYXV0bz1DbGVhckF1dG9TY3JpcHQoU1lTX0FVVE9fU0NSSVBUX05BTUUsZmFsc2UpfWdzLmluZm8oSlNPTi5zdHJpbmdpZnkocmVzdWx0cyxudWxsLDIpKTsnDQogICAgJHN5c1NjcmlwdEJvZHkuc2NyaXB0ID0gJHNjcmlwdEhlYWRlciArICRzY3JpcHRCYXNlDQogICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJDcmVhdGluZyBzeXNhdXRvX3NjcmlwdCByZWNvcmQgaW4gU04gbmFtZTogJFNjcmlwdE5hbWUuIEV4cGlyeTogJFRpbWVvdXRNaW51dGVzIG1pbnV0ZXMiDQogICAgJENyZWF0ZVJlcXVlc3QgPSBAew0KICAgICAgICBVcmkgICAgICAgICA9ICcvYXBpL25vdy90YWJsZS9zeXNhdXRvX3NjcmlwdD9zeXNwYXJtX3RyYW5zYWN0aW9uX3Njb3BlPWdsb2JhbCcNCiAgICAgICAgQm9keSAgICAgICAgPSAoJHN5c1NjcmlwdEJvZHkgfCBDb252ZXJ0VG8tSnNvbiAtRGVwdGggMykNCiAgICAgICAgQ29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbicNCiAgICAgICAgTWV0aG9kICAgICAgPSAnUE9TVCcNCiAgICB9DQogICAgJENyZWF0ZVJlc3BvbnNlID0gSW52b2tlLVNOT1dXZWJSZXF1ZXN0IEBDcmVhdGVSZXF1ZXN0IC1Vc2VSZXN0TWV0aG9kDQogICAgcmV0dXJuIEB7DQogICAgICAgIG5hbWUgICA9ICRTY3JpcHROYW1lDQogICAgICAgIHN5c19pZCA9ICRDcmVhdGVSZXNwb25zZS5yZXN1bHQuc3lzX2lkDQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBSZW1vdmUtU05PV01JRFNlcnZlckRlcGxveW1lbnQgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRNaWRTZXJ2ZXJOYW1lLA0KICAgICAgICBbc3dpdGNoXSRGb3JjZQ0KICAgICkNCiAgICAkQnVpbGRDb250ZXh0ID0gUmVzb2x2ZS1TTk9XTUlEQnVpbGRDb250ZXh0IC1SZWxvYWRDb250ZXh0DQogICAgJENvbnRhaW5lckdyb3VwID0gJEJ1aWxkQ29udGV4dC5yYXcgfCBXaGVyZS1PYmplY3QgeyAkXy50eXBlIC1lcSAnbWljcm9zb2Z0LmNvbnRhaW5lcmluc3RhbmNlL2NvbnRhaW5lcmdyb3VwcycgLWFuZCAkXy5uYW1lIC1lcSAkTWlkU2VydmVyTmFtZSB9IHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgIA0KICAgICRzYSA9IEdldC1BelN0b3JhZ2VBY2NvdW50IC1SZXNvdXJjZUdyb3VwTmFtZSAkQnVpbGRDb250ZXh0LlN0b3JhZ2VBY2NvdW50LnJlc291cmNlR3JvdXAgYA0KICAgICAgICAtTmFtZSAkQnVpbGRDb250ZXh0LlN0b3JhZ2VBY2NvdW50Lm5hbWUgYA0KICAgICAgICAtRXJyb3JBY3Rpb24gU3RvcA0KICAgICRzYWN0eCA9IE5ldy1BelN0b3JhZ2VDb250ZXh0IC1TdG9yYWdlQWNjb3VudE5hbWUgJHNhLlN0b3JhZ2VBY2NvdW50TmFtZSAtU3RvcmFnZUFjY291bnRLZXkgKEdldC1BelN0b3JhZ2VBY2NvdW50S2V5IC1SZXNvdXJjZUdyb3VwTmFtZSAkQnVpbGRDb250ZXh0LlN0b3JhZ2VBY2NvdW50LnJlc291cmNlR3JvdXAgLU5hbWUgJEJ1aWxkQ29udGV4dC5TdG9yYWdlQWNjb3VudC5uYW1lKVswXS5WYWx1ZSBgDQogICAgICAgIC1FcnJvckFjdGlvbiBTdG9wDQogICAgJHNoYXJlcyA9IEdldC1BelN0b3JhZ2VTaGFyZSAtQ29udGV4dCAkc2FjdHggLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUNCiAgICBpZiAoJENvbnRhaW5lckdyb3VwKSB7DQogICAgICAgICRDb250YWluZXJHcm91cCA9IEdldC1BekNvbnRhaW5lckdyb3VwIC1SZXNvdXJjZUdyb3VwTmFtZSAkQ29udGFpbmVyR3JvdXAucmVzb3VyY2VHcm91cCAtTmFtZSAkQ29udGFpbmVyR3JvdXAubmFtZSAtU3Vic2NyaXB0aW9uSWQgJENvbnRhaW5lckdyb3VwLnN1YnNjcmlwdGlvbklkDQogICAgICAgIGlmICgkRm9yY2UuSXNQcmVzZW50KSB7DQogICAgICAgICAgICAkQ29udGFpbmVyR3JvdXAgfCBSZW1vdmUtQXpDb250YWluZXJHcm91cCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtQ29uZmlybTokZmFsc2UNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ29udGFpbmVyIGdyb3VwICQoJENvbnRhaW5lckdyb3VwLm5hbWUpIGZvdW5kLCBidXQgbm90IGZvcmNpbmcgcmVtb3ZhbC4iDQogICAgICAgIH0NCiAgICB9DQogICAgJFNoYXJlTmFtZXMgPSBAKCRNaWRTZXJ2ZXJOYW1lLCAiJHtNaWRTZXJ2ZXJOYW1lfWtleXN0b3JlIikNCiAgICBmb3JlYWNoICggJFNoYXJlTmFtZSBpbiAkU2hhcmVOYW1lcykgew0KICAgICAgICAkU2hhcmUgPSAkc2hhcmVzIHwgV2hlcmUtT2JqZWN0IHsgJF8uTmFtZSAtZXEgJFNoYXJlTmFtZSB9DQogICAgICAgIGlmICgkU2hhcmUpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiUmVtb3Zpbmcgc3RvcmFnZSBzaGFyZSAkKCRTaGFyZS5OYW1lKSINCiAgICAgICAgICAgIGlmICgkRm9yY2UuSXNQcmVzZW50KSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJGb3JjaW5nIHJlbW92YWwgb2Ygc3RvcmFnZSBzaGFyZSAkKCRTaGFyZS5OYW1lKSINCiAgICAgICAgICAgICAgICBSZW1vdmUtQXpTdG9yYWdlU2hhcmUgLUNvbnRleHQgJHNhY3R4IC1OYW1lICRTaGFyZS5OYW1lIC1Gb3JjZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtQ29uZmlybTokZmFsc2UNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIlN0b3JhZ2Ugc2hhcmUgJCgkU2hhcmUuTmFtZSkgZm91bmQsIGJ1dCBub3QgZm9yY2luZyByZW1vdmFsLiINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIlN0b3JhZ2Ugc2hhcmUgJCgkU2hhcmVOYW1lKSBub3QgZm91bmQiDQogICAgICAgIH0NCiAgICB9DQogICAgJEVjY0FnZW50ID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSIgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgaWYgKCRFY2NBZ2VudCkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIk1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgZm91bmQiDQogICAgICAgIGlmICgkRWNjQWdlbnQudXNlcl9uYW1lKSB7DQogICAgICAgICAgICAkRWNjQWdlbnRVc2VyID0gR2V0LVNOT1dVc2VyIC1RdWVyeSAidXNlcl9uYW1lPSQoJEVjY0FnZW50LnVzZXJfbmFtZSkiIHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMQ0KICAgICAgICAgICAgaWYgKCRGb3JjZS5Jc1ByZXNlbnQpIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlJlbW92aW5nIE1JRCBTZXJ2ZXIgdXNlciAkKCRFY2NBZ2VudC51c2VyX25hbWUpIg0KICAgICAgICAgICAgICAgIGlmICgkRWNjQWdlbnRVc2VyKSB7DQogICAgICAgICAgICAgICAgICAgIFJlbW92ZS1TTk9XT2JqZWN0IC1UYWJsZSAnc3lzX3VzZXInIC1TeXNfSUQgJEVjY0FnZW50VXNlci5zeXNfaWQgLUNvbmZpcm06JGZhbHNlIHwgT3V0LU51bGwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyIHVzZXIgJCgkRWNjQWdlbnQudXNlcl9uYW1lKSBmb3VuZCwgYnV0IG5vdCBmb3JjaW5nIHJlbW92YWwuIg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmICgkRm9yY2UuSXNQcmVzZW50KSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlJlbW92aW5nIE1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUiDQogICAgICAgICAgICBSZW1vdmUtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVN5c19JRCAkRWNjQWdlbnQuc3lzX2lkIC1Db25maXJtOiRmYWxzZSB8IE91dC1OdWxsDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIGZvdW5kLCBidXQgbm90IGZvcmNpbmcgcmVtb3ZhbC4iDQogICAgICAgIH0NCiAgICB9DQogICAgQHsNCiAgICAgICAgRWNjQWdlbnQgICAgICAgPSAkRWNjQWdlbnQNCiAgICAgICAgU2hhcmVzICAgICAgICAgPSAkc2hhcmVzDQogICAgICAgIENvbnRhaW5lckdyb3VwID0gJENvbnRhaW5lckdyb3VwLmlkDQogICAgICAgIE1pZFNlcnZlck5hbWUgID0gJE1pZFNlcnZlck5hbWUNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEludm9rZS1TTk9XTUlEVmFsaWRhdGUgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRNaWRTZXJ2ZXJOYW1lDQogICAgKQ0KICAgICRNaWRTZXJ2ZXIgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVF1ZXJ5ICJuYW1lPSRNaWRTZXJ2ZXJOYW1lIiB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDENCiAgICBpZiAoIC1ub3QgJE1pZFNlcnZlcikgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIG5vdCBmb3VuZCINCiAgICAgICAgcmV0dXJuICRudWxsDQogICAgfQ0KICAgIGlmICgtbm90ICRNaWRTZXJ2ZXIucHVibGljX2tleSkgew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIGRvZXMgbm90IGhhdmUgYSBwdWJsaWMga2V5Ig0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJFVzZXJSZWNvcmQgPSBHZXQtU05PV1VzZXIgLVF1ZXJ5ICJ1c2VyX25hbWU9amF2YXNjcmlwdDpncy5nZXRVc2VyTmFtZSgpIiAtRmllbGRzICd1c2VyX25hbWUnDQogICAgU2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1TeXNfSUQgJE1pZFNlcnZlci5zeXNfaWQgLVByb3BlcnRpZXMgQHsNCiAgICAgICAgdmFsaWRhdGVkICAgID0gJ3RydWUnDQogICAgICAgIHZhbGlkYXRlZF9ieSA9ICRVc2VyUmVjb3JkLnVzZXJfbmFtZQ0KICAgICAgICAjIDIwMjUtMDUtMDggMDI6MjA6NTENCiAgICAgICAgdmFsaWRhdGVkX2F0ID0gKEdldC1EYXRlIC1Gb3JtYXQgJ3l5eXktTU0tZGQgSEg6bW06c3MnIC1Bc1VUQykNCiAgICB9DQogICAgJEVjY1F1ZXVlID0gTmV3LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfcXVldWUnIC1Qcm9wZXJ0aWVzIEB7DQogICAgICAgIGFnZW50ICAgID0gIm1pZC5zZXJ2ZXIuJHtNaWRTZXJ2ZXJOYW1lfSINCiAgICAgICAgc291cmNlICAgPSAncmVzdGFydFNlcnZpY2UnDQogICAgICAgIHNlcXVlbmNlID0gW2d1aWRdOjpOZXdHdWlkKCkuVG9TdHJpbmcoJ04nKQ0KICAgICAgICBxdWV1ZSAgICA9ICdvdXRwdXQnDQogICAgICAgIHRvcGljICAgID0gJ1N5c3RlbUNvbW1hbmQnDQogICAgfSAtUGFzc1RocnUNCiAgICBpZiAoJFF1ZXVlU3lzSWQgPSAkRWNjUXVldWUuc3lzX2lkKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ29tbWFuZCBzZW50IHRvIE1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgW3N5c19pZDogJFF1ZXVlU3lzSWRdIg0KICAgICAgICAkRWNjUmVzcG9uc2UgPSBXYWl0LVNOT1dFY2NRdWV1ZVJlc3BvbnNlIC1RdWV1ZVN5c0lkICRRdWV1ZVN5c0lkIC1UaW1lb3V0U2Vjb25kcyAxMjANCiAgICAgICAgaWYgKCRFY2NSZXNwb25zZSAtYW5kICRFY2NSZXNwb25zZS5zdGF0ZSAtZXEgJ3JlYWR5Jykgew0KICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIHZhbGlkYXRlZCBzdWNjZXNzZnVsbHkiDQogICAgICAgICAgICByZXR1cm4gJEVjY1Jlc3BvbnNlDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJGYWlsZWQgdG8gdmFsaWRhdGUgTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSINCiAgICAgICAgICAgIHJldHVybiAkbnVsbA0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBJbnZva2UtU05PV01JREludmFsaWRhdGUgeyANCiAgICBwYXJhbSgNCiAgICAgICAgW3N0cmluZ10kTWlkU2VydmVyTmFtZQ0KICAgICkNCiAgICAkTWlkU2VydmVyID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSIgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgaWYgKCAtbm90ICRNaWRTZXJ2ZXIpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBub3QgZm91bmQiDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICBTZXQtU05PV09iamVjdCAtVGFibGUgJ2VjY19hZ2VudCcgLVN5c19JRCAkTVIuc3lzX2lkIC1Qcm9wZXJ0aWVzIEB7DQogICAgICAgIHZhbGlkYXRlZCAgICA9ICcnDQogICAgICAgIHZhbGlkYXRlZF9ieSA9ICcnDQogICAgICAgICMgMjAyNS0wNS0wOCAwMjoyMDo1MQ0KICAgICAgICB2YWxpZGF0ZWRfYXQgPSAnJw0KICAgICAgICBwdWJsaWNfa2V5ICAgPSAnJw0KICAgIH0NCiAgICAkRWNjUXVldWUgPSBOZXctU05PV09iamVjdCAtVGFibGUgJ2VjY19xdWV1ZScgLVByb3BlcnRpZXMgQHsNCiAgICAgICAgYWdlbnQgICAgPSAibWlkLnNlcnZlci4ke01pZFNlcnZlck5hbWV9Ig0KICAgICAgICBuYW1lICAgICA9ICdJbnZhbGlkYXRlJw0KICAgICAgICBzb3VyY2UgICA9ICdkZWxldGVfbWlkX2tleXBhaXInDQogICAgICAgIHNlcXVlbmNlID0gW2d1aWRdOjpOZXdHdWlkKCkuVG9TdHJpbmcoJ04nKQ0KICAgICAgICBxdWV1ZSAgICA9ICdvdXRwdXQnDQogICAgICAgIHRvcGljICAgID0gJ1N5c3RlbUNvbW1hbmQnDQogICAgfSAtUGFzc1RocnUNCiAgICBpZiAoJFF1ZXVlU3lzSWQgPSAkRWNjUXVldWUuc3lzX2lkKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ29tbWFuZCBzZW50IHRvIE1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgW3N5c19pZDogJFF1ZXVlU3lzSWRdIg0KICAgICAgICAkRWNjUmVzcG9uc2UgPSBXYWl0LVNOT1dFY2NRdWV1ZVJlc3BvbnNlIC1RdWV1ZVN5c0lkICRRdWV1ZVN5c0lkDQogICAgICAgIGlmICgkRWNjUmVzcG9uc2UgLWFuZCAkRWNjUmVzcG9uc2Uuc3RhdGUgLWVxICdyZWFkeScpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBpbnZhbGlkYXRlZCBzdWNjZXNzZnVsbHkiDQogICAgICAgICAgICByZXR1cm4gJEVjY1Jlc3BvbnNlDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJGYWlsZWQgdG8gaW52YWxpZGF0ZSBNSUQgU2VydmVyICRNaWRTZXJ2ZXJOYW1lIg0KICAgICAgICAgICAgcmV0dXJuICRudWxsDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFdhaXQtU05PV0VjY1F1ZXVlUmVzcG9uc2Ugew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRRdWV1ZVN5c0lkLA0KICAgICAgICBbaW50XSRUaW1lb3V0U2Vjb25kcyA9IDM2MA0KICAgICkNCiAgICAkU3RhcnRUaW1lID0gR2V0LURhdGUNCiAgICAkRW5kVGltZSA9ICRTdGFydFRpbWUuQWRkU2Vjb25kcygkVGltZW91dFNlY29uZHMpDQogICAgJEVjY1Jlc3BvbnNlID0gJG51bGwNCiAgICB3aGlsZSAoKEdldC1EYXRlKSAtbHQgJEVuZFRpbWUpIHsNCiAgICAgICAgJEVjY1Jlc3BvbnNlID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfcXVldWUnIC1RdWVyeSAicmVzcG9uc2VfdG89JCgkUXVldWVTeXNJZClecXVldWU9aW5wdXQiDQogICAgICAgIGlmICgkRWNjUmVzcG9uc2UgLWFuZCAkRWNjUmVzcG9uc2Uuc3RhdGUgLWVxICdyZWFkeScpIHsNCiAgICAgICAgICAgIHJldHVybiAkRWNjUmVzcG9uc2UNCiAgICAgICAgfQ0KICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyAxDQogICAgfQ0KICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIlRpbWVvdXQgcmVhY2hlZCB3YWl0aW5nIGZvciBlY2NfcXVldWUgcmVzcG9uc2UgJCgkUXVldWVTeXNJZCkiDQp9DQoNCmZ1bmN0aW9uIFdhaXQtU05PV1RhYmxlUmVjb3JkIHsNCiAgICBwYXJhbSgNCiAgICAgICAgW3N0cmluZ10kVGFibGUsDQogICAgICAgIFtzdHJpbmddJFF1ZXJ5LA0KICAgICAgICBbaW50XSRUaW1lb3V0U2Vjb25kcyA9IDM2MA0KICAgICkNCiAgICAkU3RhcnRUaW1lID0gR2V0LURhdGUNCiAgICAkRW5kVGltZSA9ICRTdGFydFRpbWUuQWRkU2Vjb25kcygkVGltZW91dFNlY29uZHMpDQogICAgJFJlY29yZCA9ICRudWxsDQogICAgd2hpbGUgKChHZXQtRGF0ZSkgLWx0ICRFbmRUaW1lKSB7DQogICAgICAgICRSZWNvcmQgPSBHZXQtU05PV09iamVjdCAtVGFibGUgJFRhYmxlIC1RdWVyeSAkUXVlcnkNCiAgICAgICAgaWYgKCRSZWNvcmQpIHsNCiAgICAgICAgICAgIHJldHVybiAkUmVjb3JkDQogICAgICAgIH0NCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJXYWl0aW5nIGZvciB0YWJsZSByZWNvcmQgWyRUYWJsZV0gd2l0aCBxdWVyeSBbJFF1ZXJ5XSINCiAgICAgICAgU3RhcnQtU2xlZXAgLVNlY29uZHMgMQ0KICAgIH0NCiAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJUaW1lb3V0IHJlYWNoZWQgd2FpdGluZyBmb3IgdGFibGUgcmVjb3JkIFskVGFibGVdIHdpdGggc3lzX2lkIFskU3lzSWRdIg0KfQ0KDQpmdW5jdGlvbiBJbnZva2UtU05PV01JRENvbW1hbmQgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRNaWRTZXJ2ZXJOYW1lLA0KICAgICAgICBbc3RyaW5nXSRDb21tYW5kLA0KICAgICAgICBbaW50XSRUaW1lb3V0U2Vjb25kcyA9IDM2MA0KICAgICkNCiAgICAkTWlkU2VydmVyID0gR2V0LVNOT1dPYmplY3QgLVRhYmxlICdlY2NfYWdlbnQnIC1RdWVyeSAibmFtZT0kTWlkU2VydmVyTmFtZSIgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxDQogICAgaWYgKCAtbm90ICRNaWRTZXJ2ZXIpIHsNCiAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiTUlEIFNlcnZlciAkTWlkU2VydmVyTmFtZSBub3QgZm91bmQiDQogICAgICAgIHJldHVybiAkbnVsbA0KICAgIH0NCiAgICBXcml0ZS1Ib3N0ICJTZW5kaW5nIGNvbW1hbmQgdG8gTUlEIFNlcnZlciAkQ29tbWFuZCINCiAgICAkUGF5bG9hZCA9IFt4bWxdIjw/eG1sIHZlcnNpb249JzEuMCcgZW5jb2Rpbmc9J1VURi04Jz8+PHBhcmFtZXRlcnM+PHBhcmFtZXRlciBuYW1lPSduYW1lJyB2YWx1ZT0naWQnLz48L3BhcmFtZXRlcnM+Ig0KICAgICRQYXlsb2FkLnBhcmFtZXRlcnMucGFyYW1ldGVyLnZhbHVlID0gJENvbW1hbmQNCiAgICAkRWNjUXVldWUgPSBOZXctU05PV09iamVjdCAtVGFibGUgJ2VjY19xdWV1ZScgLVByb3BlcnRpZXMgQHsNCiAgICAgICAgYWdlbnQgICA9ICJtaWQuc2VydmVyLiR7TWlkU2VydmVyTmFtZX0iDQogICAgICAgIG5hbWUgICAgPSAnUnVuQ29tbWFuZCcNCiAgICAgICAgcGF5bG9hZCA9ICRQYXlsb2FkLk91dGVyWG1sDQogICAgICAgIHF1ZXVlICAgPSAnb3V0cHV0Jw0KICAgICAgICB0b3BpYyAgID0gJ0NvbW1hbmQnDQogICAgfSAtUGFzc1RocnUNCiAgICAkU3RhcnRUaW1lID0gR2V0LURhdGUNCiAgICBpZiAoJFF1ZXVlU3lzSWQgPSAkRWNjUXVldWUuc3lzX2lkKSB7DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiQ29tbWFuZCBzZW50IHRvIE1JRCBTZXJ2ZXIgJE1pZFNlcnZlck5hbWUgW3N5c19pZDogJFF1ZXVlU3lzSWRdIg0KICAgICAgICAkRWNjUmVzcG9uc2UgPSBXYWl0LVNOT1dFY2NRdWV1ZVJlc3BvbnNlIC1RdWV1ZVN5c0lkICRRdWV1ZVN5c0lkIC1UaW1lb3V0U2Vjb25kcyAkVGltZW91dFNlY29uZHMNCiAgICAgICAgJFJlc3BvbnNlUGF5bG9hZCA9IFt4bWxdJEVjY1Jlc3BvbnNlLnBheWxvYWQNCiAgICAgICAgcmV0dXJuIFtvcmRlcmVkXUB7DQogICAgICAgICAgICBTdGRPdXQgICAgICAgICAgPSAkUmVzcG9uc2VQYXlsb2FkLnJlc3VsdHMucmVzdWx0LnN0ZG91dCANCiAgICAgICAgICAgIFN0ZEVyciAgICAgICAgICA9ICRSZXNwb25zZVBheWxvYWQucmVzdWx0cy5yZXN1bHQuc3RkZXJyDQogICAgICAgICAgICBSZXF1ZXN0ICAgICAgICAgPSAkRWNjUXVldWUNCiAgICAgICAgICAgIFJlc3BvbnNlICAgICAgICA9ICRFY2NSZXNwb25zZQ0KICAgICAgICAgICAgU3RhdHVzICAgICAgICAgID0gJEVjY1Jlc3BvbnNlLnN0YXRlDQogICAgICAgICAgICBUaW1lICAgICAgICAgICAgPSAkRWNjUmVzcG9uc2Uuc3lzX3VwZGF0ZWRfb24NCiAgICAgICAgICAgIER1cmF0aW9uICAgICAgICA9IChHZXQtRGF0ZSkgLSAkU3RhcnRUaW1lDQogICAgICAgICAgICBEdXJhdGlvblNlY29uZHMgPSAoR2V0LURhdGUpIC0gJFN0YXJ0VGltZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5IFRvdGFsU2Vjb25kcw0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBHZXQtU05PV01JRERvd25sb2FkRmFjdHMgew0KICAgIHBhcmFtKA0KICAgICAgICAjIHhhbmFkdS0wNy0wMi0yMDI0X19wYXRjaDRiLTAxLTE1LTIwMjVfMDItMTEtMjAyNV8xNzMzDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5KV0NCiAgICAgICAgW1ZhbGlkYXRlUGF0dGVybignXlthLXpBLVowLTlcLV9dKyQnKV0NCiAgICAgICAgJEJ1aWxkVGFnLA0KICAgICAgICBbVmFsaWRhdGVTZXQoJ21pZC1saW51eC1jb250YWluZXItcmVjaXBlJywgJ21pZC13aW5kb3dzLWluc3RhbGxlcicsICdtaWQtbGludXgtaW5zdGFsbGVyLXJwbScsICdtaWQtbGludXgtaW5zdGFsbGVyLWRlYicpXQ0KICAgICAgICAkUGFja2FnZSA9ICdtaWQtbGludXgtY29udGFpbmVyLXJlY2lwZScsDQogICAgICAgICRBcmNoaXRlY3R1cmUgPSAnbGludXgueDg2LTY0Jw0KICAgICkNCiAgICAkUGFydHMgPSAkQnVpbGRUYWcgLXNwbGl0ICdfJw0KICAgICRCdWlsZERhdGUgPSAoJFBhcnRzIHwgU2VsZWN0LU9iamVjdCAtTGFzdCAyKSAtam9pbiAnXycNCiAgICAkQnVpbGRTdGFtcCA9ICRCdWlsZFRhZw0KICAgICRPdXQgPSBbb3JkZXJlZF1Aew0KICAgICAgICBQYWNrYWdlICAgICAgPSAkUGFja2FnZQ0KICAgICAgICBBcmNoaXRlY3R1cmUgPSAkQXJjaGl0ZWN0dXJlDQogICAgICAgIEJ1aWxkRGF0ZSAgICA9ICRCdWlsZERhdGUNCiAgICAgICAgQnVpbGRTdGFtcCAgID0gJEJ1aWxkU3RhbXANCiAgICB9DQogICAgJHVybF9kYXRlID0gKCRCdWlsZERhdGUgLXNwbGl0ICdfJylbMF0gLXNwbGl0ICctJyANCiAgICAkcGFja2FnZUZvbGRlciA9IEAoDQogICAgICAgICR1cmxfZGF0ZVsyXSwNCiAgICAgICAgJHVybF9kYXRlWzBdLA0KICAgICAgICAkdXJsX2RhdGVbMV0NCiAgICApIC1qb2luICcvJw0KICAgICRQYWNrYWdlRXh0ZW5zaW9uID0gc3dpdGNoICgkUGFja2FnZSkgew0KICAgICAgICAnbWlkLWxpbnV4LWNvbnRhaW5lci1yZWNpcGUnIHsgJ3ppcCcgfQ0KICAgICAgICAnbWlkLXdpbmRvd3MtaW5zdGFsbGVyJyB7ICdleGUnIH0NCiAgICAgICAgJ21pZC1saW51eC1pbnN0YWxsZXItcnBtJyB7ICdycG0nIH0NCiAgICAgICAgJ21pZC1saW51eC1pbnN0YWxsZXItZGViJyB7ICdkZWInIH0NCiAgICB9DQogICAgI1JlbW92ZSAtZGViIGFuZCAtcnBtIGZyb20gcGFja2FnZSBuYW1lDQogICAgJFBhY2thZ2VOYW1lID0gJFBhY2thZ2UgLXJlcGxhY2UgJy0oZGVifHJwbSkkJw0KICAgICRPdXQuUGFja2FnZUZpbGVOYW1lID0gIiRQYWNrYWdlTmFtZS4kQnVpbGRTdGFtcC4kQXJjaGl0ZWN0dXJlLiRQYWNrYWdlRXh0ZW5zaW9uIg0KICAgICRiYXNlVXJpID0gJ2h0dHBzOi8vaW5zdGFsbC5zZXJ2aWNlLW5vdy5jb20vZ2xpZGUvZGlzdHJpYnV0aW9uL2J1aWxkcy9wYWNrYWdlL2FwcC1zaWduZWQvezB9JyAtZiAkUGFja2FnZU5hbWUNCiAgICAkT3V0LlBhY2thZ2VVcmkgPSAiJGJhc2VVcmkvJHBhY2thZ2VGb2xkZXIvJCgkT3V0LlBhY2thZ2VGaWxlTmFtZSkiDQogICAgJE91dA0KfQ0KDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiMgUHJpdmF0ZSBGdW5jdGlvbnMgKERvY2tlci9Qb2RtYW4pDQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCg0KZnVuY3Rpb24gR2V0LURvY2tlclBvZG1hbkNvbW1hbmQgew0KICAgIGlmICgkZW52OkRPQ0tFUl9DT01NQU5EKSB7DQogICAgICAgICRlbnY6RE9DS0VSX0NPTU1BTkQNCiAgICB9DQogICAgZWxzZWlmICgoR2V0LUNvbW1hbmQgcG9kbWFuIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSkgew0KICAgICAgICAncG9kbWFuJw0KICAgIH0NCiAgICBlbHNlaWYgKChHZXQtQ29tbWFuZCBkb2NrZXIgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgICdkb2NrZXInDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICdObyBkb2NrZXIgb3IgcG9kbWFuIGNvbW1hbmQgZm91bmQuIENhbm5vdCByZXNvbHZlIGxvY2FsIGltYWdlcycNCiAgICAgICAgJG51bGwNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIEdldC1Eb2NrZXJQb2RtYW5JbWFnZVN0YXRlIHsNCiAgICAkSW1hZ2VUYWdzID0gQCgpDQogICAgJERvY2tlckNvbW1hbmQgPSBHZXQtRG9ja2VyUG9kbWFuQ29tbWFuZA0KICAgICRJbWFnZXMgPSAoJiAkRG9ja2VyQ29tbWFuZCBpbWFnZSBscyAtLWZvcm1hdCAne3suUmVwb3NpdG9yeX19fHx7ey5UYWd9fXx8e3suRGlnZXN0fX0nKQ0KICAgIGZvcmVhY2ggKCRJbWFnZSBpbiAkSW1hZ2VzKSB7DQogICAgICAgICROYW1lUmVnZXggPSAnXig/PFJlcG9zaXRvcnk+LispXHxcfCg/PFRhZz4uKylcfFx8KD88RGlnZXN0Pi4rKSQnDQoNCiAgICAgICAgaWYgKCRJbWFnZSAtbWF0Y2ggJE5hbWVSZWdleCkgew0KICAgICAgICAgICAgJFAgPSAkbWF0Y2hlc1snUmVwb3NpdG9yeSddIC1zcGxpdCAnLycsIDINCiAgICAgICAgICAgICRJbWFnZVRhZ3MgKz0gW1BTQ3VzdG9tT2JqZWN0XUB7DQogICAgICAgICAgICAgICAgUmVnaXN0cnkgID0gJHBbMF0NCiAgICAgICAgICAgICAgICBJbWFnZU5hbWUgPSAkcFsxXQ0KICAgICAgICAgICAgICAgIE5hbWUgICAgICA9ICRNYXRjaGVzWydUYWcnXQ0KICAgICAgICAgICAgICAgIERpZ2VzdCAgICA9ICRtYXRjaGVzWydEaWdlc3QnXQ0KICAgICAgICAgICAgfSAgDQogICAgICAgIH0NCiAgICB9IA0KICAgICRJbWFnZVRhZ3MgfCBHcm91cC1PYmplY3QgLVByb3BlcnR5IEltYWdlTmFtZSB8IEZvckVhY2gtT2JqZWN0IHsNCiAgICAgICAgW1BTQ3VzdG9tT2JqZWN0XUB7DQogICAgICAgICAgICBOYW1lICAgICA9ICRfLk5hbWUNCiAgICAgICAgICAgIFJlZ2lzdHJ5ID0gJF8uR3JvdXBbMF0uUmVnaXN0cnkNCiAgICAgICAgICAgIFRhZ3MgICAgID0gQCgkXy5Hcm91cCB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5IE5hbWUsIERpZ2VzdCkNCiAgICAgICAgfQ0KICAgIH0gfCBTb3J0LU9iamVjdCAtUHJvcGVydHkgTmFtZQ0KfQ0KDQpmdW5jdGlvbiBHZXQtRG9ja2VyUG9kbWFuRG9ja2VyRmlsZUNvbnRlbnQgew0KICAgIGlmICgkZW52OlNOX01JRF9DVVNUT01fRE9DS0VSRklMRV9CQVNFNjQpIHsNCiAgICAgICAgJGRvY2tlckZpbGUgPSBbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpVVEY4LkdldFN0cmluZyhbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCRlbnY6U05fTUlEX0NVU1RPTV9ET0NLRVJGSUxFX0JBU0U2NCkpDQogICAgfQ0KICAgIGVsc2VpZiAoVGVzdC1QYXRoICIkUFNTY3JpcHRSb290L2F6dXJlL0RvY2tlcmZpbGUubWlkY3VzdG9tIikgew0KICAgICAgICAkZG9ja2VyRmlsZSA9IEdldC1Db250ZW50IC1QYXRoICgiJFBTU2NyaXB0Um9vdC9henVyZS9Eb2NrZXJmaWxlLm1pZGN1c3RvbSIpIC1SYXcNCiAgICB9DQogICAgZWxzZWlmICgkZW52OlNOX01JRF9DVVNUT01fRE9DS0VSRklMRV9QQVRIKSB7DQogICAgICAgICRkb2NrZXJGaWxlID0gR2V0LUNvbnRlbnQgLVBhdGggJGVudjpTTl9NSURfQ1VTVE9NX0RPQ0tFUkZJTEVfUEFUSCAtUmF3DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICByZXR1cm4gJG51bGwNCiAgICB9DQogICAgJGRvY2tlckZpbGUNCn0NCg0KZnVuY3Rpb24gTWVyZ2UtRG9ja2VyUG9kbWFuSGFzaFRhYmxlcyB7DQogICAgcGFyYW0oDQogICAgICAgIFtoYXNodGFibGVdICRkZWZhdWx0LCAjIFlvdXIgb3JpZ2luYWwgc2V0DQogICAgICAgIFtoYXNodGFibGVdICR1cHBlbmQgIyBUaGUgc2V0IHlvdSB3YW50IHRvIHVwZGF0ZS9hcHBlbmQgdG8gdGhlIG9yaWdpbmFsIHNldA0KICAgICkNCiAgICAkZGVmYXVsdDEgPSAkZGVmYXVsdC5DbG9uZSgpDQogICAgZm9yZWFjaCAoJGtleSBpbiAkdXBwZW5kLktleXMpIHsNCiAgICAgICAgaWYgKCRkZWZhdWx0MS5Db250YWluc0tleSgka2V5KSkgew0KICAgICAgICAgICAgJGRlZmF1bHQxLlJlbW92ZSgka2V5KQ0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiAkZGVmYXVsdDEgKyAkdXBwZW5kDQp9DQoNCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiMgU2VydmljZU5vdyBNSUQgVG9vbHMgLSBWYXVsdCBNYW5hZ2VtZW50IEZ1bmN0aW9ucw0KIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KIyBUaGlzIHNjcmlwdCBwcm92aWRlcyBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIHNlY3JldHMgaW4gUG93ZXJTaGVsbCBTZWNyZXRTdG9yZQ0KIyBvciBBenVyZSBLZXkgVmF1bHQgZm9yIHVzZSB3aXRoIFNlcnZpY2VOb3cgYW5kIEF6dXJlIGVudmlyb25tZW50cy4NCiMNCiMgRnVuY3Rpb25zOg0KIyAtIFJlc29sdmUtU05PV01pZFNlY3JldE1hbmFnZW1lbnRWYXVsdDogQ29uZmlndXJlIGFuZCByZWdpc3RlciBhIHNlY3JldCB2YXVsdA0KIyAtIFNldC1Kc29uU2VjcmV0IC8gR2V0LUpzb25TZWNyZXQ6IFN0b3JlIGFuZCByZXRyaWV2ZSBKU09OLWZvcm1hdHRlZCBzZWNyZXRzDQojIC0gU2V0LVNOT1dNaWRFbnZpcm9ubWVudFNlY3JldCAvIFJlc29sdmUtU05PV01JREVudmlyb25tZW50QXV0aDogTWFuYWdlIFNlcnZpY2VOb3cgY3JlZGVudGlhbHMNCiMgLSBTZXQtU05PV01pZEF6dXJlRW52aXJvbm1lbnRTZWNyZXQgLyBSZXNvbHZlLVNOT1dNaWRBenVyZUVudmlyb25tZW50U2VjcmV0czogTWFuYWdlIEF6dXJlIGNyZWRlbnRpYWxzDQojDQojPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIEVYQU1QTEVTDQojPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQojIEV4YW1wbGUgMTogUmVnaXN0ZXIgYSB2YXVsdA0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyAjIFVzZSBQb3dlclNoZWxsIFNlY3JldFN0b3JlIChkZWZhdWx0KQ0KIyAkRGVmYXVsdFZhdWx0ID0gUmVzb2x2ZS1TTk9XTWlkU2VjcmV0TWFuYWdlbWVudFZhdWx0IC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RWYXVsdCcgLVVzZUF6dXJlS2V5VmF1bHQ6JGZhbHNlDQojDQojICMgVXNlIEF6dXJlIEtleVZhdWx0IHdpdGggbWV0YWRhdGENCiMgUmVzb2x2ZS1TTk9XTWlkU2VjcmV0TWFuYWdlbWVudFZhdWx0IC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RWYXVsdCcgLVVwZGF0ZU1ldGFkYXRhIC1WYXVsdE1ldGFkYXRhIEB7DQojICAgICBFbnZpcm9ubWVudE5hbWUgPSAnVGVzdCcNCiMgICAgIFN1YnNjcmlwdGlvbklkICA9ICcxMjM0NTY3OC0xMjM0LTEyMzQtMTIzNC0xMjM0NTY3ODkwMTInDQojIH0NCiMNCiMgRXhhbXBsZSAyOiBTZXJ2aWNlTm93IENyZWRlbnRpYWxzIE1hbmFnZW1lbnQNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojICMgU3RvcmUgU2VydmljZU5vdyBjcmVkZW50aWFscw0KIyBTZXQtU05PV01pZEVudmlyb25tZW50U2VjcmV0IC1Vc2VybmFtZSBhZG1pbiAtSW5zdGFuY2UgZGV2MTk1MjI2IC1QYXNzd29yZCAoJGVudjpTTl9QQVNTV09SRCB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZSkgYA0KIyAgICAgLVNlY3JldE5hbWUgJ3Nub3ctY29ubmVjdGlvbi11bnRzLWpzb24nIC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RWYXVsdCcNCiMNCiMgIyBSZXRyaWV2ZSBTZXJ2aWNlTm93IGNyZWRlbnRpYWxzIGFuZCBzZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzDQojIFJlc29sdmUtU05PV01JREVudmlyb25tZW50QXV0aCAtU2VjcmV0TmFtZSAnc25vdy1jb25uZWN0aW9uLXNieC1qc29uJyAtVmF1bHROYW1lICdQU1Nub3dUZXN0VmF1bHQnDQojDQojIEV4YW1wbGUgMzogQXp1cmUgQ3JlZGVudGlhbHMgTWFuYWdlbWVudA0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojICMgU3RvcmUgQXp1cmUgY3JlZGVudGlhbHMNCiMgJGNsaWVudFNlY3JldCA9IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLVN0cmluZyAieW91ci1jbGllbnQtc2VjcmV0IiAtQXNQbGFpblRleHQgLUZvcmNlDQojIFNldC1TTk9XTWlkQXp1cmVFbnZpcm9ubWVudFNlY3JldCAtVGVuYW50SWQgInlvdXItdGVuYW50LWlkIiAtU3Vic2NyaXB0aW9uSWQgInlvdXItc3Vic2NyaXB0aW9uLWlkIiBgDQojICAgICAtQ2xpZW50SWQgInlvdXItY2xpZW50LWlkIiAtUHJpbmNpcGFsSWQgInlvdXItcHJpbmNpcGFsLWlkIiAtQ2xpZW50U2VjcmV0ICRjbGllbnRTZWNyZXQgYA0KIyAgICAgLVNlY3JldE5hbWUgJ2F6dXJlLWNvbm5lY3Rpb24tc2J4LWpzb24nIC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RWYXVsdCcNCiMNCiMgIyBSZXRyaWV2ZSBhbmQgc2V0IEF6dXJlIGVudmlyb25tZW50IHZhcmlhYmxlcw0KIyBSZXNvbHZlLVNOT1dNaWRBenVyZUVudmlyb25tZW50U2VjcmV0cyAtU2VjcmV0TmFtZSAnYXp1cmUtY29ubmVjdGlvbi1zYngtanNvbicgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0Jw0KIw0KIyBFeGFtcGxlIDQ6IENvcHkgc2VjcmV0cyBiZXR3ZWVuIHZhdWx0cw0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgUmVzb2x2ZS1TTk9XTUlERW52aXJvbm1lbnRBdXRoIC1TZWNyZXROYW1lICdzbm93LWNvbm5lY3Rpb24tc2J4LWpzb24nIC1WYXVsdE5hbWUgJ1BTU25vd1Rlc3RBelZhdWx0JyB8IA0KIyAgICAgU2V0LUpzb25TZWNyZXQgLVNlY3JldE5hbWUgJ3Nub3ctY29ubmVjdGlvbi1zYngtanNvbicgLVZhdWx0TmFtZSAnUFNTbm93VGVzdFZhdWx0Jw0KIw0KIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KDQpmdW5jdGlvbiBSZXNvbHZlLVNOT1dNaWRTZWNyZXRNYW5hZ2VtZW50VmF1bHQgew0KICAgIFtDbWRsZXRCaW5kaW5nKCldDQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRWYXVsdE5hbWUsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzd2l0Y2hdJFVzZUF6dXJlS2V5VmF1bHQsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJEF6dXJlS2V5VmF1bHROYW1lLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbc3RyaW5nXSRBenVyZVN1YnNjcmlwdGlvbklkLA0KDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW2hhc2h0YWJsZV0kVmF1bHRNZXRhZGF0YSA9IEB7fSwNCg0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzd2l0Y2hdJFVwZGF0ZU1ldGFkYXRhDQogICAgKQ0KICAgICRWYXVsdE1ldGFkYXRhICs9IFtoYXNodGFibGVdQHsNCiAgICAgICAgVmF1bHROYW1lICAgICAgICAgICA9ICRWYXVsdE5hbWUNCiAgICAgICAgVXNlQXp1cmVLZXlWYXVsdCAgICA9ICRVc2VBenVyZUtleVZhdWx0DQogICAgICAgIEF6dXJlS2V5VmF1bHROYW1lICAgPSAkQXp1cmVLZXlWYXVsdE5hbWUNCiAgICAgICAgQXp1cmVTdWJzY3JpcHRpb25JZCA9ICRBenVyZVN1YnNjcmlwdGlvbklkDQogICAgICAgIFVwZGF0ZVRpbWVzdGFtcCAgICAgPSAoR2V0LURhdGUpLlRvU3RyaW5nKCd5eXl5LU1NLWRkVEhIOm1tOnNzJykNCiAgICB9DQogICAgIyBQcmVwYXJlIHZhdWx0IGNvbmZpZ3VyYXRpb24gYmFzZWQgb24gdHlwZQ0KICAgIGlmICgkVXNlQXp1cmVLZXlWYXVsdCkgew0KICAgICAgICAjIFZlcmlmeSBBenVyZSBjb250ZXh0DQogICAgICAgIHRyeSB7DQogICAgICAgICAgICAkY29udGV4dCA9IEdldC1BekNvbnRleHQgLUVycm9yQWN0aW9uIFN0b3ANCiAgICAgICAgICAgIGlmICgtbm90ICgkYXpLdk1vZHVsZSA9IEdldC1Nb2R1bGUgLU5hbWUgQXouS2V5VmF1bHQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpKSB7DQogICAgICAgICAgICAgICAgSW1wb3J0LU1vZHVsZSAtTmFtZSBBei5LZXlWYXVsdA0KICAgICAgICAgICAgICAgICRhekt2TW9kdWxlID0gR2V0LU1vZHVsZSAtTmFtZSBBei5LZXlWYXVsdCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgJGt2U2VjcmV0VmF1bHQgPSBHZXQtU2VjcmV0VmF1bHQgLU5hbWUgJFZhdWx0TmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgaWYgKCRrdlNlY3JldFZhdWx0KSB7DQogICAgICAgICAgICAgICAgaWYgKC1ub3QoJGF6S3ZNb2R1bGUuTW9kdWxlQmFzZS5Ub0xvd2VyKCkuU3RhcnRzV2l0aCgka3ZTZWNyZXRWYXVsdC5Nb2R1bGVQYXRoLlRvTG93ZXIoKSkpKSB7DQogICAgICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkFaIFNlY3JldCB2YXVsdCAnJFZhdWx0TmFtZScgZXhpc3RzIGJ1dCBpcyBub3QgcmVnaXN0ZXJlZCB3aXRoIHRoZSBleHBlY3RlZCBBei5LZXlWYXVsdCBtb2R1bGUuIE1vZHVsZVBhdGg6ICQoJGt2U2VjcmV0VmF1bHQuTW9kdWxlUGF0aCksIE1vZHVsZUJhc2U6ICQoJGF6S3ZNb2R1bGUuTW9kdWxlQmFzZSkiDQogICAgICAgICAgICAgICAgICAgIFVucmVnaXN0ZXItU2VjcmV0VmF1bHQgLU5hbWUgJFZhdWx0TmFtZSAtRXJyb3JBY3Rpb24gU3RvcA0KICAgICAgICAgICAgICAgICAgICBSZW1vdmUtVmFyaWFibGUgLU5hbWUga3ZTZWNyZXRWYXVsdCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAiQVogU2VjcmV0IHZhdWx0ICckVmF1bHROYW1lJyBhbHJlYWR5IGV4aXN0cyBhbmQgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBleHBlY3RlZCBBei5LZXlWYXVsdCBtb2R1bGUuIg0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICgtbm90ICRjb250ZXh0KSB7DQogICAgICAgICAgICAgICAgdGhyb3cgIk5vIEF6dXJlIGNvbnRleHQgZm91bmQuIFBsZWFzZSBjb25uZWN0IHRvIEF6dXJlIGZpcnN0IHdpdGggQ29ubmVjdC1BekFjY291bnQuIg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFVzZSBwcm92aWRlZCBzdWJzY3JpcHRpb24gSUQgb3IgY3VycmVudCBvbmUNCiAgICAgICAgICAgICRzdWJzY3JpcHRpb25JZCA9ICRBenVyZVN1YnNjcmlwdGlvbklkID8gJEF6dXJlU3Vic2NyaXB0aW9uSWQgOiAkY29udGV4dC5TdWJzY3JpcHRpb24uSWQNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBVc2UgdGhlIHByb3ZpZGVkIEtleVZhdWx0IG5hbWUgb3IgZGVmYXVsdCB0byB0aGUgVmF1bHROYW1lIHBhcmFtZXRlcg0KICAgICAgICAgICAgJGtleVZhdWx0VG9Vc2UgPSBpZiAoJEF6dXJlS2V5VmF1bHROYW1lKSB7ICRBenVyZUtleVZhdWx0TmFtZSB9IGVsc2UgeyAkVmF1bHROYW1lIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmVwYXJlIHBhcmFtZXRlcnMgZm9yIEF6dXJlIEtleVZhdWx0DQogICAgICAgICAgICAkdmF1bHRDb25maWcgPSBAew0KICAgICAgICAgICAgICAgIE5hbWUgICAgICAgICAgICA9ICRWYXVsdE5hbWUNCiAgICAgICAgICAgICAgICBNb2R1bGVOYW1lICAgICAgPSAnQXouS2V5VmF1bHQnDQogICAgICAgICAgICAgICAgVmF1bHRQYXJhbWV0ZXJzID0gQHsNCiAgICAgICAgICAgICAgICAgICAgQVpLVmF1bHROYW1lICAgPSAka2V5VmF1bHRUb1VzZQ0KICAgICAgICAgICAgICAgICAgICBTdWJzY3JpcHRpb25JZCA9ICRzdWJzY3JpcHRpb25JZA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCB7DQogICAgICAgICAgICBXcml0ZS1FcnJvciAiQXp1cmUgS2V5VmF1bHQgY29uZmlndXJhdGlvbiBmYWlsZWQ6ICRfIg0KICAgICAgICAgICAgcmV0dXJuDQogICAgICAgIH0NCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgICMgU2V0dXAgZm9yIFBvd2VyU2hlbGwgU2VjcmV0U3RvcmUNCiAgICAgICAgJFJlcXVpcmVkTW9kdWxlcyA9IEAoDQogICAgICAgICAgICAnTWljcm9zb2Z0LlBvd2VyU2hlbGwuU2VjcmV0TWFuYWdlbWVudCcsDQogICAgICAgICAgICAnTWljcm9zb2Z0LlBvd2VyU2hlbGwuU2VjcmV0U3RvcmUnDQogICAgICAgICkNCiAgICAgICAgJFJlcXVpcmVkTW9kdWxlcyB8IEZvckVhY2gtT2JqZWN0IHsNCiAgICAgICAgICAgIGlmICgtbm90IChHZXQtTW9kdWxlIC1OYW1lICRfIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1MaXN0QXZhaWxhYmxlKSkgew0KICAgICAgICAgICAgICAgIEluc3RhbGwtTW9kdWxlIC1OYW1lICRfIC1Gb3JjZSAtU2NvcGUgQ3VycmVudFVzZXINCiAgICAgICAgICAgICAgICBpZiAoJF8gLWVxICdNaWNyb3NvZnQuUG93ZXJTaGVsbC5TZWNyZXRTdG9yZScpIHsNCiAgICAgICAgICAgICAgICAgICAgSW1wb3J0LU1vZHVsZSAtTmFtZSAkXyAtRm9yY2UgLVNjb3BlIEN1cnJlbnRVc2VyDQogICAgICAgICAgICAgICAgICAgIFJlc2V0LVNlY3JldFN0b3JlIC1Db25maXJtOiRmYWxzZSAtQXV0aGVudGljYXRpb24gTm9uZQ0KICAgICAgICAgICAgICAgICAgICBTZXQtU2VjcmV0U3RvcmVDb25maWd1cmF0aW9uIC1BdXRoZW50aWNhdGlvbiBOb25lIC1TY29wZSBDdXJyZW50VXNlciAtQ29uZmlybTokZmFsc2UNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICMgQ29uZmlndXJlIFNlY3JldFN0b3JlDQogICAgICAgIFNldC1TZWNyZXRTdG9yZUNvbmZpZ3VyYXRpb24gLUF1dGhlbnRpY2F0aW9uIE5vbmUgLVNjb3BlIEN1cnJlbnRVc2VyIC1Db25maXJtOiRmYWxzZQ0KICAgICAgICANCiAgICAgICAgIyBQcmVwYXJlIHBhcmFtZXRlcnMgZm9yIFBvd2VyU2hlbGwgU2VjcmV0U3RvcmUNCiAgICAgICAgJHZhdWx0Q29uZmlnID0gQHsNCiAgICAgICAgICAgIE5hbWUgICAgICAgICA9ICRWYXVsdE5hbWUNCiAgICAgICAgICAgIE1vZHVsZU5hbWUgICA9ICdNaWNyb3NvZnQuUG93ZXJTaGVsbC5TZWNyZXRTdG9yZScNCiAgICAgICAgICAgIERlZmF1bHRWYXVsdCA9ICR0cnVlDQogICAgICAgIH0NCiAgICB9DQoNCiAgICAjIENvbW1vbiBmdW5jdGlvbmFsaXR5IGZvciBib3RoIHZhdWx0IHR5cGVzDQogICAgJGV4aXN0aW5nVmF1bHQgPSBHZXQtU2VjcmV0VmF1bHQgLU5hbWUgJFZhdWx0TmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICRWYXVsdE1ldGFkYXRhLlZhdWx0Q29uZmlnID0gJHZhdWx0Q29uZmlnDQogICAgJE1ldGFkYXRhID0gKENvbnZlcnRUby1Kc29uIC1JbnB1dE9iamVjdCAkVmF1bHRNZXRhZGF0YSAtRGVwdGggNCAtQ29tcHJlc3MpDQoNCiAgICBpZiAoLW5vdCAkZXhpc3RpbmdWYXVsdCkgew0KICAgICAgICAjIFJlZ2lzdGVyIHRoZSB2YXVsdCB1c2luZyBwYXJhbWV0ZXJzDQogICAgICAgIFJlZ2lzdGVyLVNlY3JldFZhdWx0IEB2YXVsdENvbmZpZyAtRXJyb3JBY3Rpb24gU3RvcA0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBJbXBvcnRhbnQgIlZhdWx0ICRWYXVsdE5hbWUgcmVnaXN0ZXJlZCBhcyAkKCR2YXVsdENvbmZpZy5Nb2R1bGVOYW1lKSB3aXRoIHBhcmFtZXRlcnMgJCgkdmF1bHRDb25maWcuVmF1bHRQYXJhbWV0ZXJzIHwgQ29udmVydFRvLUpzb24gLURlcHRoIDMgLUNvbXByZXNzKS4iDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJTZWNyZXQgdmF1bHQgJyRWYXVsdE5hbWUnIGFscmVhZHkgZXhpc3RzLiAkKCRleGlzdGluZ1ZhdWx0Lk1vZHVsZVBhdGgpIGlzIGFscmVhZHkgcmVnaXN0ZXJlZC4iDQogICAgfQ0KICAgICRleGlzdGluZ01ldGFkYXRhID0gR2V0LVNlY3JldCAtTmFtZSAnQXpWYXVsdE1ldGFkYXRhJyAtVmF1bHQgJFZhdWx0TmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtQXNQbGFpblRleHQNCiAgICBpZiAoJGV4aXN0aW5nTWV0YWRhdGEpIHsNCiAgICAgICAgJEN1cnJlbnRNZXRhZGF0YSA9IChDb252ZXJ0RnJvbS1Kc29uIC1JbnB1dE9iamVjdCAkZXhpc3RpbmdNZXRhZGF0YSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtQXNIYXNodGFibGUpIA0KICAgIH0NCiAgICBpZiAoJFVwZGF0ZU1ldGFkYXRhKSB7DQogICAgICAgIFNldC1TZWNyZXQgLU5hbWUgJ0F6VmF1bHRNZXRhZGF0YScgLVZhdWx0ICRWYXVsdE5hbWUgLVNlY3JldCAkTWV0YWRhdGENCiAgICB9DQogICAgDQogICAgIyBSZXR1cm4gdmF1bHQgaW5mb3JtYXRpb24NCiAgICAkcmVzdWx0ID0gQHsNCiAgICAgICAgVmF1bHROYW1lICAgICAgID0gJFZhdWx0TmFtZQ0KICAgICAgICBWYXVsdCAgICAgICAgICAgPSAoR2V0LVNlY3JldFZhdWx0IC1OYW1lICRWYXVsdE5hbWUpDQogICAgICAgIFZhdWx0UGFyYW1zICAgICA9ICR2YXVsdENvbmZpZw0KICAgICAgICBNZXRhZGF0YSAgICAgICAgPSAkVmF1bHRNZXRhZGF0YQ0KICAgICAgICBDdXJyZW50TWV0YWRhdGEgPSAkQ3VycmVudE1ldGFkYXRhDQogICAgfQ0KICAgIA0KICAgIA0KICAgIHJldHVybiAkcmVzdWx0DQp9DQoNCmZ1bmN0aW9uIFNldC1Kc29uU2VjcmV0IHsNCiAgICBbQ21kbGV0QmluZGluZygpXQ0KICAgIHBhcmFtICgNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSwgVmFsdWVGcm9tUGlwZWxpbmUgPSAkdHJ1ZSldDQogICAgICAgIFtoYXNodGFibGVdJFNlY3JldFZhbHVlLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kVmF1bHROYW1lDQogICAgKQ0KICAgIHByb2Nlc3Mgew0KICAgICAgICAkU2VjcmV0VmFsdWVPdXQgPSBbb3JkZXJlZF1Ae30NCiAgICAgICAgIyBHbyB0aHJvdWdoIGtleXMgYW5kIGNoZWNrIGZvciBQU0NyZWRlbnRpYWwgb3Igc2VjdXJlc3RyaW5nIG9iamVjdHMNCiAgICAgICAgZm9yZWFjaCAoJHNrZXkgaW4gJFNlY3JldFZhbHVlLktleXMpIHsNCiAgICAgICAgICAgIGlmICgkU2VjcmV0VmFsdWVbJHNrZXldIC1pcyBbUFNDcmVkZW50aWFsXSkgew0KICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZU91dFskc2tleV0gPSBAew0KICAgICAgICAgICAgICAgICAgICBVc2VyTmFtZSA9ICRTZWNyZXRWYWx1ZVskc2tleV0uVXNlck5hbWUNCiAgICAgICAgICAgICAgICAgICAgUGFzc3dvcmQgPSAkU2VjcmV0VmFsdWVbJHNrZXldLkdldE5ldHdvcmtDcmVkZW50aWFsKCkuUGFzc3dvcmQNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlaWYgKCRTZWNyZXRWYWx1ZVskc2tleV0gLWlzIFtTZWN1cmVTdHJpbmddKSB7DQogICAgICAgICAgICAgICAgJFNlY3JldFZhbHVlT3V0WyRza2V5XSA9ICRTZWNyZXRWYWx1ZVskc2tleV0gfCBDb252ZXJ0RnJvbS1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAkU2VjcmV0VmFsdWVPdXRbJHNrZXldID0gJFNlY3JldFZhbHVlWyRza2V5XQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiU3RvcmluZyBzZWNyZXQgJyRTZWNyZXROYW1lJyBpbiB2YXVsdCAnJFZhdWx0TmFtZScuIg0KICAgICAgICAkSnNvblNlY3JldFZhbHVlID0gJFNlY3JldFZhbHVlT3V0IHwgQ29udmVydFRvLUpzb24gLURlcHRoIDEwIC1Db21wcmVzcw0KICAgICAgICBTZXQtU2VjcmV0IC1OYW1lICRTZWNyZXROYW1lIC1TZWNyZXQgJEpzb25TZWNyZXRWYWx1ZSAtVmF1bHQgJFZhdWx0TmFtZQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gR2V0LUpzb25TZWNyZXQgew0KICAgIFtDbWRsZXRCaW5kaW5nKCldDQogICAgcGFyYW0gKA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kU2VjcmV0TmFtZSwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRWYXVsdE5hbWUsDQoNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbc3RyaW5nW11dJFNlY3VyZVZhcmlhYmxlcyA9IEAoJ0NsaWVudFNlY3JldCcsICdQYXNzd29yZCcsICdDbGllbnRTZWNyZXRWYWx1ZScpLA0KDQogICAgICAgIFtzd2l0Y2hdJFJhdw0KICAgICkNCiAgICBwcm9jZXNzIHsNCiAgICAgICAgJEpzb25TZWNyZXRWYWx1ZSA9IEdldC1TZWNyZXQgLU5hbWUgJFNlY3JldE5hbWUgLVZhdWx0ICRWYXVsdE5hbWUgLUFzUGxhaW5UZXh0IC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgIGlmICgkSnNvblNlY3JldFZhbHVlKSB7DQogICAgICAgICAgICAkU2VjcmV0VmFsdWVPdXQgPSBAe30NCiAgICAgICAgICAgICRTZWNyZXRWYWx1ZSA9ICRKc29uU2VjcmV0VmFsdWUgfCBDb252ZXJ0RnJvbS1Kc29uIC1Bc0hhc2h0YWJsZSAtRXJyb3JBY3Rpb24gQ29udGludWUNCiAgICAgICAgICAgIGlmKCAkUmF3LklzUHJlc2VudCkgew0KICAgICAgICAgICAgICAgIHJldHVybiAkU2VjcmV0VmFsdWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvcmVhY2ggKCRza2V5IGluICRTZWNyZXRWYWx1ZS5LZXlzKSB7DQogICAgICAgICAgICAgICAgaWYgKCRTZWNyZXRWYWx1ZVskc2tleV0gLWlzIFtoYXNodGFibGVdIC1hbmQgJFNlY3JldFZhbHVlWyRza2V5XS5LZXlzLkNvbnRhaW5zKCdVc2VyTmFtZScpIC1hbmQgJFNlY3JldFZhbHVlWyRza2V5XS5LZXlzLkNvbnRhaW5zKCdQYXNzd29yZCcpKSB7DQogICAgICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZU91dFskc2tleV0gPSBOZXctT2JqZWN0IC1UeXBlTmFtZSBQU0NyZWRlbnRpYWwgLUFyZ3VtZW50TGlzdCAkU2VjcmV0VmFsdWVbJHNrZXldLlVzZXJOYW1lLCAoQ29udmVydFRvLVNlY3VyZVN0cmluZyAtU3RyaW5nICRTZWNyZXRWYWx1ZVskc2tleV0uUGFzc3dvcmQgLUFzUGxhaW5UZXh0IC1Gb3JjZSkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZWlmICgkU2VjcmV0VmFsdWVbJHNrZXldIC1pcyBbc3RyaW5nXSAtYW5kICRTZWN1cmVWYXJpYWJsZXMgLWNvbnRhaW5zICRza2V5KSB7DQogICAgICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZU91dFskc2tleV0gPSBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1TdHJpbmcgJFNlY3JldFZhbHVlWyRza2V5XSAtQXNQbGFpblRleHQgLUZvcmNlDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAkU2VjcmV0VmFsdWVPdXRbJHNrZXldID0gJFNlY3JldFZhbHVlWyRza2V5XQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLUVycm9yICJTZWNyZXQgJyRTZWNyZXROYW1lJyBub3QgZm91bmQgaW4gdmF1bHQgJyRWYXVsdE5hbWUnLiINCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gJFNlY3JldFZhbHVlT3V0DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBOZXctU05PV01pZEVudmlyb25tZW50UGFzc3dvcmQgew0KICAgIHBhcmFtKA0KICAgICAgICBbc3RyaW5nXSRTZWNyZXROYW1lID0gJFNjcmlwdDpTTl9DT05ORUNUSU9OX1NFQ1JFVF9OQU1FLA0KICAgICAgICBbc3RyaW5nXSRWYXVsdE5hbWUgPSAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FDQogICAgKQ0KICAgICRDdXJyZW50QXV0aCA9IFJlc29sdmUtU05PV01JREVudmlyb25tZW50QXV0aCAtU2VjcmV0TmFtZSAkU2VjcmV0TmFtZSAtVmF1bHROYW1lICRWYXVsdE5hbWUNCiAgICBpZiAoJEN1cnJlbnRBdXRoIC1hbmQgKCRDdXJyZW50VXNlciA9IEdldC1TTk9XQ3VycmVudFVzZXIpIC1hbmQgKCRDdXJyZW50QXV0aC5DcmVkZW50aWFsKSkgew0KICAgICAgICAkUGFzc3dvcmQgPSBHZW5lcmF0ZVJhbmRvbVBhc3N3b3JkIC1MZW5ndGggMjQgLUFzUGxhaW5UZXh0DQogICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgIkdlbmVyYXRlZCBuZXcgcGFzc3dvcmQgZm9yIFNlcnZpY2VOb3cgTUlEIGVudmlyb25tZW50OiAkKCRDdXJyZW50QXV0aC5JbnN0YW5jZSkiDQogICAgICAgICRVc2VyVXBkYXRlID0gU2V0LVNOT1dPYmplY3QgLVRhYmxlICdzeXNfdXNlcicgLVN5c19JRCAkQ3VycmVudFVzZXIuc3lzX2lkIC1Qcm9wZXJ0aWVzIEB7DQogICAgICAgICAgICBsb2NrZWRfb3V0ICAgICAgICAgICA9ICRmYWxzZQ0KICAgICAgICAgICAgcGFzc3dvcmRfbmVlZHNfcmVzZXQgPSAkZmFsc2UNCiAgICAgICAgICAgIHVzZXJfcGFzc3dvcmQgICAgICAgID0gJFBhc3N3b3JkDQogICAgICAgIH0gLUlucHV0RGlzcGxheVZhbHVlIC1QYXNzVGhydQ0KICAgICAgICBpZiAoJFVzZXJVcGRhdGUpIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiUGFzc3dvcmQgdXBkYXRlZCBmb3IgdXNlciAkKCRDdXJyZW50VXNlci51c2VyX25hbWUpIGluIFNlcnZpY2VOb3cgTUlEIGVudmlyb25tZW50OiAkKCRDdXJyZW50QXV0aC5JbnN0YW5jZSkiDQogICAgICAgICAgICAjIFN0b3JlIHRoZSBuZXcgcGFzc3dvcmQgaW4gdGhlIHZhdWx0DQogICAgICAgICAgICAkU2VjcmV0UGFyYW1zID0gQHsNCiAgICAgICAgICAgICAgICBJbnN0YW5jZSAgID0gJEN1cnJlbnRBdXRoLkluc3RhbmNlDQogICAgICAgICAgICAgICAgQ3JlZGVudGlhbCA9IFtwc2NyZWRlbnRpYWxdOjpuZXcoJEN1cnJlbnRVc2VyLnVzZXJfbmFtZSwgKENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLVN0cmluZyAkUGFzc3dvcmQgLUFzUGxhaW5UZXh0IC1Gb3JjZSkpDQogICAgICAgICAgICAgICAgVmF1bHROYW1lICA9ICRWYXVsdE5hbWUNCiAgICAgICAgICAgICAgICBTZWNyZXROYW1lID0gJFNlY3JldE5hbWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFNldC1TTk9XTWlkRW52aXJvbm1lbnRTZWNyZXQgQFNlY3JldFBhcmFtcw0KICAgICAgICAgICAgcmV0dXJuICRTZWNyZXRQYXJhbXMNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byB1cGRhdGUgcGFzc3dvcmQgZm9yIHVzZXIgJCgkQ3VycmVudFVzZXIudXNlcl9uYW1lKSBpbiBTZXJ2aWNlTm93IE1JRCBlbnZpcm9ubWVudDogJCgkQ3VycmVudEF1dGguSW5zdGFuY2UpIg0KICAgICAgICB9DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJObyBjdXJyZW50IFNlcnZpY2VOb3cgTUlEIGVudmlyb25tZW50IGZvdW5kIHRvIGdlbmVyYXRlIGEgcGFzc3dvcmQuIg0KICAgIH0NCg0KfQ0KDQokU2NyaXB0OlBTU25vd1BhcmFtZXRlcnMgPSBAKCdJbnN0YW5jZScsICdDcmVkZW50aWFsJywgJ0NsaWVudElEJywgJ0NsaWVudFNlY3JldCcsICdQcm94eVVSSScsICdQcm94eUNyZWRlbnRpYWwnLCAnSGFuZGxlUmF0ZWxpbWl0aW5nJywgJ1dlYkNhbGxUaW1lb3V0U2Vjb25kcycsICdCeXBhc3NEZWZhdWx0UHJveHknLCAnVXNlV2ViU2Vzc2lvbicsICdBY2Nlc3NUb2tlbicsICdSZWZyZXNoVG9rZW4nKQ0KZnVuY3Rpb24gU2V0LVNOT1dNaWRFbnZpcm9ubWVudFNlY3JldCB7DQogICAgW0NtZGxldEJpbmRpbmcoRGVmYXVsdFBhcmFtZXRlclNldE5hbWUgPSAnQmFzaWMnKV0NCiAgICBwYXJhbSAoDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5LCBQYXJhbWV0ZXJTZXROYW1lID0gJ0Jhc2ljJyldDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5LCBQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoJyldDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5LCBQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoVG9rZW4nKV0NCiAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0NCiAgICAgICAgW3N0cmluZ10NCiAgICAgICAgI0luc3RhbmNlIG5hbWUgZS5nIGRldjEyMzQ1Ng0KICAgICAgICAkSW5zdGFuY2UsDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5LCBQYXJhbWV0ZXJTZXROYW1lID0gJ0Jhc2ljJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aCcpXQ0KICAgICAgICBbUFNDcmVkZW50aWFsXQ0KICAgICAgICAjQmFzaWMgQXV0aA0KICAgICAgICAkQ3JlZGVudGlhbCwNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnksIFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGgnKV0NCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnksIFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGhUb2tlbicpXQ0KICAgICAgICBbc3RyaW5nXQ0KICAgICAgICAjT0F1dGggQ2xpZW50SUQNCiAgICAgICAgJENsaWVudElELA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSwgUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aCcpXQ0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGhUb2tlbicpXQ0KICAgICAgICBbU2VjdXJlU3RyaW5nXQ0KICAgICAgICAjT0F1dGggQ2xpZW50U2VjcmV0DQogICAgICAgICRDbGllbnRTZWNyZXQsDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdCYXNpYycpXQ0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGgnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoVG9rZW4nKV0NCiAgICAgICAgW3N0cmluZ10NCiAgICAgICAgI0J5IGRlZmF1bHQgaWYgdGhpcyBwYXJhbSBpcyBub3QgdXNlZCB0aGUgc3lzdGVtIGRlZmF1bHQgcHJveHkgd2lsbCBiZSBwcm92aWRlZCBpZiBjb25maWd1cmVkLiBVUkkgc2hvdWxkIGluY2x1ZGUgdGhlIHBvcnQgaWYgdXNlZC4NCiAgICAgICAgJFByb3h5VVJJLA0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnQmFzaWMnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aFRva2VuJyldDQogICAgICAgIFtQU0NyZWRlbnRpYWxdDQogICAgICAgICNQcm92aWRlIGNyZWRlbnRpYWxzIGlmIHlvdSBkbyBub3Qgd2FudCB0byB1c2UgZGVmYXVsdCBhdXRoIGZvciBhbnkgZXhpc3RpbmcgcHJveHkNCiAgICAgICAgJFByb3h5Q3JlZGVudGlhbCwNCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ0Jhc2ljJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aCcpXQ0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGhUb2tlbicpXQ0KICAgICAgICAjU2VydmljZW5vdyByYXRlIGxpbWl0IHBvbGljaWVzIGFyZSBwZXIgaG91ciwgdGhpcyB3aWxsIGNhdXNlIGNvbW1hbmRzIHRvIHNsZWVwIGFuZCB3YWl0IHVudGlsIHRob3NlIHJhdGUgbGltaXRzIGFyZSByZWZyZXNoZWQsIGluc3RlYWQgb2YgcmV0dXJuaW5nIGFuIGVycm9yLg0KICAgICAgICBbc3dpdGNoXQ0KICAgICAgICAkSGFuZGxlUmF0ZWxpbWl0aW5nLA0KICAgICAgICAjRGVmYXVsdCBpcyBubyBzcGVjaWZpZWQgdGltZW91dA0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnQmFzaWMnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aFRva2VuJyldDQogICAgICAgIFtpbnRdDQogICAgICAgICRXZWJDYWxsVGltZW91dFNlY29uZHMsDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdCYXNpYycpXQ0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGgnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoVG9rZW4nKV0NCiAgICAgICAgW3N3aXRjaF0NCiAgICAgICAgI09ubHkgc3VwcG9ydGVkIG9uIFBTIENvcmUuIDUuMSB1c2VycyB3aWxsIG5lZWQgdG8gYWRkIGEgYnlwYXNzIHZpYSBkZXZpY2UgY29uZmlnLg0KICAgICAgICAkQnlwYXNzRGVmYXVsdFByb3h5LA0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnQmFzaWMnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aFRva2VuJyldDQogICAgICAgIFtzd2l0Y2hdDQogICAgICAgICMgQ3JlYXRlIGEgd2ViIHNlc3Npb24gZm9yIHRoZSBzZXNzaW9uIGNvbnRleHQuIFRoaXMgd2lsbCBzdG9yZSB0aGUgY29va2llcyBhbmQgWC1Vc2VyVG9rZW4gaW4gdGhlIHNlc3Npb24gb2JqZWN0Lg0KICAgICAgICAkVXNlV2ViU2Vzc2lvbiwNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnksIFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGhUb2tlbicpXQ0KICAgICAgICBbc3RyaW5nXQ0KICAgICAgICAjIEFuIGV4aXN0aW5nIE9BdXRoIEFjY2VzcyBUb2tlbg0KICAgICAgICAkQWNjZXNzVG9rZW4sDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5LCBQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoVG9rZW4nKV0NCiAgICAgICAgW3N0cmluZ10NCiAgICAgICAgI09BdXRoIFJlZnJlc2ggVG9rZW4NCiAgICAgICAgJFJlZnJlc2hUb2tlbiwNCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnksIFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGhUb2tlbicpXQ0KICAgICAgICBbZGF0ZXRpbWVdDQogICAgICAgICNPQXV0aCBSZWZyZXNoIFRva2VuDQogICAgICAgICRFeHBpcmVzLA0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnQmFzaWMnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoJyldDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdPQXV0aFRva2VuJyldDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUgPSAkU2NyaXB0OlNOX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUsDQogICAgICAgIFtQYXJhbWV0ZXIoUGFyYW1ldGVyU2V0TmFtZSA9ICdCYXNpYycpXQ0KICAgICAgICBbUGFyYW1ldGVyKFBhcmFtZXRlclNldE5hbWUgPSAnT0F1dGgnKV0NCiAgICAgICAgW1BhcmFtZXRlcihQYXJhbWV0ZXJTZXROYW1lID0gJ09BdXRoVG9rZW4nKV0NCiAgICAgICAgW3N0cmluZ10kVmF1bHROYW1lID0gJFNjcmlwdDpTTl9NSURfVkFVTFRfTkFNRQ0KICAgICkNCiAgICBwcm9jZXNzIHsNCiAgICAgICAgJFNlY3JldFZhbHVlID0gW29yZGVyZWRdQHsNCiAgICAgICAgICAgIEluc3RhbmNlID0gJEluc3RhbmNlDQogICAgICAgIH0NCiAgICAgICAgZm9yZWFjaCAoJHAgaW4gJFNjcmlwdDpQU1Nub3dQYXJhbWV0ZXJzKSB7DQogICAgICAgICAgICBpZiAoJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCRwKSkgew0KICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZVskcF0gPSAkUFNCb3VuZFBhcmFtZXRlcnNbJHBdDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICRPbGRBdXRoID0gR2V0LVNOT1dBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICBTZXQtU05PV0F1dGggQFNlY3JldFZhbHVlIC1FcnJvckFjdGlvbiBTdG9wDQogICAgICAgICAgICAjIFRlc3QgdGhlIGNvbm5lY3Rpb24gd2l0aCBhIHNpbXBsZSBBUEkgY2FsbA0KICAgICAgICAgICAgJFNlbGYgPSBJbnZva2UtU05PV1dlYlJlcXVlc3QgLU1ldGhvZCBHZXQgLVVSSSAnL2FwaS9ub3cvdGFibGUvc3lzX3VzZXI/c3lzcGFybV9maWVsZHM9c3lzX2lkLG5hbWUsdXNlcl9uYW1lJnN5c3Bhcm1fcXVlcnk9dXNlcl9uYW1lPWphdmFzY3JpcHQ6Z3MuZ2V0VXNlck5hbWUoKScgLVVzZVJlc3RNZXRob2QgLUVycm9yQWN0aW9uIFN0b3ANCiAgICAgICAgICAgIGlmICgkU2VsZi5yZXN1bHQpIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFNlcnZpY2VOb3cgWyQoJEluc3RhbmNlKV06ICQoJFNlbGYucmVzdWx0LnVzZXJfbmFtZSkgKCQoJFNlbGYucmVzdWx0LnN5c19pZCkpIg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgV2FybmluZyAiRmFpbGVkIHRvIHJldHJpZXZlIHVzZXIgaW5mb3JtYXRpb24gZnJvbSBTZXJ2aWNlTm93IGluc3RhbmNlLiBDaGVjayB5b3VyIGNyZWRlbnRpYWxzLiINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDb3VsZCBub3QgdmVyaWZ5IFNlcnZpY2VOb3cgY3JlZGVudGlhbHM6ICRfIg0KICAgICAgICAgICAgaWYgKCRPbGRBdXRoKSB7DQogICAgICAgICAgICAgICAgU2V0LVNOT1dBdXRoIC1BdXRoT2JqZWN0ICRPbGRBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIHwgT3V0LU51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoJEV4cGlyZXMpIHsNCiAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5FeHBpcmVzID0gJEV4cGlyZXMNCiAgICAgICAgfQ0KICAgICAgICBTZXQtSnNvblNlY3JldCAtU2VjcmV0VmFsdWUgJFNlY3JldFZhbHVlIC1TZWNyZXROYW1lICRTZWNyZXROYW1lIC1WYXVsdE5hbWUgJFZhdWx0TmFtZQ0KICAgICAgICAkVmF1bHRTZWNyZXRzID0gc3dpdGNoICgkUHNDbWRsZXQuUGFyYW1ldGVyU2V0TmFtZSkgew0KICAgICAgICAgICAgJ0Jhc2ljJyB7DQogICAgICAgICAgICAgICAgQHsNCiAgICAgICAgICAgICAgICAgICAgJ3Nub3ctYXBpLXVzZXJuYW1lJyA9ICRDcmVkZW50aWFsLlVzZXJOYW1lIHwgQ29udmVydFRvLVNlY3VyZVN0cmluZyAtQXNQbGFpblRleHQgLUZvcmNlDQogICAgICAgICAgICAgICAgICAgICdzbm93LWFwaS1wYXNzd29yZCcgPSAkQ3JlZGVudGlhbC5QYXNzd29yZA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICdPQXV0aCcgew0KICAgICAgICAgICAgICAgIEB7DQogICAgICAgICAgICAgICAgICAgICdzbm93LW9hdXRoLWNsaWVudGlkJyAgICAgPSAkQ2xpZW50SUQgfCBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCAtRm9yY2UNCiAgICAgICAgICAgICAgICAgICAgJ3Nub3ctb2F1dGgtY2xpZW50c2VjcmV0JyA9ICRDbGllbnRTZWNyZXQgfCBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCAtRm9yY2UNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICAnT0F1dGhUb2tlbicgew0KICAgICAgICAgICAgICAgIEB7DQogICAgICAgICAgICAgICAgICAgICdzbm93LW9hdXRoLWNsaWVudGlkJyAgICAgPSAkQ2xpZW50SUQgfCBDb252ZXJ0VG8tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCAtRm9yY2UNCiAgICAgICAgICAgICAgICAgICAgJ3Nub3ctb2F1dGgtdG9rZW4nICAgICAgICA9ICRBY2Nlc3NUb2tlbiB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZQ0KICAgICAgICAgICAgICAgICAgICAnc25vdy1vYXV0aC1yZWZyZXNodG9rZW4nID0gJFJlZnJlc2hUb2tlbiB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmb3JlYWNoICgka2V5IGluICRWYXVsdFNlY3JldHMuS2V5cykgew0KICAgICAgICAgICAgU2V0LVNlY3JldCAtTmFtZSAka2V5IC1TZWN1cmVTdHJpbmdTZWNyZXQgJFZhdWx0U2VjcmV0c1ska2V5XSAtVmF1bHQgJFZhdWx0TmFtZQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQpmdW5jdGlvbiBHZXQtU05PV01JREVudmlyb25tZW50QXV0aFNlY3JldCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUgPSAkU2NyaXB0OlNOX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUsDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZSA9ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUsDQogICAgICAgIFtzd2l0Y2hdJFJhdw0KICAgICkNCiAgICBHZXQtSnNvblNlY3JldCAtU2VjcmV0TmFtZSAkU2VjcmV0TmFtZSAtVmF1bHROYW1lICRWYXVsdE5hbWUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLVJhdzokUmF3DQp9DQoNCmZ1bmN0aW9uIFJlc29sdmUtU05PV01JREVudmlyb25tZW50QXV0aCB7DQogICAgcGFyYW0oDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUgPSAkU2NyaXB0OlNOX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUsDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZSA9ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUNCiAgICApDQogICAgcHJvY2VzcyB7DQogICAgICAgICRTZWNyZXRWYWx1ZSA9IEdldC1TTk9XTUlERW52aXJvbm1lbnRBdXRoU2VjcmV0IC1TZWNyZXROYW1lICRTZWNyZXROYW1lIC1WYXVsdE5hbWUgJFZhdWx0TmFtZQ0KICAgICAgICBpZiAoJFNlY3JldFZhbHVlLlVzZXJuYW1lIC1hbmQgJFNlY3JldFZhbHVlLlBhc3N3b3JkKSB7DQogICAgICAgICAgICAkU2VjcmV0VmFsdWUuQ3JlZGVudGlhbCA9IFtwc2NyZWRlbnRpYWxdOjpuZXcoJFNlY3JldFZhbHVlLlVzZXJuYW1lLCAkU2VjcmV0VmFsdWUuUGFzc3dvcmQpDQogICAgICAgIH0NCiAgICAgICAgIyBBdHRlbXB0IHRvIFNldC1TTk9XQXV0aCB3aXRoIHRoZSByZXRyaWV2ZWQgc2VjcmV0IGFuZCBxdWVyeSB0aGUgdXNlcg0KICAgICAgICBpZiAoJFNlY3JldFZhbHVlKSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlICJSZXNvbHZlZCBTZXJ2aWNlTm93IGNyZWRlbnRpYWxzIGZvciAkKCRTZWNyZXRWYWx1ZS5JbnN0YW5jZSkgaW4gRW52aXJvbm1lbnQgJCgkU2NyaXB0OlNOX01JRF9FTlZJUk9OTUVOVF9OQU1FKSINCiAgICAgICAgICAgICMgSWYgdGhlIGluc3RhbmNlIGlzIG5vdCBhIHByb3BlciBVUkwsIGFwcGVuZCAuc2VydmljZS1ub3cuY29tDQogICAgICAgICAgICBpZiAoJFNlY3JldFZhbHVlLkluc3RhbmNlIC1ub3RtYXRjaCAnXmh0dHBzLiokJykgew0KICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5JbnN0YW5jZSA9ICJodHRwczovLyQoJFNlY3JldFZhbHVlLkluc3RhbmNlKS5zZXJ2aWNlLW5vdy5jb20iDQogICAgICAgICAgICB9DQogICAgICAgICAgICAkU2NyaXB0OlNOX0hPU1QgPSAkU2VjcmV0VmFsdWUuSW5zdGFuY2UNCiAgICAgICAgICAgICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aCA9IEB7DQogICAgICAgICAgICAgICAgSW5zdGFuY2UgPSAkU2VjcmV0VmFsdWUuSW5zdGFuY2UNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvcmVhY2ggKCRwIGluICRTY3JpcHQ6UFNTbm93UGFyYW1ldGVycykgew0KICAgICAgICAgICAgICAgIGlmICgkU2VjcmV0VmFsdWUuS2V5cy5Db250YWlucygkcCkgLWFuZCAkbnVsbCAtbmUgJFNlY3JldFZhbHVlWyRwXSkgew0KICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGhbJHBdID0gJFNlY3JldFZhbHVlWyRwXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICgkU2VjcmV0VmFsdWUuRXhwaXJlcykgew0KICAgICAgICAgICAgICAgIGlmICgkU2VjcmV0VmFsdWUuRXhwaXJlcyAtaXMgW3N0cmluZ10pIHsNCiAgICAgICAgICAgICAgICAgICAgJFNlY3JldFZhbHVlLkV4cGlyZXMgPSBbZGF0ZXRpbWVdOjpQYXJzZSgkU2VjcmV0VmFsdWUuRXhwaXJlcykNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoLkV4cGlyZXNJblNlY29uZHMgPSAoJFNlY3JldFZhbHVlLkV4cGlyZXMgLSAoR2V0LURhdGUpKS5Ub3RhbFNlY29uZHMNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2VpZiAoJFNlY3JldFZhbHVlLkFjY2Vzc1Rva2VuIC1hbmQgLW5vdCAkU2VjcmV0VmFsdWUuRXhwaXJlcykgew0KICAgICAgICAgICAgICAgICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aC5FeHBpcmVzSW5TZWNvbmRzID0gMzANCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLU1lc3NhZ2UgIlNldHRpbmcgU2VydmljZU5vdyBjcmVkZW50aWFscyBmb3IgJCgkU2VjcmV0VmFsdWUuSW5zdGFuY2UpIGZyb20gVmF1bHQgU2VjcmV0IiAtTGV2ZWwgSW1wb3J0YW50DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nIC1NZXNzYWdlICJGYWlsZWQgdG8gcmV0cmlldmUgc2VjcmV0ICckKCRTY3JpcHQ6U05fQ09OTkVDVElPTl9TRUNSRVRfTkFNRSknIGZyb20gdmF1bHQgJyQoJFNjcmlwdDpTTl9NSURfVkFVTFRfTkFNRSknLiINCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJGVudjpNSURfSU5TVEFOQ0VfVVJMKSAtYW5kICFbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkZW52Ok1JRF9JTlNUQU5DRV9VU0VSTkFNRSkgYA0KICAgICAgICAgICAgICAgIC1hbmQgIVtzdHJpbmddOjpJc051bGxPckVtcHR5KCRlbnY6TUlEX0lOU1RBTkNFX1BBU1NXT1JEKSkgew0KICAgICAgICAgICAgJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoID0gQHsNCiAgICAgICAgICAgICAgICBJbnN0YW5jZSAgID0gJGVudjpNSURfSU5TVEFOQ0VfVVJMDQogICAgICAgICAgICAgICAgQ3JlZGVudGlhbCA9IFtwc2NyZWRlbnRpYWxdOjpuZXcoJGVudjpNSURfSU5TVEFOQ0VfVVNFUk5BTUUsICgkZW52Ok1JRF9JTlNUQU5DRV9QQVNTV09SRCB8IENvbnZlcnRUby1TZWN1cmVTdHJpbmcgLUFzUGxhaW5UZXh0IC1Gb3JjZSkpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1NZXNzYWdlICJTZXR0aW5nIFNlcnZpY2VOb3cgY3JlZGVudGlhbHMgZm9yICQoJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoLkluc3RhbmNlKSBmcm9tIE1JRF9JTlNUQU5DRV8gRW52aXJvbm1lbnQiIC1MZXZlbCBJbXBvcnRhbnQNCiAgICAgICAgfQ0KICAgICAgICANCg0KICAgICAgICBpZiAoJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoKSB7DQogICAgICAgICAgICAkU2NyaXB0OlNOX0hPU1QgPSAkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGguSW5zdGFuY2UNCiAgICAgICAgICAgICRDdXJyZW50VXNlciA9IEdldC1TTk9XTUlEUmVjb3JkV2l0aENyZWRzIC1BdXRoT2JqZWN0ICRTY3JpcHQ6U25vd0Vudmlyb25tZW50QXV0aA0KICAgICAgICAgICAgaWYgKCRDdXJyZW50VXNlcikgew0KICAgICAgICAgICAgICAgIFNldC1TTk9XQXV0aCBAU25vd0Vudmlyb25tZW50QXV0aCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgICAgICRNaWRWZXJzaW9uID0gR2V0LVNOT1dNaWRWZXJzaW9uIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICAgICAgJE5ld1Nub3dBdXRoID0gR2V0LVNOT1dBdXRoIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlDQogICAgICAgICAgICAgICAgaWYgKCROZXdTbm93QXV0aCAtYW5kICROZXdTbm93QXV0aC5Ub2tlbi5hY2Nlc3NfdG9rZW4gLWFuZCAkU2VjcmV0VmFsdWUuQWNjZXNzVG9rZW4pIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCRTZWNyZXRWYWx1ZS5BY2Nlc3NUb2tlbiAtYW5kICRTZWNyZXRWYWx1ZS5SZWZyZXNoVG9rZW4pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5BY2Nlc3NUb2tlbiA9ICROZXdTbm93QXV0aC5Ub2tlbi5hY2Nlc3NfdG9rZW4NCiAgICAgICAgICAgICAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5SZWZyZXNoVG9rZW4gPSAkTmV3U25vd0F1dGguVG9rZW4ucmVmcmVzaF90b2tlbg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCROZXdTbm93QXV0aC5Ub2tlbi5leHBpcmVzX2luKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJE5ld0V4cGlyeSA9IChHZXQtRGF0ZSkuQWRkU2Vjb25kcygkTmV3U25vd0F1dGguVG9rZW4uZXhwaXJlc19pbikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCAkU2VjcmV0VmFsdWUuRXhwaXJlcyAtb3IgJFNlY3JldFZhbHVlLkV4cGlyZXMgLWx0ICgkTmV3RXhwaXJ5LkFkZFNlY29uZHMoLTYwKSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNlY3JldFZhbHVlLkV4cGlyZXMgPSAkTmV3RXhwaXJ5DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAtTWVzc2FnZSAiVXBkYXRpbmcgU2VydmljZU5vdyBPQXV0aCB0b2tlbiBleHBpcnkgdG8gJCgkU2VjcmV0VmFsdWUuRXhwaXJlcykgZm9yICQoJFNlY3JldFZhbHVlLkluc3RhbmNlKSINCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2V0LVNOT1dNaWRFbnZpcm9ubWVudFNlY3JldCAtSW5zdGFuY2UgJE5ld1Nub3dBdXRoLkluc3RhbmNlIGANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1DbGllbnRJRCAkTmV3U25vd0F1dGguQ2xpZW50SWQgYA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLUFjY2Vzc1Rva2VuICROZXdTbm93QXV0aC5Ub2tlbi5hY2Nlc3NfdG9rZW4gYA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVJlZnJlc2hUb2tlbiAkTmV3U25vd0F1dGguVG9rZW4ucmVmcmVzaF90b2tlbiBgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtRXhwaXJlcyAkU2VjcmV0VmFsdWUuRXhwaXJlcyBgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtU2VjcmV0TmFtZSAkU2VjcmV0TmFtZSBgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmF1bHROYW1lICRWYXVsdE5hbWUNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIEltcG9ydGFudCAiU2VydmljZU5vdyBPQXV0aCB0b2tlbiBleHBpcnkgaXMgYWxyZWFkeSBzZXQgdG8gJCgkU2VjcmV0VmFsdWUuRXhwaXJlcykgZm9yICQoJFNlY3JldFZhbHVlLkluc3RhbmNlKS4gTmV3IGV4cGlyeSBpcyAkKCROZXdFeHBpcnkpLiINCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgV3JpdGUtUFNGTWVzc2FnZSAtTGV2ZWwgSW1wb3J0YW50ICJTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFNlcnZpY2VOb3cgWyQoJFNlY3JldFZhbHVlLkluc3RhbmNlKV06ICQoJE1pZFZlcnNpb24pICgkKCRDdXJyZW50VXNlci51c2VyX25hbWUpIC0gJCgkQ3VycmVudFVzZXIuc3lzX2lkKSkiDQogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6U05fTUlEX0NPTlRFWFQgLWVxICdhenVyZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICRCdWlsZENvbnRleHQgPSBSZXNvbHZlLVNOT1dNSURCdWlsZENvbnRleHQNCiAgICAgICAgICAgICAgICAgICAgICAgICRTbm93QXV0aFN0YXRlID0gQHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVc2VyICAgICAgICAgICAgICAgICA9ICgkQ3VycmVudFVzZXIudXNlcl9uYW1lKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZlcnNpb24gICAgICAgICAgICAgID0gJE1pZFZlcnNpb24NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBdXRoZW50aWNhdGlvbk1ldGhvZCA9IGlmICgkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGguQ3JlZGVudGlhbCAtYW5kIC1ub3QgJFNjcmlwdDpTbm93RW52aXJvbm1lbnRBdXRoLkNsaWVudElEKSB7ICdCYXNpYycgfSBlbHNlIHsgJ09BdXRoJyB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgTGFzdFZlcmlmaWVkICAgICAgICAgPSAoR2V0LURhdGUpLlRvU3RyaW5nKCdvJykNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIFVwZGF0ZS1BelRhZyAtUmVzb3VyY2VJZCAkQnVpbGRDb250ZXh0LlN0b3JhZ2VBY2NvdW50LnJlc291cmNlSWQgLVRhZyBAe1Nub3dBdXRoU3RhdGUgPSAoJFNub3dBdXRoU3RhdGUgfCBDb252ZXJ0VG8tSnNvbiAtQ29tcHJlc3MpIH0gLU9wZXJhdGlvbiBNZXJnZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGNhdGNoIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlLVBTRk1lc3NhZ2UgLUxldmVsIFdhcm5pbmcgIkZhaWxlZCB0byB1cGRhdGUgQXp1cmUgU3RvcmFnZSBBY2NvdW50IHRhZ3Mgd2l0aCBTZXJ2aWNlTm93IE1JRCBlbnZpcm9ubWVudCBzdGF0ZTogJF8iDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJGYWlsZWQgdG8gcmV0cmlldmUgTUlEIHZlcnNpb24gZnJvbSBTZXJ2aWNlTm93IGluc3RhbmNlLiBDaGVjayB5b3VyIGNyZWRlbnRpYWxzLiINCiAgICAgICAgICAgICAgICAkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGggPSAkbnVsbA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiAkU2NyaXB0OlNub3dFbnZpcm9ubWVudEF1dGgNCiAgICB9DQp9DQoNCmZ1bmN0aW9uIFNldC1TTk9XTWlkQXp1cmVFbnZpcm9ubWVudFNlY3JldCB7DQogICAgW0NtZGxldEJpbmRpbmcoKV0NCiAgICBwYXJhbSAoDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRUZW5hbnRJZCwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRTdWJzY3JpcHRpb25JZCwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQ0KICAgICAgICBbc3RyaW5nXSRDbGllbnRJZCwNCg0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3N0cmluZ10kUHJpbmNpcGFsSWQsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0NCiAgICAgICAgW3NlY3VyZXN0cmluZ10kQ2xpZW50U2VjcmV0LA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5YNTA5Q2VydGlmaWNhdGVzLlg1MDlDZXJ0aWZpY2F0ZTJdJENlcnRpZmljYXRlLA0KICAgICAgICANCiAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXQ0KICAgICAgICBbaGFzaHRhYmxlXSRNZXRhZGF0YSA9IEB7fSwNCiAgICAgICAgDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0NCiAgICAgICAgW3N0cmluZ10kQXp1cmVFbnZpcm9ubWVudE5hbWUgPSAnQXp1cmVDbG91ZCcsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJFNlY3JldE5hbWUgPSAkU2NyaXB0OkFaX0NPTk5FQ1RJT05fU0VDUkVUX05BTUUsDQogICAgICAgIA0KICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldDQogICAgICAgIFtzdHJpbmddJFZhdWx0TmFtZSA9ICRTY3JpcHQ6U05fTUlEX1ZBVUxUX05BTUUNCiAgICApDQogICAgcHJvY2VzcyB7DQogICAgICAgICRTZWNyZXRWYWx1ZSA9IEB7DQogICAgICAgICAgICBUZW5hbnRJZCAgICAgICAgPSAkVGVuYW50SWQNCiAgICAgICAgICAgIFN1YnNjcmlwdGlvbklkICA9ICRTdWJzY3JpcHRpb25JZA0KICAgICAgICAgICAgQ2xpZW50SWQgICAgICAgID0gJENsaWVudElkDQogICAgICAgICAgICBQcmluY2lwYWxJZCAgICAgPSAkUHJpbmNpcGFsSWQNCiAgICAgICAgICAgIENsaWVudFNlY3JldCAgICA9ICgkQ2xpZW50U2VjcmV0IHwgQ29udmVydEZyb20tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dCkNCiAgICAgICAgICAgIEVudmlyb25tZW50TmFtZSA9ICRBenVyZUVudmlyb25tZW50TmFtZQ0KICAgICAgICAgICAgTWV0YWRhdGEgICAgICAgID0gJE1ldGFkYXRhDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmICgkQ2VydGlmaWNhdGUpIHsNCiAgICAgICAgICAgICRTZWNyZXRWYWx1ZS5DZXJ0aWZpY2F0ZSA9IEAoJENlcnRpZmljYXRlLkV4cG9ydENlcnRpZmljYXRlUGVtKCksICRDZXJ0aWZpY2F0ZS5Qcml2YXRlS2V5LkV4cG9ydFBrY3M4UHJpdmF0ZUtleVBlbSgpKSAtam9pbiAiYG4iDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICMgVmVyaWZ5IHRoZSBjcmVkZW50aWFscyBhcmUgdmFsaWQgaWYgcG9zc2libGUNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICRjb250ZXh0ID0gQ29ubmVjdC1BekFjY291bnQgLVRlbmFudCAkVGVuYW50SWQgLVN1YnNjcmlwdGlvbiAkU3Vic2NyaXB0aW9uSWQgYA0KICAgICAgICAgICAgICAgIC1DcmVkZW50aWFsIChOZXctT2JqZWN0IFBTQ3JlZGVudGlhbCgkQ2xpZW50SWQsICRDbGllbnRTZWNyZXQpKSAtRW52aXJvbm1lbnQgJEF6dXJlRW52aXJvbm1lbnROYW1lIGANCiAgICAgICAgICAgICAgICAtU2VydmljZVByaW5jaXBhbCAtRXJyb3JBY3Rpb24gU3RvcCAtU2NvcGUgUHJvY2Vzcw0KICAgICAgICAgICAgIyBEaXNjb25uZWN0IGlmIHRoZSBjb25uZWN0aW9uIHdhcyBzdWNjZXNzZnVsDQogICAgICAgICAgICBEaXNjb25uZWN0LUF6QWNjb3VudCAtU2NvcGUgUHJvY2VzcyAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSANCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCB7DQogICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBXYXJuaW5nICJDb3VsZCBub3QgdmVyaWZ5IEF6dXJlIGNyZWRlbnRpYWxzOiAkXyINCiAgICAgICAgICAgICMgQ29udGludWUgYW55d2F5IC0gdGhlIHNlY3JldCB3aWxsIHN0aWxsIGJlIHN0b3JlZA0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBTZXQtSnNvblNlY3JldCAtU2VjcmV0VmFsdWUgJFNlY3JldFZhbHVlIC1TZWNyZXROYW1lICRTZWNyZXROYW1lIC1WYXVsdE5hbWUgJFZhdWx0TmFtZQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gUmVzb2x2ZS1TTk9XTWlkQXp1cmVFbnZpcm9ubWVudFNlY3JldHMgew0KICAgIFtDbWRsZXRCaW5kaW5nKCldDQogICAgcGFyYW0gKA0KICAgICAgICBbc3RyaW5nXSRTZWNyZXROYW1lID0gJFNjcmlwdDpBWl9DT05ORUNUSU9OX1NFQ1JFVF9OQU1FLA0KICAgICAgICBbc3RyaW5nXSRWYXVsdE5hbWUgPSAkU2NyaXB0OlNOX01JRF9WQVVMVF9OQU1FLA0KICAgICAgICBbc3dpdGNoXSRTZXRFbnZpcm9ubWVudFZhcmlhYmxlcw0KICAgICkNCiAgICBwcm9jZXNzIHsNCiAgICAgICAgJFNlY3JldFZhbHVlID0gR2V0LUpzb25TZWNyZXQgLVNlY3JldE5hbWUgJFNlY3JldE5hbWUgLVZhdWx0TmFtZSAkVmF1bHROYW1lDQogICAgICAgICRFbnZWYXJzID0gW29yZGVyZWRdQHsNCiAgICAgICAgICAgIEFaVVJFX1RFTkFOVF9JRCAgICAgICAgPSAkU2VjcmV0VmFsdWUuVGVuYW50SWQNCiAgICAgICAgICAgIEFaVVJFX1NVQlNDUklQVElPTl9JRCAgPSAkU2VjcmV0VmFsdWUuU3Vic2NyaXB0aW9uSWQNCiAgICAgICAgICAgIEFaVVJFX0NMSUVOVF9JRCAgICAgICAgPSAkU2VjcmV0VmFsdWUuQ2xpZW50SWQNCiAgICAgICAgICAgIEFaVVJFX0NMSUVOVF9TRUNSRVQgICAgPSAkU2VjcmV0VmFsdWUuQ2xpZW50U2VjcmV0DQogICAgICAgICAgICBBWlVSRV9FTlZJUk9OTUVOVF9OQU1FID0gJFNlY3JldFZhbHVlLkVudmlyb25tZW50TmFtZQ0KICAgICAgICB9DQogICAgICAgIGlmICgkRW52VmFycy5BWlVSRV9DTElFTlRfU0VDUkVUIC1hbmQgJEVudlZhcnMuQVpVUkVfQ0xJRU5UX1NFQ1JFVCAtaXMgW3NlY3VyZXN0cmluZ10pIHsNCiAgICAgICAgICAgICRFbnZWYXJzLkFaVVJFX0NMSUVOVF9TRUNSRVQgPSAkRW52VmFycy5BWlVSRV9DTElFTlRfU0VDUkVUIHwgQ29udmVydEZyb20tU2VjdXJlU3RyaW5nIC1Bc1BsYWluVGV4dA0KICAgICAgICB9DQogICAgICAgIGlmICgkU2VjcmV0VmFsdWUuQ2VydGlmaWNhdGUpIHsNCiAgICAgICAgICAgICRjZXJ0UGF0aCA9IFtTeXN0ZW0uSU8uUGF0aF06OkdldFRlbXBGaWxlTmFtZSgpDQogICAgICAgICAgICAkU2VjcmV0VmFsdWUuQ2VydGlmaWNhdGUgfCBPdXQtRmlsZSAtRmlsZVBhdGggJGNlcnRQYXRoIC1FbmNvZGluZyB1dGY4DQogICAgICAgICAgICAkRW52VmFycy5BWlVSRV9DRVJUSUZJQ0FURV9QQVRIID0gJGNlcnRQYXRoDQogICAgICAgIH0NCiAgICAgICAgIyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGlmIHJlcXVlc3RlZCBvciBieSBkZWZhdWx0DQogICAgICAgIGlmICgkU2VjcmV0VmFsdWUgLWFuZCAoJFNldEVudmlyb25tZW50VmFyaWFibGVzIC1vciAhJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdTZXRFbnZpcm9ubWVudFZhcmlhYmxlcycpKSkgew0KICAgICAgICAgICAgZm9yZWFjaCAoJEVudlZhciBpbiAkRW52VmFycy5LZXlzKSB7DQogICAgICAgICAgICAgICAgaWYgKCRFbnZWYXJzWyRFbnZWYXJdKSB7DQogICAgICAgICAgICAgICAgICAgICRlVmFsID0gJEVudlZhcnNbJEVudlZhcl0NCiAgICAgICAgICAgICAgICAgICAgW1N5c3RlbS5FbnZpcm9ubWVudF06OlNldEVudmlyb25tZW50VmFyaWFibGUoJEVudlZhciwgJGVWYWwsIFtTeXN0ZW0uRW52aXJvbm1lbnRWYXJpYWJsZVRhcmdldF06OlByb2Nlc3MpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBXcml0ZS1QU0ZNZXNzYWdlIC1MZXZlbCBWZXJib3NlICJFbnZpcm9ubWVudCB2YXJpYWJsZSAnJEVudlZhcicgbm90IHNldC4gVmFsdWUgaXMgbnVsbCBvciBlbXB0eS4iDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2VpZiAoISRTZWNyZXRWYWx1ZSkgew0KICAgICAgICAgICAgV3JpdGUtRXJyb3IgIkZhaWxlZCB0byByZXRyaWV2ZSBzZWNyZXQgJyRTZWNyZXROYW1lJyBmcm9tIHZhdWx0ICckVmF1bHROYW1lJy4iDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiAkRW52VmFycw0KICAgIH0NCn0NCkluaXRpYWxpemUtU05PV01pZFRvb2xzDQojIERPIE5PVCBSRU1PVkUgVEhJUyBMSU5FDQojIyMgRU5EIFBTU25vdy5NaWRUb29scy5wc20xICMjIw==",
            "dsEnv": "[union(createArray(createObject('name', 'SN_MID_ENVIRONMENT_NAME', 'value', parameters('devopsEnvironmentName')), createObject('name', 'SN_MID_CONTEXT', 'value', 'azure'), createObject('name', 'SN_MID_BUILD_STRATEGY', 'value', 'acr'), createObject('name', 'NO_COLOR', 'value', 'true')), parameters('scriptEnvironmentVariables'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[parameters('deploymentScriptName')]",
              "location": "[resourceGroup().location]",
              "identity": {
                "type": "userAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')))]": {}
                }
              },
              "kind": "AzurePowerShell",
              "properties": {
                "environmentVariables": "[variables('dsEnv')]",
                "forceUpdateTag": "[parameters('utcValue')]",
                "azPowerShellVersion": "14.2",
                "storageAccountSettings": {
                  "storageAccountName": "[variables('storageAccountName')]"
                },
                "containerSettings": {
                  "subnetIds": [
                    {
                      "id": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowContainerSubnetId]"
                    }
                  ]
                },
                "scriptContent": "[join(createArray('# GENERATED IN snow-mid-deplyoymentscript.mod.bicep', '# This function is called at the bottom of this script.', 'function SnowMidDeploymentScript {', parameters('inlineScript'), '}', '# END GENERATED FUNCTION', '# BEGIN PSSnow.MidTools.psm1 Content', base64ToString(variables('commonScriptContent')), '# END PSSnow.MidTools.psm1 Content', 'SnowMidDeploymentScript'), '\n')]",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "scriptOutput": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('deploymentScriptName')), '2023-08-01').outputs]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('midServerDeployment-{0}', parameters('midServerName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userAssignedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowMidServerIdentity]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "midServerName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName'))), '2022-09-01').outputs.scriptOutput.value.MidServerName]"
          },
          "midInstanceUrl": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowHost]"
          },
          "midInstanceUsername": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName'))), '2022-09-01').outputs.scriptOutput.value.Credentials.UserName]"
          },
          "midInstancePassword": {
            "reference": {
              "keyVault": {
                "id": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              },
              "secretName": "[reference(resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName'))), '2022-09-01').outputs.scriptOutput.value.VaultSecret]"
            }
          },
          "containerRegistryId": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowContainerRegistryId]"
          },
          "containerSubnetId": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags.SnowContainerSubnetId]"
          },
          "imagePath": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName'))), '2022-09-01').outputs.scriptOutput.value.BuildResults.CustomImageEnvironmentUri]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "numCpu": {
            "value": "[parameters('numCpu')]"
          },
          "memoryInGB": {
            "value": "[parameters('memoryInGB')]"
          },
          "additionalEnvironmentVariables": {
            "value": [
              {
                "name": "SN_MID_ENVIRONMENT_NAME",
                "value": "[parameters('devopsEnvironmentName')]"
              },
              {
                "name": "SN_MID_CONTEXT",
                "value": "azure"
              },
              {
                "name": "SN_MID_BUILD_STRATEGY",
                "value": "acr"
              },
              {
                "name": "MID_WRAPPER_wrapper__java__classpath__1",
                "value": "extlib/*.jar"
              },
              {
                "name": "MID_WRAPPER_wrapper__java__classpath__2",
                "value": "lib/*.jar"
              }
            ]
          },
          "tags": {
            "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01', 'full').tags]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "9903498722782844110"
            }
          },
          "functions": [
            {
              "namespace": "__bicep",
              "members": {
                "parseResourceId": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "resourceId"
                    }
                  ],
                  "output": {
                    "type": "object",
                    "value": {
                      "SubscriptionId": "[split(parameters('resourceId'), '/')[2]]",
                      "ResourceGroup": "[split(parameters('resourceId'), '/')[4]]",
                      "Name": "[last(split(parameters('resourceId'), '/'))]"
                    }
                  }
                }
              }
            }
          ],
          "parameters": {
            "midInstanceUrl": {
              "type": "string",
              "metadata": {
                "description": "The ServiceNow URL. Fully qualified. Example: https://<instance>.service-now.com"
              }
            },
            "midServerName": {
              "type": "string",
              "metadata": {
                "description": "The MID Server name"
              }
            },
            "midInstanceUsername": {
              "type": "string",
              "metadata": {
                "description": "The MID Server username. Must exist, and have the mid_server role"
              }
            },
            "midInstancePassword": {
              "type": "securestring"
            },
            "imagePath": {
              "type": "string",
              "metadata": {
                "description": "The fully qualified image path to use for the container. [registry].azurecr.io/snow_mid_server_custom:yokohama-12-18-2024__patch1-02-21-2025_03-05-2025_2133"
              }
            },
            "containerRegistryId": {
              "type": "string"
            },
            "userAssignedIdentityName": {
              "type": "string"
            },
            "containerSubnetId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "numCpu": {
              "type": "int",
              "defaultValue": 1,
              "allowedValues": [
                1,
                2,
                4,
                8
              ],
              "metadata": {
                "description": "The number of CPU cores to allocate to the MID Server container"
              }
            },
            "memoryInGB": {
              "type": "int",
              "defaultValue": 4,
              "allowedValues": [
                1,
                2,
                4,
                8,
                16
              ],
              "metadata": {
                "description": "The amount of memory in GB to allocate to the MID Server container"
              }
            },
            "additionalEnvironmentVariables": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "MID_WRAPPER_wrapper__java__classpath__1",
                  "value": "extlib/*.jar"
                },
                {
                  "name": "MID_WRAPPER_wrapper__java__classpath__2",
                  "value": "lib/*.jar"
                }
              ]
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the executed deployment script"
              }
            }
          },
          "variables": {
            "containerRegistryObject": "[__bicep.parseResourceId(parameters('containerRegistryId'))]",
            "fileShareName": "[toLower(replace(parameters('midServerName'), '-', ''))]",
            "subnetObject": "[__bicep.parseResourceId(parameters('containerSubnetId'))]",
            "virtualNetworkName": "[split(parameters('containerSubnetId'), '/')[8]]"
          },
          "resources": {
            "containerRegistryExisting": {
              "existing": true,
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "subscriptionId": "[variables('containerRegistryObject').SubscriptionId]",
              "resourceGroup": "[variables('containerRegistryObject').ResourceGroup]",
              "name": "[variables('containerRegistryObject').Name]"
            },
            "userAssignedIdentity": {
              "existing": true,
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('userAssignedIdentityName')]"
            },
            "storageAccount": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]"
            },
            "midServerShare": {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-05-01",
              "name": "[toLower(format('{0}/default/{1}', parameters('storageAccountName'), variables('fileShareName')))]",
              "properties": {
                "shareQuota": 5
              }
            },
            "midServerShareKeystore": {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-05-01",
              "name": "[toLower(format('{0}/default/{1}keystore', parameters('storageAccountName'), variables('fileShareName')))]",
              "properties": {
                "shareQuota": 1
              }
            },
            "virtualNetwork": {
              "existing": true,
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "subscriptionId": "[variables('subnetObject').SubscriptionId]",
              "resourceGroup": "[variables('subnetObject').ResourceGroup]",
              "name": "[variables('virtualNetworkName')]"
            },
            "containerGroup": {
              "type": "Microsoft.ContainerInstance/containerGroups",
              "apiVersion": "2023-05-01",
              "name": "[parameters('midServerName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')))]": {}
                }
              },
              "properties": {
                "containers": [
                  {
                    "name": "[parameters('midServerName')]",
                    "properties": {
                      "image": "[parameters('imagePath')]",
                      "resources": {
                        "requests": {
                          "cpu": "[parameters('numCpu')]",
                          "memoryInGB": "[parameters('memoryInGB')]"
                        }
                      },
                      "environmentVariables": "[union(createArray(createObject('name', 'HOSTNAME', 'value', parameters('midServerName')), createObject('name', 'MID_INSTANCE_URL', 'value', parameters('midInstanceUrl')), createObject('name', 'MID_SERVER_NAME', 'value', parameters('midServerName')), createObject('name', 'MID_INSTANCE_USERNAME', 'value', parameters('midInstanceUsername')), createObject('name', 'MID_INSTANCE_PASSWORD', 'secureValue', parameters('midInstancePassword')), createObject('name', 'MID_CONFIG__AZURE__CLIENT__ID', 'value', reference('userAssignedIdentity').principalId)), parameters('additionalEnvironmentVariables'))]",
                      "volumeMounts": [
                        {
                          "name": "midserver",
                          "mountPath": "/opt/snc_mid_server/mid_container"
                        },
                        {
                          "name": "keystore",
                          "mountPath": "/opt/snc_mid_server/agent/security"
                        }
                      ]
                    }
                  }
                ],
                "imageRegistryCredentials": [
                  {
                    "server": "[reference('containerRegistryExisting').loginServer]",
                    "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                  }
                ],
                "dnsConfig": "[if(not(empty(tryGet(tryGet(reference('virtualNetwork'), 'dhcpOptions'), 'dnsServers'))), createObject('nameServers', reference('virtualNetwork').dhcpOptions.dnsServers), null())]",
                "osType": "Linux",
                "restartPolicy": "Always",
                "subnetIds": [
                  {
                    "name": "default",
                    "id": "[parameters('containerSubnetId')]"
                  }
                ],
                "volumes": [
                  {
                    "name": "midserver",
                    "azureFile": {
                      "shareName": "[variables('fileShareName')]",
                      "storageAccountName": "[parameters('storageAccountName')]",
                      "storageAccountKey": "[listKeys('storageAccount', '2023-01-01').keys[0].value]"
                    }
                  },
                  {
                    "name": "keystore",
                    "azureFile": {
                      "shareName": "[format('{0}keystore', variables('fileShareName'))]",
                      "storageAccountName": "[parameters('storageAccountName')]",
                      "storageAccountKey": "[listKeys('storageAccount', '2023-01-01').keys[0].value]"
                    }
                  }
                ]
              },
              "tags": "[union(parameters('tags'), createObject('SnowMidServerName', parameters('midServerName'), 'SnowMidServerUser', parameters('midInstanceUsername'), 'SnowMidImage', parameters('imagePath')))]",
              "dependsOn": [
                "containerRegistryExisting",
                "userAssignedIdentity",
                "virtualNetwork"
              ]
            }
          },
          "outputs": {
            "container": {
              "type": "object",
              "value": "[reference('containerGroup', '2023-05-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName')))]"
      ]
    }
  ],
  "outputs": {
    "storageAccountId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
    },
    "scriptOutputs": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('GetBuildContext-{0}', parameters('midServerName'))), '2022-09-01').outputs]"
    }
  }
}